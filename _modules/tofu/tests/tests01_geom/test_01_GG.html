<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.tests.tests01_geom.test_01_GG &#8212; Tofu 1.5.0</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.5.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../../installation.html">Installation</a></li>
                <li><a href="../../../../contributing.html">Contributing</a></li>
                <li><a href="../../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../../aboutus.html">About</a></li>
                <li><a href="../../../../releases.html">Releases</a></li>
                <li><a href="../../../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.tests.tests01_geom.test_01_GG</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains tests for tofu.geom in its structured version</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># External modules</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># ToFu-specific</span>
<span class="kn">import</span> <span class="nn">tofu.geom._GG</span> <span class="k">as</span> <span class="nn">GG</span>
<span class="kn">from</span> <span class="nn">.testing_tools</span> <span class="kn">import</span> <span class="n">compute_ves_norm</span>


<span class="c1"># header</span>
<span class="n">VerbHead</span> <span class="o">=</span> <span class="s1">&#39;tofu.geom.test_01_GG&#39;</span>


<span class="c1">#######################################################</span>
<span class="c1">#</span>
<span class="c1">#     Setup and Teardown</span>
<span class="c1">#</span>
<span class="c1">#######################################################</span>

<div class="viewcode-block" id="setup_module"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.setup_module">[docs]</a><span class="k">def</span> <span class="nf">setup_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># this is to get a newline after the dots</span></div>
    <span class="c1">#print (&quot;setup_module before anything in this file&quot;)</span>

<div class="viewcode-block" id="teardown_module"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.teardown_module">[docs]</a><span class="k">def</span> <span class="nf">teardown_module</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
    <span class="c1">#os.remove(VesTor.Id.SavePath + VesTor.Id.SaveName + &#39;.npz&#39;)</span>
    <span class="c1">#os.remove(VesLin.Id.SavePath + VesLin.Id.SaveName + &#39;.npz&#39;)</span>
    <span class="c1">#print (&quot;teardown_module after everything in this file&quot;)</span>
    <span class="c1">#print (&quot;&quot;) # this is to get a newline</span>
    <span class="k">pass</span></div>


<span class="c1">#######################################################</span>
<span class="c1">#</span>
<span class="c1">#     Testing</span>
<span class="c1">#</span>
<span class="c1">#######################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">######################################################</span>
<span class="sd">######################################################</span>
<span class="sd">#               Commons</span>
<span class="sd">######################################################</span>
<span class="sd">######################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<div class="viewcode-block" id="test01_CoordShift"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test01_CoordShift">[docs]</a><span class="k">def</span> <span class="nf">test01_CoordShift</span><span class="p">():</span>

    <span class="c1"># Tests 1D input</span>
    <span class="n">Pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">coord_shift</span><span class="p">(</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s1">&#39;(R,Z)&#39;</span><span class="p">,</span> <span class="n">cross_format</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mf">1.</span><span class="p">])</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">coord_shift</span><span class="p">(</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s1">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">cross_format</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="mf">1.</span><span class="p">])</span>

    <span class="c1"># Test 2D input</span>
    <span class="n">Pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">coord_shift</span><span class="p">(</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s1">&#39;(R,Phi,Z)&#39;</span><span class="p">,</span> <span class="n">cross_format</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">pts</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
            <span class="n">pts</span><span class="p">,</span>
            <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">coord_shift</span><span class="p">(</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(Phi,Z,R)&#39;</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s1">&#39;(X,Y)&#39;</span><span class="p">,</span> <span class="n">cross_format</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">pts</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
            <span class="n">pts</span><span class="p">,</span>
            <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">1.</span><span class="p">)],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">1.</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">1.</span><span class="p">)]]</span>
        <span class="p">)</span>
    <span class="p">)</span></div>






<span class="c1">########################################################</span>
<span class="c1">########################################################</span>
<span class="c1">#       Polygons</span>
<span class="c1">########################################################</span>

<div class="viewcode-block" id="test02_Poly_CLockOrder"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test02_Poly_CLockOrder">[docs]</a><span class="k">def</span> <span class="nf">test02_Poly_CLockOrder</span><span class="p">():</span>

    <span class="c1"># Test arbitrary 2D polygon</span>
    <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]])</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">format_poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                <span class="ow">not</span> <span class="n">GG</span><span class="o">.</span><span class="n">Poly_isClockwise</span><span class="p">(</span><span class="n">P</span><span class="p">),</span> <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">],</span>
                <span class="ow">not</span> <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;F_CONTIGUOUS&#39;</span><span class="p">]])</span>

    <span class="n">P</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">format_poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;poly should not be closed&quot;</span>
    <span class="k">assert</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;shape of poly should be (2,4), here = &quot;</span>
                               <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Poly = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">GG</span><span class="o">.</span><span class="n">Poly_isClockwise</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">P</span><span class="p">,</span> <span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;F_CONTIGUOUS&#39;</span><span class="p">]</span>

    <span class="c1"># Test arbitrary 3D polygon</span>
    <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]])</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">format_poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">],</span> <span class="ow">not</span> <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;F_CONTIGUOUS&#39;</span><span class="p">]])</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">format_poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">P</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">P</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                <span class="ow">not</span> <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;C_CONTIGUOUS&#39;</span><span class="p">],</span> <span class="n">P</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="s1">&#39;F_CONTIGUOUS&#39;</span><span class="p">]])</span></div>


<div class="viewcode-block" id="test03_Poly_VolAngTor"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test03_Poly_VolAngTor">[docs]</a><span class="k">def</span> <span class="nf">test03_Poly_VolAngTor</span><span class="p">():</span>
    <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
        <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span>
    <span class="p">])</span>
    <span class="n">Poly</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">format_poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">V</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">Poly_VolAngTor</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">V</span><span class="o">==</span><span class="mf">1.5</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="p">[</span><span class="mf">7.</span><span class="o">/</span><span class="p">(</span><span class="mf">3.</span><span class="o">*</span><span class="mf">1.5</span><span class="p">),</span> <span class="mf">0.5</span><span class="p">])</span></div>





<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">######################################################</span>
<span class="sd">######################################################</span>
<span class="sd">#               Ves</span>
<span class="sd">######################################################</span>
<span class="sd">######################################################</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># VPoly</span>
<span class="n">thet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">VPoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">thet</span><span class="p">),</span> <span class="mf">0.</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">thet</span><span class="p">)])</span>



<div class="viewcode-block" id="test04_Ves_isInside"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test04_Ves_isInside">[docs]</a><span class="k">def</span> <span class="nf">test04_Ves_isInside</span><span class="p">(</span><span class="n">VPoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">):</span>

    <span class="c1"># Lin Ves</span>
    <span class="n">Pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]])</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span> <span class="n">ves_lims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]]),</span> <span class="n">nlim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Lin&#39;</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="p">[</span>
            <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Tor Ves</span>
    <span class="n">Pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">,</span> <span class="mf">30.</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]])</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span> <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span>
                           <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(Phi,R,Z)&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="p">[</span>
            <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># Tor Struct</span>
    <span class="n">pi2</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">Pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span> <span class="n">pi2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">pi2</span><span class="p">,</span> <span class="n">pi2</span><span class="p">,</span> <span class="n">pi2</span><span class="p">],</span>
                    <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>    <span class="mf">2.</span><span class="p">,</span>    <span class="mf">4.</span><span class="p">,</span>    <span class="mf">2.</span><span class="p">,</span>    <span class="mf">2.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">],</span>
                    <span class="p">[</span> <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">0.</span><span class="p">,</span>    <span class="mf">2.</span><span class="p">,</span>   <span class="o">-</span><span class="mf">2.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">]])</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                           <span class="n">ves_lims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]]),</span>
                           <span class="n">nlim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(Phi,R,Z)&#39;</span><span class="p">,</span>
                           <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="p">[</span>
            <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
            <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">])</span>
    <span class="p">)</span></div>


<span class="c1">#####################################################</span>
<span class="c1">#               Ves  - SMesh</span>
<span class="c1">#####################################################</span>
<div class="viewcode-block" id="test09_Ves_Smesh_Tor"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test09_Ves_Smesh_Tor">[docs]</a><span class="k">def</span> <span class="nf">test09_Ves_Smesh_Tor</span><span class="p">(</span><span class="n">VPoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">):</span>

    <span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span>
    <span class="n">VIn</span> <span class="o">=</span> <span class="n">compute_ves_norm</span><span class="p">(</span><span class="n">VPoly</span><span class="p">)</span>
    <span class="n">DIn</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">LDPhi</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">LDPhi</span><span class="p">)):</span>
        <span class="c1"># With Ves</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">NL</span><span class="p">,</span> \
            <span class="n">dLr</span><span class="p">,</span> <span class="n">Rref</span><span class="p">,</span> <span class="n">dRPhir</span><span class="p">,</span>\
            <span class="n">nRPhi0</span><span class="p">,</span> <span class="n">VPbis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Tor_SubFromD_cython</span><span class="p">(</span><span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                                                              <span class="n">DR</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span>
                                                              <span class="n">DZ</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
                                                              <span class="n">DPhi</span><span class="o">=</span><span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                                              <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span> <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                              <span class="n">PhiMinMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                              <span class="n">Out</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                                              <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="mf">2.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">marg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dRPhir</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">VPoly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">marg</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">marg</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">marg</span><span class="p">)</span>
                    <span class="o">|</span> <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">LDPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">marg</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span>
                                       <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                       <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">dS</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],),</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">])</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span> <span class="ow">and</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">NL</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">VPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">assert</span> <span class="n">dLr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dLr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span>
        <span class="k">assert</span> <span class="n">Rref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">dRPhir</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dRPhir</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">Rref</span><span class="o">.</span><span class="n">size</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">nRPhi0</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span>

        <span class="n">Ptsi</span><span class="p">,</span> <span class="n">dSi</span><span class="p">,</span> <span class="n">NLi</span><span class="p">,</span> \
            <span class="n">dLri</span><span class="p">,</span> <span class="n">Rrefi</span><span class="p">,</span> <span class="n">dRPhiri</span><span class="p">,</span> \
            <span class="n">nRPhi0i</span><span class="p">,</span> \
            <span class="n">VPbisi</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Tor_SubFromInd_cython</span><span class="p">(</span><span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span><span class="p">,</span>
                                                         <span class="n">VPoly</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
                                                         <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span> <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                         <span class="n">PhiMinMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                         <span class="n">Out</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                                         <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Ptsi</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dSi</span><span class="p">,</span> <span class="n">dS</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">NLi</span><span class="p">,</span> <span class="n">NL</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dLri</span><span class="p">,</span> <span class="n">dLr</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Rrefi</span><span class="p">,</span><span class="n">Rref</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dRPhiri</span><span class="p">,</span> <span class="n">dRPhir</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nRPhi0i</span> <span class="o">==</span> <span class="n">nRPhi0</span></div>



<div class="viewcode-block" id="test10_Ves_Smesh_Tor_PhiMinMax"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test10_Ves_Smesh_Tor_PhiMinMax">[docs]</a><span class="k">def</span> <span class="nf">test10_Ves_Smesh_Tor_PhiMinMax</span><span class="p">(</span><span class="n">VPoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span>
    <span class="n">VIn</span> <span class="o">=</span> <span class="n">compute_ves_norm</span><span class="p">(</span><span class="n">VPoly</span><span class="p">)</span>
    <span class="n">DIn</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">LPhi</span> <span class="o">=</span> <span class="p">[[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">]]]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">LPhi</span><span class="p">)):</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>\
            <span class="n">NL</span><span class="p">,</span> <span class="n">dLr</span><span class="p">,</span> <span class="n">Rref</span><span class="p">,</span>\
            <span class="n">dRPhir</span><span class="p">,</span> <span class="n">nRPhi0</span><span class="p">,</span>\
            <span class="n">VPbis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Tor_SubFromD_cython</span><span class="p">(</span>
                <span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                <span class="n">DR</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span> <span class="n">DZ</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
                <span class="n">DPhi</span><span class="o">=</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span> <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                <span class="n">PhiMinMax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                <span class="n">Out</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1">#try:</span>
        <span class="k">assert</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">marg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dRPhir</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">VPoly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="p">))</span>
        <span class="k">if</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">marg</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">marg</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">marg</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">marg</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span>
                                       <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">nlim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                       <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">dS</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],),</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)])</span>
        <span class="k">assert</span> <span class="n">NL</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">VPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">assert</span> <span class="n">dLr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dLr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span>
        <span class="k">assert</span> <span class="n">Rref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">dRPhir</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dRPhir</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">Rref</span><span class="o">.</span><span class="n">size</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">nRPhi0</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span>

        <span class="n">lrphi_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Tor_SubFromInd_cython</span><span class="p">(</span><span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span><span class="p">,</span>
                                                  <span class="n">VPoly</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
                                                  <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span>
                                                  <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                  <span class="n">PhiMinMax</span><span class="o">=</span><span class="n">lrphi_arr</span><span class="p">,</span>
                                                  <span class="n">Out</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                                  <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">)</span>
        <span class="n">Ptsi</span><span class="p">,</span> <span class="n">dSi</span><span class="p">,</span> <span class="n">NLi</span><span class="p">,</span> <span class="n">dLri</span><span class="p">,</span> <span class="n">Rrefi</span><span class="p">,</span> <span class="n">dRPhiri</span><span class="p">,</span> <span class="n">nRPhi0i</span><span class="p">,</span> <span class="n">VPbisi</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Ptsi</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dSi</span><span class="p">,</span> <span class="n">dS</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">NLi</span><span class="p">,</span> <span class="n">NL</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dLri</span><span class="p">,</span> <span class="n">dLr</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Rrefi</span><span class="p">,</span><span class="n">Rref</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dRPhiri</span><span class="p">,</span> <span class="n">dRPhir</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nRPhi0i</span> <span class="o">==</span> <span class="n">nRPhi0</span></div>

        <span class="c1"># except:</span>
        <span class="c1"># print([ind.shape == (Pts.shape[1],), ind.dtype == int,</span>
        <span class="c1"># ind.size == np.unique(ind).size, np.all(ind == np.unique(ind)),</span>
        <span class="c1"># np.all(ind&gt;=0)])</span>
        <span class="c1"># print(np.unique(ind).size, ind.size)</span>
        <span class="c1"># lii = [</span>
        <span class="c1"># ind[ii] for ii in range(0,len(ind))</span>
        <span class="c1"># if np.sum(ind == ind[ii])&gt;1</span>
        <span class="c1"># ]</span>
        <span class="c1"># liib = [</span>
        <span class="c1"># ii for ii in range(0,len(ind))</span>
        <span class="c1"># if np.sum(ind == ind[ii])&gt;1</span>
        <span class="c1"># ]</span>
        <span class="c1"># print(len(lii),len(liib))</span>
        <span class="c1"># print(lii)</span>
        <span class="c1"># print(liib)</span>
        <span class="c1"># for ii in range(0,len(liib)):</span>
        <span class="c1"># print([Pts[:,liib[ii]] == Pts[:,hh] for hh in [jj for jj in</span>
        <span class="c1"># range(0,len(ind)) if ind[jj] == lii[ii]]])</span>



<div class="viewcode-block" id="test11_Ves_Smesh_TorStruct"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test11_Ves_Smesh_TorStruct">[docs]</a><span class="k">def</span> <span class="nf">test11_Ves_Smesh_TorStruct</span><span class="p">(</span><span class="n">VPoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">PhiMinMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span><span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">])</span>
    <span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span>
    <span class="n">VIn</span> <span class="o">=</span> <span class="n">compute_ves_norm</span><span class="p">(</span><span class="n">VPoly</span><span class="p">)</span>
    <span class="n">DIn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.001</span>
    <span class="n">LPhi</span> <span class="o">=</span> <span class="p">[[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]],</span>
            <span class="p">[[</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">6.</span><span class="p">]]]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">LPhi</span><span class="p">)):</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">NL</span><span class="p">,</span> \
            <span class="n">dLr</span><span class="p">,</span> <span class="n">Rref</span><span class="p">,</span> \
            <span class="n">dR0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">,</span> \
            <span class="n">dRPhir</span><span class="p">,</span> \
            <span class="n">VPbis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_TorStruct_SubFromD_cython</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                                            <span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                                                            <span class="n">DR</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span>
                                                            <span class="n">DZ</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
                                                            <span class="n">DPhi</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                                            <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span> <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                            <span class="n">Out</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                                            <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">)</span>

        <span class="c1">#try:</span>
        <span class="k">assert</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">marg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dRPhir</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">VPoly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="p">))</span>
        <span class="k">if</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">marg</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">marg</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">marg</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">marg</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">DIn</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span>
                                           <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">nlim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                           <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span>
                                               <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                               <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                               <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">dS</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],),</span>
                       <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)])</span>
        <span class="k">assert</span> <span class="n">NL</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">VPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">assert</span> <span class="n">dLr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dLr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span>
        <span class="k">assert</span> <span class="n">Rref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dR0r</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">dZ0r</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span>
        <span class="k">assert</span> <span class="n">dRPhir</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dRPhir</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">Rref</span><span class="o">.</span><span class="n">size</span>

        <span class="n">Ptsi</span><span class="p">,</span> <span class="n">dSi</span><span class="p">,</span> <span class="n">NLi</span><span class="p">,</span>\
            <span class="n">dLri</span><span class="p">,</span> <span class="n">Rrefi</span><span class="p">,</span>\
            <span class="n">dR0ri</span><span class="p">,</span> <span class="n">dZ0ri</span><span class="p">,</span>\
            <span class="n">dRPhiri</span><span class="p">,</span>\
            <span class="n">VPbisi</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_TorStruct_SubFromInd_cython</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LPhi</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                                               <span class="n">dL</span><span class="p">,</span> <span class="n">dRPhi</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                                                               <span class="n">ind</span><span class="p">,</span>
                                                               <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span> <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                               <span class="n">Out</span><span class="o">=</span><span class="s1">&#39;(R,Z,Phi)&#39;</span><span class="p">,</span>
                                                               <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Ptsi</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dSi</span><span class="p">,</span> <span class="n">dS</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">NLi</span><span class="p">,</span> <span class="n">NL</span><span class="p">)</span>
        <span class="c1"># We know it does not match here (too complicated, not necessary)</span>
        <span class="c1"># assert np.allclose(dLri, dLr)</span>
        <span class="c1"># assert np.allclose(Rrefi,Rref)</span>
        <span class="c1"># assert np.allclose(dRPhiri, dRPhir)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">dR0r</span> <span class="o">==</span> <span class="n">dR0ri</span><span class="p">,</span> <span class="n">dZ0r</span> <span class="o">==</span> <span class="n">dZ0ri</span><span class="p">])</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        except:</span>
<span class="sd">            print([ind.shape == (Pts.shape[1],), ind.dtype == int,</span>
<span class="sd">        ind.size == np.unique(ind).size, np.all(ind == np.unique(ind)),</span>
<span class="sd">        np.all(ind&gt;=0)])</span>
<span class="sd">            print(np.unique(ind).size, ind.size)</span>
<span class="sd">            lii = [ind[ii] for ii in range(0,len(ind))</span>
<span class="sd">        if np.sum(ind == ind[ii])&gt;1]</span>
<span class="sd">            liib = [ii for ii in range(0,len(ind)) if np.sum(ind == ind[ii])&gt;1]</span>
<span class="sd">            print(len(lii),len(liib))</span>
<span class="sd">            print(lii)</span>
<span class="sd">            print(liib)</span>
<span class="sd">            for ii in range(0,len(liib)):</span>
<span class="sd">                print([Pts[:,liib[ii]] == Pts[:,hh]</span>
<span class="sd">        for hh in [jj for jj in range(0,len(ind)) if ind[jj] == lii[ii]]])</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="test12_Ves_Smesh_Lin"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test12_Ves_Smesh_Lin">[docs]</a><span class="k">def</span> <span class="nf">test12_Ves_Smesh_Lin</span><span class="p">(</span><span class="n">VPoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">):</span>

    <span class="n">XMinMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">])</span>
    <span class="n">dL</span><span class="p">,</span> <span class="n">dX</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.05</span>
    <span class="n">VIn</span> <span class="o">=</span> <span class="n">compute_ves_norm</span><span class="p">(</span><span class="n">VPoly</span><span class="p">)</span>
    <span class="n">DIn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.001</span>
    <span class="n">DY</span><span class="p">,</span> <span class="n">DZ</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
    <span class="n">LDX</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">],</span> <span class="p">[</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">11.</span><span class="p">]]</span>

    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">LDX</span><span class="p">)):</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>\
            <span class="n">NL</span><span class="p">,</span> <span class="n">dLr</span><span class="p">,</span> <span class="n">Rref</span><span class="p">,</span> \
            <span class="n">dXr</span><span class="p">,</span> <span class="n">dY0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">,</span> \
            <span class="n">VPbis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Lin_SubFromD_cython</span><span class="p">(</span><span class="n">XMinMax</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                                                      <span class="n">DX</span><span class="o">=</span><span class="n">LDX</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">DY</span><span class="o">=</span><span class="n">DY</span><span class="p">,</span> <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span>
                                                      <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span> <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                      <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">Pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">XMinMax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">XMinMax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="mf">3.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DIn</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">DIn</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                                           <span class="n">vs_lims</span><span class="o">=</span><span class="n">XMinMax</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                                           <span class="n">nlim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Lin&#39;</span><span class="p">,</span>
                                           <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span>
                <span class="n">Pts</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                <span class="n">ves_lims</span><span class="o">=</span><span class="n">XMinMax</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                <span class="n">nlim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Lin&#39;</span><span class="p">,</span>
                <span class="n">in_format</span><span class="o">=</span><span class="s1">&#39;(X,Y,Z)&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">assert</span> <span class="n">dS</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],),</span>
                    <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)])</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">ind</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],)</span> <span class="ow">and</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">int</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">NL</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">VPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">assert</span> <span class="n">dLr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dLr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">NL</span><span class="o">.</span><span class="n">size</span>
        <span class="k">assert</span> <span class="n">Rref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dXr</span><span class="p">,</span> <span class="n">dY0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">]])</span>

        <span class="n">Ptsi</span><span class="p">,</span> <span class="n">dSi</span><span class="p">,</span> <span class="n">NLi</span><span class="p">,</span> \
            <span class="n">dLri</span><span class="p">,</span> <span class="n">Rrefi</span><span class="p">,</span> <span class="n">dXri</span><span class="p">,</span>\
            <span class="n">dY0ri</span><span class="p">,</span> <span class="n">dZ0ri</span><span class="p">,</span> \
            <span class="n">VPbisi</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Lin_SubFromInd_cython</span><span class="p">(</span><span class="n">XMinMax</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span>
                                                         <span class="n">ind</span><span class="p">,</span> <span class="n">DIn</span><span class="o">=</span><span class="n">DIn</span><span class="p">,</span> <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                         <span class="n">margin</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">Ptsi</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dS</span><span class="p">,</span> <span class="n">dSi</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">NL</span><span class="p">,</span> <span class="n">NLi</span><span class="p">)</span>
        <span class="c1"># We know the following are not identical (size), but too complicated</span>
        <span class="c1"># for little gain</span>
        <span class="c1"># assert np.allclose(dLr, dLri)</span>
        <span class="c1"># assert np.allclose(Rref,Rrefi)</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">dXr</span> <span class="o">==</span> <span class="n">dXri</span><span class="p">,</span> <span class="n">dY0r</span> <span class="o">==</span> <span class="n">dY0ri</span><span class="p">,</span> <span class="n">dZ0r</span> <span class="o">==</span> <span class="n">dZ0ri</span><span class="p">])</span></div>



<span class="c1">######################################################</span>
<span class="c1">######################################################</span>
<span class="c1">#               LOS</span>
<span class="c1">######################################################</span>
<span class="c1">######################################################</span>


<div class="viewcode-block" id="test13_LOS_PInOut"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test13_LOS_PInOut">[docs]</a><span class="k">def</span> <span class="nf">test13_LOS_PInOut</span><span class="p">():</span>

    <span class="n">VP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">],[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.</span><span class="p">]])</span>
    <span class="n">VIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]])</span>
    <span class="n">VL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">SP0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">],[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">]])</span>
    <span class="n">SP1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">],[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">]])</span>
    <span class="n">SP2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">],[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">]])</span>
    <span class="n">SP0x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">]</span>
    <span class="n">SP1x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">]</span>
    <span class="n">SP2x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">]</span>
    <span class="n">SP0y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">]</span>
    <span class="n">SP1y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">]</span>
    <span class="n">SP2y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">]</span>
    <span class="n">nstruct_lim</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">nstruct_tot</span> <span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">lstruct_nlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">SL0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
    <span class="n">SL1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]</span>
    <span class="p">])</span>
    <span class="n">SL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
    <span class="n">lspolyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">SP0x</span> <span class="o">+</span> <span class="n">SP1x</span> <span class="o">+</span> <span class="n">SP2x</span><span class="p">)</span>
    <span class="n">lspolyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">SP0y</span> <span class="o">+</span> <span class="n">SP1y</span> <span class="o">+</span> <span class="n">SP2y</span><span class="p">)</span>
    <span class="n">lnvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nstruct_tot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">lsvinx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">VIn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">lsviny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">VIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1"># Linear without Struct</span>
    <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.</span><span class="p">,</span><span class="mf">5.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">9.</span><span class="p">,</span><span class="mf">9.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">5.</span><span class="p">,</span><span class="mf">5.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">9.</span><span class="p">,</span><span class="mf">9.</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                            <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">6.</span><span class="p">)),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Ds</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>
                                                         <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]),</span>
                                      <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
                                      <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">]])),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">],[</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">0.</span><span class="p">]])</span>
    <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">1.</span><span class="p">],[</span><span class="mf">0.</span><span class="p">]])</span>
    <span class="n">ez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">0.</span><span class="p">],[</span><span class="mf">1.</span><span class="p">]])</span>
    <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">ey</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">,</span>
            <span class="n">ey</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">,</span>
            <span class="n">ey</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">,</span>
            <span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">]</span>
    <span class="n">Sols_In</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span>
                                                 <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                                 <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">6.</span><span class="p">)),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">Sols_In</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Sols_In</span><span class="p">,</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span>
                                                           <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]),</span>
                                        <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
                                        <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">]])),</span>
                             <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">]</span>
    <span class="n">Sols_Out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                                  <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">/</span><span class="mf">6.</span><span class="p">)),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">3</span><span class="p">)])</span>
    <span class="n">Sols_Out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Sols_Out</span><span class="p">,</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span>
                                                            <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]),</span>
                                         <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
                                         <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">]])),</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Iin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ndim</span><span class="p">,</span> <span class="n">nlos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Ds</span><span class="p">)</span>
    <span class="n">kPIn</span><span class="p">,</span> <span class="n">kPOut</span><span class="p">,</span>\
        <span class="n">VperpOut</span><span class="p">,</span> <span class="n">IOut</span><span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">VP</span><span class="p">,</span> <span class="n">VIn</span><span class="p">,</span>
                                                     <span class="n">ves_lims</span><span class="o">=</span><span class="n">VL</span><span class="p">,</span>
                                                     <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Lin&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPIn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">N</span><span class="p">,)),</span>
                                            <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,))</span> <span class="p">)),</span>
                       <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPOut</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">kPOut</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">8</span><span class="p">,)),</span>
                                             <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,))))),</span>
                       <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">,</span> <span class="o">-</span><span class="n">us</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">IOut</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Iout</span><span class="p">)</span>

    <span class="c1"># Linear with Struct</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span>
         <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
         <span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span><span class="mf">5.</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span>
         <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span>
         <span class="mf">8.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span>
         <span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span>
         <span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span>
         <span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span>
         <span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span>
         <span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">]</span>
    <span class="n">Sols_Out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
    <span class="n">Iin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                     <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">indS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
                      <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">kPIn</span><span class="p">,</span> <span class="n">kPOut</span><span class="p">,</span> \
        <span class="n">VperpOut</span><span class="p">,</span> \
        <span class="n">IOut</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">VP</span><span class="p">,</span> <span class="n">VIn</span><span class="p">,</span> <span class="n">ves_lims</span><span class="o">=</span><span class="n">VL</span><span class="p">,</span>
                                            <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">nstruct_tot</span><span class="p">,</span>
                                            <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">nstruct_lim</span><span class="p">,</span>
                                            <span class="n">lnvert</span><span class="o">=</span><span class="n">lnvert</span><span class="p">,</span>
                                            <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lspolyx</span><span class="p">,</span>
                                            <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lspolyy</span><span class="p">,</span>
                                            <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">lstruct_nlim</span><span class="p">,</span>
                                            <span class="n">lstruct_lims</span><span class="o">=</span><span class="p">[</span><span class="n">SL0</span><span class="p">,</span><span class="n">SL1</span><span class="p">,</span><span class="n">SL2</span><span class="p">],</span>
                                            <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lsvinx</span><span class="p">,</span>
                                            <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lsviny</span><span class="p">,</span>
                                            <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Lin&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPIn</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">N</span><span class="p">,)),</span>
                                            <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,)))),</span>
                       <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
        <span class="n">kPOut</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span>
            <span class="p">[</span>
                <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="mf">2.</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="p">))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">,</span> <span class="o">-</span><span class="n">us</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">IOut</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Iout</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">IOut</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">indS</span><span class="p">)</span>

    <span class="c1"># Toroidal, without Struct</span>
    <span class="n">Theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="o">/</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">7.</span><span class="o">/</span><span class="mf">4.</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">9.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">])</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">ex</span><span class="p">,</span> <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]])</span>
    <span class="n">ez</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">]])</span>
    <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">Sols_In</span><span class="p">,</span> <span class="n">Sols_Out</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">rsol_In</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]]</span>
    <span class="n">zsol_In</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">]]</span>
    <span class="n">rsol_Out</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]]</span>
    <span class="n">zsol_Out</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Theta</span><span class="p">)):</span>
        <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Theta</span><span class="p">[</span><span class="n">ii</span><span class="p">])],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Theta</span><span class="p">[</span><span class="n">ii</span><span class="p">])],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]])</span>
        <span class="n">Ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">er</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">ez</span><span class="o">*</span><span class="n">z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">er</span><span class="p">,</span> <span class="n">er</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">er</span><span class="p">,</span> <span class="o">-</span><span class="n">er</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">,</span> <span class="o">-</span><span class="n">ez</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Sols_In</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rsol_In</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">er</span> <span class="o">+</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zsol_In</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">ez</span><span class="p">)</span>
        <span class="n">Sols_Out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rsol_Out</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">er</span> <span class="o">+</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zsol_Out</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">ez</span><span class="p">)</span>
    <span class="n">Ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
                        <span class="p">[</span><span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">6.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.5</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">]]))</span>
    <span class="n">us</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">ey</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">,</span> <span class="o">-</span><span class="n">ex</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Ds</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">us</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Sols_In</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Sols_In</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Sols_Out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Sols_Out</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Iin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">ndim</span><span class="p">,</span> <span class="n">nlos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Ds</span><span class="p">)</span>

    <span class="n">kPIn</span><span class="p">,</span> <span class="n">kPOut</span><span class="p">,</span>\
        <span class="n">VperpOut</span><span class="p">,</span> \
        <span class="n">IOut</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">VP</span><span class="p">,</span> <span class="n">VIn</span><span class="p">,</span> <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Reconstructing PIn and Pout from kPIn and kPOut</span>
    <span class="n">PIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">)</span>
    <span class="n">POut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlos</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">PIn</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">Ds</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">kPIn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">*</span> <span class="n">us</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">POut</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">kPOut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">us</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
    <span class="c1"># ...</span>
    <span class="n">ThetaIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">PIn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span>  <span class="n">PIn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:])</span>
    <span class="n">ThetaOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">POut</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span> <span class="n">POut</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:])</span>
    <span class="n">ErIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ThetaIn</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ThetaIn</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,))])</span>
    <span class="n">ErOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ThetaOut</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ThetaOut</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,))])</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPIn</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">N</span><span class="p">,)),</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">kPIn</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">kPIn</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="mf">6.5</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPOut</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="mf">3.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">N</span><span class="p">,)),</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">kPOut</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="mf">6.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">kPOut</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="mf">16.</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">PIn</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">Sols_In</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">ThetaIn</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ThetaIn</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">POut</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">Sols_Out</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">ThetaOut</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ThetaOut</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">PIn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span> <span class="n">PIn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:]),</span> <span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,)))</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">POut</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span> <span class="n">POut</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:]),</span> <span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">8</span><span class="p">,)))</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="o">-</span><span class="n">us</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">])</span>
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">[:,</span> <span class="mi">32</span><span class="p">:],</span> <span class="o">-</span><span class="n">ErOut</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">IOut</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Iout</span><span class="p">)</span>
    <span class="n">npts_vp</span> <span class="o">=</span> <span class="n">VP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_Calc_kMinkMax_VesStruct</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span>
                                         <span class="p">[</span><span class="n">VP</span><span class="p">,</span> <span class="n">VP</span><span class="p">,</span> <span class="n">VP</span><span class="p">],</span> <span class="p">[</span><span class="n">VIn</span><span class="p">,</span> <span class="n">VIn</span><span class="p">,</span> <span class="n">VIn</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">npts_vp</span><span class="p">,</span> <span class="n">npts_vp</span><span class="p">,</span> <span class="n">npts_vp</span><span class="p">])</span>
    <span class="n">kmin_res</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">kmax_res</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kmin_res</span><span class="p">[:</span><span class="n">nlos</span><span class="p">],</span>    <span class="n">kPIn</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kmin_res</span><span class="p">[</span><span class="n">nlos</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nlos</span><span class="p">],</span> <span class="n">kPIn</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kmin_res</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nlos</span><span class="p">:],</span>  <span class="n">kPIn</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kmax_res</span><span class="p">[:</span><span class="n">nlos</span><span class="p">],</span>    <span class="n">kPOut</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kmax_res</span><span class="p">[</span><span class="n">nlos</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nlos</span><span class="p">],</span> <span class="n">kPOut</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kmax_res</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">nlos</span><span class="p">:],</span>  <span class="n">kPOut</span><span class="p">)</span>
    <span class="c1"># Toroidal, with Struct</span>
    <span class="n">SL0_or</span> <span class="o">=</span><span class="kc">None</span>
    <span class="n">SL1_or</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">]]]</span>
    <span class="n">SL2_or</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]</span>

    <span class="n">SL0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>
    <span class="n">SL1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">]]])</span>
    <span class="n">SL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
    <span class="n">lstruct_nlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">nstruct_lim</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">nstruct_tot</span> <span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1">#....</span>
    <span class="n">Sols_In</span><span class="p">,</span> <span class="n">Sols_Out</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">rsol_In</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">]]</span>
    <span class="n">zsol_In</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">],</span>
               <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">]]</span>
    <span class="n">rsol_Out</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">]]</span>
    <span class="n">zsol_Out</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">7.</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">8.</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">8.</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">8.</span><span class="p">,</span><span class="mf">6.5</span><span class="p">,</span><span class="mf">7.5</span><span class="p">,</span><span class="mf">6.</span><span class="p">,</span><span class="mf">7.</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Theta</span><span class="p">)):</span>
        <span class="n">er</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Theta</span><span class="p">[</span><span class="n">ii</span><span class="p">])],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Theta</span><span class="p">[</span><span class="n">ii</span><span class="p">])],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]])</span>
        <span class="n">Sols_In</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rsol_In</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">er</span> <span class="o">+</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zsol_In</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">ez</span><span class="p">)</span>
        <span class="n">Sols_Out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rsol_Out</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">er</span> <span class="o">+</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zsol_Out</span><span class="p">[</span><span class="n">ii</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">ez</span><span class="p">)</span>
    <span class="n">Sols_In</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Sols_In</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Sols_Out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Sols_Out</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kpout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">Iin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">])</span>
    <span class="n">Iout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
        <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
        <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">])</span>
    <span class="n">indS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span>
            <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">]],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">kPIn</span><span class="p">,</span> <span class="n">kPOut</span><span class="p">,</span>\
        <span class="n">VperpOut</span><span class="p">,</span> \
        <span class="n">IOut</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">VP</span><span class="p">,</span> <span class="n">VIn</span><span class="p">,</span> <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">nstruct_tot</span><span class="p">,</span>
                                            <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">nstruct_lim</span><span class="p">,</span>
                                            <span class="n">lnvert</span><span class="o">=</span><span class="n">lnvert</span><span class="p">,</span>
                                            <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lspolyx</span><span class="p">,</span>
                                            <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lspolyy</span><span class="p">,</span>
                                            <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">lstruct_nlim</span><span class="p">,</span>
                                            <span class="n">lstruct_lims</span><span class="o">=</span><span class="p">[</span><span class="n">SL0</span><span class="p">,</span><span class="n">SL1</span><span class="p">,</span><span class="n">SL2</span><span class="p">],</span>
                                            <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lsvinx</span><span class="p">,</span>
                                            <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lsviny</span><span class="p">,</span>
                                            <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPOut</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="n">kpout</span><span class="p">,</span>
                       <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">kPOut</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span><span class="o">&gt;=</span><span class="mf">3.</span><span class="p">)</span> <span class="o">&amp;</span>
                                                  <span class="p">(</span><span class="n">kPOut</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span><span class="o">&lt;</span><span class="mf">16.</span><span class="p">))</span>
    <span class="c1"># Reconstructing PIn and Pout from kPIn and kPOut</span>
    <span class="n">PIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">)</span>
    <span class="n">POut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">)</span>
    <span class="n">ndim</span><span class="p">,</span> <span class="n">nlos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlos</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">PIn</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">Ds</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">kPIn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">*</span> <span class="n">us</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">POut</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">kPOut</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">us</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
    <span class="c1"># ...</span>
    <span class="n">RIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">PIn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span> <span class="n">PIn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:])</span>
    <span class="n">ROut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">POut</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span> <span class="n">POut</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:])</span>
    <span class="n">ThetaIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">PIn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span>  <span class="n">PIn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:])</span>
    <span class="n">ThetaOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">POut</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">:],</span> <span class="n">POut</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">:])</span>
    <span class="n">ErIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ThetaIn</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ThetaIn</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,))])</span>
    <span class="n">ErOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ThetaOut</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ThetaOut</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">8</span><span class="p">,))])</span>
    <span class="n">vperpout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">(</span>
            <span class="n">ErOut</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">ErOut</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">ey</span><span class="p">,</span> <span class="o">-</span><span class="n">ErOut</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span>
            <span class="o">-</span><span class="n">ErOut</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">:</span><span class="mi">5</span><span class="p">],</span> <span class="n">ErOut</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">ex</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPIn</span><span class="p">[:</span><span class="mi">32</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">4</span><span class="o">*</span><span class="n">N</span><span class="p">,)),</span>
                       <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">kPIn</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span>
                                                  <span class="p">(</span><span class="n">kPIn</span><span class="p">[</span><span class="mi">32</span><span class="p">:]</span><span class="o">&lt;</span><span class="mf">6.5</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">PIn</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">Sols_In</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span>
                       <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">ThetaIn</span><span class="o">&gt;-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span> <span class="o">&amp;</span>
                                                  <span class="p">(</span><span class="n">ThetaIn</span><span class="o">&lt;</span><span class="mf">0.</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">POut</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="n">Sols_Out</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span>
                       <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">ThetaOut</span><span class="o">&gt;-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&amp;</span>
                                                  <span class="p">(</span><span class="n">ThetaOut</span><span class="o">&lt;</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">RIn</span><span class="o">&gt;=</span><span class="mf">6.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RIn</span><span class="o">&lt;=</span><span class="mf">8.</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">ROut</span><span class="o">&gt;=</span><span class="mf">6.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ROut</span><span class="o">&lt;=</span><span class="mf">8.</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">],</span> <span class="o">-</span><span class="n">us</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">32</span><span class="p">])</span> <span class="ow">and</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">VperpOut</span><span class="p">[:,</span> <span class="mi">32</span><span class="p">:],</span> <span class="n">vperpout</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">IOut</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">indS</span><span class="p">)</span></div>


<div class="viewcode-block" id="test14_LOS_sino"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test14_LOS_sino">[docs]</a><span class="k">def</span> <span class="nf">test14_LOS_sino</span><span class="p">():</span>

    <span class="n">RZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">10.</span><span class="p">])</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                               <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)])</span>
    <span class="n">Ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,)),</span>
                   <span class="n">RZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                   <span class="n">RZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)])</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">Ms</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">us</span><span class="p">)</span>
    <span class="n">PMin0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
    <span class="n">kPMin0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
    <span class="n">RMin0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
    <span class="n">Theta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
    <span class="n">p0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
    <span class="n">ImpTheta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
    <span class="n">phi0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_sino</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">RZ</span><span class="p">,</span> <span class="n">kOut</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                      <span class="n">Mode</span><span class="o">=</span><span class="s1">&#39;LOS&#39;</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="s1">&#39;Lin&#39;</span><span class="p">)</span>
    <span class="n">PMin0</span><span class="p">,</span> <span class="n">kPMin0</span><span class="p">,</span> <span class="n">RMin0</span><span class="p">,</span> <span class="n">Theta0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">ImpTheta0</span><span class="p">,</span> <span class="n">phi0</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">PMin0</span><span class="p">,</span><span class="n">Ms</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPMin0</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">RMin0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">Theta0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p0</span><span class="p">),</span><span class="n">r</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ImpTheta0</span><span class="p">),</span><span class="n">theta</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phi0</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>

    <span class="c1"># Tor (to be finished)</span>
    <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)])</span>
    <span class="n">Ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">RZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,)),</span>
                   <span class="n">RZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)])</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">Ms</span> <span class="o">-</span> <span class="n">k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">us</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_sino</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">RZ</span><span class="p">,</span> <span class="n">kOut</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                      <span class="n">Mode</span><span class="o">=</span><span class="s1">&#39;LOS&#39;</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">)</span>
    <span class="n">PMin0</span><span class="p">,</span> <span class="n">kPMin0</span><span class="p">,</span> <span class="n">RMin0</span><span class="p">,</span> <span class="n">Theta0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">ImpTheta0</span><span class="p">,</span> <span class="n">phi0</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">PMin0</span><span class="p">,</span><span class="n">Ms</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">kPMin0</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">RMin0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">Theta0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p0</span><span class="p">),</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ImpTheta0</span><span class="p">),</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi0</span><span class="p">),</span> <span class="n">phi</span><span class="p">)</span></div>


<div class="viewcode-block" id="test15_LOS_sino_vec"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test15_LOS_sino_vec">[docs]</a><span class="k">def</span> <span class="nf">test15_LOS_sino_vec</span><span class="p">():</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">RZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,)),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,))])</span>
    <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span>
                   <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,)),</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)])</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_sino</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">RZ</span><span class="p">,</span> <span class="n">kOut</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">N</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                          <span class="n">Mode</span><span class="o">=</span><span class="s1">&#39;LOS&#39;</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="s1">&#39;Lin&#39;</span><span class="p">,</span> <span class="n">try_new_algo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">PMin0</span><span class="p">,</span> <span class="n">kPMin0</span><span class="p">,</span> <span class="n">RMin0</span><span class="p">,</span> <span class="n">Theta0</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">ImpTheta0</span><span class="p">,</span> <span class="n">phi0</span> <span class="o">=</span> <span class="n">res</span>
        <span class="c1"># verifying there is no Nan:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PMin0</span><span class="p">))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kPMin0</span><span class="p">))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">RMin0</span><span class="p">))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Theta0</span><span class="p">))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p0</span><span class="p">))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ImpTheta0</span><span class="p">))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">phi0</span><span class="p">))</span></div>


<div class="viewcode-block" id="test16_dist_los_vpoly"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test16_dist_los_vpoly">[docs]</a><span class="k">def</span> <span class="nf">test16_dist_los_vpoly</span><span class="p">():</span>
    <span class="n">num_rays</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">ves_poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">ves_poly0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">ves_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly0</span><span class="p">)</span>
    <span class="n">ves_poly</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly1</span><span class="p">)</span>
    <span class="c1"># rays :</span>
    <span class="n">ray_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_rays</span><span class="p">))</span>
    <span class="n">ray_vdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_rays</span><span class="p">))</span>
    <span class="c1"># ray 0 :</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 1 :</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 2 :</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># ray 3:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 4:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 5:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.4</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.3</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="c1"># ray 6:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="c1"># ray 7:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="c1"># ray 8:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="c1"># ray 9:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="c1"># ray 10:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_vpoly</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ray_orig</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ray_vdir</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
        <span class="n">ves_poly</span><span class="p">,</span> <span class="n">disc_step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">exact_ks</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span>
                <span class="mf">0.</span><span class="p">,</span>
                <span class="mf">0.</span><span class="p">,</span>
                <span class="mf">0.9999999999999992</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>
                <span class="mf">1.2576248261177692</span><span class="p">,</span>
                <span class="mf">6.0</span><span class="p">,</span>
                <span class="mf">1.0</span><span class="p">,</span>
                <span class="o">-</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">,</span>
                <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">exact_dists</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>
                   <span class="mf">1.0</span><span class="p">,</span>
                   <span class="mf">1.0</span><span class="p">,</span>
                   <span class="mf">1.4142135623730951</span><span class="p">,</span>
                   <span class="mf">2.0</span><span class="p">,</span>
                   <span class="mf">2.448667030011657</span><span class="p">,</span>
                   <span class="mf">2.0</span><span class="p">,</span>
                   <span class="mf">2.0</span><span class="p">,</span>
                   <span class="mf">1.0</span><span class="p">,</span>
                   <span class="mf">0.5</span><span class="p">,</span>
                   <span class="mf">0.5</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exact_ks</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exact_dists</span><span class="p">)</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                           DISTANCE CIRCLE - LOS</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>

<div class="viewcode-block" id="test17_distance_los_to_circle"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test17_distance_los_to_circle">[docs]</a><span class="k">def</span> <span class="nf">test17_distance_los_to_circle</span><span class="p">():</span>
    <span class="c1"># == One Line One Circle ===================================================</span>
    <span class="c1"># -- simplest circle -------------------------------------------------------</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">circ_z</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># Horizontal ray with no intersection with circle ..........................</span>
    <span class="n">ray_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray_vd</span><span class="p">,</span> <span class="n">ray_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">2.5</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.5</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span>
    <span class="c1"># Horizontal ray tagential to circle at origin..............................</span>
    <span class="n">ray_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray_vd</span><span class="p">,</span> <span class="n">ray_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span>
    <span class="c1"># Diagonal ray with one intersection........................................</span>
    <span class="n">ray_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray_vd</span><span class="p">,</span> <span class="n">ray_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="n">k_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k_ex</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span>
    <span class="c1"># Diagonal ray with no intersction with circle .............................</span>
    <span class="n">ray_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray_vd</span><span class="p">,</span> <span class="n">ray_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="n">dist_ex</span> <span class="o">=</span> <span class="mf">1.1213203435596426</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dist_ex</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span>
    <span class="c1"># -- Changing plane circle and radius  -------------------------------------</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">2.</span>
    <span class="n">circ_z</span> <span class="o">=</span> <span class="mf">3.</span>
    <span class="c1"># Vertical ray with no intersection with circle ............................</span>
    <span class="n">ray_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.8</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])</span>
    <span class="n">ray_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray_vd</span><span class="p">,</span> <span class="n">ray_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.3</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.8</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span>
    <span class="c1"># Normal ray passing on bottom of circle center ............................</span>
    <span class="n">ray_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.</span><span class="p">])</span>
    <span class="n">ray_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray_vd</span><span class="p">,</span> <span class="n">ray_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">6.324555320336759</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span>
    <span class="c1"># Normal ray passing through circle center .................................</span>
    <span class="n">ray_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">ray_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray_vd</span><span class="p">,</span> <span class="n">ray_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">3.</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">2.</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span>
    <span class="c1"># Random ray (not normal, not passing through origin, ...) .................</span>
    <span class="n">ray3_or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.1</span><span class="p">])</span>
    <span class="n">ray3_vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">circ_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.1</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle</span><span class="p">(</span><span class="n">ray3_vd</span><span class="p">,</span> <span class="n">ray3_or</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">)</span>
    <span class="c1"># computed using scipy</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.280758570860685</span><span class="p">),</span> \
       <span class="s2">&quot;Problem with &#39;k&#39; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.331367971970488</span><span class="p">),</span> \
       <span class="s2">&quot;Problem with &#39;dist&#39; = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># == Vectorial tests =======================================================</span>
    <span class="n">circle_radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">])</span>
    <span class="n">circle_zcoord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
    <span class="n">ray1_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">])</span>
    <span class="n">ray1_direct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
    <span class="n">ray2_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">7.</span><span class="p">])</span>
    <span class="n">ray2_direct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">rays_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ray1_origin</span><span class="p">,</span> <span class="n">ray2_origin</span><span class="p">])</span>
    <span class="n">rays_direct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ray1_direct</span><span class="p">,</span> <span class="n">ray2_direct</span><span class="p">])</span>
    <span class="n">nlos</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">ncir</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_circle_vec</span><span class="p">(</span><span class="n">nlos</span><span class="p">,</span> <span class="n">ncir</span><span class="p">,</span>
                                      <span class="n">rays_direct</span><span class="p">,</span>
                                      <span class="n">rays_origin</span><span class="p">,</span>
                                      <span class="n">circle_radius</span><span class="p">,</span>
                                      <span class="n">circle_zcoord</span><span class="p">)</span>
    <span class="n">k_exact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">8.</span> <span class="p">],</span>
                        <span class="p">[</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.</span> <span class="p">,</span> <span class="mf">0.5</span><span class="p">]])</span>
    <span class="n">d_exact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.</span> <span class="p">,</span> <span class="mf">3.5</span><span class="p">],</span>
                        <span class="p">[</span><span class="mf">8.1</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">1.</span> <span class="p">]])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k_exact</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;k&#39;&quot;</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d_exact</span><span class="p">),</span> <span class="s2">&quot;Problem with &#39;dist&#39;&quot;</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                       TEST CLOSENESS CIRCLE - LOS</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="test17_is_los_close_to_circle"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test17_is_los_close_to_circle">[docs]</a><span class="k">def</span> <span class="nf">test17_is_los_close_to_circle</span><span class="p">():</span>
    <span class="n">sqrt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
    <span class="c1">#...</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">circ_z</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># A &quot;yes&quot; case with a tangential ray .......................................</span>
    <span class="n">ray_or1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sqrt2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">is_close_los_circle</span><span class="p">(</span><span class="n">ray_vd1</span><span class="p">,</span> <span class="n">ray_or1</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="s2">&quot;res = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="c1"># A &quot;yes&quot; case with a non tangential ray ...................................</span>
    <span class="n">ray_or2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sqrt2</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">is_close_los_circle</span><span class="p">(</span><span class="n">ray_vd2</span><span class="p">,</span> <span class="n">ray_or2</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># A &quot;yes&quot; case with a intersection..........................................</span>
    <span class="n">ray_or3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sqrt2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">is_close_los_circle</span><span class="p">(</span><span class="n">ray_vd3</span><span class="p">,</span> <span class="n">ray_or3</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="c1"># A &quot;no&quot; case with no intersection..........................................</span>
    <span class="n">ray_or4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sqrt2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">is_close_los_circle</span><span class="p">(</span><span class="n">ray_vd4</span><span class="p">,</span> <span class="n">ray_or4</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">circ_z</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="c1"># == Vectorial case ========================================================</span>
    <span class="c1"># Similar cases but symetric or negative</span>
    <span class="c1"># A &quot;yes&quot; case with a tangential ray .......................................</span>
    <span class="n">ray_or1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sqrt2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="c1"># A &quot;yes&quot; case with a non tangential ray ...................................</span>
    <span class="n">ray_or2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sqrt2</span><span class="o">+</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="c1"># A &quot;yes&quot; case with a intersection..........................................</span>
    <span class="n">ray_or3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sqrt2</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="c1"># A &quot;no&quot; case with no intersection..........................................</span>
    <span class="n">ray_or4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sqrt2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">ray_vd4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
    <span class="c1">#Computing result..........................................................</span>
    <span class="n">nlos</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">ncircles</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">los_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ray_vd1</span><span class="p">,</span> <span class="n">ray_vd2</span><span class="p">,</span> <span class="n">ray_vd3</span><span class="p">,</span> <span class="n">ray_vd4</span><span class="p">])</span>
    <span class="n">los_oris</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ray_or1</span><span class="p">,</span> <span class="n">ray_or2</span><span class="p">,</span> <span class="n">ray_or3</span><span class="p">,</span> <span class="n">ray_or4</span><span class="p">])</span>
    <span class="n">circle_radius</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">radius</span><span class="p">])</span>
    <span class="n">circle_zcoord</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">circ_z</span><span class="p">])</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">is_close_los_circle_vec</span><span class="p">(</span><span class="n">nlos</span><span class="p">,</span> <span class="n">ncircles</span><span class="p">,</span>
                                     <span class="mf">0.005</span><span class="p">,</span>
                                     <span class="n">los_dirs</span><span class="p">,</span> <span class="n">los_oris</span><span class="p">,</span>
                                     <span class="n">circle_radius</span><span class="p">,</span>
                                     <span class="n">circle_zcoord</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">assert</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span></div>

<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                       DISTANCE BETWEEN LOS AND EXT-POLY</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="test18_comp_dist_los_vpoly"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test18_comp_dist_los_vpoly">[docs]</a><span class="k">def</span> <span class="nf">test18_comp_dist_los_vpoly</span><span class="p">():</span>
    <span class="c1"># !!!!!! ARTIFICIAL TEST CASE SINCE THIS IS ONLY A SIMPLIFIED VERSION !!!!!!</span>
    <span class="n">num_rays</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">ves_poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">ves_poly0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">ves_poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly0</span><span class="p">)</span>
    <span class="n">ves_poly</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly1</span><span class="p">)</span>
    <span class="c1"># rays :</span>
    <span class="n">ray_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_rays</span><span class="p">))</span>
    <span class="n">ray_vdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_rays</span><span class="p">))</span>
    <span class="c1"># ray 0 :</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 1 :</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 2 :</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c1"># ray 3:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 4:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1"># ray 5:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.4</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.3</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># ray 6:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="c1"># ray 7:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="c1"># ray 8:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="c1"># ray 9:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="c1"># ray 10:</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="c1"># .. computing .............................................................</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_vpoly</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ray_orig</span><span class="p">),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">ray_vdir</span><span class="p">),</span>
                                 <span class="n">ves_poly</span><span class="p">,</span> <span class="n">disc_step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">k_vec</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span>
             <span class="mf">0.0</span><span class="p">,</span>
             <span class="mf">0.0</span><span class="p">,</span>
             <span class="mf">1.0</span><span class="p">,</span>
             <span class="mf">0.0</span><span class="p">,</span>
             <span class="mf">1.3</span><span class="p">,</span>
             <span class="mf">6.0</span><span class="p">,</span>
             <span class="mf">1.0</span><span class="p">,</span>
             <span class="mf">0.0</span><span class="p">,</span>
             <span class="mf">0.0</span><span class="p">,</span>
             <span class="mf">0.0</span><span class="p">]</span>
    <span class="n">dist_vec</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="mf">1.0</span><span class="p">,</span>
                <span class="mf">1.0</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
                <span class="mf">2.0</span><span class="p">,</span>
                <span class="mf">1.0</span><span class="p">,</span>
                <span class="mf">2.0</span><span class="p">,</span>
                <span class="mf">2.0</span><span class="p">,</span>
                <span class="mf">1.0</span><span class="p">,</span>
                <span class="mf">0.5</span><span class="p">,</span>
                <span class="mf">0.5</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">k_vec</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dist_vec</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="test19_comp_dist_los_vpoly_vec"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test19_comp_dist_los_vpoly_vec">[docs]</a><span class="k">def</span> <span class="nf">test19_comp_dist_los_vpoly_vec</span><span class="p">():</span>
    <span class="c1"># !!!!!! ARTIFICIAL TEST CASE SINCE THIS IS ONLY A SIMPLIFIED VERSION !!!!!!</span>
    <span class="c1"># ves 0</span>
    <span class="n">ves_poly0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly00</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly00</span><span class="p">)</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly01</span><span class="p">)</span>
    <span class="c1"># ves 1</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly10</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly11</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly10</span><span class="p">)</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly11</span><span class="p">)</span>
    <span class="n">vessels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ves_poly0</span><span class="p">,</span> <span class="n">ves_poly1</span><span class="p">])</span>
    <span class="c1"># Tab for rays</span>
    <span class="n">num_rays</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ray_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ray_vdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># ray 0 : First ray intersects all</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 1 : intersects outer circle but not inner</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 2 : above all polys</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.5</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">7.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="c1"># .. computing .............................................................</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">comp_dist_los_vpoly_vec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="n">num_rays</span><span class="p">,</span>
                                     <span class="n">ray_orig</span><span class="p">,</span>
                                     <span class="n">ray_vdir</span><span class="p">,</span>
                                     <span class="n">vessels</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                         ARE LOS AND EXT-POLY CLOSE</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="test20_is_close_los_vpoly_vec"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test20_is_close_los_vpoly_vec">[docs]</a><span class="k">def</span> <span class="nf">test20_is_close_los_vpoly_vec</span><span class="p">():</span>
    <span class="c1"># !!!!!! ARTIFICIAL TEST CASE SINCE THIS IS ONLY A SIMPLIFIED VERSION !!!!!!</span>
    <span class="c1"># ves 0</span>
    <span class="n">ves_poly0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly00</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly00</span><span class="p">)</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly01</span><span class="p">)</span>
    <span class="c1"># ves 1</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly10</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly11</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly10</span><span class="p">)</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly11</span><span class="p">)</span>
    <span class="n">vessels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ves_poly0</span><span class="p">,</span> <span class="n">ves_poly1</span><span class="p">])</span>
    <span class="c1"># Tab for rays</span>
    <span class="n">num_rays</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ray_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ray_vdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># ray 0 : First ray intersects first</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.01</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.01</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 1 : close to second one</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.01</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.01</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 2 : close to none</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># .. computing .............................................................</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">is_close_los_vpoly_vec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="n">num_rays</span><span class="p">,</span>
                                    <span class="n">ray_orig</span><span class="p">,</span> <span class="n">ray_vdir</span><span class="p">,</span>
                                    <span class="n">vessels</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">],[</span><span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">],</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]])</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                         ARE LOS AND EXT-POLY CLOSE</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>
<span class="k">def</span> <span class="nf">test21_which_los_closer_vpoly_vec</span><span class="p">():</span>
    <span class="c1"># !!!!!! ARTIFICIAL TEST CASE SINCE THIS IS ONLY A SIMPLIFIED VERSION !!!!!!</span>
    <span class="c1"># ves 0</span>
    <span class="n">ves_poly0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly00</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly00</span><span class="p">)</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly01</span><span class="p">)</span>
    <span class="c1"># ves 1</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly10</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly11</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly10</span><span class="p">)</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly11</span><span class="p">)</span>
    <span class="n">vessels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ves_poly0</span><span class="p">,</span> <span class="n">ves_poly1</span><span class="p">])</span>
    <span class="c1"># Tab for rays</span>
    <span class="n">num_rays</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ray_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ray_vdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># ray 0 : First ray intersects first</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.01</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.01</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 1 : close to second one</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.01</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.01</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 2 : close to none</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># .. computing .............................................................</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">which_los_closer_vpoly_vec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="n">num_rays</span><span class="p">,</span>
                                        <span class="n">ray_orig</span><span class="p">,</span> <span class="n">ray_vdir</span><span class="p">,</span>
                                        <span class="n">vessels</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>


<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                         ARE LOS AND EXT-POLY CLOSE</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="test21_which_los_closer_vpoly_vec"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test21_which_los_closer_vpoly_vec">[docs]</a><span class="k">def</span> <span class="nf">test21_which_los_closer_vpoly_vec</span><span class="p">():</span>
    <span class="c1"># !!!!!! ARTIFICIAL TEST CASE SINCE THIS IS ONLY A SIMPLIFIED VERSION !!!!!!</span>
    <span class="c1"># ves 0</span>
    <span class="n">ves_poly0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly00</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly00</span><span class="p">)</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly01</span><span class="p">)</span>
    <span class="c1"># ves 1</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ves_poly10</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly11</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly10</span><span class="p">)</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly11</span><span class="p">)</span>
    <span class="n">vessels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">ves_poly0</span><span class="p">,</span> <span class="n">ves_poly1</span><span class="p">])</span>
    <span class="c1"># Tab for rays</span>
    <span class="n">num_rays</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">ray_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ray_vdir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_rays</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="c1"># ray 0 : First ray intersects first</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.01</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.01</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 1 : close to second one</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.01</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">6.01</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># ray 2 : close to none</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="n">ray_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="n">ray_vdir</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="c1"># .. computing .............................................................</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">which_vpoly_closer_los_vec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="n">num_rays</span><span class="p">,</span>
                                        <span class="n">ray_orig</span><span class="p">,</span> <span class="n">ray_vdir</span><span class="p">,</span>
                                        <span class="n">vessels</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>

<span class="c1"># ==============================================================================</span>
<span class="c1">#</span>
<span class="c1">#                              VIGNETTING</span>
<span class="c1">#</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="test22_earclipping"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test22_earclipping">[docs]</a><span class="k">def</span> <span class="nf">test22_earclipping</span><span class="p">():</span>
    <span class="c1"># .. First test ............................................................</span>
    <span class="n">ves_poly0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ves_poly00</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">ves_poly01</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly00</span><span class="p">)</span>
    <span class="n">ves_poly0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ves_poly01</span><span class="p">)</span>
    <span class="c1"># ...computing</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">triangulate_by_earclipping</span><span class="p">(</span><span class="n">ves_poly0</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="c1"># .. Second test ...........................................................</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y1</span>
    <span class="c1"># ...computing</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">triangulate_by_earclipping</span><span class="p">(</span><span class="n">ves_poly1</span><span class="p">)</span>
    <span class="c1"># out = out.reshape((7, 3))</span>
    <span class="c1"># print(out)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
    <span class="c1"># .. Third test ............................................................</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">if</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="mf">5.</span> <span class="k">else</span> <span class="mf">1.</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x2</span><span class="p">])</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">ves_poly2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">npts</span><span class="p">))</span>
    <span class="n">ves_poly2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2</span>
    <span class="n">ves_poly2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y2</span>
    <span class="n">ves_poly2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2</span>
    <span class="c1"># ...computing</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">triangulate_by_earclipping</span><span class="p">(</span><span class="n">ves_poly2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span></div>
    <span class="c1"># out = out.reshape((npts-2, 3))</span>
    <span class="c1"># print(out)</span>

<div class="viewcode-block" id="test23_vignetting"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test23_vignetting">[docs]</a><span class="k">def</span> <span class="nf">test23_vignetting</span><span class="p">():</span>
   <span class="c1"># .. First configuration ....................................................</span>
    <span class="n">ves_poly1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>
    <span class="n">ves_poly1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y1</span>
    <span class="c1"># .. Second configuration ..................................................</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span> <span class="k">if</span> <span class="n">xi</span> <span class="o">&lt;</span> <span class="mf">5.</span> <span class="k">else</span> <span class="mf">1.</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x2</span><span class="p">])</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">ves_poly2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">npts</span><span class="p">))</span>
    <span class="n">ves_poly2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2</span>
    <span class="n">ves_poly2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y2</span>
    <span class="n">ves_poly2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z2</span>
    <span class="c1">#  === Creating configurations tabs ===</span>
    <span class="n">vignetts</span> <span class="o">=</span> <span class="p">[</span><span class="n">ves_poly1</span><span class="p">,</span> <span class="n">ves_poly2</span><span class="p">]</span>
    <span class="n">lnvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="n">npts</span><span class="p">]</span>
    <span class="c1"># === Ray tabs ====</span>
    <span class="n">rays_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">rays_direct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="c1"># -- First ray</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">3.75</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dire</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]</span>
    <span class="n">rays_origin</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span>
    <span class="n">rays_direct</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dire</span>
    <span class="c1"># -- Second ray</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">dire</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]</span>
    <span class="n">rays_origin</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span>
    <span class="n">rays_direct</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dire</span>
    <span class="c1"># -- Third ray</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="n">dire</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">rays_origin</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span>
    <span class="n">rays_direct</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dire</span>
    <span class="c1"># ==== 3D TESTS ====</span>
    <span class="n">orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fina</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">6.1</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">dire</span> <span class="o">=</span> <span class="n">fina</span> <span class="o">-</span> <span class="n">orig</span>
    <span class="n">rays_origin</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig</span>
    <span class="n">rays_direct</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dire</span>
    <span class="c1"># Another ray</span>
    <span class="n">orig2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">fina2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">dire2</span> <span class="o">=</span> <span class="n">fina2</span> <span class="o">-</span> <span class="n">orig2</span>
    <span class="n">rays_origin</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig2</span>
    <span class="n">rays_direct</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dire2</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">vignetting</span><span class="p">(</span><span class="n">rays_origin</span><span class="p">,</span> <span class="n">rays_direct</span><span class="p">,</span>
                        <span class="n">vignetts</span><span class="p">,</span> <span class="n">lnvert</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>  <span class="kc">True</span><span class="p">,</span>
                             <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span></div>


<div class="viewcode-block" id="test24_is_visible"><a class="viewcode-back" href="../../../../tofu.tests.tests01_geom.html#tofu.tests.tests01_geom.test_01_GG.test24_is_visible">[docs]</a><span class="k">def</span> <span class="nf">test24_is_visible</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="kn">import</span> <span class="nn">tofu.geom</span> <span class="k">as</span> <span class="nn">tfg</span>

    <span class="c1"># -- Vessel creation ------------------------------------------------------</span>
    <span class="n">VP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">],</span> <span class="p">[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]])</span>
    <span class="n">VIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]])</span>
    <span class="c1"># -- Structures -----------------------------------------------------------</span>
    <span class="n">SP0x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]</span>
    <span class="n">SP0y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]</span>
    <span class="n">SP1x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">]</span>
    <span class="n">SP1y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">]</span>
    <span class="n">SP2x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.75</span><span class="p">,</span> <span class="mf">7.25</span><span class="p">,</span> <span class="mf">7.25</span><span class="p">,</span> <span class="mf">6.75</span><span class="p">,</span> <span class="mf">6.75</span><span class="p">]</span>
    <span class="n">SP2y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.75</span><span class="p">,</span> <span class="mf">6.75</span><span class="p">,</span> <span class="mf">7.25</span><span class="p">,</span> <span class="mf">7.25</span><span class="p">,</span> <span class="mf">6.75</span><span class="p">]</span>
    <span class="n">nstruct_lim</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">nstruct_tot</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># structs: limitless, 2 limits, 1 limit</span>
    <span class="n">lspolyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">SP0x</span> <span class="o">+</span> <span class="n">SP1x</span> <span class="o">+</span> <span class="n">SP2x</span><span class="p">)</span>
    <span class="n">lspolyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">SP0y</span> <span class="o">+</span> <span class="n">SP1y</span> <span class="o">+</span> <span class="n">SP2y</span><span class="p">)</span>
    <span class="n">lnvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nstruct_tot</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">lsvinx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">VIn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">lsviny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">VIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">VIn</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="c1"># ...</span>
    <span class="c1"># Structures limits</span>
    <span class="n">SL0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="kc">None</span><span class="p">])</span>
    <span class="n">SL1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">]]])</span>
    <span class="n">SL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">])</span>
    <span class="n">lstruct_nlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># -- Points ---------------------------------------------------------------</span>
    <span class="c1"># First point (in the center of poloidal plane</span>
    <span class="n">pt0</span> <span class="o">=</span> <span class="mf">8.</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="mf">6.</span>
    <span class="c1"># Other points (to check if visible or not)</span>
    <span class="c1"># first test point: same point (should be visible), in torus, out torus</span>
    <span class="n">other_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">other_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">other_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other_x</span><span class="p">)</span>
    <span class="n">others</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">npts</span><span class="p">))</span>
    <span class="n">others</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">other_x</span>
    <span class="n">others</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">other_y</span>
    <span class="n">others</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">other_z</span>
    <span class="n">point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">pt0</span><span class="p">,</span> <span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">]</span>
    <span class="n">is_vis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_isVis_PtFromPts_VesStruct</span><span class="p">(</span><span class="n">pt0</span><span class="p">,</span> <span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span>
                                              <span class="n">others</span><span class="p">,</span>
                                              <span class="n">ves_poly</span><span class="o">=</span><span class="n">VP</span><span class="p">,</span>
                                              <span class="n">ves_norm</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                              <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">nstruct_tot</span><span class="p">,</span>
                                              <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">nstruct_lim</span><span class="p">,</span>
                                              <span class="n">lnvert</span><span class="o">=</span><span class="n">lnvert</span><span class="p">,</span>
                                              <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lspolyx</span><span class="p">,</span>
                                              <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lspolyy</span><span class="p">,</span>
                                              <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">lstruct_nlim</span><span class="p">,</span>
                                              <span class="n">lstruct_lims</span><span class="o">=</span><span class="p">[</span><span class="n">SL0</span><span class="p">,</span> <span class="n">SL1</span><span class="p">,</span> <span class="n">SL2</span><span class="p">],</span>
                                              <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lsvinx</span><span class="p">,</span>
                                              <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lsviny</span><span class="p">,</span>
                                              <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">is_vis</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">others</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">point</span><span class="p">,</span>
                                                <span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">is_vis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_isVis_PtFromPts_VesStruct</span><span class="p">(</span><span class="n">pt0</span><span class="p">,</span> <span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span>
                                              <span class="n">others</span><span class="p">,</span>
                                              <span class="n">dist</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                              <span class="n">ves_poly</span><span class="o">=</span><span class="n">VP</span><span class="p">,</span>
                                              <span class="n">ves_norm</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                              <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">nstruct_tot</span><span class="p">,</span>
                                              <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">nstruct_lim</span><span class="p">,</span>
                                              <span class="n">lnvert</span><span class="o">=</span><span class="n">lnvert</span><span class="p">,</span>
                                              <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lspolyx</span><span class="p">,</span>
                                              <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lspolyy</span><span class="p">,</span>
                                              <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">lstruct_nlim</span><span class="p">,</span>
                                              <span class="n">lstruct_lims</span><span class="o">=</span><span class="p">[</span><span class="n">SL0</span><span class="p">,</span> <span class="n">SL1</span><span class="p">,</span> <span class="n">SL2</span><span class="p">],</span>
                                              <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lsvinx</span><span class="p">,</span>
                                              <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lsviny</span><span class="p">,</span>
                                              <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">is_vis</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Visualisation:</span>
        <span class="n">ves</span> <span class="o">=</span> <span class="n">tfg</span><span class="o">.</span><span class="n">Ves</span><span class="p">(</span>
            <span class="n">Name</span><span class="o">=</span><span class="s2">&quot;DebugVessel&quot;</span><span class="p">,</span>
            <span class="n">Poly</span><span class="o">=</span><span class="n">VP</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">,</span>
            <span class="n">Exp</span><span class="o">=</span><span class="s2">&quot;Misc&quot;</span><span class="p">,</span>
            <span class="n">shot</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">tfg</span><span class="o">.</span><span class="n">PFC</span><span class="p">(</span><span class="n">Name</span><span class="o">=</span><span class="s2">&quot;S1&quot;</span><span class="p">,</span>
                     <span class="n">Poly</span><span class="o">=</span><span class="p">[</span><span class="n">SP0x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">SP0y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                     <span class="n">Exp</span><span class="o">=</span><span class="s2">&quot;Misc&quot;</span><span class="p">,</span>
                     <span class="n">shot</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">tfg</span><span class="o">.</span><span class="n">PFC</span><span class="p">(</span><span class="n">Name</span><span class="o">=</span><span class="s2">&quot;S2&quot;</span><span class="p">,</span>
                     <span class="n">Poly</span><span class="o">=</span><span class="p">[</span><span class="n">SP1x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">SP1y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                     <span class="n">Exp</span><span class="o">=</span><span class="s2">&quot;Misc&quot;</span><span class="p">,</span>
                     <span class="n">shot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">Lim</span><span class="o">=</span><span class="n">SL1</span><span class="p">)</span>
        <span class="n">s3</span> <span class="o">=</span> <span class="n">tfg</span><span class="o">.</span><span class="n">PFC</span><span class="p">(</span><span class="n">Name</span><span class="o">=</span><span class="s2">&quot;S3&quot;</span><span class="p">,</span>
                     <span class="n">Poly</span><span class="o">=</span><span class="p">[</span><span class="n">SP2x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">SP2y</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                     <span class="n">Exp</span><span class="o">=</span><span class="s2">&quot;Misc&quot;</span><span class="p">,</span>
                     <span class="n">shot</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">Lim</span><span class="o">=</span><span class="n">SL2</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">tfg</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="n">Name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
                            <span class="n">Exp</span><span class="o">=</span><span class="s2">&quot;Misc&quot;</span><span class="p">,</span>
                            <span class="n">lStruct</span><span class="o">=</span><span class="p">[</span><span class="n">ves</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">s3</span><span class="p">])</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_colors_random</span><span class="p">()</span>  <span class="c1"># to see different colors</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;cross&#39;</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">proj</span><span class="o">=</span><span class="s1">&#39;hor&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">others</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">others</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
                         <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">others</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">others</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                        <span class="n">others</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
            <span class="c1"># plotting rays for better viz</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">others</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]],</span>
                         <span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">others</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]])</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">others</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">others</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)],</span>
                        <span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">others</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ii</span><span class="p">]])</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pointt&quot;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">point</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pointt&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;test1&quot;</span><span class="p">)</span>

    <span class="n">pt_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>
    <span class="n">pt_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">7.4</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>
    <span class="n">pt_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">]</span>
    <span class="n">npts2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pt_x</span><span class="p">)</span>
    <span class="n">pts2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">npts2</span><span class="p">))</span>
    <span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pt_x</span>
    <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pt_y</span>
    <span class="n">pts2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">pt_z</span>
    <span class="n">others</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">others</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pts2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">others</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">pts2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pts2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">others</span><span class="p">)</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bo&quot;</span><span class="p">,</span> <span class="s2">&quot;b*&quot;</span><span class="p">,</span> <span class="s2">&quot;b^&quot;</span><span class="p">,</span> <span class="s2">&quot;bs&quot;</span><span class="p">,</span> <span class="s2">&quot;bp&quot;</span><span class="p">,</span> <span class="s2">&quot;bv&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts2</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
                         <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
                        <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ro&quot;</span><span class="p">,</span> <span class="s2">&quot;r*&quot;</span><span class="p">,</span> <span class="s2">&quot;r^&quot;</span><span class="p">,</span> <span class="s2">&quot;rs&quot;</span><span class="p">,</span> <span class="s2">&quot;rp&quot;</span><span class="p">,</span> <span class="s2">&quot;rv&quot;</span><span class="p">]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;test2&quot;</span><span class="p">)</span>

    <span class="n">are_vis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_areVis_PtsFromPts_VesStruct</span><span class="p">(</span><span class="n">pts2</span><span class="p">,</span>
                                                 <span class="n">others</span><span class="p">,</span>
                                                 <span class="n">ves_poly</span><span class="o">=</span><span class="n">VP</span><span class="p">,</span>
                                                 <span class="n">ves_norm</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                 <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">nstruct_tot</span><span class="p">,</span>
                                                 <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">nstruct_lim</span><span class="p">,</span>
                                                 <span class="n">lnvert</span><span class="o">=</span><span class="n">lnvert</span><span class="p">,</span>
                                                 <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lspolyx</span><span class="p">,</span>
                                                 <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lspolyy</span><span class="p">,</span>
                                                 <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">lstruct_nlim</span><span class="p">,</span>
                                                 <span class="n">lstruct_lims</span><span class="o">=</span><span class="p">[</span><span class="n">SL0</span><span class="p">,</span> <span class="n">SL1</span><span class="p">,</span> <span class="n">SL2</span><span class="p">],</span>
                                                 <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lsvinx</span><span class="p">,</span>
                                                 <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lsviny</span><span class="p">,</span>
                                                 <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">are_vis</span><span class="p">,</span> <span class="p">[[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">are_vis</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">npts2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npts2</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts2</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">xdiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">others</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">ydiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">others</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">zdiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">others</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xdiff</span> <span class="o">+</span> <span class="n">ydiff</span> <span class="o">+</span> <span class="n">zdiff</span><span class="p">)</span>

    <span class="n">are_vis</span> <span class="o">=</span> <span class="n">GG</span><span class="o">.</span><span class="n">LOS_areVis_PtsFromPts_VesStruct</span><span class="p">(</span><span class="n">pts2</span><span class="p">,</span>
                                                 <span class="n">others</span><span class="p">,</span>
                                                 <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                                                 <span class="n">ves_poly</span><span class="o">=</span><span class="n">VP</span><span class="p">,</span>
                                                 <span class="n">ves_norm</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                                                 <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">nstruct_tot</span><span class="p">,</span>
                                                 <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">nstruct_lim</span><span class="p">,</span>
                                                 <span class="n">lnvert</span><span class="o">=</span><span class="n">lnvert</span><span class="p">,</span>
                                                 <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lspolyx</span><span class="p">,</span>
                                                 <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lspolyy</span><span class="p">,</span>
                                                 <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">lstruct_nlim</span><span class="p">,</span>
                                                 <span class="n">lstruct_lims</span><span class="o">=</span><span class="p">[</span><span class="n">SL0</span><span class="p">,</span> <span class="n">SL1</span><span class="p">,</span> <span class="n">SL2</span><span class="p">],</span>
                                                 <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lsvinx</span><span class="p">,</span>
                                                 <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lsviny</span><span class="p">,</span>
                                              <span class="n">ves_type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">are_vis</span><span class="p">,</span> <span class="p">[[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                                 <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]])</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">are_vis</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">npts2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pts2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">others</span><span class="p">)</span>
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npts2</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
                         <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
                        <span class="n">markers</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ms</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">))</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
                     <span class="p">[</span><span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pts2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)],</span>
                    <span class="p">[</span><span class="n">pts2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pts2</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;test3&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">are_vis</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">are_vis</span><span class="p">))</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on Nov 15, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>