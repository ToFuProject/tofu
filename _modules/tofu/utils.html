<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.utils &#8212; Tofu 1.4.15</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.15</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../installation.html">Installation</a></li>
                <li><a href="../../contributing.html">Contributing</a></li>
                <li><a href="../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../aboutus.html">About</a></li>
                <li><a href="../../releases.html">Releases</a></li>
                <li><a href="../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.utils</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># Built-in</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">itt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="c1"># Common</span>
<span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">scpio</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="kn">import</span> <span class="n">Triangulation</span> <span class="k">as</span> <span class="n">mplTri</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="c1"># tofu-specific</span>
<span class="kn">from</span> <span class="nn">tofu</span> <span class="kn">import</span> <span class="n">__version__</span>

<span class="n">_SAVEPATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<span class="n">_SEP</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
<span class="n">_dict_lexcept_key</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">_SAVETYP</span> <span class="o">=</span> <span class="s1">&#39;__type__&#39;</span>
<span class="n">_NSAVETYP</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_SAVETYP</span><span class="p">)</span>

<span class="n">_LIDS_CUSTOM</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;magfieldlines&#39;</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="s1">&#39;shortcuts&#39;</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">]</span>


<span class="c1">###############################################</span>
<span class="c1">#           File searching</span>
<span class="c1">###############################################</span>

<div class="viewcode-block" id="FileNotFoundMsg"><a class="viewcode-back" href="../../tofu.html#tofu.utils.FileNotFoundMsg">[docs]</a><span class="k">def</span> <span class="nf">FileNotFoundMsg</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">lF</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntab</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">lF</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">pattern</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">tab</span> <span class="o">=</span> <span class="s2">&quot;    &quot;</span><span class="o">*</span><span class="n">ntab</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Wrong number of matches (</span><span class="si">%i</span><span class="s2">) !&quot;</span><span class="o">%</span><span class="n">nocc</span><span class="p">]</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;    for : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">pat</span><span class="p">]</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;    in  : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">path</span><span class="p">]</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;    =&gt;    </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">lF</span><span class="p">)]</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tab</span><span class="o">+</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">msg</span></div>


<div class="viewcode-block" id="FindFilePattern"><a class="viewcode-back" href="../../tofu.html#tofu.utils.FindFilePattern">[docs]</a><span class="k">def</span> <span class="nf">FindFilePattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntab</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">pattern</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">pat</span><span class="p">])</span>
    <span class="n">lF</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">lF</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lF</span> <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">ff</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">pat</span><span class="p">])]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lF</span><span class="p">)</span><span class="o">==</span><span class="n">nocc</span><span class="p">,</span> <span class="n">FileNotFoundMsg</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">lF</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">ntab</span><span class="o">=</span><span class="n">ntab</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lF</span></div>


<div class="viewcode-block" id="get_pathfileext"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_pathfileext">[docs]</a><span class="k">def</span> <span class="nf">get_pathfileext</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">path_def</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">name_def</span><span class="o">=</span><span class="s1">&#39;dummy&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;npz&#39;</span><span class="p">):</span>
    <span class="n">modeok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;npz&#39;</span><span class="p">,</span><span class="s1">&#39;mat&#39;</span><span class="p">]</span>
    <span class="n">modeokstr</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modeok</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;]&quot;</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">C</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">name</span>
        <span class="k">assert</span> <span class="n">C</span><span class="p">,</span> <span class="s2">&quot;name should not include the extension !&quot;</span>
    <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;Arg path must be None or a str !&quot;</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modeok</span><span class="p">,</span> <span class="s2">&quot;Arg mode must be in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">modeokstr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path_def</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name_def</span>
    <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span></div>



<span class="c1">#############################################</span>
<span class="c1">#       figure size</span>
<span class="c1">#############################################</span>

<div class="viewcode-block" id="get_figuresize"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_figuresize">[docs]</a><span class="k">def</span> <span class="nf">get_figuresize</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">fsdef</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                   <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;landscape&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xrandr&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generic function to return figure size in inches</span>

<span class="sd">        Useful for str-based flags such as:</span>
<span class="sd">            - &#39;a4&#39;  : use orient=&#39;portrait&#39; or &#39;landscape&#39;</span>
<span class="sd">            - &#39;full&#39;: to get screen size</span>
<span class="sd">                use method=&#39;xrandr&#39; (recommended),</span>
<span class="sd">                as &#39;xdpyinfo&#39; tends to be wrong</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">assert</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">tuple</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">fsdef</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fs</span><span class="o">==</span><span class="s1">&#39;a4&#39;</span><span class="p">:</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">8.27</span><span class="p">,</span><span class="mf">11.69</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">orient</span><span class="o">==</span><span class="s1">&#39;landscape&#39;</span><span class="p">:</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">fs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">fs</span><span class="o">==</span><span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;xrandr&#39;</span><span class="p">,</span><span class="s1">&#39;xdpyinfo&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;xrandr&#39;</span><span class="p">:</span>
                <span class="n">cmd0</span> <span class="o">=</span> <span class="s2">&quot;xrandr&quot;</span>
                <span class="c1">#cmd1 = &quot;grep &#39;*&#39;&quot;</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd0</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;mm x &#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;mm&#39;</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
                <span class="n">fsmm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmd0</span> <span class="o">=</span> <span class="s1">&#39;xdpyinfo&#39;</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd0</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                     <span class="k">if</span> <span class="s1">&#39;dimensions&#39;</span> <span class="ow">in</span> <span class="n">o</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39; millimeters&#39;</span><span class="p">)]</span>
                <span class="n">fsmm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)]</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="p">(</span><span class="n">fsmm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mf">2.54</span><span class="p">),</span> <span class="n">fsmm</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mf">2.54</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">fs</span></div>


<span class="c1">#############################################</span>
<span class="c1">#       todict formatting</span>
<span class="c1">#############################################</span>


<div class="viewcode-block" id="flatten_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.flatten_dict">[docs]</a><span class="k">def</span> <span class="nf">flatten_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span>
                 <span class="n">lexcept_key</span><span class="o">=</span><span class="n">_dict_lexcept_key</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">_SEP</span>

    <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lexcept_key</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">lexcept_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lexcept_key</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lexcept_key</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">ToFuObjectBase</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">deep</span><span class="o">==</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="s1">&#39;dict&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">deep</span><span class="o">==</span><span class="s1">&#39;copy&#39;</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">)</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">parent_key</span> <span class="o">+</span> <span class="n">sep</span> <span class="o">+</span> <span class="n">k</span> <span class="k">if</span> <span class="n">parent_key</span> <span class="k">else</span> <span class="n">k</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
                <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flatten_dict</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">new_key</span><span class="p">,</span>
                                          <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">new_key</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">items</span><span class="p">)</span></div>


<div class="viewcode-block" id="_reshape_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils._reshape_dict">[docs]</a><span class="k">def</span> <span class="nf">_reshape_dict</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">vv</span><span class="p">,</span> <span class="n">dinit</span><span class="o">=</span><span class="p">{},</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">_SEP</span>
    <span class="n">ls</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">ss</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dk</span> <span class="o">=</span> <span class="p">{</span><span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">vv</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dinit</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dinit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dinit</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">dinit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">vv</span><span class="p">})</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dinit</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dinit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_reshape_dict</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">vv</span><span class="p">,</span> <span class="n">dinit</span><span class="o">=</span><span class="n">dinit</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dinit</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">dinit</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span></div>


<div class="viewcode-block" id="reshape_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.reshape_dict">[docs]</a><span class="k">def</span> <span class="nf">reshape_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcls</span><span class="o">=</span><span class="p">[]):</span>
    <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">_SEP</span>

    <span class="c1"># Get all individual keys</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">_reshape_dict</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">vv</span><span class="p">,</span> <span class="n">dinit</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1"># Check if deprecated ???</span>
<div class="viewcode-block" id="get_todictfields"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_todictfields">[docs]</a><span class="k">def</span> <span class="nf">get_todictfields</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="n">ls</span><span class="p">):</span>
    <span class="n">C0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
    <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span><span class="p">,</span> <span class="s2">&quot;Provide two list of dict or two dict !&quot;</span>
    <span class="k">if</span> <span class="n">C1</span><span class="p">:</span>
        <span class="n">ld</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">ld</span><span class="p">],</span> <span class="p">[</span><span class="n">ls</span><span class="p">]</span>
    <span class="n">nd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nd</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ls</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ss</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">ks</span><span class="p">]</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span></div>


<span class="c1">#############################################</span>
<span class="c1">#       Special dict subclass for dynamic attributes creation</span>
<span class="c1">#############################################</span>

<div class="viewcode-block" id="Dictattr"><a class="viewcode-back" href="../../tofu.html#tofu.utils.Dictattr">[docs]</a><span class="k">class</span> <span class="nc">Dictattr</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="fm">__getattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="c1">#super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Dictattr</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra</span> <span class="o">=</span> <span class="n">extra</span>

    <span class="k">def</span> <span class="fm">__dir__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_extra</span></div>


<span class="c1">#############################################</span>
<span class="c1">#       Miscellaneous</span>
<span class="c1">#############################################</span>

<div class="viewcode-block" id="_set_arrayorder"><a class="viewcode-back" href="../../tofu.html#tofu.utils._set_arrayorder">[docs]</a><span class="k">def</span> <span class="nf">_set_arrayorder</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Set the memory order of all np.ndarrays in a tofu object &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg arrayorder must be in [&#39;C&#39;,&#39;F&#39;]&quot;</span>
    <span class="k">assert</span> <span class="n">arrayorder</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">],</span> <span class="n">msg</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">strip</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Success&#39;</span><span class="p">:[],</span> <span class="s1">&#39;Failed&#39;</span><span class="p">:[]}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arrayorder</span><span class="o">==</span><span class="s1">&#39;C&#39;</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">account</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
                <span class="n">account</span><span class="p">[</span><span class="s1">&#39;Failed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">account</span></div>


<span class="c1">#############################################</span>
<span class="c1">#       save / load</span>
<span class="c1">#############################################</span>

<div class="viewcode-block" id="save"><a class="viewcode-back" href="../../tofu.html#tofu.utils.save">[docs]</a><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;npz&#39;</span><span class="p">,</span>
         <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_pfe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Save the ToFu object</span>

<span class="sd">    ToFu provides built-in saving and loading functions for ToFu objects.</span>
<span class="sd">    Specifying saving path ad name is optional (defaults recommended)</span>
<span class="sd">    The mode refers to the file format</span>

<span class="sd">    Good practices are:</span>
<span class="sd">        - save all struct objects</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj  :      ToFuObject subclass instance</span>
<span class="sd">        The object to be saved</span>
<span class="sd">    path :      None / str</span>
<span class="sd">        The folder where to save, if None (recommended), uses obj.Id.SavePath</span>
<span class="sd">    name :      None / str</span>
<span class="sd">        The file name, if None (recommended), uses obj.Id.SaveName</span>
<span class="sd">    mode :      str</span>
<span class="sd">        Flag specifying the saving mode</span>
<span class="sd">            - &#39;npz&#39;: numpy file</span>
<span class="sd">            - &#39;mat&#39;: matlab file</span>
<span class="sd">    strip:      int</span>
<span class="sd">        Flag indicating how stripped the saved object should be</span>
<span class="sd">        See docstring of self.strip()</span>
<span class="sd">    deep:       bool</span>
<span class="sd">        Flag, used when the object has other tofu objects as attributes</span>
<span class="sd">        Indicated whether these attribute object should be:</span>
<span class="sd">            - True: converted to dict themselves in order to be saved inside</span>
<span class="sd">                the same file as attributes</span>
<span class="sd">                (-&gt; uses self.to_dict(deep=&#39;dict&#39;))</span>
<span class="sd">            - False: not converted, in that the strategy would be to save them</span>
<span class="sd">                separately and store only the reference to the saved files</span>
<span class="sd">                instead of the objects themselves.</span>
<span class="sd">                To do this, you must:</span>
<span class="sd">                    1/ Save all object attributes independently</span>
<span class="sd">                    2/ Store only the reference by doing self.strip(-1)</span>
<span class="sd">                       The strip() method will check they have been saved</span>
<span class="sd">                       before removing them, and throw an Exception otherwise</span>
<span class="sd">                    3/ self.save(deep=False)</span>
<span class="sd">    compressed :    bool</span>
<span class="sd">        Flag indicating whether to compress the file (slower, not recommended)</span>
<span class="sd">    verb :          bool</span>
<span class="sd">        Flag indicating whether to print a summary (recommended)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg obj must be a tofu subclass instance !&quot;</span>
    <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">ToFuObject</span><span class="p">),</span> <span class="n">msg</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg path must be None or a str (folder) !&quot;</span>
    <span class="k">assert</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="nb">str</span><span class="p">),</span> <span class="n">msg</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg name must be None or a str (file name) !&quot;</span>
    <span class="k">assert</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">str</span><span class="p">),</span> <span class="n">msg</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg mode must be in [&#39;npz&#39;,&#39;mat&#39;] !&quot;</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;npz&#39;</span><span class="p">,</span><span class="s1">&#39;mat&#39;</span><span class="p">],</span> <span class="n">msg</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg compressed must be a bool !&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">msg</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg verb must be a bool !&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">verb</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">msg</span>

    <span class="c1"># Check path, name, mode</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">get_pathfileext</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">path_def</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span><span class="p">,</span>
                                       <span class="n">name_def</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

    <span class="c1"># Update self._Id fields</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">_SavePath</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">!=</span><span class="n">obj</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">set_SaveName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># Get stripped dictionnary</span>
    <span class="n">deep</span> <span class="o">=</span> <span class="s1">&#39;dict&#39;</span> <span class="k">if</span> <span class="n">deep</span> <span class="k">else</span> <span class="s1">&#39;ref&#39;</span>
    <span class="k">if</span> <span class="n">sep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mat&#39;</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">_SEP</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mat&#39;</span> <span class="ow">and</span> <span class="n">sep</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sep=&#39;.&#39; cannot be used when mode=&#39;mat&#39; (incompatible)</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;Matlab would interpret variables as structures&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">dd</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span>

    <span class="n">pathfileext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;npz&#39;</span><span class="p">:</span>
        <span class="n">_save_npz</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pathfileext</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s1">&#39;mat&#39;</span><span class="p">:</span>
        <span class="n">_save_mat</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pathfileext</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">)</span>

    <span class="c1"># print</span>
    <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Saved in :</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span><span class="o">+</span><span class="n">pathfileext</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_pfe</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pathfileext</span></div>


<div class="viewcode-block" id="_save_npzmat_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils._save_npzmat_dict">[docs]</a><span class="k">def</span> <span class="nf">_save_npzmat_dict</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;dId</span><span class="si">{0}</span><span class="s1">dall</span><span class="si">{0}</span><span class="s1">SaveName&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;How to deal with:&quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> SaveName : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Attributes:&quot;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dnpzmat</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kt</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">_SAVETYP</span>
        <span class="n">dt</span><span class="p">[</span><span class="n">kt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># save only the type, because:</span>
            <span class="c1">#     - .mat cannot handle None</span>
            <span class="c1">#     - save disk</span>
            <span class="c1"># None will be recreated at load time</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="nb">str</span><span class="p">]</span>
              <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
              <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
              <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)):</span>
            <span class="n">dnpzmat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">]:</span>
            <span class="n">dnpzmat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">dnpzmat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
            <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">dnpzmat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dnpzmat</span></div>


<div class="viewcode-block" id="_save_npz"><a class="viewcode-back" href="../../tofu.html#tofu.utils._save_npz">[docs]</a><span class="k">def</span> <span class="nf">_save_npz</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pathfileext</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span> <span class="k">if</span> <span class="n">compressed</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">savez</span>
    <span class="n">dsave</span> <span class="o">=</span> <span class="n">_save_npzmat_dict</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">func</span><span class="p">(</span><span class="n">pathfileext</span><span class="p">,</span> <span class="o">**</span><span class="n">dsave</span><span class="p">)</span></div>


<div class="viewcode-block" id="_save_mat"><a class="viewcode-back" href="../../tofu.html#tofu.utils._save_mat">[docs]</a><span class="k">def</span> <span class="nf">_save_mat</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">pathfileext</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Create intermediate dict to make sure to get rid of None values</span>
    <span class="n">dsave</span> <span class="o">=</span> <span class="n">_save_npzmat_dict</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
    <span class="n">scpio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">pathfileext</span><span class="p">,</span> <span class="n">dsave</span><span class="p">,</span> <span class="n">do_compression</span><span class="o">=</span><span class="n">compressed</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;5&#39;</span><span class="p">)</span></div>





<span class="c1">###################################</span>
<span class="c1">#       loading routines</span>
<span class="c1">###################################</span>

<div class="viewcode-block" id="_filefind"><a class="viewcode-back" href="../../tofu.html#tofu.utils._filefind">[docs]</a><span class="k">def</span> <span class="nf">_filefind</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lmodes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span><span class="s1">&#39;.mat&#39;</span><span class="p">]):</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span><span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">name</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg name must be a str (file name or full path+file)&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; or a list of str patterns to be found at pathi</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    name : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">name</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg path must be a str !&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Extract folder and file name</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">p</span>
        <span class="k">elif</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Specified folder does not exist :&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Check unicity of matching file</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lf</span> <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">ff</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">name</span><span class="p">])]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;No / several matching files found:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;  folder:      </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;  looking for: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;  found:</span><span class="se">\n\t</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lf</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">nameext</span> <span class="o">=</span> <span class="n">lf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Check file extension</span>
    <span class="n">indend</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span><span class="o">==</span><span class="n">nameext</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lmodes</span><span class="p">]</span>
    <span class="n">indin</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">nameext</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lmodes</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indend</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indin</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;None / too many of the available file extensions !&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  file: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nameext</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  ext.: </span><span class="si">{0}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmodes</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># load and format dict</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">nameext</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">lmodes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">indend</span><span class="p">)]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">nameext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">pfe</span></div>


<div class="viewcode-block" id="get_param_from_file_name"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_param_from_file_name">[docs]</a><span class="k">def</span> <span class="nf">get_param_from_file_name</span><span class="p">(</span><span class="n">pfe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Try to extract desired parameter from file name</span>

<span class="sd">    tofu typically saves files with names formatted as:</span>
<span class="sd">        XXX_Key0param0_Key1param1_Key2param2...</span>

<span class="sd">    Where:</span>
<span class="sd">        - XXX corresponds to the sub-package that created the file</span>
<span class="sd">        - Keyiparami are (key, value) parameter pairs, when possible</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Check inputs</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lparams</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
              <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lparams</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                  <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">lparams</span><span class="p">])))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg lparams must be a str of list of str!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;Provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lparams</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">c0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Provided file does not exist!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lparams</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">lparams</span> <span class="o">=</span> <span class="p">[</span><span class="n">lparams</span><span class="p">]</span>

    <span class="c1"># Get params</span>
    <span class="n">path</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>

    <span class="c1"># First, try from file name</span>
    <span class="n">dout</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">lparams</span><span class="p">)</span>
    <span class="n">lk</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="n">nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">lparams</span><span class="p">:</span>
        <span class="n">lind</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">pp</span> <span class="ow">in</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">lk</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">lk</span><span class="p">[</span><span class="n">lind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lind</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Several values for key </span><span class="si">{}</span><span class="s2"> found in file:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;    file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dout</span></div>


<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../tofu.html#tofu.utils.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;     Load a tofu object file</span>

<span class="sd">    Can load from .npz or .txt files</span>
<span class="sd">        In future versions, will also load from .mat</span>

<span class="sd">    The file must have been saved with tofu (i.e.: must be tofu-formatted)</span>
<span class="sd">    The associated tofu object will be created and returned</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name:   str</span>
<span class="sd">        Name of the file to load from, can include the path</span>
<span class="sd">    path:   None / str</span>
<span class="sd">        Path where the file is located (if not provided in name), defaults &#39;./&#39;</span>
<span class="sd">    strip:  None / int</span>
<span class="sd">        FLag indicating whether to strip the object of some attributes</span>
<span class="sd">            =&gt; see the docstring of the class strip() method for details</span>
<span class="sd">    verb:   bool</span>
<span class="sd">        Flag indocating whether to print a summary of the loaded file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lmodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.npz&#39;</span><span class="p">,</span> <span class="s1">&#39;.mat&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">]</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">pfe</span> <span class="o">=</span> <span class="n">_filefind</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">lmodes</span><span class="o">=</span><span class="n">lmodes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">]:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">_load_from_txt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pfe</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;npz&#39;</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">_load_npz</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="n">allow_pickle</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mat&#39;</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">_load_mat</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>

        <span class="c1"># Recreate from dict</span>
        <span class="n">lsep</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">keyMod</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lsep</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;dId</span><span class="si">{0}</span><span class="s1">dall</span><span class="si">{0}</span><span class="s1">Mod&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="n">ss</span>
                <span class="n">keyMod</span> <span class="o">=</span> <span class="n">key</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No known separator in file keys!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - separators tested: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lsep</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - keys:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mod</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;tofu.</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">keyMod</span><span class="p">]))</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dId</span><span class="si">{0}</span><span class="s1">dall</span><span class="si">{0}</span><span class="s1">Cls&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sep</span><span class="p">)])</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">fromdict</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>

    <span class="c1"># print</span>
    <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Loaded from:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span><span class="o">+</span><span class="n">pfe</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="_get_load_npzmat_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils._get_load_npzmat_dict">[docs]</a><span class="k">def</span> <span class="nf">_get_load_npzmat_dict</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pfe</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;npz&#39;</span><span class="p">,</span> <span class="n">exclude_keys</span><span class="o">=</span><span class="p">[]):</span>

    <span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dId&#39;</span> <span class="ow">in</span> <span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;There does not seem to be a dId in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    =&gt; Is it really a tofu-generated file ?&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="n">_NSAVETYP</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">_SAVETYP</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_keys</span><span class="p">)]</span>
    <span class="n">lkt</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="n">_NSAVETYP</span><span class="p">:]</span> <span class="o">==</span> <span class="n">_SAVETYP</span><span class="p">]</span>
    <span class="n">dout</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span>

    <span class="n">err</span><span class="p">,</span> <span class="n">msgi</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">kt</span> <span class="ow">in</span> <span class="n">lkt</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">kt</span><span class="p">[:</span><span class="o">-</span><span class="n">_NSAVETYP</span><span class="p">]</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">kt</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;NoneType&#39;</span><span class="p">:</span>
            <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span><span class="s1">&#39;float&#39;</span><span class="p">,</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;bool&#39;</span><span class="p">,</span><span class="s1">&#39;bool_&#39;</span><span class="p">,</span><span class="s1">&#39;str&#39;</span><span class="p">,</span><span class="s1">&#39;str_&#39;</span><span class="p">]:</span>
            <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;float&#39;</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;bool&#39;</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;str&#39;</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;list&#39;</span><span class="p">,</span><span class="s1">&#39;tuple&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mat&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;tuple&#39;</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">typ</span><span class="o">==</span><span class="s1">&#39;ndarray&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;mat&#39;</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msgi</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">typ</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;How to deal with:&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> SaveName : </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;dId_dall_SaveName&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Attributes:&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="n">msgi</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dout</span></div>


<div class="viewcode-block" id="_load_npz"><a class="viewcode-back" href="../../tofu.html#tofu.utils._load_npz">[docs]</a><span class="k">def</span> <span class="nf">_load_npz</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">allow_pickle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">allow_pickle</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="n">allow_pickle</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">mmap_mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="n">allow_pickle</span><span class="p">,</span>
                      <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">err</span>

    <span class="k">return</span> <span class="n">_get_load_npzmat_dict</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pfe</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;npz&#39;</span><span class="p">,</span> <span class="n">exclude_keys</span><span class="o">=</span><span class="p">[])</span></div>


<div class="viewcode-block" id="_load_mat"><a class="viewcode-back" href="../../tofu.html#tofu.utils._load_mat">[docs]</a><span class="k">def</span> <span class="nf">_load_mat</span><span class="p">(</span><span class="n">pfe</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">scpio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">err</span>

    <span class="n">lsmat</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;__header__&#39;</span><span class="p">,</span> <span class="s1">&#39;__globals__&#39;</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">_get_load_npzmat_dict</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">pfe</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;mat&#39;</span><span class="p">,</span> <span class="n">exclude_keys</span><span class="o">=</span><span class="n">lsmat</span><span class="p">)</span></div>


<span class="c1">###############################################</span>
<span class="c1">#       Getting parameters from txt files</span>
<span class="c1">###############################################</span>


<div class="viewcode-block" id="from_txt_extract_params"><a class="viewcode-back" href="../../tofu.html#tofu.utils.from_txt_extract_params">[docs]</a><span class="k">def</span> <span class="nf">from_txt_extract_params</span><span class="p">(</span><span class="n">pfe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Extract key parameters stored as commented lines at top of file</span>

<span class="sd">    tofu saves some data to txt files with the following formatting:</span>
<span class="sd">        - a series of commented (#) lines, each with format:</span>
<span class="sd">            # key: value</span>
<span class="sd">        - a 1d or 2d np.ndarray</span>

<span class="sd">    This routine extracts the desired parameters from the commented lines</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="n">comments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>

    <span class="n">c0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Provided file does not exist!</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lparams</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
          <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lparams</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
              <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">lparams</span><span class="p">])))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg lparams must be a str of list of str!</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;Provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lparams</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lparams</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">lparams</span> <span class="o">=</span> <span class="p">[</span><span class="n">lparams</span><span class="p">]</span>

    <span class="c1"># First, try from file name</span>
    <span class="n">dout</span> <span class="o">=</span> <span class="n">get_param_from_file_name</span><span class="p">(</span><span class="n">pfe</span><span class="o">=</span><span class="n">pfe</span><span class="p">,</span> <span class="n">lparams</span><span class="o">=</span><span class="n">lparams</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Then try from file content (overwrite but warn)</span>
    <span class="n">lout</span> <span class="o">=</span> <span class="n">lparams</span> <span class="o">+</span> <span class="p">[</span><span class="n">comments</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">lparams</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lout</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="k">if</span> <span class="n">dout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Inconsistency between file name and content</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- parameter: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- from name: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">])</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- from content: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>
    <span class="k">return</span> <span class="n">dout</span></div>


<span class="c1">#######</span>
<span class="c1">#   tf.geom.Struct - specific</span>
<span class="c1">#######</span>


<div class="viewcode-block" id="_load_from_txt"><a class="viewcode-back" href="../../tofu.html#tofu.utils._load_from_txt">[docs]</a><span class="k">def</span> <span class="nf">_load_from_txt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pfe</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># Extract class</span>
    <span class="n">lk</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">lCls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PFC&#39;</span><span class="p">,</span><span class="s1">&#39;CoilPF&#39;</span><span class="p">,</span><span class="s1">&#39;CoilCS&#39;</span><span class="p">,</span><span class="s1">&#39;Ves&#39;</span><span class="p">,</span><span class="s1">&#39;PlasmaDomain&#39;</span><span class="p">]</span>
    <span class="n">lcc</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">k</span> <span class="o">==</span> <span class="bp">cls</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">lCls</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lcc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provided file name does not include any known Struct subclass:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided file name: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">name</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;     - Valid classes: [</span><span class="si">%s</span><span class="s2">]&quot;</span><span class="o">%</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lCls</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="n">lCls</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">lcc</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

    <span class="c1"># Recreate object</span>
    <span class="kn">import</span> <span class="nn">tofu.geom</span> <span class="k">as</span> <span class="nn">mod</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_txt</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span></div>


<span class="c1">#######</span>
<span class="c1">#   imas</span>
<span class="c1">#######</span>

<span class="n">_DEF_IMAS_PLASMA_SIG</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">:{</span><span class="s1">&#39;plot_sig&#39;</span><span class="p">:[</span><span class="s1">&#39;1dTe&#39;</span><span class="p">,</span><span class="s1">&#39;1dne&#39;</span><span class="p">],</span>
                                         <span class="s1">&#39;plot_X&#39;</span><span class="p">:[</span><span class="s1">&#39;1drhotn&#39;</span><span class="p">],</span>
                                         <span class="s1">&#39;other&#39;</span><span class="p">:[</span><span class="s1">&#39;t&#39;</span><span class="p">]}}</span>

<div class="viewcode-block" id="_get_exception"><a class="viewcode-back" href="../../tofu.html#tofu.utils._get_exception">[docs]</a><span class="k">def</span> <span class="nf">_get_exception</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">qtype</span><span class="o">=</span><span class="s1">&#39;quantity&#39;</span><span class="p">):</span>
    <span class="c1"># -------------------</span>
    <span class="c1"># import imas2tofu</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">imas</span>
        <span class="kn">from</span> <span class="nn">tofu.imas2tofu</span> <span class="kn">import</span> <span class="n">MultiIDSLoader</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> module imas2tofu does not seem available</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; imas may not be installed ?&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_shortcuts</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
                                    <span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="s1">&#39;shortcut&#39;</span><span class="p">,</span> <span class="s1">&#39;long version&#39;</span><span class="p">]</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_getcharray</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Args quantity and quant_X must be valid shortcuts for ids &quot;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ids</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Available shortcuts are:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Provided:</span><span class="se">\n</span><span class="s2">    - </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qtype</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_from_imas"><a class="viewcode-back" href="../../tofu.html#tofu.utils.load_from_imas">[docs]</a><span class="k">def</span> <span class="nf">load_from_imas</span><span class="p">(</span><span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">returnas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description_2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">dsig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_sig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invertx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indch_auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tosoledge3x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">mag_init_pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mag_sep_dR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mag_sep_nbpts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># import imas2tofu</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">imas</span>
        <span class="kn">import</span> <span class="nn">tofu.imas2tofu</span> <span class="k">as</span> <span class="nn">imas2tofu</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> module imas2tofu does not seem available</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; imas may not be installed ?&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">lok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Config&#39;</span><span class="p">,</span> <span class="s1">&#39;Plasma2D&#39;</span><span class="p">,</span> <span class="s1">&#39;Cam&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">]</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">returnas</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">returnas</span> <span class="ow">in</span> <span class="n">lok</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg returnas must be in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lok</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare ids</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please specify an ids to load data from!&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ids_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids_</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Pre-check ids</span>
    <span class="n">lidsok</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">imas</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;_&#39;</span><span class="p">])</span>
    <span class="n">lidscustom</span> <span class="o">=</span> <span class="n">_LIDS_CUSTOM</span>
    <span class="n">lidsout</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids_</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">ids_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ids_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lidsok</span> <span class="o">+</span> <span class="n">lidscustom</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lidsout</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ids </span><span class="si">%s</span><span class="s2"> matched no known imas ids !</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">lidsout</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; Available imas ids are:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">lidsok</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">nids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nids</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">lidscustom</span><span class="p">])</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># print shortcuts if relevant</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;shortcuts&#39;</span><span class="p">]:</span>
        <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">get_shortcutsc</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare shot</span>
    <span class="k">if</span> <span class="n">shot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">shot</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">nshot</span> <span class="o">=</span> <span class="n">shot</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Call magfieldline if relevant</span>
    <span class="k">if</span> <span class="n">ids</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;magfieldlines&#39;</span><span class="p">]:</span>
        <span class="k">assert</span> <span class="n">shot</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="kn">import</span> <span class="nn">tofu.mag</span> <span class="k">as</span> <span class="nn">tfm</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">invertx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">invertx</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">multi</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="p">(</span><span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                         <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                                         <span class="n">ids</span><span class="o">=</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
        <span class="n">equi</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">to_Plasma2D</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get time in the middle of equilibrium time interval</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.t&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span>
                <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.t&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">equi_ind_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.t&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">equi_ind_r_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.sep&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                                   <span class="p">[</span><span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">equi_r_ext</span> <span class="o">=</span> <span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.sep&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span>
                     <span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">equi_ind_r_ext</span><span class="p">]</span>
        <span class="n">equi_z_r_ext</span> <span class="o">=</span> <span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.sep&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span>
                       <span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">equi_ind_r_ext</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mag_sep_nbpts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mag_sep_nbpts</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="n">mag_sep_dR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mag_sep_dR</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">r_init</span> <span class="o">=</span> <span class="p">[</span><span class="n">equi_r_ext</span> <span class="o">+</span> <span class="n">mag_sep_dR</span><span class="p">]</span><span class="o">*</span><span class="n">mag_sep_nbpts</span>
        <span class="n">phi_init</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">mag_sep_nbpts</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mag_sep_nbpts</span><span class="p">)]</span>
        <span class="n">z_init</span> <span class="o">=</span> <span class="p">[</span><span class="n">equi_z_r_ext</span><span class="p">]</span><span class="o">*</span><span class="n">mag_sep_nbpts</span>
        <span class="n">init_plt</span> <span class="o">=</span> <span class="p">[</span><span class="n">r_init</span><span class="p">,</span> <span class="n">phi_init</span><span class="p">,</span> <span class="n">z_init</span><span class="p">]</span>

        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">multi</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="p">(</span>
                <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="s1">&#39;wall&#39;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">to_Config</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tofu.geom</span> <span class="k">as</span> <span class="nn">tfg</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">tfg</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">create_config</span><span class="p">(</span><span class="s1">&#39;B3&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">nStruct</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set_colors_random</span><span class="p">()</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">tfm</span><span class="o">.</span><span class="n">MagFieldLines</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">trace_mline</span><span class="p">(</span><span class="n">init_plt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
                                                            <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;FWD&#39;</span><span class="p">,</span>
                                                            <span class="n">length_line</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
                                                            <span class="n">stp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">trace_rev</span> <span class="o">=</span> <span class="n">tfm</span><span class="o">.</span><span class="n">MagFieldLines</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">trace_mline</span><span class="p">(</span><span class="n">init_plt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
                                              <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;REV&#39;</span><span class="p">,</span>
                                              <span class="n">length_line</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
                                              <span class="n">stp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">refpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mf">2.4</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span>
        <span class="n">dax</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_phithetaproj_dist</span><span class="p">(</span><span class="n">refpt</span><span class="p">,</span> <span class="n">invertx</span><span class="o">=</span><span class="n">invertx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mag_init_pts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">trace_init</span> <span class="o">=</span> <span class="n">tfm</span><span class="o">.</span><span class="n">MagFieldLines</span><span class="p">(</span>
                         <span class="nb">int</span><span class="p">(</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">trace_mline</span><span class="p">(</span><span class="n">mag_init_pts</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
                                                   <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;FWD&#39;</span><span class="p">,</span>
                                                   <span class="n">length_line</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
                                                   <span class="n">stp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">trace_init_rev</span> <span class="o">=</span> <span class="n">tfm</span><span class="o">.</span><span class="n">MagFieldLines</span><span class="p">(</span>
                             <span class="nb">int</span><span class="p">(</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">trace_mline</span><span class="p">(</span><span class="n">mag_init_pts</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
                                                       <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;REV&#39;</span><span class="p">,</span>
                                                       <span class="n">length_line</span><span class="o">=</span><span class="mi">35</span><span class="p">,</span>
                                                       <span class="n">stp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">trace_init_rev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">phi_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]),</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]))</span>
                <span class="n">theta_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">refpt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">refpt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">indnan</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">phi_init</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                          <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">theta_init</span><span class="p">))</span>
                             <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">phi_init</span><span class="p">,</span> <span class="n">indnan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">theta_init</span><span class="p">,</span> <span class="n">indnan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;cross&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span>
                                     <span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
                                     <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trace_init</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;hor&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
            <span class="n">alpha_mag_lines</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_mag_lines</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">)):</span>
            <span class="c1"># Concatenate trace lists</span>
            <span class="c1"># trace[ii] = trace[ii] + trace_rev[ii]</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">])):</span>
                <span class="n">lab</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;t = </span><span class="si">%s</span><span class="s1"> s&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]))</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">refpt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">refpt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># insert nans for clean periodicity</span>
                <span class="n">indnan</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                          <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">l</span><span class="p">,</span> <span class="o">=</span> <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">indnan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">indnan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                         <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_mag_lines</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;cross&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
                                     <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_mag_lines</span><span class="p">,</span>
                                     <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;hor&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_mag_lines</span><span class="p">,</span>
                                   <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="c1"># rev</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">]))</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">refpt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">refpt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># insert nans for clean periodicity</span>
                <span class="n">indnan</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                          <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;dist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">indnan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">indnan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                                    <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_mag_lines</span><span class="p">,</span>
                                   <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;cross&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">],</span>
                                     <span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
                                     <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_mag_lines</span><span class="p">,</span>
                                     <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">trace_rev</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">jj</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;hor&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha_mag_lines</span><span class="p">,</span>
                                   <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;cross&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.sep&#39;</span><span class="p">][</span>
                             <span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">equi</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="s1">&#39;equilibrium.sep&#39;</span><span class="p">][</span>
                             <span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

        <span class="n">s01</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">dsig</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;strike0&#39;</span><span class="p">,</span> <span class="s1">&#39;strike1&#39;</span><span class="p">]},</span>
                             <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">]</span>
        <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;cross&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s01</span><span class="p">[</span><span class="s1">&#39;strike0&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">s01</span><span class="p">[</span><span class="s1">&#39;strike0&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                             <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;cross&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s01</span><span class="p">[</span><span class="s1">&#39;strike1&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">s01</span><span class="p">[</span><span class="s1">&#39;strike1&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">equi_ind_t</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                             <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">dax</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Shot </span><span class="si">{0}</span><span class="s1">, t = </span><span class="si">{1:6.3f}</span><span class="s1"> s&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">dax</span>

    <span class="k">elif</span> <span class="n">ids</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]:</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="p">(</span><span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                         <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                                         <span class="n">ids</span><span class="o">=</span><span class="s1">&#39;pulse_schedule&#39;</span><span class="p">,</span> <span class="n">ids_base</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">multi</span><span class="o">.</span><span class="n">get_events</span><span class="p">(</span><span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">elif</span> <span class="n">ids</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]:</span>
        <span class="kn">import</span> <span class="nn">tofu.geom</span> <span class="k">as</span> <span class="nn">tfg</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
            <span class="n">tfg</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_available_config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">tfg</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">create_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">set_colors_random</span><span class="p">()</span>
            <span class="n">conf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tosoledge3x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="n">conf</span><span class="o">.</span><span class="n">to_SOLEDGE3X</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">tosoledge3x</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare returnas</span>
    <span class="n">loutok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Config&#39;</span><span class="p">,</span> <span class="s1">&#39;Plasma2D&#39;</span><span class="p">,</span> <span class="s1">&#39;Cam&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">]</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">returnas</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">returnas</span> <span class="ow">in</span> <span class="n">loutok</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">returnas</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">oo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">loutok</span>
                                         <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">returnas</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span> <span class="ow">or</span> <span class="n">c2</span>
    <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">returnas</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">c1</span><span class="p">:</span>
        <span class="n">returnas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">returnas</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>

    <span class="c1"># Temporary caveat</span>
    <span class="k">if</span> <span class="n">nids</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">ids_</span> <span class="ow">in</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_lidsdiag</span>
                    <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;tf.load_from_imas() only handles multipe ids</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;if all are diagnostics ids !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>

        <span class="c1"># Config</span>
        <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;wall&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Config&#39;</span><span class="p">]</span>
            <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Config&#39;</span>
        <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Config&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;wall&#39;</span><span class="p">]</span>

        <span class="c1"># Plasma2D</span>
        <span class="n">lids</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_lidsplasma</span>
        <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Plasma2D&#39;</span><span class="p">]</span>
            <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Plasma2D&#39;</span>
        <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Plasma2D&#39;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lids</span>

        <span class="c1"># Cam or Data</span>
        <span class="n">lids</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_lidsdiag</span>
        <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Cam&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Data&#39;</span>
        <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cam&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lids</span>

    <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="n">shot</span><span class="p">[</span><span class="n">jj</span><span class="p">]:</span> <span class="p">{</span><span class="n">oo</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">returnas</span><span class="p">)}</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nshot</span><span class="p">)}</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare plot_ and complement ids</span>
    <span class="n">lPla</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nids</span><span class="p">)</span> <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Plasma2D&#39;</span><span class="p">]</span>
    <span class="n">lCam</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nids</span><span class="p">)</span> <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Cam&#39;</span><span class="p">]</span>
    <span class="n">lDat</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nids</span><span class="p">)</span> <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Data&#39;</span><span class="p">]</span>
    <span class="n">nPla</span><span class="p">,</span> <span class="n">nCam</span><span class="p">,</span> <span class="n">nDat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lPla</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lCam</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lDat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plot_</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_</span> <span class="o">=</span> <span class="n">plot</span>

    <span class="c1"># Check conformity nshot / nDat</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nshot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot plot several diags for several shots!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; Please select either several diags (plot_combine)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                          several shots (plot_compare)&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nshot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot plot several plasma profles for several shots!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; Please select either several profiles (plot_combine)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                          several shots (plot_compare)&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nDat</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nPla</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nCam</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can only load Cam xor Data xor Plasma2D !&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Complement ids</span>
    <span class="n">lids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nCam</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;wall&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
            <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;wall&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">extra</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;equilibrium&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;lh_antennas&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lh_antennas&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;ic_antennas&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ic_antennas&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;pulse_schedule&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pulse_schedule&#39;</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># If plot and plasma, default dsig, plot_sig, plot_X</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">plot_sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_sig</span> <span class="o">=</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;plot_sig&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">plot_X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_X</span> <span class="o">=</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;plot_X&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dsig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lsig</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">plot_sig</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">plot_X</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;other&#39;</span><span class="p">])</span>
                <span class="n">dsig</span> <span class="o">=</span> <span class="p">{</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">lsig</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">plot_sig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">plot_X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Trying to plot a plasma profile</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Impossible if plot_sig and plot_X not provided!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  (resp. quantity and quant_X if calling from tofuplot)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dq</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_dshort</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dq</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="n">plot_sig</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="n">_get_exception</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qtype</span><span class="o">=</span><span class="s1">&#39;quantity&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="n">plot_X</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="n">_get_exception</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qtype</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>


    <span class="c1"># -------------------</span>
    <span class="c1"># load</span>
    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shot</span><span class="p">:</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="p">(</span><span class="n">shot</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                         <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                                         <span class="n">ids</span><span class="o">=</span><span class="n">lids</span><span class="p">)</span>

        <span class="c1"># export to instances</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Config&#39;</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">to_Config</span><span class="p">(</span>
                        <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
                        <span class="n">description_2d</span><span class="o">=</span><span class="n">description_2d</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Plasma2D&#39;</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">to_Plasma2D</span><span class="p">(</span>
                        <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
                        <span class="n">tlim</span><span class="o">=</span><span class="n">tlim</span><span class="p">,</span> <span class="n">dsig</span><span class="o">=</span><span class="n">dsig</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span>
                        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_sig</span><span class="o">=</span><span class="n">plot_sig</span><span class="p">,</span>
                        <span class="n">dextra</span><span class="o">=</span><span class="n">dextra</span><span class="p">,</span> <span class="n">plot_X</span><span class="o">=</span><span class="n">plot_X</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Cam&#39;</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">to_Cam</span><span class="p">(</span>
                        <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
                        <span class="n">ids</span><span class="o">=</span><span class="n">lids</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">indch</span><span class="o">=</span><span class="n">indch</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
                        <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Data&quot;</span><span class="p">:</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multi</span><span class="o">.</span><span class="n">to_Data</span><span class="p">(</span>
                        <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
                        <span class="n">ids</span><span class="o">=</span><span class="n">lids</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">tlim</span><span class="o">=</span><span class="n">tlim</span><span class="p">,</span> <span class="n">dsig</span><span class="o">=</span><span class="n">dsig</span><span class="p">,</span>
                        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="n">indch</span><span class="p">,</span>
                        <span class="n">indch_auto</span><span class="o">=</span><span class="n">indch_auto</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span>
                        <span class="n">dextra</span><span class="o">=</span><span class="n">dextra</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lids</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">returnas</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># plot if relevant</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

        <span class="c1"># Config &amp; Cam</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shot</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;Config&#39;</span><span class="p">,</span> <span class="s1">&#39;Cam&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">returnas</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">k0</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="c1"># Plasma2D</span>
        <span class="k">if</span> <span class="n">nshot</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nPla</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Plasma2D&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Plasma2D&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_sig</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">plot_X</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nshot</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nPla</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="p">[</span><span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="s1">&#39;Plasma2D&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_Data</span><span class="p">(</span><span class="n">plot_sig</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">plot_X</span><span class="p">,</span>
                                                   <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shot</span> <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="s1">&#39;Plasma2D&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">)</span>

        <span class="c1"># Data</span>
        <span class="k">elif</span> <span class="n">nshot</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nDat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nshot</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nDat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="p">[</span><span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shot</span>
                  <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">ss</span><span class="p">][</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tit</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_compare</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nshot</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">dout</span><span class="p">[</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tit</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">_dids</span><span class="p">[</span><span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">][</span><span class="s1">&#39;idd&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ld</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_combine</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">)</span>

    <span class="c1"># return</span>
    <span class="k">if</span> <span class="n">nshot</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nDat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">dout</span><span class="p">[</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">nshot</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nPla</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">dout</span><span class="p">[</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;Plasma2D&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dout</span></div>


<div class="viewcode-block" id="calc_from_imas"><a class="viewcode-back" href="../../tofu.html#tofu.utils.calc_from_imas">[docs]</a><span class="k">def</span> <span class="nf">calc_from_imas</span><span class="p">(</span>
    <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">shot_eq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_eq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_eq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database_eq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">shot_prof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_prof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user_prof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">database_prof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description_2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dsig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">Brightness</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot_compare</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">input_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coefs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indch_auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate syntehtic signal for a diagnostic</span>

<span class="sd">    Read the geometry from an idd (database, user, shot, run)</span>
<span class="sd">    Read the equilibrium from the same / another idd</span>
<span class="sd">    Read the profile from the same / another idd</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># import imas2tofu</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">imas</span>
        <span class="kn">import</span> <span class="nn">tofu.imas2tofu</span> <span class="k">as</span> <span class="nn">imas2tofu</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> module imas2tofu does not seem available</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;  =&gt; imas may not be installed?&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">lok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">lok</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg out must be in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lok</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">extra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Equilibrium idd</span>
    <span class="k">if</span> <span class="n">database_eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">database_eq</span> <span class="o">=</span> <span class="n">database</span>
    <span class="k">if</span> <span class="n">user_eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_eq</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">if</span> <span class="n">shot_eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shot_eq</span> <span class="o">=</span> <span class="n">shot</span>
    <span class="k">if</span> <span class="n">run_eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_eq</span> <span class="o">=</span> <span class="n">run</span>

    <span class="c1"># prof idd</span>
    <span class="k">if</span> <span class="n">database_prof</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">database_prof</span> <span class="o">=</span> <span class="n">database</span>
    <span class="k">if</span> <span class="n">user_prof</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_prof</span> <span class="o">=</span> <span class="n">user</span>
    <span class="k">if</span> <span class="n">shot_prof</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shot_prof</span> <span class="o">=</span> <span class="n">shot</span>
    <span class="k">if</span> <span class="n">run_prof</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_prof</span> <span class="o">=</span> <span class="n">run</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare ids</span>
    <span class="k">assert</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ids_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ids_</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Pre-check ids</span>
    <span class="n">lidsok</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">imas</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;_&#39;</span><span class="p">])</span>
    <span class="n">lidscustom</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lidsout</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids_</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">ids_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ids_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lidsok</span><span class="o">+</span><span class="n">lidscustom</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lidsout</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ids </span><span class="si">{}</span><span class="s2"> matched no known imas ids !</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lidsout</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; Available imas ids are:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">lidsok</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">nids</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nids</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">lidscustom</span><span class="p">])</span>

    <span class="c1"># Check if input_file</span>
    <span class="k">if</span> <span class="n">input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lids_input_file</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bremsstrahlung_visible&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nids</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids_input_file</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;input_file is only available for a single ids in:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">- &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lids_input_file</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare shot</span>
    <span class="n">shot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">shot</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">nshot</span> <span class="o">=</span> <span class="n">shot</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Check if input_file</span>
    <span class="k">if</span> <span class="n">input_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nshot</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;input_file not available for multiple shots!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare out</span>
    <span class="n">loutok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">loutok</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">oo</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">loutok</span>
                                    <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">out</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span> <span class="ow">or</span> <span class="n">c2</span>
    <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">c1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>

    <span class="c1"># Temporary caveat</span>
    <span class="k">if</span> <span class="n">nids</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">ids_</span> <span class="ow">in</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_lidsdiag</span>
                    <span class="k">for</span> <span class="n">ids_</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;tf.load_from_imas() only handles multipe ids &quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;if all are diagnostics ids!&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>

        <span class="c1"># Cam or Data</span>
        <span class="n">lids</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_lidsdiag</span>
        <span class="k">if</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Cam&#39;</span><span class="p">,</span><span class="s1">&#39;Data&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Data&#39;</span>
        <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Cam&#39;</span><span class="p">,</span><span class="s1">&#39;Data&#39;</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">ids</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lids</span>

    <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="n">shot</span><span class="p">[</span><span class="n">jj</span><span class="p">]:</span> <span class="p">{</span><span class="n">oo</span><span class="p">:[]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">out</span><span class="p">)}</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nshot</span><span class="p">)}</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># Prepare plot_ and complement ids</span>
    <span class="n">lPla</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nids</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Plasma2D&#39;</span><span class="p">]</span>
    <span class="n">lCam</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nids</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Cam&#39;</span><span class="p">]</span>
    <span class="n">lDat</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nids</span><span class="p">)</span> <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Data&#39;</span><span class="p">]</span>
    <span class="n">nPla</span><span class="p">,</span> <span class="n">nCam</span><span class="p">,</span> <span class="n">nDat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lPla</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lCam</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lDat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plot_</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plot_</span> <span class="o">=</span> <span class="n">plot</span>

    <span class="c1"># Check conformity nshot / nDat</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nshot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot plot several diags for several shots!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; Please select either several diags (plot_combine)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                          several shots (plot_compare)&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nshot</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot plot several plasma profles for several shots!</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; Please select either several profiles (plot_combine)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                          several shots (plot_compare)&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nDat</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nPla</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nCam</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Can only load Cam xor Data xor Plasma2D !&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Complement ids</span>
    <span class="n">lids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nCam</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;wall&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
            <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;wall&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">extra</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;equilibrium&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;lh_antennas&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lh_antennas&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;ic_antennas&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ic_antennas&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">nDat</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;pulse_schedule&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
                <span class="n">lids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pulse_schedule&#39;</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># If plot and plasma, default dsig, plot_sig, plot_X</span>
    <span class="k">if</span> <span class="n">plot</span> <span class="ow">and</span> <span class="n">nPla</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">plot_sig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_sig</span> <span class="o">=</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;plot_sig&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">plot_X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot_X</span> <span class="o">=</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;plot_X&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dsig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lsig</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">plot_sig</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">plot_X</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">_DEF_IMAS_PLASMA_SIG</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;other&#39;</span><span class="p">])</span>
                <span class="n">dsig</span> <span class="o">=</span> <span class="p">{</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">lsig</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">plot_sig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">plot_X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Trying to plot a plasma profile</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Impossible if plot_sig and plot_X not provided!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  (resp. quantity and quant_X if calling from tofuplot)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dq</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_dshort</span><span class="p">[</span><span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dq</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="n">plot_sig</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="n">_get_exception</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qtype</span><span class="o">=</span><span class="s1">&#39;quantity&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="n">plot_X</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="n">_get_exception</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">lids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qtype</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>

    <span class="c1"># -------------------</span>
    <span class="c1"># load</span>

    <span class="n">lidsdiag</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lids</span>
                <span class="k">if</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="o">.</span><span class="n">_lidsdiag</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">input_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">shot</span><span class="p">:</span>
            <span class="n">multi</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="p">(</span>
                <span class="n">shot</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                <span class="n">ids</span><span class="o">=</span><span class="n">lids</span><span class="p">,</span> <span class="n">synthdiag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">get</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">lids_synth</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">get_inputs_for_synthsignal</span><span class="p">(</span><span class="n">lidsdiag</span><span class="p">,</span>
                                                          <span class="n">returnas</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>
                                                          <span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;equilibrium&#39;</span> <span class="ow">in</span> <span class="n">lids_synth</span><span class="p">:</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">add_ids</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">database_eq</span><span class="p">,</span>
                              <span class="n">user</span><span class="o">=</span><span class="n">user_eq</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot_eq</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run_eq</span><span class="p">,</span>
                              <span class="n">get</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">lids_synth</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lids_synth</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">multi</span><span class="o">.</span><span class="n">add_ids</span><span class="p">(</span><span class="n">lids_synth</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">database_prof</span><span class="p">,</span>
                              <span class="n">user</span><span class="o">=</span><span class="n">user_prof</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="n">shot_prof</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run_prof</span><span class="p">,</span>
                              <span class="n">get</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">multi</span><span class="o">.</span><span class="n">open_get_close</span><span class="p">()</span>

            <span class="c1"># export to instances</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nids</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Data&quot;</span><span class="p">:</span>
                    <span class="n">multi</span><span class="o">.</span><span class="n">calc_signal</span><span class="p">(</span><span class="n">ids</span><span class="o">=</span><span class="n">lids</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                      <span class="n">tlim</span><span class="o">=</span><span class="n">tlim</span><span class="p">,</span> <span class="n">dsig</span><span class="o">=</span><span class="n">dsig</span><span class="p">,</span>
                                      <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                                      <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="n">indch</span><span class="p">,</span>
                                      <span class="n">Brightness</span><span class="o">=</span><span class="n">Brightness</span><span class="p">,</span>
                                      <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                      <span class="n">indch_auto</span><span class="o">=</span><span class="n">indch_auto</span><span class="p">,</span>
                                      <span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="n">dextra</span><span class="p">,</span>
                                      <span class="n">coefs</span><span class="o">=</span><span class="n">coefs</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span>
                                      <span class="n">plot_compare</span><span class="o">=</span><span class="n">plot_compare</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">MultiIDSLoader</span><span class="p">(</span><span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                         <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                                         <span class="n">ids</span><span class="o">=</span><span class="n">lids</span><span class="p">,</span> <span class="n">synthdiag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;bremsstrahlung_visible&#39;</span> <span class="ow">in</span> <span class="n">lids</span><span class="p">:</span>
            <span class="n">multi</span><span class="o">.</span><span class="n">add_ids</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">,</span> <span class="n">get</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plasma</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">to_Plasma2D</span><span class="p">()</span>
            <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;rhotn&#39;</span><span class="p">,</span> <span class="s1">&#39;brem&#39;</span><span class="p">]</span>
            <span class="n">lamb</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="n">dsig</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bremsstrahlung_visible&#39;</span><span class="p">:</span> <span class="s1">&#39;lamb&#39;</span><span class="p">},</span>
                <span class="n">return_all</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)[</span><span class="s1">&#39;bremsstrahlung_visible&#39;</span><span class="p">][</span><span class="s1">&#39;lamb&#39;</span><span class="p">]</span>
            <span class="n">dout</span> <span class="o">=</span> <span class="n">imas2tofu</span><span class="o">.</span><span class="n">get_data_from_matids</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span>
                                                  <span class="n">return_fields</span><span class="o">=</span><span class="n">lf</span><span class="p">,</span>
                                                  <span class="n">lamb</span><span class="o">=</span><span class="n">lamb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">plasma</span><span class="o">.</span><span class="n">add_ref</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;core_profiles.t&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">],</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                           <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;input_file&#39;</span><span class="p">)</span>
            <span class="n">nrad</span> <span class="o">=</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;rhotn&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">plasma</span><span class="o">.</span><span class="n">add_ref</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;core_profiles.radius&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrad</span><span class="p">),</span>
                           <span class="n">group</span><span class="o">=</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;input_file&#39;</span><span class="p">)</span>
            <span class="n">plasma</span><span class="o">.</span><span class="n">add_quantity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;core_profiles.1drhotn&#39;</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;rhotn&#39;</span><span class="p">],</span>
                                <span class="n">depend</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;core_profiles.t&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;core_profiles.radius&#39;</span><span class="p">),</span>
                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;input_file&#39;</span><span class="p">,</span>
                                <span class="n">quant</span><span class="o">=</span><span class="s1">&#39;rhotn&#39;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;adim.&#39;</span><span class="p">)</span>
            <span class="n">plasma</span><span class="o">.</span><span class="n">add_quantity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;core_profiles.1dbrem&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;brem&#39;</span><span class="p">],</span>
                                <span class="n">depend</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;core_profiles.t&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;core_profiles.radius&#39;</span><span class="p">),</span>
                                <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;input_file&#39;</span><span class="p">)</span>
            <span class="n">cam</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">to_Cam</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">calc_signal_from_Plasma2D</span><span class="p">(</span><span class="n">plasma</span><span class="p">,</span>
                                                <span class="n">quant</span><span class="o">=</span><span class="s1">&#39;core_profiles.1dbrem&#39;</span><span class="p">,</span>
                                                <span class="n">ref1d</span><span class="o">=</span><span class="s1">&#39;core_profiles.1drhotn&#39;</span><span class="p">,</span>
                                                <span class="n">ref2d</span><span class="o">=</span><span class="s1">&#39;equilibrium.2drhotn&#39;</span><span class="p">,</span>
                                                <span class="n">coefs</span><span class="o">=</span><span class="n">coefs</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span>
                                                <span class="n">Brightness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Format output dictionnary to be saved</span>
                <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shot&#39;</span><span class="p">:</span> <span class="n">shot</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">sig</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                        <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">sig</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="s1">&#39;units_t&#39;</span><span class="p">:</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;units_data&#39;</span><span class="p">:</span> <span class="s1">&#39;ph / (s.m2.sr.m)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;channels&#39;</span><span class="p">:</span> <span class="n">sig</span><span class="o">.</span><span class="n">dchans</span><span class="p">(</span><span class="s1">&#39;names&#39;</span><span class="p">),</span>
                        <span class="s1">&#39;tofu_version&#39;</span><span class="p">:</span> <span class="n">__version__</span><span class="p">}</span>

                <span class="c1"># Save to specified path + filename + extension</span>
                <span class="k">if</span> <span class="n">output_file</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.mat&#39;</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">output_file</span> <span class="o">+=</span> <span class="s1">&#39;.mat&#39;</span>
                <span class="n">scpio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="n">dout</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Successfully saved in:</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Could not save computed synthetic signal to:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;scpio.savemat(</span><span class="si">{0}</span><span class="s2">, dout)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<span class="c1">#############################################</span>
<span class="c1">#       Generic tofu object</span>
<span class="c1">#############################################</span>

<div class="viewcode-block" id="_check_notNone"><a class="viewcode-back" href="../../tofu.html#tofu.utils._check_notNone">[docs]</a><span class="k">def</span> <span class="nf">_check_notNone</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">lk</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> should not be None !&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="_check_InputsGeneric"><a class="viewcode-back" href="../../tofu.html#tofu.utils._check_InputsGeneric">[docs]</a><span class="k">def</span> <span class="nf">_check_InputsGeneric</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="c1"># Prepare</span>
    <span class="n">bstr0</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;    &quot;</span><span class="o">*</span><span class="n">tab</span> <span class="o">+</span> <span class="s2">&quot;Error on arg </span><span class="si">%s</span><span class="s2">:&quot;</span>
    <span class="n">bstr1</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;    &quot;</span><span class="o">*</span><span class="p">(</span><span class="n">tab</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;Expected: &quot;</span>
    <span class="n">bstr2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot;    &quot;</span><span class="o">*</span><span class="p">(</span><span class="n">tab</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;Provided: &quot;</span>

    <span class="n">ltypes_f2i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>
    <span class="n">ltypes_i2f</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]</span>

    <span class="c1"># Check</span>
    <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ld</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">errk</span><span class="p">,</span> <span class="n">msgk</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">bstr0</span><span class="o">%</span><span class="n">k</span>
        <span class="k">if</span> <span class="s1">&#39;cls&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;cls&#39;</span><span class="p">]):</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;class </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;class </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="s1">&#39;NoneOrCls&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span>
                                                   <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;NoneOrCls&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;None or class </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;NoneOrCls&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;class </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="s1">&#39;in&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;in&#39;</span><span class="p">]:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;in </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;in&#39;</span><span class="p">])</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;lisfof&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;listof&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c1</span><span class="p">:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;list of </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;listof&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;iter2array&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span><span class="s1">&#39;__iter__&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;iterable of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;iter2array&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
            <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;iter2array&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;ndim&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c1</span><span class="p">:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;array of </span><span class="si">{0}</span><span class="s2"> dimensions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ndim&#39;</span><span class="p">])</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;shape </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;inshape&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;inshape&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c1</span><span class="p">:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;shape including </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;inshape&#39;</span><span class="p">])</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;shape </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;float2int&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
                   <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span><span class="o">==</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
                  <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ltypes_f2i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;convertible to int from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">ltypes_f2i</span><span class="p">)</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> (</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span>
                                                 <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;int2float&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ltypes_i2f</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;convertible to float from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">ltypes_i2f</span><span class="p">)</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;class </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;NoneOrIntPos&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
                   <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span><span class="o">==</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span>
                   <span class="ow">and</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ltypes_f2i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">)):</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;convertible to &gt;0 int from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">ltypes_f2i</span><span class="p">)</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
            <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">c0</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;NoneOrFloatPos&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">cc</span><span class="p">)</span>
                   <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span>
                   <span class="ow">and</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">ltypes_f2i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">)):</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;convertible to &gt;0 float from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">ltypes_f2i</span>
                <span class="p">)</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
            <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">c0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;&gt;&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;&gt;&#39;</span><span class="p">])):</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;&gt; </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;&gt;&#39;</span><span class="p">])</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;vectnd&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span><span class="n">tt</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;vectnd&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">c0</span> <span class="o">&amp;=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;vectnd&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;array of size </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;vectnd&#39;</span><span class="p">])</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
            <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;unitvectnd&#39;</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span><span class="n">tt</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]])</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;unitvectnd&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c1</span><span class="p">:</span>
                <span class="n">errk</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr1</span> <span class="o">+</span> <span class="s2">&quot;array of size </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;unitvectnd&#39;</span><span class="p">])</span>
                <span class="n">msgk</span> <span class="o">+=</span> <span class="n">bstr2</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">])</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">ld</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">errk</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">msgk</span>
    <span class="k">return</span> <span class="n">ld</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="_get_attrdictfromobj"><a class="viewcode-back" href="../../tofu.html#tofu.utils._get_attrdictfromobj">[docs]</a><span class="k">def</span> <span class="nf">_get_attrdictfromobj</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">dd</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dd</span></div>


<div class="viewcode-block" id="ToFuObjectBase"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase">[docs]</a><span class="k">class</span> <span class="nc">ToFuObjectBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>
    <span class="n">_dstrip</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;strip&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;allowed&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

    <span class="c1"># Does not exist before Python 3.6 !!!</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ToFuObjectBase</span><span class="p">,</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span> <span class="o">=</span> <span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">_dstrip</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_strip_init</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_dstrip</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fromdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">fromdict</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">kwdargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Done</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="ToFuObjectBase._reset"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._reset">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be overloaded &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ToFuObjectBase._set_Id"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._set_Id">[docs]</a>    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be overloaded &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ToFuObjectBase._init"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._init">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be overloaded &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ToFuObjectBase._strip_init"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._strip_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be overloaded &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ToFuObjectBase._get_largs_Id"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._get_largs_Id">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_Id</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span><span class="s1">&#39;Deg&#39;</span><span class="p">,</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span><span class="s1">&#39;Diag&#39;</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;SaveName&#39;</span><span class="p">,</span><span class="s1">&#39;SavePath&#39;</span><span class="p">,</span><span class="s1">&#39;usr&#39;</span><span class="p">,</span><span class="s1">&#39;dUSR&#39;</span><span class="p">,</span><span class="s1">&#39;lObj&#39;</span><span class="p">,</span><span class="s1">&#39;include&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="ToFuObjectBase._extract_kwdargs"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._extract_kwdargs">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_kwdargs</span><span class="p">(</span><span class="n">din</span><span class="p">,</span> <span class="n">largs</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">largs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">din</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">din</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="ToFuObjectBase._set_arrayorder"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._set_arrayorder">[docs]</a>    <span class="k">def</span> <span class="nf">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">account</span> <span class="o">=</span> <span class="n">_set_arrayorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;Failed&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All np.ndarrays were not set to </span><span class="si">{0}</span><span class="s2"> :</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">arrayorder</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Success : [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;Success&#39;</span><span class="p">]))</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Failed :  [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s1">&#39;Failed&#39;</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dextra</span><span class="p">[</span><span class="s1">&#39;arrayorder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arrayorder</span></div>

<div class="viewcode-block" id="ToFuObjectBase._strip_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._strip_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_strip_dict</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lkeep</span><span class="p">:</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="ToFuObjectBase._test_Rebuild"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._test_Rebuild">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_test_Rebuild</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[]):</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lkeep</span><span class="p">:</span>
                <span class="n">reset</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">reset</span></div>

<div class="viewcode-block" id="ToFuObjectBase._check_Fields4Rebuild"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._check_Fields4Rebuild">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_Fields4Rebuild</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[],</span> <span class="n">dname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lkeep</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">dd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Rebuilding </span><span class="si">{0}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dname</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Field &#39;</span><span class="si">{0}</span><span class="s2">&#39; is missing !&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="ToFuObjectBase._check_InputsGeneric"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._check_InputsGeneric">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_InputsGeneric</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">ld</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="n">tab</span><span class="p">)</span></div>


    <span class="c1">#############################</span>
    <span class="c1">#  charray and summary</span>
    <span class="c1">#############################</span>


<div class="viewcode-block" id="ToFuObjectBase._getcharray"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._getcharray">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_getcharray</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">c0</span> <span class="o">=</span> <span class="n">ar</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ar</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">ar</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="c1"># Get just len</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">str_len</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ar</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;len(col) should be in np.array(ar, dtype=&#39;U&#39;).shape:</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- len(col) = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- ar.shape = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ar</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="o">.</span><span class="n">T</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">str_len</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fmax</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span>

        <span class="c1"># Apply to array</span>
        <span class="n">fjust</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">ljust</span> <span class="k">if</span> <span class="n">just</span> <span class="o">==</span> <span class="s1">&#39;l&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">rjust</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fjust</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span><span class="n">nn</span><span class="p">)])</span>

        <span class="c1"># Apply to col</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="p">[</span><span class="n">line</span><span class="o">*</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nn</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
            <span class="n">arcol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fjust</span><span class="p">(</span><span class="n">arcol</span><span class="p">,</span><span class="n">nn</span><span class="p">)])</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arcol</span><span class="p">,</span><span class="n">out</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="ToFuObjectBase._get_summary"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._get_summary">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_summary</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lar</span><span class="p">,</span> <span class="n">lcol</span><span class="p">,</span>
                     <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="n">table_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Summary description of the object content as a np.array of str &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">table_sep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">table_sep</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>


        <span class="c1"># Out</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="ow">or</span> <span class="n">return_</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span><span class="s1">&#39;msg&#39;</span><span class="p">]:</span>
            <span class="n">lmsg</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_getcharray</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">just</span><span class="o">=</span><span class="n">just</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ar</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">lar</span><span class="p">,</span><span class="n">lcol</span><span class="p">])]</span>
            <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">table_sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lmsg</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">lar</span><span class="p">,</span> <span class="n">lmsg</span>
            <span class="k">elif</span> <span class="n">return_</span> <span class="o">==</span> <span class="s1">&#39;array&#39;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">lar</span>
            <span class="k">elif</span> <span class="n">return_</span> <span class="o">==</span> <span class="s1">&#39;msg&#39;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">table_sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lmsg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lok</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">]</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Valid return_ values are: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">lok</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">out</span></div>


    <span class="c1"># def get_summary(self, sep=&#39;  &#39;, line=&#39;-&#39;, just=&#39;l&#39;,</span>
                    <span class="c1"># table_sep=None, verb=True, return_=False):</span>
        <span class="c1"># &quot;&quot;&quot; Summary description of the object content as a np.array of str &quot;&quot;&quot;</span>
        <span class="c1"># pass</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;get_summary&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary</span><span class="p">(</span><span class="n">return_</span><span class="o">=</span><span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

    <span class="c1">#############################</span>
    <span class="c1">#  strip and to/from dict</span>
    <span class="c1">#############################</span>


<div class="viewcode-block" id="ToFuObjectBase.strip"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove non-essential attributes to save memory / disk usage</span>

<span class="sd">        Useful to save a very compressed version of the object</span>
<span class="sd">        The higher strip =&gt; the more stripped the object</span>
<span class="sd">        Use strip=0 to recover all atributes</span>

<span class="sd">        See the difference by doing:</span>
<span class="sd">            &gt; self.get_nbytes()</span>
<span class="sd">            &gt; self.strip(-1)</span>
<span class="sd">            &gt; self.get_nbytes()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strip:      int</span>
<span class="sd">            Flag indicating how much to strip from the object</span>
<span class="sd">                 0: Make complete (retrieve all attributes){0}</span>
<span class="sd">                -1: Equivalent to strip={1}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Only allowed strip values are:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span><span class="o">+</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]])</span>
        <span class="k">assert</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">],</span> <span class="n">msg</span>
        <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">][</span><span class="n">strip</span><span class="p">]</span>

        <span class="c1"># --------------------------------</span>
        <span class="c1"># Call class-specific strip method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="c1"># --------------------------------</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strip</span></div>

<div class="viewcode-block" id="ToFuObjectBase.to_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="s1">&#39;ref&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a flat dict view of the object&#39;s attributes</span>

<span class="sd">        Useful for:</span>
<span class="sd">            * displaying all attributes</span>
<span class="sd">            * saving to file</span>
<span class="sd">            * exchaning data with non-tofu libraries</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        strip :     int</span>
<span class="sd">            Flag indicating how stripped the object should be</span>
<span class="sd">            Fed to self.strip()</span>
<span class="sd">        sep :       str</span>
<span class="sd">            Separator char used for flattening the dict</span>
<span class="sd">            The output dict is flat (i.e.: no nested dict)</span>
<span class="sd">            Keys are created from the keys of nested dict, separated by sep</span>
<span class="sd">        deep:       str</span>
<span class="sd">            Flag indicating how to behave when an attribute is itself a tofu</span>
<span class="sd">            object. The associated field in the exported dict can be:</span>
<span class="sd">                - &#39;ref&#39; : a simple reference to the object</span>
<span class="sd">                - &#39;copy&#39;: a tofu object itself (i.e.: a copy of the original)</span>
<span class="sd">                - &#39;dict&#39;: the tofu object is itself exported as a dict</span>
<span class="sd">                    (using also self.to_dict())</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        dout :      dict</span>
<span class="sd">            Flat dict containing all the objects attributes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">deep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span><span class="s1">&#39;dict&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg deep must be a flag in [&#39;ref&#39;,&#39;copy&#39;,&#39;dict&#39;] !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">strip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>

        <span class="c1"># ---------------------</span>
        <span class="c1"># Call class-specific</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span>
        <span class="c1"># ---------------------</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dId</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dstrip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

        <span class="n">dout</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lexcept_key</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lexcept_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;dict&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;dict&#39;</span><span class="p">],</span>
                                 <span class="n">parent_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">,</span>
                                 <span class="n">lexcept_key</span><span class="o">=</span><span class="n">lexcept_key</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Issue flattening dict </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">k</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;dict&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">flatten_dict</span><span class="p">(</span><span class="n">dout</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="ToFuObjectBase._get_dId"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase._get_dId">[docs]</a>    <span class="k">def</span> <span class="nf">_get_dId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; To be overloaded &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dict&#39;</span><span class="p">:{}}</span></div>

<div class="viewcode-block" id="ToFuObjectBase.from_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase.from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Populate the instances attributes using an input dict</span>

<span class="sd">        The input dict must be properly formatted</span>
<span class="sd">        In practice it should be the return output of a similar class to_dict()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fd :    dict</span>
<span class="sd">            The properly formatted ditionnary from which to read the attributes</span>
<span class="sd">        sep :   str</span>
<span class="sd">            The separator that was used to format fd keys (cf. self.to_dict())</span>
<span class="sd">        strip : int</span>
<span class="sd">            Flag indicating how stripped the resulting object shouyld be</span>
<span class="sd">            (cf. self.strip())</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">reshape_dict</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)</span>

        <span class="c1"># ---------------------</span>
        <span class="c1"># Call class-specific</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
        <span class="c1"># ---------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dstrip&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;dId&#39;</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_Id</span><span class="p">(</span><span class="n">Id</span><span class="o">=</span><span class="n">ID</span><span class="p">(</span><span class="n">fromdict</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dId&#39;</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">strip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">strip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>

<div class="viewcode-block" id="ToFuObjectBase.copy"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="s1">&#39;ref&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return another instance of the object, with the same attributes</span>

<span class="sd">        If deep=True, all attributes themselves are also copies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">fromdict</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span></div>

<div class="viewcode-block" id="ToFuObjectBase.get_nbytes"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObjectBase.get_nbytes">[docs]</a>    <span class="k">def</span> <span class="nf">get_nbytes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute and return the object size in bytes (i.e.: octets)</span>

<span class="sd">        A flat dict containing all the objects attributes is first created</span>
<span class="sd">        The size of each attribute is then estimated with np.asarray().nbytes</span>

<span class="sd">        Note :</span>
<span class="sd">            if the attribute is a tofu object, get_nbytes() is recursive</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        total :     int</span>
<span class="sd">            The total object estimated size, in bytes</span>
<span class="sd">        dsize :     dict</span>
<span class="sd">            A dictionnary giving the size of each attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">dsize</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">ToFuObjectBase</span><span class="p">):</span>
                <span class="n">dsize</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get_nbytes</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dsize</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">nbytes</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">dsize</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">total</span><span class="p">,</span> <span class="n">dsize</span></div>


    <span class="c1">#############################</span>
    <span class="c1">#  operator overloading</span>
    <span class="c1">#############################</span>


    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">lexcept</span><span class="o">=</span><span class="p">[],</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The 2 objects have different &quot;</span>
        <span class="c1"># Check class</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">==</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;classes :</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

        <span class="c1"># Check keys</span>
        <span class="k">if</span> <span class="n">eq</span><span class="p">:</span>
            <span class="n">d0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">lk0</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d0</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">lk1</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="n">lk0</span><span class="o">==</span><span class="n">lk1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;dict keys :</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;    [&#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk0</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lk1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;    [&#39;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk1</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lk0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>

        <span class="c1"># Check values</span>
        <span class="k">if</span> <span class="n">eq</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;dict values :</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">lsimple</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">bool</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span>
                       <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lexcept</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">eqk</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                    <span class="n">eq</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="n">k</span><span class="o">+</span><span class="s2">&quot; types :</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">eqk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">in</span> <span class="n">lsimple</span><span class="p">:</span>
                        <span class="n">eqk</span> <span class="o">=</span> <span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                            <span class="n">m0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="n">m1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
                        <span class="n">eqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">([</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]],[</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                            <span class="n">m0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="n">m1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                        <span class="n">eqk</span> <span class="o">=</span> <span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">if</span> <span class="n">eqk</span><span class="p">:</span>
                            <span class="n">eqk</span> <span class="o">=</span> <span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
                            <span class="k">if</span> <span class="n">eqk</span><span class="p">:</span>
                                <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="nb">issubclass</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                                    <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                                    <span class="n">eqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">equal_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">eqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                                    <span class="n">m0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                                    <span class="n">m1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">m0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                                <span class="n">m1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">m0</span> <span class="o">=</span> <span class="s2">&quot;shape </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                            <span class="n">m1</span> <span class="o">=</span> <span class="s2">&quot;shape </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">ToFuObjectBase</span><span class="p">):</span>
                        <span class="n">eqk</span> <span class="o">=</span> <span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                            <span class="n">m0</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="n">m1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">mplTri</span><span class="p">):</span>
                        <span class="n">eqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                            <span class="n">m0</span> <span class="o">=</span> <span class="s1">&#39;x &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                            <span class="n">m1</span> <span class="o">=</span> <span class="s1">&#39;x &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">eqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                                <span class="n">m0</span> <span class="o">=</span> <span class="s1">&#39;y &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                                <span class="n">m1</span> <span class="o">=</span> <span class="s1">&#39;y &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">eqk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">triangles</span> <span class="o">==</span> <span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">triangles</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                                    <span class="n">m0</span> <span class="o">=</span> <span class="s1">&#39;tri &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">triangles</span><span class="p">)</span>
                                    <span class="n">m1</span> <span class="o">=</span> <span class="s1">&#39;tri &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">triangles</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s1">&#39;trifind&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">lpar0</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">parameters</span>
                        <span class="n">lpar1</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">parameters</span>
                        <span class="n">eqk</span> <span class="o">=</span> <span class="n">lpar0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">lpar1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                            <span class="n">m0</span> <span class="o">=</span> <span class="s1">&#39;tri &#39;</span> <span class="o">+</span> <span class="n">lpar0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="n">m1</span> <span class="o">=</span> <span class="s1">&#39;tri &#39;</span> <span class="o">+</span> <span class="n">lpar1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;How to handle :</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    </span><span class="si">{0}</span><span class="s2"> is a </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d0</span><span class="p">[</span><span class="n">k</span><span class="p">])))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">eqk</span><span class="p">:</span>
                        <span class="n">eq</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="n">k</span><span class="o">+</span><span class="s2">&quot; :</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span><span class="o">+</span><span class="n">m0</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    &quot;</span><span class="o">+</span><span class="n">m1</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">detail</span><span class="p">:</span>
                            <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">eq</span> <span class="ow">and</span> <span class="n">verb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eq</span>

    <span class="c1"># Python 3</span>
    <span class="k">def</span> <span class="nf">__neq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>

    <span class="c1"># Python 2</span>
    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>



<div class="viewcode-block" id="ToFuObject"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject">[docs]</a><span class="k">class</span> <span class="nc">ToFuObject</span><span class="p">(</span><span class="n">ToFuObjectBase</span><span class="p">):</span>

    <span class="c1"># Does not exist before Python 3.6 !!!</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ToFuObject</span><span class="p">,</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<div class="viewcode-block" id="ToFuObject._set_Id"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._set_Id">[docs]</a>    <span class="k">def</span> <span class="nf">_set_Id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">dUSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lObj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_Id</span><span class="p">()</span>
        <span class="n">dId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">dId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_Id</span><span class="p">(</span><span class="o">**</span><span class="n">dId</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="n">ID</span><span class="p">(</span><span class="n">Cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="o">**</span><span class="n">dId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span> <span class="o">=</span> <span class="n">Id</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The ID instance of the object</span>

<span class="sd">        The ID class in tofu objects contains all information used for</span>
<span class="sd">        identifying the instance and automatically managing saving / loading</span>
<span class="sd">        In particular, it yields information such as:</span>
<span class="sd">                - Name of the object</span>
<span class="sd">                - Name that would be used for the file in case of saving</span>
<span class="sd">                - Path under which it would be saved</span>
<span class="sd">                - Experiment the object is associated to</span>
<span class="sd">                - Diagnostic the object is associated to</span>
<span class="sd">                - Type of the object</span>
<span class="sd">                - shot the object is associated to</span>
<span class="sd">                - version of tofu used for creating the object</span>
<span class="sd">                - ...</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span>

<div class="viewcode-block" id="ToFuObject._get_dId"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._get_dId">[docs]</a>    <span class="k">def</span> <span class="nf">_get_dId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">)}</span></div>

<div class="viewcode-block" id="ToFuObject._reset"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;_Id&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span></div>


<div class="viewcode-block" id="ToFuObject._set_dlObj"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._set_dlObj">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dlObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lObj</span><span class="p">,</span> <span class="n">din</span><span class="o">=</span><span class="p">{}):</span>

        <span class="c1"># Make sure to kill the link to the mutable being provided</span>
        <span class="n">nObj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lObj</span><span class="p">)</span>
        <span class="n">lCls</span><span class="p">,</span> <span class="n">lorder</span><span class="p">,</span> <span class="n">lerr</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">lObj</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">ToFuObject</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The following obj is not a ToFuObject subclass:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">cls</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span>
            <span class="n">clsname</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName_Conv</span><span class="p">(</span><span class="n">Cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                           <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lCls</span><span class="p">:</span>
                <span class="n">lCls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">clsname</span> <span class="ow">in</span> <span class="n">lorder</span><span class="p">:</span>
                    <span class="n">lerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clsname</span><span class="p">)</span>
            <span class="n">lorder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clsname</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lerr</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;There is an ambiguity in the names :&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lerr</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> =&gt; Please clarify (choose unique Cls/Names)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Initialize dObj is not existing</span>
        <span class="k">if</span> <span class="s1">&#39;dObj&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">din</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,{})</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lCls</span><span class="p">])</span>

        <span class="c1"># Initisalize</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lCls</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lObj</span> <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                    <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">din</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;nObj&#39;</span><span class="p">:</span><span class="n">nObj</span><span class="p">,</span> <span class="s1">&#39;lorder&#39;</span><span class="p">:</span><span class="n">lorder</span><span class="p">,</span> <span class="s1">&#39;lCls&#39;</span><span class="p">:</span><span class="n">lCls</span><span class="p">})</span></div>

<div class="viewcode-block" id="ToFuObject._get_ind12r_n12"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._get_ind12r_n12">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_ind12r_n12</span><span class="p">(</span><span class="n">ind1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ind2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">ind1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ind2</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">n1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">c1</span><span class="p">,</span> <span class="s2">&quot;Provide n1 and n2 !&quot;</span>
        <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">),</span> <span class="n">n2</span><span class="p">)</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">),</span> <span class="n">n1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ind1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ind2</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ind1</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">ind2</span><span class="o">.</span><span class="n">size</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind1</span><span class="o">&lt;</span><span class="n">n1</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind2</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind2</span><span class="o">&lt;</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">indr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n2</span><span class="p">,</span><span class="n">n1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ind1</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="n">indr</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">ind1</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ii</span>
        <span class="k">return</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">indr</span></div>

<div class="viewcode-block" id="ToFuObject._checkformat_Narray"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._checkformat_Narray">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_Narray</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">extramsg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">aa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">N</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">N</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aa</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Array </span><span class="si">{}</span><span class="s2">.shape should containg </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aa</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">aa</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">aa</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">aa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">N</span> <span class="ow">and</span> <span class="n">aa</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">aa</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">dim</span> <span class="ow">and</span> <span class="n">aa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">N</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Arg </span><span class="si">{}</span><span class="s2"> must be a (</span><span class="si">{}</span><span class="s2">, ...) np.ndarray</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">extramsg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aa</span></div>

<div class="viewcode-block" id="ToFuObject._checkformat_scalar"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._checkformat_scalar">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_scalar</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ss&#39;</span><span class="p">,</span> <span class="n">extramsg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Please provide </span><span class="si">{}</span><span class="s2"> as a float:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">))</span>
                       <span class="o">+</span> <span class="n">extramsg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ss</span></div>

<div class="viewcode-block" id="ToFuObject._rotate_pts_vectors_around_3daxis"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._rotate_pts_vectors_around_3daxis">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rotate_pts_vectors_around_3daxis</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># angle, pts, vect and axis</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_scalar</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;angle&#39;</span><span class="p">)</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pts&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">vect</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">vect</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vect&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vect&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg axis must be a tuple of 2 arrays of len()=3</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- axis[0] is the (x,y,z) coords of a point</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- axis[1] is the (x,y,z) coords of a vector&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">ax_pt</span> <span class="o">=</span> <span class="n">axis</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:][:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">ax_ez</span> <span class="o">=</span> <span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axis</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ax_ez</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.999</span><span class="p">:</span>
            <span class="n">ax_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="o">-</span><span class="n">ax_ez</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax_ez</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">ax_ex</span> <span class="o">=</span> <span class="n">ax_ex</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ax_ex</span><span class="o">*</span><span class="n">ax_ez</span><span class="p">)</span><span class="o">*</span><span class="n">ax_ez</span>
        <span class="n">ax_ex</span> <span class="o">=</span> <span class="n">ax_ex</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ax_ex</span><span class="p">)</span>
        <span class="n">ax_ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ax_ez</span><span class="p">,</span> <span class="n">ax_ex</span><span class="p">)</span>
        <span class="n">ax_ex</span> <span class="o">=</span> <span class="n">ax_ex</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">ax_ey</span> <span class="o">=</span> <span class="n">ax_ey</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">ax_ez</span> <span class="o">=</span> <span class="n">ax_ez</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Compute pts</span>
        <span class="k">if</span> <span class="n">pts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ptsv</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">-</span> <span class="n">ax_pt</span>
            <span class="n">ptsz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptsv</span><span class="o">*</span><span class="n">ax_ez</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ptsr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptsv</span><span class="o">*</span><span class="n">ax_ex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptsv</span><span class="o">*</span><span class="n">ax_ey</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">ptsang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptsv</span><span class="o">*</span><span class="n">ax_ey</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ptsv</span><span class="o">*</span><span class="n">ax_ex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">ang2</span> <span class="o">=</span> <span class="n">ptsang</span> <span class="o">+</span> <span class="n">angle</span>
            <span class="n">pts2</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax_pt</span> <span class="o">+</span> <span class="n">ptsz</span><span class="o">*</span><span class="n">ax_ez</span>
                    <span class="o">+</span> <span class="n">ptsr</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang2</span><span class="p">)</span><span class="o">*</span><span class="n">ax_ex</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang2</span><span class="p">)</span><span class="o">*</span><span class="n">ax_ey</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pts2</span>

        <span class="c1"># Compute vect</span>
        <span class="k">if</span> <span class="n">vect</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">ax_ez</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">vr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">ax_ex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">ax_ey</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">vang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">ax_ey</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">ax_ex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">ang2</span> <span class="o">=</span> <span class="n">vang</span> <span class="o">+</span> <span class="n">angle</span>
            <span class="n">vect2</span> <span class="o">=</span> <span class="p">(</span><span class="n">vz</span><span class="o">*</span><span class="n">ax_ez</span>
                     <span class="o">+</span> <span class="n">vr</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang2</span><span class="p">)</span><span class="o">*</span><span class="n">ax_ex</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang2</span><span class="p">)</span><span class="o">*</span><span class="n">ax_ey</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vect2</span>
        <span class="k">return</span> <span class="n">pts2</span><span class="p">,</span> <span class="n">vect2</span></div>

<div class="viewcode-block" id="ToFuObject._rotate_pts_vectors_around_torusaxis"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._rotate_pts_vectors_around_torusaxis">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rotate_pts_vectors_around_torusaxis</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rotate_pts_vectors_around_3daxis</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">vect</span><span class="p">,</span>
                                                     <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span>
                                                     <span class="n">axis</span><span class="o">=</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                                                           <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]))</span></div>

<div class="viewcode-block" id="ToFuObject._rotate_pts_vectors_in_poloidal_plane"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._rotate_pts_vectors_in_poloidal_plane">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rotate_pts_vectors_in_poloidal_plane</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># phi</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_scalar</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;phi&#39;</span><span class="p">)</span>
        <span class="n">axis_rz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">axis_rz</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;axis_rz&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax_pt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">axis_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                      <span class="n">axis_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">axis_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">ax_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rotate_pts_vectors_around_3daxis</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">vect</span><span class="p">,</span>
                                                     <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span>
                                                     <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="n">ax_pt</span><span class="p">,</span> <span class="n">ax_v</span><span class="p">))</span></div>

<div class="viewcode-block" id="ToFuObject._rotate_pts_vectors_in_poloidal_plane_2D"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._rotate_pts_vectors_in_poloidal_plane_2D">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rotate_pts_vectors_in_poloidal_plane_2D</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pts_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">vect_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">axis_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check format input</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_scalar</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;angle&#39;</span><span class="p">)</span>
        <span class="n">pts_rz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">pts_rz</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pts_rz&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">vect_rz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">vect_rz</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vect_rz&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axis_rz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">axis_rz</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;axis_rz&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">axis_rz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide both axis_rz and angle !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">pts_rz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">vect_rz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Neither pts_rz nor vect_rz was provided, nothing to rotate&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Compute</span>
        <span class="k">if</span> <span class="n">pts_rz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">pts_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">axis_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pts_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">axis_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">pts_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">axis_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pts_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">axis_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ptsrz2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">axis_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rad</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="o">+</span><span class="n">angle</span><span class="p">),</span>
                               <span class="n">axis_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">rad</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="o">+</span><span class="n">angle</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">vect_rz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ptsrz2</span>

        <span class="k">if</span> <span class="n">vect_rz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vect_rz</span><span class="p">)</span>
            <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">vect_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vect_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vectrz2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rad</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="o">+</span><span class="n">angle</span><span class="p">),</span>
                                <span class="n">rad</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="o">+</span><span class="n">angle</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">pts_rz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">vectrz2</span>
        <span class="k">return</span> <span class="n">ptsrz2</span><span class="p">,</span> <span class="n">vectrz2</span></div>

<div class="viewcode-block" id="ToFuObject._translate_pts_3d"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._translate_pts_3d">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_translate_pts_3d</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">direction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pts&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_scalar</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pts</span> <span class="o">+</span> <span class="n">distance</span><span class="o">*</span><span class="n">direction</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="ToFuObject._translate_pts_poloidal_plane"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._translate_pts_poloidal_plane">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_translate_pts_poloidal_plane</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">direction_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_scalar</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;phi&#39;</span><span class="p">)</span>
        <span class="n">direction_rz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">direction_rz</span><span class="p">,</span>
                                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;direction&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pts&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pts&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;If pts are in (R, Z) coordinates, please provide phi!&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                            <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]])</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">direction_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                              <span class="n">direction_rz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">direction_rz</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_translate_pts_3d</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span></div>

<div class="viewcode-block" id="ToFuObject._translate_pts_poloidal_plane_2D"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._translate_pts_poloidal_plane_2D">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_translate_pts_poloidal_plane_2D</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pts_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                         <span class="n">direction_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">direction_rz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">direction_rz</span><span class="p">,</span>
                                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;direction_rz&#39;</span><span class="p">,</span>
                                               <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pts_rz</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Narray</span><span class="p">(</span><span class="n">pts_rz</span><span class="p">,</span>
                                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;pts_rz&#39;</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_scalar</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;distance&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pts_rz</span> <span class="o">+</span> <span class="n">distance</span><span class="o">*</span><span class="n">direction_rz</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span></div>

<div class="viewcode-block" id="ToFuObject._checkformat_set_move"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._checkformat_set_move">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_set_move</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">move</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
              <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
              <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">move</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rotate&#39;</span><span class="p">,</span> <span class="s1">&#39;translate&#39;</span><span class="p">]]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">or</span> <span class="n">move</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;move must be a str matching the name of a valid&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot; movement method (rotate/translate)</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">move</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">move</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">param</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_scalar</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">lc0</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="ow">in</span> <span class="n">sig</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">lc1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;angle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="s1">&#39;distance&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
               <span class="s1">&#39;return_copy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">lc0</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc1</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;extra keyword arguments cannot include:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;angle&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;distance&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;return_copy&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;  you provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwdargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">vv</span>
                   <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">move</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">kwdargs</span></div>

<div class="viewcode-block" id="ToFuObject._move"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject._move">[docs]</a>    <span class="k">def</span> <span class="nf">_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">dictname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictname</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;move&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Default movement not defined</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;  =&gt; use self.set_move()&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="s1">&#39;move_param&#39;</span><span class="p">,</span> <span class="s1">&#39;move_kwdargs&#39;</span><span class="p">]</span>
        <span class="n">move</span><span class="p">,</span> <span class="n">param0</span><span class="p">,</span> <span class="n">kwdargs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictname</span><span class="p">)[</span><span class="n">kk</span><span class="p">]</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">kwdargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">move</span><span class="p">)</span>
        <span class="n">dparam</span> <span class="o">=</span> <span class="n">param</span> <span class="o">-</span> <span class="n">param0</span>
        <span class="n">func</span><span class="p">(</span><span class="n">dparam</span><span class="p">,</span> <span class="n">return_copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">param</span></div>

<div class="viewcode-block" id="ToFuObject.save"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ToFuObject.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;npz&#39;</span><span class="p">,</span>
             <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_pfe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please set a unique instance name before saving using:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    self.Id.set_Name( name )</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; (to avoid saving of different instances with no name)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please specify a saving path (path=...)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                    <span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">,</span>
                    <span class="n">return_pfe</span><span class="o">=</span><span class="n">return_pfe</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div></div>


<span class="n">ToFuObject</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">save</span><span class="o">.</span><span class="vm">__doc__</span>


<span class="c1">#############################################</span>
<span class="c1">#       ID class</span>
<span class="c1">#############################################</span>


<div class="viewcode-block" id="ID"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID">[docs]</a><span class="k">class</span> <span class="nc">ID</span><span class="p">(</span><span class="n">ToFuObjectBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A class used by all ToFu objects as an attribute</span>

<span class="sd">    It stores all relevant data for the identification of instances</span>
<span class="sd">    Stored info can be the name of the instance, the experiment and diagnostics</span>
<span class="sd">    it belongs to, or other user-defined info</span>
<span class="sd">    Also provides default names for saving the instances</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Cls :       str</span>
<span class="sd">        Class of the object on which info should be stored:</span>
<span class="sd">    Name :      str</span>
<span class="sd">        Name of the instance (user-defined)</span>
<span class="sd">        Should be a str without space &#39; &#39; or underscore &#39;_&#39;</span>
<span class="sd">        (automatically removed if present)</span>
<span class="sd">    Type :      None / str</span>
<span class="sd">        Type of object (i.e.: &#39;Tor&#39; or &#39;Lin&#39; for a :class:`~tofu.geom.Ves`)</span>
<span class="sd">    Deg :       None / int</span>
<span class="sd">        Degree of the b-splines constituting the :mod:`tofu.mesh` object</span>
<span class="sd">    Exp :       None / str</span>
<span class="sd">        Flag specifying the experiment (e.g.: &#39;WEST&#39;, &#39;AUG&#39;, &#39;ITER&#39;, &#39;JET&#39;...)</span>
<span class="sd">    Diag :      None / str</span>
<span class="sd">        Flag indicating the diagnostic (e.g.: &#39;SXR&#39;, &#39;HXR&#39;, &#39;Bolo&#39;...)</span>
<span class="sd">    shot :      None / int</span>
<span class="sd">        A shot number from which the instance is valid (for tracking changes)</span>
<span class="sd">    SaveName :  None / str</span>
<span class="sd">        Overrides the default file name for saving (not recommended)</span>
<span class="sd">    SavePath :  None / str</span>
<span class="sd">        Absolute path where the instance should be saved</span>
<span class="sd">    dUSR :   None / dict</span>
<span class="sd">        A user-defined dictionary containing information about the instance</span>
<span class="sd">        All info considered relevant can be passed here</span>
<span class="sd">        (e.g.: thickness of the diode, date of installation...)</span>
<span class="sd">    lObj :      None / dict / list</span>
<span class="sd">        Either:</span>
<span class="sd">            - list: list of other ID instances of objects on which the created object depends</span>
<span class="sd">              (this list will then be sorted by class and formatted into a dictionary storign key attributes)</span>
<span class="sd">            - dict: a ready-made such dictionary</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dModes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;geom&#39;</span><span class="p">:</span><span class="s1">&#39;TFG&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="s1">&#39;TFD&#39;</span><span class="p">}</span>
    <span class="n">_defInclude</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span><span class="s1">&#39;Deg&#39;</span><span class="p">,</span><span class="s1">&#39;Diag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">]</span>
    <span class="n">_dPref</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Exp&#39;</span><span class="p">:</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span><span class="s1">&#39;Diag&#39;</span><span class="p">:</span><span class="s1">&#39;Dg&#39;</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">:</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span><span class="s1">&#39;Deg&#39;</span><span class="p">:</span><span class="s1">&#39;Deg&#39;</span><span class="p">,</span>
              <span class="s1">&#39;version&#39;</span><span class="p">:</span><span class="s1">&#39;Vers&#39;</span><span class="p">,</span><span class="s1">&#39;usr&#39;</span><span class="p">:</span><span class="s1">&#39;U&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">SavePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dUSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lObj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span>
        <span class="c1">#super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<div class="viewcode-block" id="ID._reset"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dall</span><span class="p">())</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get largs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._get_largs_dall"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._get_largs_dall">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dall</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Deg&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;Exp&#39;</span><span class="p">,</span> <span class="s1">&#39;Diag&#39;</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;SaveName&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;SavePath&#39;</span><span class="p">,</span> <span class="s1">&#39;usr&#39;</span><span class="p">,</span> <span class="s1">&#39;dUSR&#39;</span><span class="p">,</span> <span class="s1">&#39;lObj&#39;</span><span class="p">,</span> <span class="s1">&#39;include&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get check and format inputs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._checkformat_inputs_dall"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._checkformat_inputs_dall">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dall</span><span class="p">(</span><span class="n">usr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">SavePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">SaveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">lObj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dUSR</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Str args</span>
        <span class="k">if</span> <span class="n">SavePath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">SavePath</span> <span class="o">=</span> <span class="n">_SAVEPATH</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">usr</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">SavePath</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="p">,</span> <span class="n">SaveName</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">ss</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">usr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">usr</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">shot</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">shot</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span>
              <span class="n">Deg</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Deg</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">Deg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span>
              <span class="n">Cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Cls</span><span class="p">,</span> <span class="n">ToFuObject</span><span class="p">),</span>
              <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include</span><span class="p">,</span> <span class="nb">list</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Arg shot should be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- None</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- int and positive</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;  You provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shot</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Arg Deg should be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- None</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- int and positive</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;  You provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Deg</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lc</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Arg Cls should be a ToFuObject subclass!&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;  You provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Cls</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lc</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Arg include should be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- None</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- list</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;  You provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">include</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dout</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dout</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get keys of dictionnaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._get_keys_dall"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._get_keys_dall">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dall</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span> <span class="s1">&#39;Cls&#39;</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;SaveName&#39;</span><span class="p">,</span>
              <span class="s1">&#39;SavePath&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">,</span> <span class="s1">&#39;Diag&#39;</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;Deg&#39;</span><span class="p">,</span>
              <span class="s1">&#39;version&#39;</span><span class="p">,</span> <span class="s1">&#39;usr&#39;</span><span class="p">,</span> <span class="s1">&#39;dUSR&#39;</span><span class="p">,</span> <span class="s1">&#39;lObj&#39;</span><span class="p">,</span> <span class="s1">&#39;SaveName-usr&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _init</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._init"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._init">[docs]</a>    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">lObj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dUSR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dall</span><span class="p">()</span>
        <span class="n">kwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_dall</span><span class="p">(</span><span class="o">**</span><span class="n">kwd</span><span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># set dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._set_dall"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._set_dall">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">lObj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dUSR</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">dargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">dargs</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span>
        <span class="n">dargs</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">_checkformat_inputs_dall</span><span class="p">(</span><span class="o">**</span><span class="n">dargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>
        <span class="n">lasis</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;usr&#39;</span><span class="p">,</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span><span class="s1">&#39;SavePath&#39;</span><span class="p">,</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span><span class="s1">&#39;Diag&#39;</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">,</span><span class="s1">&#39;Deg&#39;</span><span class="p">]</span>
        <span class="n">dasis</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span><span class="n">dargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lasis</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dasis</span><span class="p">)</span>

        <span class="c1"># Set fixed attributes</span>
        <span class="n">Mod</span><span class="p">,</span> <span class="n">Cls</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">_extract_ModClsFrom_class</span><span class="p">(</span><span class="n">dargs</span><span class="p">[</span><span class="s1">&#39;Cls&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Cls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cls</span>

        <span class="c1"># Set variable attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Name</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_lObj</span><span class="p">(</span><span class="n">lObj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dUSR</span><span class="p">(</span><span class="n">dUSR</span><span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># strip dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._strip_dall"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._strip_dall">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">pass</span></div>

    <span class="c1">###########</span>
    <span class="c1"># rebuild dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._rebuild_dall"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._rebuild_dall">[docs]</a>    <span class="k">def</span> <span class="nf">_rebuild_dall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[]):</span>
        <span class="k">pass</span></div>


    <span class="c1">###########</span>
    <span class="c1"># _strip and get/from dict</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._strip_init"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._strip_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">])</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="n">nMax</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="ID.strip"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1">#super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span></div>

<div class="viewcode-block" id="ID._strip"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._strip">[docs]</a>    <span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ID._to_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dall&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">dall</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="ID._from_dict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dall&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;version&#39;</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">__version__</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The object was created with a different tofu version !&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  object: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;SaveName&#39;</span><span class="p">])</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    original : tofu </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    current  : tofu </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">__version__</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Properties</span>
    <span class="c1">###########</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dall</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Mod</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Cls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Cls&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">NameLTX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">r</span><span class="s2">&quot;$&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;\_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;$&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Exp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Exp&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Diag&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;shot&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">usr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;usr&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Deg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Deg&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SaveName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">SavePath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SavePath&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lObj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;lObj&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dUSR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;dUSR&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span>

    <span class="c1">###########</span>
    <span class="c1"># semi-public methods</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="ID._extract_ModClsFrom_class"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID._extract_ModClsFrom_class">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_ModClsFrom_class</span><span class="p">(</span><span class="n">Cls</span><span class="p">):</span>
        <span class="n">strc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cls</span><span class="p">)</span>
        <span class="n">ind0</span> <span class="o">=</span> <span class="n">strc</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;tofu.&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span>
        <span class="n">indeol</span> <span class="o">=</span> <span class="n">strc</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;&#39;&gt;&quot;</span><span class="p">)</span>
        <span class="n">strc</span> <span class="o">=</span> <span class="n">strc</span><span class="p">[</span><span class="n">ind0</span><span class="p">:</span><span class="n">indeol</span><span class="p">]</span>
        <span class="n">indp</span> <span class="o">=</span> <span class="n">strc</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">Mod</span> <span class="o">=</span> <span class="n">strc</span><span class="p">[:</span><span class="n">indp</span><span class="p">]</span>
        <span class="n">strc</span> <span class="o">=</span> <span class="n">strc</span><span class="p">[</span><span class="n">indp</span><span class="o">+</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#cls = strc[:strc.index(&#39;.&#39;)][::-1]</span>
        <span class="k">return</span> <span class="n">Mod</span><span class="p">,</span> <span class="n">Cls</span><span class="o">.</span><span class="vm">__name__</span></div>

<div class="viewcode-block" id="ID.SaveName_Conv"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID.SaveName_Conv">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">SaveName_Conv</span><span class="p">(</span><span class="n">Mod</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a default name for saving the object</span>

<span class="sd">        Includes key info for fast identification of the object from file name</span>
<span class="sd">        Used on object creation by :class:`~tofu.pathfile.ID`</span>
<span class="sd">        It is recommended to use this default name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Modstr</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">_dModes</span><span class="p">[</span><span class="n">Mod</span><span class="p">]</span> <span class="k">if</span> <span class="n">Mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">include</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">_defInclude</span> <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">include</span>
        <span class="k">if</span> <span class="n">Cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;Type&#39;</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">Clsstr</span> <span class="o">=</span> <span class="n">Cls</span><span class="o">+</span><span class="n">Type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Clsstr</span> <span class="o">=</span> <span class="n">Cls</span>
        <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Mod&#39;</span><span class="p">:</span><span class="n">Modstr</span><span class="p">,</span> <span class="s1">&#39;Cls&#39;</span><span class="p">:</span><span class="n">Clsstr</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">:</span><span class="n">Name</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]:</span>
                <span class="n">Dict</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">ii</span><span class="o">==</span><span class="s1">&#39;Deg&#39;</span> <span class="ow">and</span> <span class="n">Deg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Dict</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">_dPref</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{0:02.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Deg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ii</span><span class="o">==</span><span class="s1">&#39;shot&#39;</span> <span class="ow">and</span> <span class="n">shot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Dict</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">_dPref</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">{0:05.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span><span class="s1">&#39;Type&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">eval</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="s1">&#39; is None&#39;</span><span class="p">)):</span>
                <span class="n">Dict</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">_dPref</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="nb">eval</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;Data&#39;</span> <span class="ow">in</span> <span class="n">Cls</span><span class="p">:</span>
            <span class="n">Order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span><span class="s1">&#39;Deg&#39;</span><span class="p">,</span><span class="s1">&#39;Diag&#39;</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;version&#39;</span><span class="p">,</span><span class="s1">&#39;usr&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span><span class="s1">&#39;Deg&#39;</span><span class="p">,</span><span class="s1">&#39;Diag&#39;</span><span class="p">,</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;shot&#39;</span><span class="p">,</span><span class="s1">&#39;version&#39;</span><span class="p">,</span><span class="s1">&#39;usr&#39;</span><span class="p">]</span>

        <span class="n">SVN</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Order</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">Order</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="n">include</span> <span class="ow">and</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Order</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">SVN</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Order</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="n">SVN</span> <span class="o">=</span> <span class="n">SVN</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SVN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;_&#39;</span><span class="p">:</span>
            <span class="n">SVN</span> <span class="o">=</span> <span class="n">SVN</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">SVN</span></div>

    <span class="c1">###########</span>
    <span class="c1"># public methods</span>
    <span class="c1">###########</span>


<div class="viewcode-block" id="ID.set_Name"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID.set_Name">[docs]</a>    <span class="k">def</span> <span class="nf">set_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">SaveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ForceUpdate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the Name of the instance, automatically updating the SaveName</span>

<span class="sd">        The name should be a str without spaces or underscores (removed)</span>
<span class="sd">        When the name is changed, if SaveName (i.e. the name used for saving)</span>
<span class="sd">        was not user-defined, it is automatically updated</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Name :      str</span>
<span class="sd">            Name of the instance, without &#39; &#39; or &#39;_&#39; (automatically removed)</span>
<span class="sd">        SaveName :  None / str</span>
<span class="sd">            If provided, overrides the default name for saving (not recommended)</span>
<span class="sd">        include:    list</span>
<span class="sd">            Controls how te default SaveName is generated</span>
<span class="sd">            Each element of the list is a key str indicating whether an element</span>
<span class="sd">            should be present in the SaveName</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_SaveName</span><span class="p">(</span><span class="n">SaveName</span><span class="o">=</span><span class="n">SaveName</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span>
                          <span class="n">ForceUpdate</span><span class="o">=</span><span class="n">ForceUpdate</span><span class="p">)</span></div>

<div class="viewcode-block" id="ID.set_SaveName"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID.set_SaveName">[docs]</a>    <span class="k">def</span> <span class="nf">set_SaveName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">SaveName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">ForceUpdate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the name for saving the instance (SaveName)</span>

<span class="sd">        SaveName can be either:</span>
<span class="sd">            - provided by the user (no constraint) - not recommended</span>
<span class="sd">            - automatically generated from Name and key attributes (cf. include)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        SaveName :      None / str</span>
<span class="sd">            If provided, overrides the default name for saving (not recommended)</span>
<span class="sd">        include :       list</span>
<span class="sd">            Controls how te default SaveName is generated</span>
<span class="sd">            Each element of the list is a key str indicating whether an element</span>
<span class="sd">            should be present in the SaveName</span>
<span class="sd">        ForceUpdate :   bool</span>
<span class="sd">            Flag indicating the behaviour when SaveName=None:</span>
<span class="sd">                - True : A new SaveName is generated, overriding the old one</span>
<span class="sd">                - False : The former SaveName is preserved (default)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;SaveName-usr&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dall</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName-usr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">SaveName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># If SaveName provided by user, override</span>
        <span class="k">if</span> <span class="n">SaveName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SaveName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName-usr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Don&#39;t update if former is user-defined and ForceUpdate is False</span>
            <span class="c1"># Override if previous was:</span>
            <span class="c1"># automatic or (user-defined but ForceUpdate is True)</span>
            <span class="n">C0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName-usr&#39;</span><span class="p">]</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName-usr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ForceUpdate</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">C0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">C1</span><span class="p">:</span>
                <span class="n">SN</span> <span class="o">=</span> <span class="n">ID</span><span class="o">.</span><span class="n">SaveName_Conv</span><span class="p">(</span><span class="n">Mod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Mod</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cls</span><span class="p">,</span>
                                      <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
                                      <span class="n">Deg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Deg</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
                                      <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                                      <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span>
                                      <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SN</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;SaveName-usr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ID.generate_SaveName"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID.generate_SaveName">[docs]</a>    <span class="k">def</span> <span class="nf">generate_SaveName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">SN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SaveName_Conv</span><span class="p">(</span><span class="n">Mod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Mod</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Cls</span><span class="p">,</span>
                              <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
                              <span class="n">Deg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Deg</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
                              <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                              <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">usr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">usr</span><span class="p">,</span>
                              <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SN</span></div>

<div class="viewcode-block" id="ID.set_lObj"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID.set_lObj">[docs]</a>    <span class="k">def</span> <span class="nf">set_lObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lObj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the lObj attribute, storing objects the instance depends on</span>

<span class="sd">        For example:</span>
<span class="sd">        A Detect object depends on a vessel and some apertures</span>
<span class="sd">        That link between should be stored somewhere (for saving/loading).</span>
<span class="sd">        lObj does this: it stores the ID (as dict) of all objects depended on.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lObj :  None / dict / :class:`~tofu.pathfile.ID` / list of such</span>
<span class="sd">            Provide either:</span>
<span class="sd">                - A dict (derived from :meth:`~tofu.pathfile.ID._todict`)</span>
<span class="sd">                - A :class:`~tofu.pathfile.ID` instance</span>
<span class="sd">                - A list of dict or :class:`~tofu.pathfile.ID` instances</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lObj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lObj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;lObj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">lObj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lObj</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">lObj</span> <span class="o">=</span> <span class="p">[</span><span class="n">lObj</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lObj</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lObj</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="ow">is</span> <span class="n">ID</span><span class="p">:</span>
                    <span class="n">lObj</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">lObj</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">ClsU</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">oo</span><span class="p">[</span><span class="s1">&#39;Cls&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">lObj</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ClsU</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;lObj&#39;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">lObj</span> <span class="k">if</span> <span class="n">oo</span><span class="p">[</span><span class="s1">&#39;Cls&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">c</span><span class="p">]</span></div>

<div class="viewcode-block" id="ID.set_dUSR"><a class="viewcode-back" href="../../tofu.html#tofu.utils.ID.set_dUSR">[docs]</a>    <span class="k">def</span> <span class="nf">set_dUSR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dUSR</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot; Set the dUSR, containing user-defined info about the instance</span>

<span class="sd">        Useful for arbitrary info (e.g.: manufacturing date, material...)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dUSR :   dict</span>
<span class="sd">            A user-defined dictionary containing info about the instance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;dUSR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dUSR</span></div></div>






<span class="c1">#############################################</span>
<span class="c1">#       Geometry</span>
<span class="c1">#############################################</span>

<div class="viewcode-block" id="dict_cmp"><a class="viewcode-back" href="../../tofu.html#tofu.utils.dict_cmp">[docs]</a><span class="k">def</span> <span class="nf">dict_cmp</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Different types: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)),</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d2</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span><span class="o">==</span><span class="nb">type</span><span class="p">(</span><span class="n">d2</span><span class="p">),</span> <span class="n">msg</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span><span class="o">==</span><span class="n">l2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d1</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">d2</span><span class="p">))</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">d1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">l1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">dict</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">]:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">dict_cmp</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span><span class="nb">type</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                    <span class="k">raise</span> <span class="n">err</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">out</span></div>



<span class="c1">###############################################</span>
<span class="c1">#           DChans</span>
<span class="c1">###############################################</span>


<div class="viewcode-block" id="DChans"><a class="viewcode-back" href="../../tofu.html#tofu.utils.DChans">[docs]</a><span class="k">class</span> <span class="nc">DChans</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class for handling event on tofu interactive figures &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dchans</span><span class="p">,</span> <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">fromdict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dchans</span><span class="p">,</span> <span class="n">nch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">dchans</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span> <span class="o">=</span> <span class="n">dchans</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nch</span> <span class="o">=</span> <span class="n">nch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fromdict</span><span class="p">(</span><span class="n">fromdict</span><span class="p">)</span>

<div class="viewcode-block" id="DChans._check_inputs"><a class="viewcode-back" href="../../tofu.html#tofu.utils.DChans._check_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">fd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
            <span class="k">elif</span> <span class="n">fd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">fd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">size</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
        <span class="n">nch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">ss</span> <span class="o">==</span> <span class="n">nch</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">size</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fd</span><span class="p">,</span> <span class="n">nch</span></div>

<div class="viewcode-block" id="DChans._todict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.DChans._todict">[docs]</a>    <span class="k">def</span> <span class="nf">_todict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span></div>


<div class="viewcode-block" id="DChans._fromdict"><a class="viewcode-back" href="../../tofu.html#tofu.utils.DChans._fromdict">[docs]</a>    <span class="k">def</span> <span class="nf">_fromdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="n">fd</span><span class="p">,</span> <span class="n">nch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span> <span class="o">=</span> <span class="n">fd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nch</span> <span class="o">=</span> <span class="n">nch</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dchans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the dchans dict &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the dchans dict &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nch</span>

<div class="viewcode-block" id="DChans.select"><a class="viewcode-back" href="../../tofu.html#tofu.utils.DChans.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The the indices of all channels matching the (key,val) pairs &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="s2">&quot;Arg out is not valid (int or bool) !&quot;</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">C0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_nch</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nch</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ind</span>

        <span class="n">lt0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
        <span class="n">lt1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lt0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">ll</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">log</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span><span class="p">,</span> <span class="s2">&quot;Arg out is not valid (&#39;any&#39;,&#39;all&#39; or an iterable) !&quot;</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">C2</span><span class="p">,</span> <span class="s2">&quot;Arg key not valid: provide key of self.dchans&quot;</span>
        <span class="n">C4</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lt1</span>
        <span class="n">C5</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lt0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lt1</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">C4</span> <span class="ow">or</span> <span class="n">C5</span><span class="p">,</span> <span class="s2">&quot;Arg val not valid, should be in </span><span class="si">%s</span><span class="s2"> !&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">lt1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">C4</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
        <span class="n">nv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">vv</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># To be finsihed: add operators and str operations + not</span>

        <span class="k">return</span> <span class="n">ind</span></div></div>


<span class="c1">###############################################</span>
<span class="c1">#           Plot KeyHandler 2</span>
<span class="c1">###############################################</span>


<div class="viewcode-block" id="get_indncurind"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_indncurind">[docs]</a><span class="k">def</span> <span class="nf">get_indncurind</span><span class="p">(</span><span class="n">dind</span><span class="p">,</span> <span class="n">linds</span><span class="p">):</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;lrefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">linds</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_indrefind"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_indrefind">[docs]</a><span class="k">def</span> <span class="nf">get_indrefind</span><span class="p">(</span><span class="n">dind</span><span class="p">,</span> <span class="n">linds</span><span class="p">,</span> <span class="n">drefid</span><span class="p">):</span>
    <span class="n">ninds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">linds</span><span class="p">)</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ninds</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ninds</span><span class="p">):</span>
        <span class="n">i0</span> <span class="o">=</span> <span class="n">dind</span><span class="p">[</span><span class="s1">&#39;lrefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">linds</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">dind</span><span class="p">[</span><span class="s1">&#39;cumsum0&#39;</span><span class="p">][</span><span class="n">i0</span><span class="p">]</span> <span class="o">+</span> <span class="n">drefid</span><span class="p">[</span><span class="n">linds</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">ind</span></div>


<div class="viewcode-block" id="get_valf"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_valf">[docs]</a><span class="k">def</span> <span class="nf">get_valf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">lrids</span><span class="p">,</span> <span class="n">linds</span><span class="p">):</span>
    <span class="c1"># Python 2 vs 3:</span>
    <span class="c1"># The order of arguments is reversed for lambda functions !</span>
    <span class="c1">#   =&gt; use py2 convention, compatible with both, WRONG !!!</span>
    <span class="c1"># Replace *li by li (which is always an array of max 3 elements</span>
    <span class="n">ninds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">linds</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ninds</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">lrids</span> <span class="o">==</span> <span class="n">linds</span>
        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">ninds</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">lrids</span> <span class="o">==</span> <span class="n">linds</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="c1"># Python 2 and 3 syntax</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">n1</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n1</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i1</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i2</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lrids</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="n">ninds</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lrids</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lrids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ninds</span> <span class="ow">and</span> <span class="n">ndim</span> <span class="o">&gt;=</span> <span class="n">ninds</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Wrong dimension / shape / references!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    val.ndim  : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    lrids     : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lrids</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    len(linds): </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ninds</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="n">ninds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span>  <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

            <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">li</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">li</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="n">lrids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">linds</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ninds</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>

                    <span class="k">elif</span> <span class="n">lord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[:,</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                <span class="k">elif</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">],:,:]</span>

                    <span class="k">elif</span> <span class="n">lord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[:,</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span>

                    <span class="k">elif</span> <span class="n">lord</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[:,:,</span><span class="n">li</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">elif</span> <span class="n">ninds</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lord</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lord</span><span class="p">[</span><span class="n">args</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span>  <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">li</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]],:]</span>

                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lord</span><span class="p">[</span><span class="n">args</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span>  <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="n">li</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">:,</span> <span class="n">li</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lord</span><span class="p">[</span><span class="n">args</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">li</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[:,</span> <span class="n">li</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">li</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>

    <span class="k">return</span> <span class="n">func</span></div>

<div class="viewcode-block" id="get_fupdate"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_fupdate">[docs]</a><span class="k">def</span> <span class="nf">get_fupdate</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">n12</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bstr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;xdata&#39;</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_xdata</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;ydata&#39;</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_ydata</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>   <span class="c1"># Also works for imshow</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;data-reshape&#39;</span><span class="p">]:</span>   <span class="c1"># Also works for imshow</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">n12</span><span class="o">=</span><span class="n">n12</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n12</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">n12</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]:</span>   <span class="c1"># Also works for imshow</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">bstr</span><span class="o">=</span><span class="n">bstr</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">bstr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f</span></div>


<div class="viewcode-block" id="get_ind_frompos"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_ind_frompos">[docs]</a><span class="k">def</span> <span class="nf">get_ind_frompos</span><span class="p">(</span><span class="n">Type</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">otherid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indother</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;2d&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">otherid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ref</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ref</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref</span><span class="o">-</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref</span><span class="o">-</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                        <span class="k">return</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">refb</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refb</span><span class="o">=</span><span class="n">refb</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">refb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refb</span><span class="o">=</span><span class="n">refb</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">refb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">indother</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ref</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ind0</span><span class="p">,:]</span><span class="o">-</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref</span><span class="p">[:,</span><span class="n">ind0</span><span class="p">]</span><span class="o">-</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                        <span class="n">refb</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ind0</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref</span><span class="p">[</span><span class="n">ind0</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">refb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                        <span class="n">refb</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ind0</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref</span><span class="p">[</span><span class="n">ind0</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">refb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ref</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">indother</span><span class="o">=</span><span class="n">indother</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">indother</span><span class="p">[</span><span class="n">ind0</span><span class="p">],:]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">indother</span><span class="o">=</span><span class="n">indother</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">indother</span><span class="p">[</span><span class="n">ind0</span><span class="p">],:]</span> <span class="o">-</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">indother</span><span class="o">=</span><span class="n">indother</span><span class="p">):</span>
                        <span class="n">refb</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">indother</span><span class="p">[</span><span class="n">ind0</span><span class="p">],</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref</span><span class="p">[</span><span class="n">indother</span><span class="p">[</span><span class="n">ind0</span><span class="p">],:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">refb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">indother</span><span class="o">=</span><span class="n">indother</span><span class="p">):</span>
                        <span class="n">refb</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">indother</span><span class="p">[</span><span class="n">ind0</span><span class="p">],</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref</span><span class="p">[</span><span class="n">indother</span><span class="p">[</span><span class="n">ind0</span><span class="p">],:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">refb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">ref2</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rr</span><span class="p">))</span> <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">ref2</span><span class="p">]):</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2</span><span class="o">=</span><span class="n">ref2</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span><span class="p">):</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">return</span> <span class="n">i2</span><span class="o">*</span><span class="n">n1</span> <span class="o">+</span> <span class="n">i1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refb1</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">refb2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refb1</span><span class="o">=</span><span class="n">refb1</span><span class="p">,</span> <span class="n">refb2</span><span class="o">=</span><span class="n">refb2</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span><span class="p">):</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">refb1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">([</span><span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">refb2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">i2</span><span class="o">*</span><span class="n">n1</span> <span class="o">+</span> <span class="n">i1</span>
    <span class="k">return</span> <span class="n">func</span></div>

<div class="viewcode-block" id="get_pos_fromind"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_pos_fromind">[docs]</a><span class="k">def</span> <span class="nf">get_pos_fromind</span><span class="p">(</span><span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">otherid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indother</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ref2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">ref2</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ref2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2</span><span class="o">=</span><span class="n">ref2</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">%</span> <span class="n">n1</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">//</span> <span class="n">n1</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i1</span><span class="p">],</span> <span class="n">ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i2</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">otherid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ref</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">indother</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="n">ind0</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">ind0</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">indother</span><span class="o">=</span><span class="n">indother</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="n">indother</span><span class="p">[</span><span class="n">ind0</span><span class="p">],</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span></div>

<div class="viewcode-block" id="get_ind_fromkey"><a class="viewcode-back" href="../../tofu.html#tofu.utils.get_ind_fromkey">[docs]</a><span class="k">def</span> <span class="nf">get_ind_fromkey</span><span class="p">(</span><span class="n">dmovkeys</span><span class="o">=</span><span class="p">{},</span> <span class="n">nn</span><span class="o">=</span><span class="p">[],</span> <span class="n">is2d</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">is2d</span><span class="p">:</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">nn</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">movk</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">doinc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dmovkeys</span><span class="o">=</span><span class="n">dmovkeys</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span><span class="p">):</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">%</span> <span class="n">n1</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">//</span> <span class="n">n1</span>
            <span class="k">if</span> <span class="n">movk</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="s1">&#39;right&#39;</span><span class="p">]:</span>
                <span class="n">i1</span> <span class="o">+=</span> <span class="n">dmovkeys</span><span class="p">[</span><span class="n">movk</span><span class="p">][</span><span class="n">doinc</span><span class="p">]</span>
                <span class="n">i1</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">%</span> <span class="n">n1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i2</span> <span class="o">+=</span> <span class="n">dmovkeys</span><span class="p">[</span><span class="n">movk</span><span class="p">][</span><span class="n">doinc</span><span class="p">]</span>
                <span class="n">i2</span> <span class="o">=</span> <span class="n">i2</span> <span class="o">%</span> <span class="n">n2</span>
            <span class="k">return</span> <span class="n">i2</span> <span class="o">*</span> <span class="n">n1</span> <span class="o">+</span> <span class="n">i1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">nn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">nn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">movk</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">doinc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dmovkeys</span><span class="o">=</span><span class="n">dmovkeys</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">):</span>
            <span class="n">ind</span> <span class="o">+=</span> <span class="n">dmovkeys</span><span class="p">[</span><span class="n">movk</span><span class="p">][</span><span class="n">doinc</span><span class="p">]</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">%</span> <span class="n">nx</span>
            <span class="k">return</span> <span class="n">ind</span>
    <span class="k">return</span> <span class="n">func</span></div>




<div class="viewcode-block" id="KeyHandler_mpl"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl">[docs]</a><span class="k">class</span> <span class="nc">KeyHandler_mpl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">_msgdobj</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; Arg dobj must be a dict</span>
<span class="s2">    The keys are handles to matplotlib Artist objects (e.g.: lines, imshow...)</span>

<span class="s2">    For each object oo, dobj[oo] is itself a dict with (key,value) pairs:</span>
<span class="s2">        - &#39;ref&#39;   : a 1D flat np.ndarray, used as reference</span>
<span class="s2">        - &#39;lgroup&#39;: list of int, indicating to which groups of indices oo belongs</span>
<span class="s2">        - &#39;lind&#39;  : list of int, indicating the index of oo in each group</span>
<span class="s2">        - &#39;update&#39;: a callable (function), to be called when updating</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">_ltypesref</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;2d&#39;</span><span class="p">]</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">can</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lax_fix</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">groupinit</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">follow</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">can</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">backend_bases</span><span class="o">.</span><span class="n">FigureCanvasBase</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can</span> <span class="o">=</span> <span class="n">can</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_dgrouprefaxobj</span><span class="p">(</span><span class="n">dgroup</span><span class="p">,</span> <span class="n">dref</span><span class="p">,</span> <span class="n">dobj</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">ddata</span><span class="p">)</span>
        <span class="n">dgroup</span><span class="p">,</span> <span class="n">dref</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">dobj</span><span class="p">,</span> <span class="n">dind</span><span class="p">,</span> <span class="n">ddata</span> <span class="o">=</span> <span class="n">out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span> <span class="o">=</span> <span class="n">dgroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dref</span> <span class="o">=</span> <span class="n">dref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddata</span> <span class="o">=</span> <span class="n">ddata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dax</span> <span class="o">=</span> <span class="n">dax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dind</span> <span class="o">=</span> <span class="n">dind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">ax</span><span class="p">,{</span><span class="s1">&#39;fix&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;lobj&#39;</span><span class="p">:[]})</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">lax_fix</span>
                              <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">()]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span> <span class="o">=</span> <span class="n">dobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dcur_init</span><span class="p">(</span><span class="n">dgroup</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">groupinit</span><span class="p">)</span>
        <span class="n">dkeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dkeys</span><span class="p">()</span>
        <span class="n">lact</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dkeys</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">dkeys_r</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">aa</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dkeys</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">dkeys</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;action&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">aa</span><span class="p">])</span>
                             <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">lact</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span> <span class="o">=</span> <span class="n">dkeys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dkeys_r</span> <span class="o">=</span> <span class="n">dkeys_r</span>
        <span class="c1">#self.init(dgroup=dgroup, dobj=dobj)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isinteractive</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">can</span><span class="p">,</span><span class="s1">&#39;toolbar&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">can</span><span class="o">.</span><span class="n">toolbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_follow</span> <span class="o">=</span> <span class="n">follow</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dBck</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="KeyHandler_mpl._get_dcur_init"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._get_dcur_init">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_dcur_init</span><span class="p">(</span><span class="n">dgroup</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">groupinit</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">groupinit</span> <span class="ow">in</span> <span class="n">dgroup</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg groupinit must be a valid key of dgroup !</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Valid keys: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dgroup</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided  : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">groupinit</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">refid</span> <span class="o">=</span> <span class="n">dgroup</span><span class="p">[</span><span class="n">groupinit</span><span class="p">][</span><span class="s1">&#39;defid&#39;</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">dgroup</span><span class="p">[</span><span class="n">groupinit</span><span class="p">][</span><span class="s1">&#39;defax&#39;</span><span class="p">]</span>
        <span class="n">dcur</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;refid&#39;</span><span class="p">:</span><span class="n">refid</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span><span class="n">groupinit</span><span class="p">,</span> <span class="s1">&#39;ax&#39;</span><span class="p">:</span><span class="n">ax</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">dcur</span></div>

<div class="viewcode-block" id="KeyHandler_mpl._warn_ifnotInteractive"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._warn_ifnotInteractive">[docs]</a>    <span class="k">def</span> <span class="nf">_warn_ifnotInteractive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isinteractive</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not interactive backend!:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - backend : </span><span class="si">%s</span><span class="s2">   (prefer Qt5Agg)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">plt</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - canvas  : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">warn</span></div>

<div class="viewcode-block" id="KeyHandler_mpl._get_dmovkeys"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._get_dmovkeys">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_dmovkeys</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">inc</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">Type</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ltypesref</span>
        <span class="k">if</span> <span class="n">Type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="n">dmovkeys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;left&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="o">-</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="o">-</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
                        <span class="s1">&#39;right&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]}}</span>
        <span class="k">elif</span> <span class="n">Type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">dmovkeys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;down&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="o">-</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="o">-</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
                        <span class="s1">&#39;up&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]}}</span>
        <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s1">&#39;2d&#39;</span><span class="p">:</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">dmovkeys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;left&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
                        <span class="s1">&#39;right&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
                        <span class="s1">&#39;down&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="o">-</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span>
                        <span class="s1">&#39;up&#39;</span><span class="p">:{</span><span class="kc">False</span><span class="p">:</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">:</span><span class="n">sig</span><span class="o">*</span><span class="n">inc</span><span class="p">[</span><span class="mi">1</span><span class="p">]}}</span>
        <span class="k">return</span> <span class="n">dmovkeys</span></div>

<div class="viewcode-block" id="KeyHandler_mpl._checkformat_dgrouprefaxobj"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._checkformat_dgrouprefaxobj">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_dgrouprefaxobj</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dgroup</span><span class="p">,</span> <span class="n">dref</span><span class="p">,</span> <span class="n">dobj</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">ddata</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dgroup</span><span class="p">,</span> <span class="n">dref</span><span class="p">,</span> <span class="n">dobj</span><span class="p">,</span> <span class="n">dax</span><span class="p">]])</span>

        <span class="c1">#---------------</span>
        <span class="c1"># Preliminary checks</span>

        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nMax&#39;</span><span class="p">,</span><span class="s1">&#39;key&#39;</span><span class="p">,</span><span class="s1">&#39;defax&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dgroup</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">and</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_msgdobj</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;nMax&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span>
            <span class="k">assert</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;defax&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">lg</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dgroup</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lg</span><span class="p">))</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">lg</span><span class="p">)</span>

        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">,</span><span class="s1">&#39;refids&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">and</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_msgdobj</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">dref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;refids&#39;</span><span class="p">]])</span>
        <span class="n">ldid</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ldid</span><span class="p">))</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">ldid</span><span class="p">)</span>

        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span><span class="s1">&#39;val&#39;</span><span class="p">,</span><span class="s1">&#39;inc&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dref</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">and</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_msgdobj</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lg</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">tuple</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;inc&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">v</span><span class="p">[</span><span class="s1">&#39;inc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;inc&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">lrid</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dref</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="p">[</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lrid</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lrid</span><span class="p">))</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">lrid</span><span class="p">)</span>

        <span class="n">ls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ltypesref</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dax</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="s1">&#39;ref&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="n">c3</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">ls</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="n">c4</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">kk</span> <span class="ow">in</span> <span class="n">lrid</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">c3</span><span class="p">,</span><span class="n">c4</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;defrefid&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;defrefid&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lrid</span>
        <span class="n">la</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">la</span><span class="p">))</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>

        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dupdate&#39;</span><span class="p">,</span><span class="s1">&#39;drefid&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dobj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">mpl</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">Artist</span><span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">and</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">lrid</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;drefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">dobj</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">axes</span>
            <span class="k">if</span> <span class="n">dobj</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dax</span><span class="p">[</span><span class="n">dobj</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;ax&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fix&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">:{}}</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dobj</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lo</span><span class="p">))</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">lo</span><span class="p">)</span>

        <span class="c1">#---------------</span>
        <span class="c1"># Complement</span>

        <span class="c1"># dax</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">lobj</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">dobj</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ax</span><span class="p">]</span>
            <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;lobj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lobj</span>
            <span class="k">if</span> <span class="s1">&#39;invert&#39;</span> <span class="ow">in</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;invert&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">bool</span>
                <span class="k">assert</span> <span class="s1">&#39;2d&#39;</span> <span class="ow">in</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;invert&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Handle cases were several ref are associated to the same typ</span>
            <span class="n">lrefid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">ltypu</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            <span class="n">dtypu</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">typ</span><span class="p">,[</span><span class="n">rid</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lrefid</span>
                                <span class="k">if</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">]</span> <span class="o">==</span> <span class="n">typ</span><span class="p">])</span>
                         <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">ltypu</span><span class="p">])</span>
            <span class="c1"># Check unicity of graphical ref</span>
            <span class="k">if</span> <span class="s1">&#39;graph&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dtypu</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
                <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">dtypu</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtypu</span><span class="p">[</span><span class="n">typ</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">rid</span> <span class="ow">in</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                       <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">dtypu</span><span class="p">[</span><span class="n">typ</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">][</span><span class="n">dtypu</span><span class="p">[</span><span class="n">typ</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">typ</span>

            <span class="c1"># func dict</span>
            <span class="n">dmovkeys</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lrefid</span><span class="p">:</span>
                <span class="n">dmovkeys</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_dmovkeys</span><span class="p">(</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">],</span>
                                                  <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;inc&#39;</span><span class="p">],</span>
                                                  <span class="n">invert</span><span class="o">=</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;invert&#39;</span><span class="p">])</span>
            <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;dmovkeys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmovkeys</span>

            <span class="c1"># Find default refid for ax (in case of ref from several groups)</span>
            <span class="n">lrefid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lrefid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="s1">&#39;defrefid&#39;</span> <span class="ow">in</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;defrefid&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lrefid</span>


        <span class="c1"># dgroup</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">lg</span><span class="p">:</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;valind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;nMax&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">lridg</span> <span class="o">=</span> <span class="p">[</span><span class="n">rid</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lrid</span> <span class="k">if</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">]</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;lrefid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lridg</span>
            <span class="c1"># To catch cross-dependencies:</span>
            <span class="c1"># All axes of all objects with a group dependency</span>
            <span class="n">lla</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">lo</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">g</span>
                        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;drefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]):</span>
                    <span class="k">if</span> <span class="n">dobj</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lla</span><span class="p">:</span>
                        <span class="n">lla</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">o</span><span class="p">][</span><span class="s1">&#39;ax&#39;</span><span class="p">])</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;lax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lla</span>

            <span class="c1"># Set defid</span>
            <span class="n">ldefid</span> <span class="o">=</span> <span class="n">dax</span><span class="p">[</span><span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;defax&#39;</span><span class="p">]][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">ldefid</span> <span class="o">=</span> <span class="p">[</span><span class="n">defid</span> <span class="k">for</span> <span class="n">defid</span> <span class="ow">in</span> <span class="n">ldefid</span> <span class="k">if</span> <span class="n">dref</span><span class="p">[</span><span class="n">defid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldefid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;defid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldefid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Get list of obj with their indices, for fast updates</span>
            <span class="n">lobj</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">dobj</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span>
                            <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;drefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])]</span>
            <span class="n">nobj</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lobj</span><span class="p">)</span>
            <span class="n">lind</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">lobj</span><span class="p">:</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">rid</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;drefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                      <span class="k">if</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Case when same group refered to via several refs</span>
                    <span class="c1"># Only works if consistent indices !</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">iii</span><span class="o">==</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">iii</span> <span class="ow">in</span> <span class="n">ii</span><span class="p">])</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">lind</span> <span class="o">+=</span> <span class="n">ii</span>
            <span class="n">lindu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lind</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lindu</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">lindu</span> <span class="o">&lt;</span> <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;nMax&#39;</span><span class="p">])</span>
            <span class="n">d2obj</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">ind</span><span class="p">,</span> <span class="p">[</span><span class="n">lobj</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nobj</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="n">ind</span><span class="p">])</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">lindu</span><span class="p">])</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;d2obj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2obj</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;lobj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lobj</span>


        <span class="c1"># dref</span>
        <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lrid</span><span class="p">:</span>
            <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dgroup</span><span class="p">[</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]][</span><span class="s1">&#39;nMax&#39;</span><span class="p">],),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

            <span class="c1"># Check consistency of otherid and indother</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="s1">&#39;indother&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;indother&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;otherid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span>
                <span class="k">assert</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span>
                <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;indother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">otherid</span> <span class="o">=</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">otherid</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">otherid</span> <span class="ow">in</span> <span class="n">dref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">otherid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span>
                    <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                        <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;indother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">dref</span><span class="p">[</span><span class="n">otherid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
                        <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                            <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;indother&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;indother&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>

            <span class="c1"># Get nn</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>

            <span class="c1"># Check if is2d</span>
            <span class="n">ltypes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">ltypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">])</span>
            <span class="n">ltypes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ltypes</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">ltypes</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;2d&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">&#39;2d&#39;</span> <span class="ow">in</span> <span class="n">ltypes</span>
            <span class="n">is2d</span> <span class="o">=</span> <span class="s1">&#39;2d&#39;</span> <span class="ow">in</span> <span class="n">ltypes</span>
            <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;is2d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">is2d</span>

            <span class="c1"># Get functions</span>
            <span class="n">otherid</span> <span class="o">=</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]</span>
            <span class="n">indother</span> <span class="o">=</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;indother&#39;</span><span class="p">]</span>
            <span class="n">df_ind_pos</span><span class="p">,</span> <span class="n">df_ind_key</span><span class="p">,</span> <span class="n">df_pos_ind</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;ref&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;2d&#39;</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="s1">&#39;2d&#39;</span> <span class="ow">in</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="n">val2</span> <span class="o">=</span> <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;2d&#39;</span><span class="p">]</span>
                        <span class="n">is2d</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">nn</span> <span class="o">=</span> <span class="p">(</span><span class="n">val2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">val2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val2</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">is2d</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                            <span class="n">nn</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">nn</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">),)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown val type !&quot;</span><span class="p">)</span>
                    <span class="n">df_ind_pos</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_ind_frompos</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span>
                                                     <span class="n">otherid</span> <span class="o">=</span> <span class="n">otherid</span><span class="p">,</span>
                                                     <span class="n">indother</span> <span class="o">=</span> <span class="n">indother</span><span class="p">)</span>
                    <span class="n">dmovkeys</span> <span class="o">=</span> <span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;dmovkeys&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">]</span>

                    <span class="n">df_ind_key</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_ind_fromkey</span><span class="p">(</span><span class="n">dmovkeys</span><span class="p">,</span>
                                                     <span class="n">is2d</span> <span class="o">=</span> <span class="n">is2d</span><span class="p">,</span>
                                                     <span class="n">nn</span> <span class="o">=</span> <span class="n">nn</span><span class="p">)</span>
                    <span class="n">df_pos_ind</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_pos_fromind</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span>
                                                     <span class="n">otherid</span> <span class="o">=</span> <span class="n">otherid</span><span class="p">,</span>
                                                     <span class="n">indother</span> <span class="o">=</span> <span class="n">indother</span><span class="p">)</span>

            <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;df_ind_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ind_pos</span>
            <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;df_ind_key&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_ind_key</span>
            <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;df_pos_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pos_ind</span>

            <span class="c1"># lobj</span>
            <span class="n">lobj</span> <span class="o">=</span> <span class="p">[</span><span class="n">oo</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">dobj</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;drefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;lobj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lobj</span>

        <span class="c1"># dind</span>
        <span class="n">lref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dref</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">nref</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lref</span><span class="p">)</span>
        <span class="n">ancur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="n">nref</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ancur</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dgroup</span><span class="p">[</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]][</span><span class="s1">&#39;nMax&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lref</span><span class="p">]</span>
        <span class="n">cumsum0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">ancur</span><span class="p">[</span><span class="mi">1</span><span class="p">,:])]</span>
        <span class="n">arefind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ancur</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]),),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">dind</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lrefid&#39;</span><span class="p">:</span><span class="n">lref</span><span class="p">,</span> <span class="s1">&#39;anMaxcur&#39;</span><span class="p">:</span><span class="n">ancur</span><span class="p">,</span> <span class="s1">&#39;arefind&#39;</span><span class="p">:</span><span class="n">arefind</span><span class="p">,</span>
                <span class="s1">&#39;cumsum0&#39;</span><span class="p">:</span><span class="n">cumsum0</span><span class="p">}</span>

        <span class="c1"># dobj</span>
        <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">dobj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># get functions to update</span>
            <span class="n">lrefid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;drefid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Check consistency with ddata</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dref</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Missing id in ddata or dref &quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;(vs dobj[idobj][&#39;dupdate&#39;][k][&#39;id&#39;]) !</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    idobj: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">oo</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    k    : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">k</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    id   : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="n">ddata</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">dref</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">]}</span>
                    <span class="k">if</span> <span class="n">dref</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ddata</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;refids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ddata</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;refids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dref</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;otherid&#39;</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span>

                <span class="c1"># get update tools</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ddata</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
                <span class="n">lrefs</span> <span class="o">=</span> <span class="n">ddata</span><span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]][</span><span class="s1">&#39;refids&#39;</span><span class="p">]</span>
                <span class="n">linds</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;lrid&#39;</span><span class="p">]</span>
                <span class="n">fgetval</span> <span class="o">=</span> <span class="n">get_valf</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">lrefs</span><span class="p">,</span> <span class="n">linds</span><span class="p">)</span>

                <span class="n">lkv</span> <span class="o">=</span> <span class="p">[(</span><span class="n">kk</span><span class="p">,</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">kk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;lrid&#39;</span><span class="p">]]</span>
                <span class="n">fupdate</span> <span class="o">=</span> <span class="n">get_fupdate</span><span class="p">(</span><span class="n">oo</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">lkv</span><span class="p">))</span>
                <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;fgetval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fgetval</span>
                <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;fupdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fupdate</span>
                <span class="n">indrefind</span> <span class="o">=</span> <span class="n">get_indrefind</span><span class="p">(</span><span class="n">dind</span><span class="p">,</span> <span class="n">linds</span><span class="p">,</span> <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;drefid&#39;</span><span class="p">])</span>
                <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;indrefind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indrefind</span>

            <span class="c1"># linds not necessarily identical !</span>
            <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;aindvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;drefid&#39;</span><span class="p">][</span><span class="n">rid</span><span class="p">]</span>
                                            <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lrefid</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">indncurind</span> <span class="o">=</span> <span class="n">get_indncurind</span><span class="p">(</span><span class="n">dind</span><span class="p">,</span> <span class="n">lrefid</span><span class="p">)</span>
            <span class="n">dobj</span><span class="p">[</span><span class="n">oo</span><span class="p">][</span><span class="s1">&#39;indncurind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indncurind</span>

        <span class="k">return</span> <span class="n">dgroup</span><span class="p">,</span> <span class="n">dref</span><span class="p">,</span> <span class="n">dax</span><span class="p">,</span> <span class="n">dobj</span><span class="p">,</span> <span class="n">dind</span><span class="p">,</span> <span class="n">ddata</span></div>


<div class="viewcode-block" id="KeyHandler_mpl._get_dkeys"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._get_dkeys">[docs]</a>    <span class="k">def</span> <span class="nf">_get_dkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dkeys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shift&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;generic&#39;</span><span class="p">},</span>
                 <span class="s1">&#39;control&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;generic&#39;</span><span class="p">},</span>
                 <span class="s1">&#39;ctrl&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;generic&#39;</span><span class="p">},</span>
                 <span class="s1">&#39;alt&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;generic&#39;</span><span class="p">},</span>
                 <span class="s1">&#39;left&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;move&#39;</span><span class="p">},</span>
                 <span class="s1">&#39;right&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;move&#39;</span><span class="p">},</span>
                 <span class="s1">&#39;up&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;move&#39;</span><span class="p">},</span>
                 <span class="s1">&#39;down&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;move&#39;</span><span class="p">}}</span>
                 <span class="c1"># &#39;pageup&#39;:{&#39;val&#39;:False, &#39;action&#39;:&#39;move&#39;},</span>
                 <span class="c1"># &#39;pagedown&#39;:{&#39;val&#39;:False, &#39;action&#39;:&#39;move&#39;}}</span>
        <span class="n">dkeys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],{</span><span class="s1">&#39;group&#39;</span><span class="p">:</span><span class="n">k</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;group&#39;</span><span class="p">})</span>
                           <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;nMax&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="n">dkeys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">([(</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">),{</span><span class="s1">&#39;ind&#39;</span><span class="p">:</span><span class="n">ii</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;action&#39;</span><span class="p">:</span><span class="s1">&#39;indices&#39;</span><span class="p">})</span>
                          <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nMax</span><span class="p">)]))</span>
        <span class="k">return</span> <span class="n">dkeys</span></div>

<div class="viewcode-block" id="KeyHandler_mpl.disconnect_old"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.disconnect_old">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_ifnotInteractive</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">key_press_handler_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="s1">&#39;keymap&#39;</span> <span class="ow">in</span> <span class="n">kk</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">store_rcParams</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">kd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store_rcParams</span><span class="p">[</span><span class="n">kd</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kd</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="n">kk</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">store_rcParams</span><span class="p">[</span><span class="n">kd</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">kd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">button_pick_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="KeyHandler_mpl.reconnect_old"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.reconnect_old">[docs]</a>    <span class="k">def</span> <span class="nf">reconnect_old</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_ifnotInteractive</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_rcParams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_rcParams</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">store_rcParams</span><span class="p">[</span><span class="n">kk</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">kd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="n">kk</span><span class="p">]:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kd</span><span class="p">)</span></div>

<div class="viewcode-block" id="KeyHandler_mpl.connect"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_ifnotInteractive</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">keyp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onkeypress</span><span class="p">)</span>
        <span class="n">keyr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;key_release_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onkeypress</span><span class="p">)</span>
        <span class="n">butp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mouseclic</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;resize_event&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">)</span>
        <span class="c1">#butr = self.can.mpl_connect(&#39;button_release_event&#39;, self.mouserelease)</span>
        <span class="c1">#if not plt.get_backend() == &quot;agg&quot;:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mouserelease</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cid</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;keyp&#39;</span><span class="p">:</span><span class="n">keyp</span><span class="p">,</span> <span class="s1">&#39;keyr&#39;</span><span class="p">:</span><span class="n">keyr</span><span class="p">,</span> <span class="s1">&#39;butp&#39;</span><span class="p">:</span><span class="n">butp</span><span class="p">,</span> <span class="s1">&#39;res&#39;</span><span class="p">:</span><span class="n">res</span><span class="p">}</span><span class="c1">#, &#39;butr&#39;:butr}</span></div>

<div class="viewcode-block" id="KeyHandler_mpl.disconnect"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warn_ifnotInteractive</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cid</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">mpl_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cid</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">release</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">event</span><span class="p">:</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="KeyHandler_mpl.resize"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.resize">[docs]</a>    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dBck</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="KeyHandler_mpl._set_dBck"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._set_dBck">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dBck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lax</span><span class="p">):</span>
        <span class="c1"># Make all invisible</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">lax</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;lobj&#39;</span><span class="p">]:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Draw and reset Bck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">lax</span><span class="p">:</span>
            <span class="c1">#ax.draw(self.can.renderer)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;Bck&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">copy_from_bbox</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>

        <span class="c1"># Redraw</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">lax</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;lobj&#39;</span><span class="p">]:</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;vis&#39;</span><span class="p">])</span>
                <span class="c1">#ax.draw(self.can.renderer)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>

<div class="viewcode-block" id="KeyHandler_mpl.init"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ngroup</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dobj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="KeyHandler_mpl.update"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excluderef</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dcur</span><span class="p">()</span> <span class="c1"># 0.4 ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dref</span><span class="p">(</span><span class="n">excluderef</span><span class="o">=</span><span class="n">excluderef</span><span class="p">)</span>    <span class="c1"># 0.1 ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_dobj</span><span class="p">()</span> <span class="c1"># 0.2 s</span></div>

<div class="viewcode-block" id="KeyHandler_mpl._update_dcur"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._update_dcur">[docs]</a>    <span class="k">def</span> <span class="nf">_update_dcur</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
        <span class="n">refid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span>
        <span class="k">assert</span> <span class="n">refid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># Update also dind !</span>
        <span class="n">an</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]][</span><span class="s1">&#39;ncur&#39;</span><span class="p">]</span>
              <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;lrefid&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;anMaxcur&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">an</span>

        <span class="c1"># Update array ncur</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;lobj&#39;</span><span class="p">]:</span>
            <span class="n">a0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;anMaxcur&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;indncurind&#39;</span><span class="p">]]</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;aindvis&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">a0</span> <span class="o">&gt;=</span> <span class="n">a1</span> <span class="p">)</span></div>


<div class="viewcode-block" id="KeyHandler_mpl._update_dref"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._update_dref">[docs]</a>    <span class="k">def</span> <span class="nf">_update_dref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">excluderef</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;valind&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">,:]</span>

        <span class="k">if</span> <span class="n">excluderef</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;lrefid&#39;</span><span class="p">])</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;lrefid&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">rid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">indother</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">group2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
                    <span class="n">ind2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group2</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span>
                    <span class="n">indother</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ind2</span><span class="p">]</span>
                <span class="n">lax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;df_ind_pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A ref has no associated ax !</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - group: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">group</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - rid  : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">rid</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;df_ind_pos&#39;</span><span class="p">][</span><span class="n">lax</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">val</span><span class="p">,</span> <span class="n">indother</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_follow</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ii</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;lrefid&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">indother</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">group2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
                    <span class="n">ind2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group2</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span>
                    <span class="n">indother</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ind2</span><span class="p">]</span>
                <span class="n">lax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;df_ind_pos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A ref has no associated ax !</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - group: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">group</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - rid  : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">rid</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;df_ind_pos&#39;</span><span class="p">][</span><span class="n">lax</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">val</span><span class="p">,</span> <span class="n">indother</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_follow</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ii</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>

        <span class="c1"># Update dind[&#39;arefind&#39;]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;lrefid&#39;</span><span class="p">])):</span>
            <span class="n">rid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;lrefid&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;cumsum0&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">i0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]][</span><span class="s1">&#39;nMax&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;arefind&#39;</span><span class="p">][</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="KeyHandler_mpl._update_dobj"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl._update_dobj">[docs]</a>    <span class="k">def</span> <span class="nf">_update_dobj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># --- Prepare ----- 2 us</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
        <span class="n">refid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
        <span class="n">indcur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span>
        <span class="n">lax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;lax&#39;</span><span class="p">]</span>

        <span class="c1"># ---- Restore backgrounds ---- 1 ms</span>
        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">lax</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">restore_region</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">aa</span><span class="p">][</span><span class="s1">&#39;Bck&#39;</span><span class="p">])</span>

        <span class="c1"># ---- update data of group objects ----  0.15 s</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;d2obj&#39;</span><span class="p">][</span><span class="n">indcur</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;indrefind&#39;</span><span class="p">]</span>  <span class="c1"># 20 us</span>
                <span class="n">li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dind</span><span class="p">[</span><span class="s1">&#39;arefind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>   <span class="c1"># 50 us</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;fgetval&#39;</span><span class="p">](</span> <span class="n">li</span> <span class="p">)</span>    <span class="c1"># 0.0001 s</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;dupdate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;fupdate&#39;</span><span class="p">](</span> <span class="n">val</span> <span class="p">)</span>  <span class="c1"># 2 ms</span>

        <span class="c1"># --- Redraw all objects (due to background restore) --- 25 ms</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;vis&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dobj</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">draw_artist</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># ---- blit axes ------ 5 ms</span>
        <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">lax</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span></div>

<div class="viewcode-block" id="KeyHandler_mpl.mouseclic"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.mouseclic">[docs]</a>    <span class="k">def</span> <span class="nf">mouseclic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="c1"># Check click is relevant</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">C0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">curax_panzoom</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span>   <span class="c1"># DB ?</span>

        <span class="c1"># Check axes is relevant and toolbar not active</span>
        <span class="n">c_activeax</span> <span class="o">=</span> <span class="s1">&#39;fix&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">inaxes</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">c_toolbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_active</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">False</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">c_activeax</span><span class="p">,</span><span class="n">c_toolbar</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="c1"># Set self.dcur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">inaxes</span>
        <span class="n">lrid</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">inaxes</span><span class="p">][</span><span class="s1">&#39;graph&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lrid</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">lg</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">rid</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rid</span> <span class="ow">in</span> <span class="n">lrid</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lg</span><span class="p">:</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="n">lrid</span><span class="p">[</span><span class="n">lg</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">])]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">inaxes</span><span class="p">][</span><span class="s1">&#39;defrefid&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rid</span><span class="o">=</span> <span class="n">lrid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>

        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span>
        <span class="n">refid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>

        <span class="c1"># Check max number of occurences not reached if shift</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
              <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;nMax&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Max nb. of plots reached (</span><span class="si">{0}</span><span class="s2">) for group </span><span class="si">{1}</span><span class="s2">&quot;</span>
            <span class="n">msg</span>  <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;nMax&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Update indcur</span>
        <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;ctrl&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ctrl</span><span class="p">:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">nn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">])</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">])</span>

        <span class="c1"># Update dcur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>

        <span class="c1"># Update group val</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_follow</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;valind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;valind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">excluderef</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="KeyHandler_mpl.mouserelease"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.mouserelease">[docs]</a>    <span class="k">def</span> <span class="nf">mouserelease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Make sure you release the mouse button on an axes !&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Otherwise the background plot cannot be properly updated !&quot;</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_active</span> <span class="o">==</span> <span class="s1">&#39;PAN&#39;</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_active</span> <span class="o">==</span> <span class="s1">&#39;ZOOM&#39;</span>

        <span class="k">if</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curax_panzoom</span>
            <span class="k">assert</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">lax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_shared_x_axes</span><span class="p">()</span><span class="o">.</span><span class="n">get_siblings</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">lax</span> <span class="o">+=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_shared_y_axes</span><span class="p">()</span><span class="o">.</span><span class="n">get_siblings</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">lax</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lax</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dBck</span><span class="p">(</span><span class="n">lax</span><span class="p">)</span></div>


<div class="viewcode-block" id="KeyHandler_mpl.onkeypress"><a class="viewcode-back" href="../../tofu.html#tofu.utils.KeyHandler_mpl.onkeypress">[docs]</a>    <span class="k">def</span> <span class="nf">onkeypress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>

        <span class="n">lkey</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>

        <span class="n">c0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">can</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_active</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lkey</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lkey</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">c2</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">lgen</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys_r</span><span class="p">[</span><span class="s1">&#39;generic&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lkey</span><span class="p">]</span>
        <span class="n">lmov</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys_r</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lkey</span><span class="p">]</span>
        <span class="n">lgrp</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys_r</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lkey</span><span class="p">]</span>
        <span class="n">lind</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys_r</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lkey</span><span class="p">]</span>

        <span class="n">ngen</span><span class="p">,</span> <span class="n">nmov</span><span class="p">,</span> <span class="n">ngrp</span><span class="p">,</span> <span class="n">nind</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lgen</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lmov</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lgrp</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lind</span><span class="p">)</span>
        <span class="n">ln</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">ngen</span><span class="p">,</span> <span class="n">nmov</span><span class="p">,</span> <span class="n">ngrp</span><span class="p">,</span> <span class="n">nind</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ln</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ngrp</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">nind</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">genk</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">ngen</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">lgen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">movk</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">nmov</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">lmov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grpk</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">ngrp</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">lgrp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">indk</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">nind</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">lind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;key_release_event&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">genk</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="n">genk</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">genk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">genk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="n">genk</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">grpk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;defid&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;defax&#39;</span><span class="p">]</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">indk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
            <span class="n">indmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">]</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">&gt;</span> <span class="n">indmax</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Maximum allowed index for group </span><span class="si">{0}</span><span class="s2"> is </span><span class="si">{1}</span><span class="s2">, set to it&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">indmax</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">indmax</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">movk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
            <span class="n">refid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dcur</span><span class="p">[</span><span class="s1">&#39;ax&#39;</span><span class="p">]</span>

            <span class="c1"># # Debug</span>
            <span class="c1"># if refid not in self.dax[ax][&#39;dmovkeys&#39;].keys():    # DB</span>
                <span class="c1"># print(refid, self.dref[refid][&#39;group&#39;])  # DB</span>
                <span class="c1"># print(ax, self.dax[ax][&#39;dmovkeys&#39;]) # DB</span>

            <span class="k">if</span> <span class="n">movk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dax</span><span class="p">[</span><span class="n">ax</span><span class="p">][</span><span class="s1">&#39;dmovkeys&#39;</span><span class="p">][</span><span class="n">refid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span>

            <span class="c1"># Check max number of occurences not reached if shift</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
                  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;nMax&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Max nb. of plots reached (</span><span class="si">{0}</span><span class="s2">) for group </span><span class="si">{1}</span><span class="s2">&quot;</span>
                <span class="n">msg</span>  <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;nMax&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;control&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;ctrl&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ctrl</span><span class="p">:</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;shift&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]:</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">nn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">])</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">])</span>

            <span class="c1"># Update dcur</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;ncur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>

            <span class="c1"># Update refid ind</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;df_ind_key&#39;</span><span class="p">][</span><span class="n">ax</span><span class="p">](</span><span class="n">movk</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">dkeys</span><span class="p">[</span><span class="s1">&#39;alt&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_follow</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>

            <span class="c1"># Update group val</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indother</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
                <span class="n">ind2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group2</span><span class="p">][</span><span class="s1">&#39;indcur&#39;</span><span class="p">]</span>
                <span class="n">indother</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;otherid&#39;</span><span class="p">]][</span><span class="s1">&#39;ind&#39;</span><span class="p">][</span><span class="n">ind2</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dref</span><span class="p">[</span><span class="n">refid</span><span class="p">][</span><span class="s1">&#39;df_pos_ind&#39;</span><span class="p">][</span><span class="n">ax</span><span class="p">](</span> <span class="n">ind</span><span class="p">,</span> <span class="n">indother</span> <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_follow</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;valind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">:,:]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="s1">&#39;valind&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">val</span>

            <span class="c1"># Upadte all</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">excluderef</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>





<span class="c1">###################################################################</span>
<span class="c1">###################################################################</span>
<span class="c1">#       Start new abstract Data2DBase with indices for next version</span>
<span class="c1">###################################################################</span>

<div class="viewcode-block" id="Data2DBase"><a class="viewcode-back" href="../../tofu.html#tofu.utils.Data2DBase">[docs]</a><span class="k">class</span> <span class="nc">Data2DBase</span><span class="p">(</span><span class="n">ToFuObjectBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Provide a a dict of sequences depending on 2 indices</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on Nov 15, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>