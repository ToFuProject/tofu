<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.geom._comp &#8212; Tofu 1.5.0</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.5.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../contributing.html">Contributing</a></li>
                <li><a href="../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../aboutus.html">About</a></li>
                <li><a href="../../../releases.html">Releases</a></li>
                <li><a href="../../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.geom._comp</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is the computational part of the geometrical module of ToFu</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Built-in</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>

<span class="c1"># Common</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">scpinterp</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="k">as</span> <span class="nn">scpintg</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">signature</span> <span class="k">as</span> <span class="n">insp</span>



<span class="c1"># ToFu-specific</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tofu.geom._def</span> <span class="k">as</span> <span class="nn">_def</span>
    <span class="kn">import</span> <span class="nn">tofu.geom._GG</span> <span class="k">as</span> <span class="nn">_GG</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_def</span> <span class="k">as</span> <span class="n">_def</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_GG</span> <span class="k">as</span> <span class="n">_GG</span>


<span class="n">_LTYPES</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">]</span>
<span class="n">_RES</span> <span class="o">=</span> <span class="mf">0.1</span>


<span class="c1">###############################################################################</span>
<span class="c1">#                            Default parameters</span>
<span class="c1">###############################################################################</span>


<span class="n">_SAMPLE_RES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="s1">&#39;cross&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">_SAMPLE_RESMODE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cross&#39;</span><span class="p">:</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="s1">&#39;abs&#39;</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="_check_float"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._check_float">[docs]</a><span class="k">def</span> <span class="nf">_check_float</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vardef</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">vardef</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_LTYPES</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Arg </span><span class="si">{}</span><span class="s2"> must be a float!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;Provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span></div>

<span class="c1">###############################################################################</span>
<span class="c1">#                            Ves functions</span>
<span class="c1">###############################################################################</span>


<span class="c1"># ==============================================================================</span>
<span class="c1"># Interfacing functions</span>
<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="_get_pts_from_path_svg"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._get_pts_from_path_svg">[docs]</a><span class="k">def</span> <span class="nf">_get_pts_from_path_svg</span><span class="p">(</span>
    <span class="n">path_str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># Check inputs</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">_check_float</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="n">vardef</span><span class="o">=</span><span class="n">_RES</span><span class="p">)</span>

    <span class="c1"># try loading</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">svg.path</span> <span class="kn">import</span> <span class="n">parse_path</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">You do not seem to have svg.path installed</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;It is an optional dependency only used for this method</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;To use from_svg(), please install svg.path using:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">pip install svg.path&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">lpath</span> <span class="o">=</span> <span class="n">parse_path</span><span class="p">(</span><span class="n">path_str</span><span class="p">)</span>

    <span class="n">lpath</span><span class="o">.</span><span class="n">_calc_lengths</span><span class="p">()</span>
    <span class="n">fract</span> <span class="o">=</span> <span class="n">lpath</span><span class="o">.</span><span class="n">_fractions</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">pat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lpath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pat</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Line&#39;</span><span class="p">:</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">fract</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">pat</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Move&#39;</span><span class="p">:</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">fract</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">pat</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;Close&#39;</span><span class="p">:</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">fract</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="o">/</span> <span class="n">res</span><span class="p">))</span>
            <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">fract</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">fract</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">npts</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-14</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pos</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Several 1!&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lpath</span><span class="o">.</span><span class="n">point</span><span class="p">(</span><span class="n">po</span><span class="p">)</span> <span class="k">for</span> <span class="n">po</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">])</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pts</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">pts</span><span class="o">.</span><span class="n">imag</span><span class="p">])</span>

    <span class="c1"># Check for reference line</span>
    <span class="n">isref</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">path_str</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">isref</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Non-conform path (</span><span class="si">{}</span><span class="s2">) identified!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;All path must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- closed</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- or a unique straight line with 2 points</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pts</span><span class="p">,</span> <span class="n">isref</span></div>


<div class="viewcode-block" id="get_paths_from_svg"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp.get_paths_from_svg">[docs]</a><span class="k">def</span> <span class="nf">get_paths_from_svg</span><span class="p">(</span>
    <span class="n">pfe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">r0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">z0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">point_ref1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">point_ref2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">length_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># check input</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pfe</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.svg&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Arg pfe should be a path to a valid .svg file!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;Provided:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>

    <span class="c1"># r0, z0, scale</span>
    <span class="n">z0</span> <span class="o">=</span> <span class="n">_check_float</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">z0</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;z0&#39;</span><span class="p">,</span> <span class="n">vardef</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="n">_check_float</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;r0&#39;</span><span class="p">,</span> <span class="n">vardef</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">_check_float</span><span class="p">(</span><span class="n">var</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">vardef</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

    <span class="c1"># verb</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verb</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Arg verb must be a bool!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;Provided:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">verb</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Predefine useful var</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">minidom</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>

    <span class="c1"># Try extract raw data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">path</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> <span class="p">{</span>
                <span class="s1">&#39;poly&#39;</span><span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">),</span>
                <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">getAttribute</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Could not extract path coordinates from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Derive usable data</span>
    <span class="n">kstr</span> <span class="o">=</span> <span class="s1">&#39;fill:&#39;</span>
    <span class="n">lk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dpath</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">k0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lk</span><span class="p">):</span>

        <span class="n">v0</span> <span class="o">=</span> <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span>
        <span class="n">poly</span><span class="p">,</span> <span class="n">isref</span> <span class="o">=</span> <span class="n">_get_pts_from_path_svg</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">],</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isref</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">poly</span>
            <span class="k">del</span> <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poly</span>

        <span class="c1"># class and color</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">][</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">kstr</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">kstr</span><span class="p">):]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Ves&#39;</span>
            <span class="n">color</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;PFC&#39;</span>
        <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>

    <span class="c1"># Check for negative r</span>
    <span class="n">lkneg</span> <span class="o">=</span> <span class="p">[</span><span class="n">k0</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dpath</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lkneg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">lkneg</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;With the chosen r0 (</span><span class="si">{}</span><span class="s2">) some structure have negative r values</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;This is impossible in a toroidal coordinate system</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;  =&gt; the following structures are removed:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lkneg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dpath</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="p">{</span><span class="n">k0</span><span class="p">:</span> <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dpath</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lkneg</span><span class="p">}</span>

    <span class="c1"># Set origin and rescale</span>
    <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">point_ref1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">point_ref2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">point_ref1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">length_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Arg reference line for scaling has been detected!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;But it cannot be used without providing:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- point_ref1 + point_ref2: iterables of len() = 2</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- point_Ref1 + length_ref: iterable len() = 2 + scalar</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">unit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="o">-</span><span class="n">unit</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">point_ref2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">point_ref1</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">length_ref</span><span class="o">*</span><span class="n">unit</span>

            <span class="c1"># if horizontal (resp. vertical line) =&gt; coef = inf</span>
            <span class="c1"># =&gt; assume equal scale for r and z instead to avoid inf</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="mf">1.e-8</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="n">r_coef</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">point_ref2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">point_ref1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="n">z_coef</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">point_ref2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">point_ref1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="c1"># vertical line =&gt; assume rscale  = zscale</span>
                <span class="n">r_coef</span> <span class="o">=</span> <span class="o">-</span><span class="n">z_coef</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unit</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">:</span>
                <span class="c1"># horizontal line =&gt; assume rscale  = zscale</span>
                <span class="n">z_coef</span> <span class="o">=</span> <span class="o">-</span><span class="n">r_coef</span>
            <span class="n">r_offset</span> <span class="o">=</span> <span class="n">point_ref1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">r_coef</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">z_offset</span> <span class="o">=</span> <span class="n">point_ref1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">z_coef</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dpath</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="n">r_coef</span><span class="o">*</span><span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">r_offset</span><span class="p">,</span>
                    <span class="n">z_coef</span><span class="o">*</span><span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">z_offset</span><span class="p">,</span>
                <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dpath</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">scale</span><span class="o">*</span><span class="p">(</span><span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">r0</span><span class="p">),</span>
                <span class="n">scale</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">z0</span><span class="p">),</span>
            <span class="p">])</span>

    <span class="c1"># verb</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">lVes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">k0</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dpath</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ves&#39;</span><span class="p">])</span>
        <span class="n">lPFC</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">k0</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dpath</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PFC&#39;</span><span class="p">])</span>
        <span class="n">lobj</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1"> pts, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;cls&#39;</span><span class="p">],</span> <span class="n">k0</span><span class="p">,</span>
                <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dpath</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">lVes</span> <span class="o">+</span> <span class="n">lPFC</span>
        <span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The following structures were loaded:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lobj</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dpath</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1"># = Ves sub-functions</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="_Struct_set_Poly"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Struct_set_Poly">[docs]</a><span class="k">def</span> <span class="nf">_Struct_set_Poly</span><span class="p">(</span>
    <span class="n">Poly</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">arrayorder</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute geometrical attributes of a Struct object &quot;&quot;&quot;</span>

    <span class="c1"># Make Poly closed, counter-clockwise, with &#39;(cc,N)&#39; layout and arrayorder</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">format_poly</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">excp</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Arg Poly must be a 2D polygon !&quot;</span>
    <span class="n">fPfmt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span> <span class="k">if</span> <span class="n">arrayorder</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">asfortranarray</span>

    <span class="c1"># Get all remarkable points and moments</span>
    <span class="n">NP</span> <span class="o">=</span> <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">P1Max</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])]</span>
    <span class="n">P1Min</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])]</span>
    <span class="n">P2Max</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])]</span>
    <span class="n">P2Min</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])]</span>
    <span class="n">BaryP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Poly</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">BaryL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[(</span><span class="n">P1Max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">P1Min</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">P2Max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">P2Min</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">BaryS</span><span class="p">,</span> <span class="n">Surf</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">poly_area_and_barycenter</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">NP</span><span class="p">)</span>

    <span class="c1"># Get lim-related indicators</span>
    <span class="n">noccur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">Multi</span> <span class="o">=</span> <span class="n">noccur</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="c1"># Get Tor-related quantities</span>
    <span class="k">if</span> <span class="n">Type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;lin&quot;</span><span class="p">:</span>
        <span class="n">Vol</span><span class="p">,</span> <span class="n">BaryV</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Vol</span><span class="p">,</span> <span class="n">BaryV</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">Poly_VolAngTor</span><span class="p">(</span><span class="n">Poly</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Vol</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Pb. with volume computation for Struct of type &#39;Tor&#39; !</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Vol = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Vol</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Poly = </span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Poly</span><span class="p">))</span>
                   <span class="o">+</span> <span class="s2">&quot;  =&gt; Probably corrupted polygon</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;  =&gt; Please check polygon is not self-intersecting&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Compute the non-normalized vector of each side of the Poly</span>
    <span class="n">Vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Vect</span> <span class="o">=</span> <span class="n">fPfmt</span><span class="p">(</span><span class="n">Vect</span><span class="p">)</span>

    <span class="c1"># Compute the normalised vectors directed inwards</span>
    <span class="n">Vin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Vect</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="o">-</span><span class="n">Vect</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]])</span>
    <span class="n">Vin</span> <span class="o">=</span> <span class="o">-</span><span class="n">Vin</span>  <span class="c1"># Poly is Counter Clock-wise as defined above</span>
    <span class="n">Vin</span> <span class="o">=</span> <span class="n">Vin</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">Vin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Vin</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">Vin</span> <span class="o">=</span> <span class="n">fPfmt</span><span class="p">(</span><span class="n">Vin</span><span class="p">)</span>

    <span class="n">poly</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">format_poly</span><span class="p">(</span>
        <span class="n">Poly</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span>
        <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span>
        <span class="n">close</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Get bounding circle</span>
    <span class="n">circC</span> <span class="o">=</span> <span class="n">BaryS</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">poly</span> <span class="o">-</span> <span class="n">circC</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">circr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Poly&quot;</span><span class="p">:</span> <span class="n">poly</span><span class="p">,</span>
        <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span>
        <span class="s2">&quot;extent&quot;</span><span class="p">:</span> <span class="n">extent</span><span class="p">,</span>
        <span class="s2">&quot;noccur&quot;</span><span class="p">:</span> <span class="n">noccur</span><span class="p">,</span>
        <span class="s2">&quot;Multi&quot;</span><span class="p">:</span> <span class="n">Multi</span><span class="p">,</span>
        <span class="s2">&quot;nP&quot;</span><span class="p">:</span> <span class="n">NP</span><span class="p">,</span>
        <span class="s2">&quot;P1Max&quot;</span><span class="p">:</span> <span class="n">P1Max</span><span class="p">,</span>
        <span class="s2">&quot;P1Min&quot;</span><span class="p">:</span> <span class="n">P1Min</span><span class="p">,</span>
        <span class="s2">&quot;P2Max&quot;</span><span class="p">:</span> <span class="n">P2Max</span><span class="p">,</span>
        <span class="s2">&quot;P2Min&quot;</span><span class="p">:</span> <span class="n">P2Min</span><span class="p">,</span>
        <span class="s2">&quot;BaryP&quot;</span><span class="p">:</span> <span class="n">BaryP</span><span class="p">,</span>
        <span class="s2">&quot;BaryL&quot;</span><span class="p">:</span> <span class="n">BaryL</span><span class="p">,</span>
        <span class="s2">&quot;BaryS&quot;</span><span class="p">:</span> <span class="n">BaryS</span><span class="p">,</span>
        <span class="s2">&quot;BaryV&quot;</span><span class="p">:</span> <span class="n">BaryV</span><span class="p">,</span>
        <span class="s2">&quot;Surf&quot;</span><span class="p">:</span> <span class="n">Surf</span><span class="p">,</span>
        <span class="s2">&quot;VolAng&quot;</span><span class="p">:</span> <span class="n">Vol</span><span class="p">,</span>
        <span class="s2">&quot;Vect&quot;</span><span class="p">:</span> <span class="n">Vect</span><span class="p">,</span>
        <span class="s2">&quot;VIn&quot;</span><span class="p">:</span> <span class="n">Vin</span><span class="p">,</span>
        <span class="s2">&quot;circ-C&quot;</span><span class="p">:</span> <span class="n">circC</span><span class="p">,</span>
        <span class="s2">&quot;circ-r&quot;</span><span class="p">:</span> <span class="n">circr</span><span class="p">,</span>
        <span class="s2">&quot;Clock&quot;</span><span class="p">:</span> <span class="n">Clock</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">dout</span></div>


<div class="viewcode-block" id="_Ves_get_InsideConvexPoly"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Ves_get_InsideConvexPoly">[docs]</a><span class="k">def</span> <span class="nf">_Ves_get_InsideConvexPoly</span><span class="p">(</span>
    <span class="n">Poly</span><span class="p">,</span>
    <span class="n">P2Min</span><span class="p">,</span>
    <span class="n">P2Max</span><span class="p">,</span>
    <span class="n">BaryS</span><span class="p">,</span>
    <span class="n">RelOff</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorRelOff</span><span class="p">,</span>
    <span class="n">ZLim</span><span class="o">=</span><span class="s2">&quot;Def&quot;</span><span class="p">,</span>
    <span class="n">Spline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">Splprms</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorSplprms</span><span class="p">,</span>
    <span class="n">NP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorInsideNP</span><span class="p">,</span>
    <span class="n">Plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">RelOff</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;Arg RelOff must be a float&quot;</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">ZLim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ZLim</span> <span class="o">==</span> <span class="s2">&quot;Def&quot;</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ZLim</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span>
        <span class="p">),</span> <span class="s2">&quot;Arg ZLim must be a tuple (ZlimMin, ZLimMax)&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Spline</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">,</span> <span class="s2">&quot;Arg Spline must be a bool !&quot;</span>
    <span class="k">if</span> <span class="n">ZLim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ZLim</span> <span class="o">==</span> <span class="s2">&quot;Def&quot;</span><span class="p">:</span>
            <span class="n">ZLim</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">P2Min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">P2Max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P2Min</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">P2Max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="p">(</span><span class="n">P2Max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">P2Min</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="n">indZLim</span> <span class="o">=</span> <span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">ZLim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="n">ZLim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indZLim</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Poly seems to be Convex and simple enough !&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Poly.shape[1] - indZLim.sum() &lt; 10&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Poly</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Poly</span><span class="p">,</span> <span class="n">indZLim</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Poly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Np</span> <span class="o">=</span> <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Spline</span><span class="p">:</span>
        <span class="n">BarySbis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">BaryS</span><span class="p">,</span> <span class="p">(</span><span class="n">Np</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Ptemp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">RelOff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Poly</span> <span class="o">-</span> <span class="n">BarySbis</span><span class="p">)</span>
        <span class="c1"># Poly = BarySbis + Ptemp</span>
        <span class="n">Ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Ptemp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Ptemp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">Ang</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Ang</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Ptemp</span> <span class="o">=</span> <span class="n">Ptemp</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
        <span class="c1"># spline parameters</span>
        <span class="n">ww</span> <span class="o">=</span> <span class="n">Splprms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Np</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,))</span>
        <span class="n">ss</span> <span class="o">=</span> <span class="n">Splprms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">Np</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># smoothness parameter</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">Splprms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># spline order</span>
        <span class="n">nest</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="p">(</span><span class="n">Np</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="p">)</span>  <span class="c1"># estimate of number of knots needed (-1 = maximal)</span>
        <span class="c1"># Find the knot points</span>

        <span class="c1"># TODO @DV : we can probably get rid of this</span>
        <span class="c1"># tckp,uu = scpinterp.splprep([np.append(Ptemp[0,:],Ptemp[0,0]),</span>
        <span class="c1"># np.append(Ptemp[1,:],Ptemp[1,0]),np.append(Ang,Ang[0]+2.*np.pi)],</span>
        <span class="c1"># w=ww, s=ss, k=kk, nest=nest)</span>
        <span class="n">tckp</span><span class="p">,</span> <span class="n">uu</span> <span class="o">=</span> <span class="n">scpinterp</span><span class="o">.</span><span class="n">splprep</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ptemp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Ptemp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ptemp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Ptemp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="p">],</span>
            <span class="n">u</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ang</span><span class="p">,</span> <span class="n">Ang</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
            <span class="n">w</span><span class="o">=</span><span class="n">ww</span><span class="p">,</span>
            <span class="n">s</span><span class="o">=</span><span class="n">ss</span><span class="p">,</span>
            <span class="n">k</span><span class="o">=</span><span class="n">kk</span><span class="p">,</span>
            <span class="n">nest</span><span class="o">=</span><span class="n">nest</span><span class="p">,</span>
            <span class="n">full_output</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">xnew</span><span class="p">,</span> <span class="n">ynew</span> <span class="o">=</span> <span class="n">scpinterp</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">NP</span><span class="p">),</span> <span class="n">tckp</span><span class="p">)</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xnew</span> <span class="o">+</span> <span class="n">BaryS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ynew</span> <span class="o">+</span> <span class="n">BaryS</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Plot</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Poly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Poly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;-k&quot;</span><span class="p">,</span> <span class="n">Poly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Poly</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="s2">&quot;-r&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s2">&quot;datalim&quot;</span><span class="p">),</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;R (m)&quot;</span>
        <span class="p">),</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Z (m)&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Poly</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1"># = Ves sampling functions</span>
<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="_Ves_get_sample_checkinputs"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Ves_get_sample_checkinputs">[docs]</a><span class="k">def</span> <span class="nf">_Ves_get_sample_checkinputs</span><span class="p">(</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">which</span><span class="o">=</span><span class="s1">&#39;volume&#39;</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check inputs for all sampling routines &quot;&quot;&quot;</span>

    <span class="c1"># res</span>
    <span class="n">dres</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;cross&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">_SAMPLE_RES</span><span class="p">[</span><span class="n">which</span><span class="p">]</span>
    <span class="n">ltypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">]</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span>
          <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
              <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="n">dres</span><span class="p">[</span><span class="n">which</span><span class="p">]</span>
              <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg res must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- float: unique resolution for all directions</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- iterable of </span><span class="si">{}</span><span class="s2"> floats</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dres</span><span class="p">[</span><span class="n">which</span><span class="p">])</span>
               <span class="o">+</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">which</span> <span class="o">!=</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dres</span><span class="p">[</span><span class="n">which</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For edge, res cannot be an iterable!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- res: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dres</span><span class="p">[</span><span class="n">which</span><span class="p">])]</span>

    <span class="c1"># domain (i.e.: sub-domain to be sampled, defined by its limits)</span>
    <span class="n">ddomain</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;edge&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;cross&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">domain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ddomain</span><span class="p">[</span><span class="n">which</span><span class="p">])]</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
          <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span> <span class="o">==</span> <span class="n">ddomain</span><span class="p">[</span><span class="n">which</span><span class="p">]</span>
          <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">dd</span> <span class="ow">is</span> <span class="kc">None</span>
                   <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
                       <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                       <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span>
                                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">]))</span>
                   <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">]))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg domain must be a len()=</span><span class="si">{}</span><span class="s2"> iterable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ddomain</span><span class="p">[</span><span class="n">which</span><span class="p">])</span>
               <span class="o">+</span> <span class="s2">&quot; where each element can be:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- an iterable 2 floats: [lower, upper] bounds</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- None: no bounds</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">domain</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">domain</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">domain</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">domain</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                          <span class="k">if</span> <span class="n">domain</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="nb">float</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                          <span class="k">if</span> <span class="n">domain</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># resMode</span>
    <span class="k">if</span> <span class="n">resMode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resMode</span> <span class="o">=</span> <span class="n">_SAMPLE_RESMODE</span><span class="p">[</span><span class="n">which</span><span class="p">]</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resMode</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">resMode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="s2">&quot;rel&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg resMode must be in [&#39;abs&#39;,&#39;rel&#39;]!</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resMode</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">resMode</span> <span class="o">=</span> <span class="n">resMode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1"># ind (indices of points to be recovered)</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span>
          <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
              <span class="ow">and</span> <span class="n">ind</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
              <span class="ow">and</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span>
              <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
          <span class="ow">or</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;surface&#39;</span>
              <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
              <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">indi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                       <span class="ow">and</span> <span class="n">indi</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                       <span class="ow">and</span> <span class="n">indi</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span>
                       <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">indi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">indi</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">])))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg ind must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- None: domain is used instead</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- 1d np.ndarray of positive int: indices</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">which</span> <span class="o">==</span> <span class="s1">&#39;surface&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- list of 1d np.ndarray of positive indices</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">resMode</span><span class="p">,</span> <span class="n">ind</span></div>


<div class="viewcode-block" id="_Ves_get_sampleEdge"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Ves_get_sampleEdge">[docs]</a><span class="k">def</span> <span class="nf">_Ves_get_sampleEdge</span><span class="p">(</span>
    <span class="n">VPoly</span><span class="p">,</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">offsetIn</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">VIn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span>
<span class="p">):</span>

    <span class="c1"># -------------</span>
    <span class="c1">#  Check inputs</span>

    <span class="c1"># standard</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">resMode</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">_Ves_get_sample_checkinputs</span><span class="p">(</span>
        <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">which</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># specific</span>
    <span class="n">ltypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">offsetIn</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span>

    <span class="c1"># -------------</span>
    <span class="c1">#  Compute</span>

    <span class="n">Pts</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">Rref</span><span class="p">,</span> <span class="n">VPolybis</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">discretize_vpoly</span><span class="p">(</span>
        <span class="n">VPoly</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
        <span class="n">D1</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">D2</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
        <span class="n">DIn</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">offsetIn</span><span class="p">),</span>
        <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">ind</span></div>


<div class="viewcode-block" id="_Ves_get_sampleCross"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Ves_get_sampleCross">[docs]</a><span class="k">def</span> <span class="nf">_Ves_get_sampleCross</span><span class="p">(</span>
    <span class="n">VPoly</span><span class="p">,</span>
    <span class="n">Min1</span><span class="p">,</span>
    <span class="n">Max1</span><span class="p">,</span>
    <span class="n">Min2</span><span class="p">,</span>
    <span class="n">Max2</span><span class="p">,</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># -------------</span>
    <span class="c1">#  Check inputs</span>

    <span class="c1"># standard</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">resMode</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">_Ves_get_sample_checkinputs</span><span class="p">(</span>
        <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
        <span class="n">which</span><span class="o">=</span><span class="s1">&#39;cross&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># specific</span>
    <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span> <span class="s2">&quot;imshow&quot;</span><span class="p">]</span>

    <span class="c1"># -------------</span>
    <span class="c1">#  Compute</span>

    <span class="n">MinMax1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Min1</span><span class="p">,</span> <span class="n">Max1</span><span class="p">])</span>
    <span class="n">MinMax2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Min2</span><span class="p">,</span> <span class="n">Max2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;flat&quot;</span><span class="p">:</span>
            <span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">d1r</span><span class="p">,</span> <span class="n">d2r</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">discretize_segment2d</span><span class="p">(</span>
                <span class="n">MinMax1</span><span class="p">,</span>
                <span class="n">MinMax2</span><span class="p">,</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">D1</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">D2</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                <span class="n">VPoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">,</span>
                <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">d1r</span><span class="p">,</span> <span class="n">d2r</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">d1r</span><span class="p">,</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">N1</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_mesh_dlfromL_cython</span><span class="p">(</span>
                <span class="n">MinMax1</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dLMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span>
            <span class="p">)</span>
            <span class="n">x2</span><span class="p">,</span> <span class="n">d2r</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">N2</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_mesh_dlfromL_cython</span><span class="p">(</span>
                <span class="n">MinMax2</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">dLMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span> <span class="n">margin</span><span class="o">=</span><span class="n">margin</span>
            <span class="p">)</span>
            <span class="n">xx1</span><span class="p">,</span> <span class="n">xx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">([</span><span class="n">xx1</span><span class="p">,</span> <span class="n">xx2</span><span class="p">])</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">d1r</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d1r</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                <span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">d2r</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">extent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;flat&quot;</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">ind</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;int32&quot;</span><span class="p">,</span> <span class="s2">&quot;int64&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">c0</span><span class="p">,</span> <span class="s2">&quot;Arg ind must be a np.ndarray of int !&quot;</span>
        <span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">d1r</span><span class="p">,</span> <span class="n">d2r</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_meshCross_FromInd</span><span class="p">(</span>
            <span class="n">MinMax1</span><span class="p">,</span>
            <span class="n">MinMax2</span><span class="p">,</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">ind</span><span class="p">,</span>
            <span class="n">dSMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="n">d1r</span><span class="p">,</span> <span class="n">d2r</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="_Ves_get_sampleS"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Ves_get_sampleS">[docs]</a><span class="k">def</span> <span class="nf">_Ves_get_sampleS</span><span class="p">(</span>
    <span class="n">VPoly</span><span class="p">,</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resMode</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span>
    <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">offsetIn</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">VIn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">VType</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">,</span>
    <span class="n">VLim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nVLim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">returnas</span><span class="o">=</span><span class="s2">&quot;(X,Y,Z)&quot;</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
    <span class="n">Multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">Ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sample the surface &quot;&quot;&quot;</span>

    <span class="c1"># -------------</span>
    <span class="c1">#  Check inputs</span>

    <span class="c1"># standard</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">resMode</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">_Ves_get_sample_checkinputs</span><span class="p">(</span>
        <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
        <span class="n">which</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># nVLim and VLim</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">nVLim</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]</span> <span class="ow">and</span> <span class="n">nVLim</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg nVLim must be a positive int</span><span class="se">\\</span><span class="s2">n&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nVLim</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">nVLim</span><span class="p">)))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">VLim</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="n">VLim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nVLim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VLim</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Multi</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg Multi must be a bool!</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Multi</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Check if Multi</span>
    <span class="k">if</span> <span class="n">nVLim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">VLim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;For multiple Struct, Lim cannot be None !&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">VLim</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nVLim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ind</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Ind</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">Ind</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Ind</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ind</span><span class="p">))]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ind</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg ind must be a list of same len() as Ind!</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">VLim</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="k">if</span> <span class="n">VLim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">VLim</span><span class="o">.</span><span class="n">ravel</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ind must be a np.ndarray if nVLim == 1</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">Ind</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">reseff</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">],</span>
            <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">VType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tor&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ind</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">VLim</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                     <span class="n">dS</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                     <span class="n">ind</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                     <span class="n">NL</span><span class="p">,</span>
                     <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">Rref</span><span class="p">,</span>
                     <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">nRPhi0</span><span class="p">,</span>
                     <span class="n">VPbis</span><span class="p">)</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Tor_SubFromD_cython</span><span class="p">(</span>
                         <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">VPoly</span><span class="p">,</span>
                         <span class="n">DR</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">DZ</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">DPhi</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                         <span class="n">DIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
                         <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                         <span class="n">PhiMinMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">Out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                         <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                     <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                     <span class="n">dS</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                     <span class="n">ind</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                     <span class="n">NL</span><span class="p">,</span>
                     <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">Rref</span><span class="p">,</span>
                     <span class="n">dR0r</span><span class="p">,</span>
                     <span class="n">dZ0r</span><span class="p">,</span>
                     <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">VPbis</span><span class="p">)</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Smesh_TorStruct_SubFromD_cython</span><span class="p">(</span>
                         <span class="n">VLim</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                         <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">VPoly</span><span class="p">,</span>
                         <span class="n">DR</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">DZ</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                         <span class="n">DPhi</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                         <span class="n">DIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
                         <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                         <span class="n">Out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                         <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                     <span class="p">)</span>
                    <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dR0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ind</span><span class="p">)):</span>
                <span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                 <span class="n">dS</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                 <span class="n">ind</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                 <span class="n">NL</span><span class="p">,</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">Rref</span><span class="p">,</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">dY0r</span><span class="p">,</span>
                 <span class="n">dZ0r</span><span class="p">,</span>
                 <span class="n">VPbis</span><span class="p">)</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Lin_SubFromD_cython</span><span class="p">(</span>
                     <span class="n">VLim</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                     <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">VPoly</span><span class="p">,</span>
                     <span class="n">DX</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="n">DY</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="n">DZ</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                     <span class="n">DIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
                     <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                     <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                 <span class="p">)</span>
                <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dY0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="k">if</span> <span class="n">Multi</span> <span class="k">else</span> <span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">reseff</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">],</span>
            <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">VType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tor&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ind</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">ind</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">VLim</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">out_loc</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Tor_SubFromInd_cython</span><span class="p">(</span>
                            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">VPoly</span><span class="p">,</span>
                            <span class="n">ind</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                            <span class="n">DIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
                            <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                            <span class="n">PhiMinMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">Out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                            <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">pts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dS</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">NL</span><span class="p">,</span> <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rref</span> <span class="o">=</span> <span class="n">out_loc</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
                        <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">nRPhi0</span><span class="p">,</span> <span class="n">VPbis</span> <span class="o">=</span> <span class="n">out_loc</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out_loc</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Smesh_TorStruct_SubFromInd_cython</span><span class="p">(</span>
                            <span class="n">VLim</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                            <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">VPoly</span><span class="p">,</span>
                            <span class="n">ind</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                            <span class="n">DIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
                            <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                            <span class="n">Out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                            <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">pts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dS</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">NL</span><span class="p">,</span> <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rref</span> <span class="o">=</span> <span class="n">out_loc</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
                        <span class="n">dR0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">,</span> <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">VPbis</span> <span class="o">=</span> <span class="n">out_loc</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                        <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dR0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ind</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">ind</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">out_loc</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Smesh_Lin_SubFromInd_cython</span><span class="p">(</span>
                        <span class="n">VLim</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">VPoly</span><span class="p">,</span>
                        <span class="n">ind</span><span class="p">[</span><span class="n">Ind</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                        <span class="n">DIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
                        <span class="n">VIn</span><span class="o">=</span><span class="n">VIn</span><span class="p">,</span>
                        <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">pts</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">dS</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">NL</span><span class="p">,</span> <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rref</span> <span class="o">=</span> <span class="n">out_loc</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">dY0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">,</span> <span class="n">VPbis</span> <span class="o">=</span> <span class="n">out_loc</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                    <span class="n">reseff</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dY0r</span><span class="p">,</span> <span class="n">dZ0r</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">VLim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">reseff</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reseff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pts</span><span class="p">,</span> <span class="n">dS</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">reseff</span></div>


<div class="viewcode-block" id="_Ves_get_sampleV"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Ves_get_sampleV">[docs]</a><span class="k">def</span> <span class="nf">_Ves_get_sampleV</span><span class="p">(</span>
    <span class="n">VPoly</span><span class="p">,</span>
    <span class="n">Min1</span><span class="p">,</span>
    <span class="n">Max1</span><span class="p">,</span>
    <span class="n">Min2</span><span class="p">,</span>
    <span class="n">Max2</span><span class="p">,</span>
    <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">VType</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">,</span>
    <span class="n">VLim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">returnas</span><span class="o">=</span><span class="s2">&quot;(X,Y,Z)&quot;</span><span class="p">,</span>
    <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
    <span class="n">algo</span><span class="o">=</span><span class="s2">&quot;new&quot;</span><span class="p">,</span>
    <span class="n">num_threads</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Sample the volume &quot;&quot;&quot;</span>

    <span class="c1"># -------------</span>
    <span class="c1">#  Check inputs</span>
    <span class="n">res</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">resMode</span><span class="p">,</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">_Ves_get_sample_checkinputs</span><span class="p">(</span>
        <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
        <span class="n">which</span><span class="o">=</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------</span>
    <span class="c1"># Computation</span>

    <span class="n">MinMax1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Min1</span><span class="p">,</span> <span class="n">Max1</span><span class="p">])</span>
    <span class="n">MinMax2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Min2</span><span class="p">,</span> <span class="n">Max2</span><span class="p">])</span>
    <span class="n">VLim</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">VType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tor&quot;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VLim</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">reseff</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tor&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">algo</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">sz_r</span><span class="p">,</span> <span class="n">sz_z</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Vmesh_Tor_SubFromD_cython</span><span class="p">(</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">MinMax1</span><span class="p">,</span>
                    <span class="n">MinMax2</span><span class="p">,</span>
                    <span class="n">DR</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">DZ</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">DPhi</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">limit_vpoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">,</span>
                    <span class="n">out_format</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                    <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                    <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Vmesh_Tor_SubFromD_cython_old</span><span class="p">(</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">MinMax1</span><span class="p">,</span>
                    <span class="n">MinMax2</span><span class="p">,</span>
                    <span class="n">DR</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">DZ</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">DPhi</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">VPoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">,</span>
                    <span class="n">Out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                    <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span>
             <span class="n">reseff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">reseff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="n">reseff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Vmesh_Lin_SubFromD_cython</span><span class="p">(</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">VLim</span><span class="p">,</span>
                <span class="n">MinMax1</span><span class="p">,</span>
                <span class="n">MinMax2</span><span class="p">,</span>
                <span class="n">DX</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">DY</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">DZ</span><span class="o">=</span><span class="n">domain</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">limit_vpoly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">,</span>
                <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tor&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">algo</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Vmesh_Tor_SubFromInd_cython</span><span class="p">(</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">MinMax1</span><span class="p">,</span>
                    <span class="n">MinMax2</span><span class="p">,</span>
                    <span class="n">ind</span><span class="p">,</span>
                    <span class="n">Out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                    <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                    <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">reseff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Vmesh_Tor_SubFromInd_cython_old</span><span class="p">(</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                    <span class="n">MinMax1</span><span class="p">,</span>
                    <span class="n">MinMax2</span><span class="p">,</span>
                    <span class="n">ind</span><span class="p">,</span>
                    <span class="n">Out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
                    <span class="n">margin</span><span class="o">=</span><span class="n">margin</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span>
             <span class="n">reseff</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">reseff</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
             <span class="n">reseff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_Vmesh_Lin_SubFromInd_cython</span><span class="p">(</span>
                 <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                 <span class="n">VLim</span><span class="p">,</span>
                 <span class="n">MinMax1</span><span class="p">,</span>
                 <span class="n">MinMax2</span><span class="p">,</span>
                 <span class="n">ind</span><span class="p">,</span>
                 <span class="n">margin</span><span class="o">=</span><span class="n">margin</span>
             <span class="p">)</span>
    <span class="k">return</span> <span class="n">pts</span><span class="p">,</span> <span class="n">dV</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">reseff</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1"># =  phi / theta projections for magfieldlines</span>
<span class="c1"># ==============================================================================</span>


<div class="viewcode-block" id="_Struct_get_phithetaproj"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._Struct_get_phithetaproj">[docs]</a><span class="k">def</span> <span class="nf">_Struct_get_phithetaproj</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">poly_closed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noccur</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="c1"># phi = toroidal angle</span>
    <span class="k">if</span> <span class="n">noccur</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Dphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]])</span>
        <span class="n">nphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">lim</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lim</span><span class="p">)</span>
        <span class="n">nphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">noccur</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">lim</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Dphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lim</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">noccur</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind</span><span class="p">:</span>
                <span class="n">Dphi</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lim</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">lim</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
                <span class="n">nphi</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># theta = poloidal angle</span>
    <span class="n">Dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">poly_closed</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">poly_closed</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Dtheta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Dtheta</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">Dtheta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Dtheta</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">ntheta</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">Dtheta</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dtheta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">Dtheta</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ntheta</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">nphi</span><span class="p">,</span> <span class="n">Dphi</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">,</span> <span class="n">Dtheta</span></div>


<div class="viewcode-block" id="_get_phithetaproj_dist"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp._get_phithetaproj_dist">[docs]</a><span class="k">def</span> <span class="nf">_get_phithetaproj_dist</span><span class="p">(</span>
    <span class="n">poly_closed</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">Dtheta</span><span class="p">,</span>
    <span class="n">nDtheta</span><span class="p">,</span>
    <span class="n">Dphi</span><span class="p">,</span>
    <span class="n">nDphi</span><span class="p">,</span>
    <span class="n">theta</span><span class="p">,</span>
    <span class="n">phi</span><span class="p">,</span>
    <span class="n">ntheta</span><span class="p">,</span>
    <span class="n">nphi</span><span class="p">,</span>
    <span class="n">noccur</span><span class="p">,</span>
<span class="p">):</span>

    <span class="k">if</span> <span class="n">nDtheta</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;=</span> <span class="n">Dtheta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="n">Dtheta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;=</span> <span class="n">Dtheta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="n">Dtheta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">disttheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">theta</span><span class="o">.</span><span class="n">size</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># phi within Dphi</span>
    <span class="k">if</span> <span class="n">noccur</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">indphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nphi</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccur</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nDphi</span><span class="p">[</span><span class="n">ii</span><span class="p">]):</span>
                <span class="n">indphi</span> <span class="o">|=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="n">Dphi</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&lt;=</span> <span class="n">Dphi</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indphi</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">disttheta</span><span class="p">,</span> <span class="n">indphi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nphi</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># No theta within Dtheta</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">disttheta</span><span class="p">,</span> <span class="n">indphi</span>

    <span class="c1"># Check for non-parallel AB / u pairs</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)])</span>
    <span class="n">AB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">poly_closed</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">detABu</span> <span class="o">=</span> <span class="n">AB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">AB</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">inddet</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">detABu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-9</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">inddet</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">disttheta</span><span class="p">,</span> <span class="n">indphi</span>

    <span class="n">nseg</span> <span class="o">=</span> <span class="n">poly_closed</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nseg</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">OA</span> <span class="o">=</span> <span class="n">poly_closed</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">detOAu</span> <span class="o">=</span> <span class="p">(</span><span class="n">OA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">OA</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])[</span>
        <span class="n">inddet</span>
    <span class="p">]</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="o">-</span><span class="n">detOAu</span> <span class="o">/</span> <span class="n">detABu</span><span class="p">[</span><span class="n">inddet</span><span class="p">]</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="p">(</span><span class="n">ss</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ss</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">inddet</span><span class="p">[</span><span class="n">inddet</span><span class="p">]</span> <span class="o">=</span> <span class="n">inds</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">disttheta</span><span class="p">,</span> <span class="n">indphi</span>

    <span class="n">scaOAu</span> <span class="o">=</span> <span class="p">(</span><span class="n">OA</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">OA</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])[</span>
        <span class="n">inddet</span>
    <span class="p">]</span>
    <span class="n">scaABu</span> <span class="o">=</span> <span class="p">(</span><span class="n">AB</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">AB</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])[</span>
        <span class="n">inddet</span>
    <span class="p">]</span>
    <span class="n">k</span><span class="p">[</span><span class="n">inddet</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaOAu</span> <span class="o">+</span> <span class="n">ss</span><span class="p">[</span><span class="n">inds</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaABu</span>
    <span class="n">indk</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="n">inddet</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
    <span class="n">inddet</span><span class="p">[</span><span class="n">inddet</span><span class="p">]</span> <span class="o">=</span> <span class="n">indk</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indk</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">disttheta</span><span class="p">,</span> <span class="n">indphi</span>

    <span class="n">k</span><span class="p">[</span><span class="o">~</span><span class="n">inddet</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">indok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">inddet</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">disttheta</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">k</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">disttheta</span><span class="p">,</span> <span class="n">indphi</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1"># =  LOS functions</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="LOS_PRMin"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp.LOS_PRMin">[docs]</a><span class="k">def</span> <span class="nf">LOS_PRMin</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">kOut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Eps</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  Compute the point on the LOS where the major radius is minimum &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">Ds</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">Ds</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="n">Ds</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">us</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="n">kOut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">kOut</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">kOut</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">Ds</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">Ds</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">us</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">Ds</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kOut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kOut</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kOut</span> <span class="o">=</span> <span class="n">kOut</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">nlos</span><span class="p">,</span> <span class="n">nref</span> <span class="o">=</span> <span class="n">Ds</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">kRMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlos</span><span class="p">,</span> <span class="n">nref</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">uparN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">us</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">us</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Case with u vertical</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">uparN</span> <span class="o">&gt;</span> <span class="n">Eps</span>
    <span class="n">kRMin</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Else</span>
    <span class="n">kRMin</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">-</span><span class="p">(</span><span class="n">us</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ds</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">us</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ds</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind</span><span class="p">])</span> <span class="o">/</span> <span class="n">uparN</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="p">)</span>

    <span class="c1"># Check</span>
    <span class="n">kRMin</span><span class="p">[</span><span class="n">kRMin</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">kOut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kRMin</span><span class="p">[</span><span class="n">kRMin</span> <span class="o">&gt;</span> <span class="n">kOut</span><span class="p">]</span> <span class="o">=</span> <span class="n">kOut</span><span class="p">[</span><span class="n">kRMin</span> <span class="o">&gt;</span> <span class="n">kOut</span><span class="p">]</span>

    <span class="c1"># squeeze</span>
    <span class="k">if</span> <span class="n">squeeze</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nref</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nlos</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">kRMin</span> <span class="o">=</span> <span class="n">kRMin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">nref</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kRMin</span> <span class="o">=</span> <span class="n">kRMin</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">nlos</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kRMin</span> <span class="o">=</span> <span class="n">kRMin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">kRMin</span></div>


<div class="viewcode-block" id="LOS_CrossProj"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp.LOS_CrossProj">[docs]</a><span class="k">def</span> <span class="nf">LOS_CrossProj</span><span class="p">(</span>
    <span class="n">VType</span><span class="p">,</span>
    <span class="n">Ds</span><span class="p">,</span>
    <span class="n">us</span><span class="p">,</span>
    <span class="n">kOuts</span><span class="p">,</span>
    <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;All&quot;</span><span class="p">,</span>
    <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">num_threads</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
    <span class="n">return_pts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute the parameters to plot the poloidal projection of the LOS  &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">VType</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">VType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tor&quot;</span><span class="p">,</span> <span class="s2">&quot;lin&quot;</span><span class="p">]</span>
    <span class="n">dproj</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cross&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">),</span>
        <span class="s2">&quot;hor&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;x,y&quot;</span><span class="p">),</span>
        <span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">),</span>
        <span class="s2">&quot;3d&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">proj</span><span class="p">])</span>
        <span class="n">lcoords</span> <span class="o">=</span> <span class="n">proj</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">proj</span> <span class="ow">in</span> <span class="n">dproj</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">lcoords</span> <span class="o">=</span> <span class="n">dproj</span><span class="p">[</span><span class="n">proj</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">proj</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cross&quot;</span><span class="p">,</span> <span class="s2">&quot;hor&quot;</span><span class="p">,</span> <span class="s2">&quot;3d&quot;</span><span class="p">]</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ds</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">Ds</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">us</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Ds and us must have the same shape and dim in [2,3]:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - provided Ds.shape: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Ds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - provided us.shape: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">us</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">kOuts</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">Ds</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">kOuts</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">Ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;kOuts must have the same shape and ndim = Ds.ndim-1:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Ds.shape    : </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Ds</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - kOutss.shape: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">kOuts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Prepare inputs</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">nlos</span><span class="p">,</span> <span class="n">nseg</span> <span class="o">=</span> <span class="n">Ds</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Detailed sampling for &#39;tor&#39; and (&#39;cross&#39; or &#39;all&#39;)</span>
    <span class="n">R</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span> <span class="ow">or</span> <span class="s2">&quot;Z&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
        <span class="n">angcross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">us</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">us</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">us</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">resnk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">25.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">angcross</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">resnk</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">resnk</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="c1"># Use optimized get sample</span>
        <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nlos</span> <span class="o">*</span> <span class="n">nseg</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span> <span class="n">kOuts</span><span class="o">.</span><span class="n">ravel</span><span class="p">()))</span>

        <span class="n">k</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">lind</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_get_sample</span><span class="p">(</span>
            <span class="n">nlos</span> <span class="o">*</span> <span class="n">nseg</span><span class="p">,</span>
            <span class="n">resnk</span><span class="p">,</span>
            <span class="n">DL</span><span class="p">,</span>
            <span class="n">dmethod</span><span class="o">=</span><span class="s2">&quot;rel&quot;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;simps&quot;</span><span class="p">,</span>
            <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">assert</span> <span class="n">lind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nseg</span> <span class="o">*</span> <span class="n">nlos</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">lind</span><span class="p">[</span><span class="n">nseg</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">::</span> <span class="n">nseg</span><span class="p">]</span>  <span class="c1"># noqa</span>
        <span class="n">nbrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">lind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lind</span><span class="p">),</span> <span class="n">k</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">lind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nlos</span> <span class="o">*</span> <span class="n">nseg</span><span class="p">)),</span> <span class="n">nbrep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span>
            <span class="kc">None</span><span class="p">,</span> <span class="p">:</span>
        <span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">us</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nlos</span> <span class="o">*</span> <span class="n">nseg</span><span class="p">)),</span> <span class="n">nbrep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]])</span>
            <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;Z&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;Z&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Normal sampling =&gt; pts</span>
    <span class="c1"># unnecessary only if &#39;tor&#39; and &#39;cross&#39;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span> <span class="ow">or</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span> <span class="ow">or</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
            <span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">Ds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">kOuts</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">:]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nlos</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nlos</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nancoords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nlos</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pts</span><span class="p">,</span> <span class="n">nancoords</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nlos</span> <span class="o">*</span> <span class="p">(</span><span class="n">nseg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">proj</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;hor&quot;</span><span class="p">,</span> <span class="s2">&quot;3d&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proj</span> <span class="o">==</span> <span class="s2">&quot;hor&quot;</span><span class="p">:</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pts</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">proj</span> <span class="o">==</span> <span class="s2">&quot;hor&quot;</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ind</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">lcoords</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">return_pts</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pts</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span></div>


<span class="c1"># ==============================================================================</span>
<span class="c1"># =  Meshing &amp; signal</span>
<span class="c1"># ==============================================================================</span>
<div class="viewcode-block" id="LOS_get_sample"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp.LOS_get_sample">[docs]</a><span class="k">def</span> <span class="nf">LOS_get_sample</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dLMode</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return the sampled line, with the specified method</span>

<span class="sd">    &#39;linspace&#39;: return the N+1 edges, including the first and last point</span>
<span class="sd">    &#39;sum&#39; : return the N middle of the segments</span>
<span class="sd">    &#39;simps&#39;: return the N+1 egdes, where N has to be even</span>
<span class="sd">             (scipy.simpson requires an even number of intervals)</span>
<span class="sd">    &#39;romb&#39; : return the N+1 edges, where N+1 = 2**k+1</span>
<span class="sd">             (fed to scipy.romb for integration)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">dd</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">]]</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dL</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">DL</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="n">DL</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
                <span class="nb">all</span><span class="p">([</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">DL</span><span class="p">]),</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="n">dLMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="s2">&quot;rel&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">method</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;linspace&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="s2">&quot;simps&quot;</span><span class="p">,</span>
            <span class="s2">&quot;romb&quot;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="c1"># Compute the min number of intervals to satisfy the specified resolution</span>
    <span class="n">N</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">dL</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dLMode</span> <span class="o">==</span> <span class="s2">&quot;abs&quot;</span>
        <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">dL</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="c1"># Modify N according to the desired method</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;simps&quot;</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">N</span> <span class="k">if</span> <span class="n">N</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;romb&quot;</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)))</span>

    <span class="c1"># Derive k and dLr</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="n">dLr</span> <span class="o">=</span> <span class="p">(</span><span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">N</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span> <span class="o">*</span> <span class="n">dLr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">dLr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span>
        <span class="p">)</span>

    <span class="n">Pts</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Pts</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dLr</span></div>


<div class="viewcode-block" id="LOS_calc_signal"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp.LOS_calc_signal">[docs]</a><span class="k">def</span> <span class="nf">LOS_calc_signal</span><span class="p">(</span>
    <span class="n">ff</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dLMode</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;romb&quot;</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
    <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">),</span> <span class="p">(</span>
        <span class="s2">&quot;Arg ff must be a callable (function) taking at least 1 positional &quot;</span><span class="p">,</span>
        <span class="s2">&quot;Pts (a (3,N) np.ndarray of cartesian (X,Y,Z) coordinates) !&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;linspace&quot;</span>
    <span class="n">Pts</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dLr</span> <span class="o">=</span> <span class="n">LOS_get_sample</span><span class="p">(</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dL</span><span class="p">,</span> <span class="n">DL</span><span class="o">=</span><span class="n">DL</span><span class="p">,</span> <span class="n">dLMode</span><span class="o">=</span><span class="n">dLMode</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="n">Test</span>
    <span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">insp</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
                <span class="ow">and</span> <span class="n">pp</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">pp</span><span class="o">.</span><span class="n">empty</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Vals</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">Pts</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">Vals</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">Pts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="p">(</span><span class="n">Pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;The function (ff) assessing the emissivity locally &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;must take a single positional argument: Pts a (3,N)&quot;</span>
            <span class="o">+</span> <span class="s2">&quot; np.ndarray of (X,Y,Z) cartesian coordinates !&quot;</span>
        <span class="p">)</span>

    <span class="n">Vals</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Vals</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="n">Int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Vals</span><span class="p">)</span> <span class="o">*</span> <span class="n">dLr</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;simps&quot;</span><span class="p">:</span>
        <span class="n">Int</span> <span class="o">=</span> <span class="n">scpintg</span><span class="o">.</span><span class="n">simps</span><span class="p">(</span><span class="n">Vals</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dLr</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;romb&quot;</span><span class="p">:</span>
        <span class="n">Int</span> <span class="o">=</span> <span class="n">scpintg</span><span class="o">.</span><span class="n">romb</span><span class="p">(</span><span class="n">Vals</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">dLr</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Int</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on Nov 15, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>