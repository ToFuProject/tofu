<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.geom._core &#8212; Tofu 1.4.15</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.15</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../contributing.html">Contributing</a></li>
                <li><a href="../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../aboutus.html">About</a></li>
                <li><a href="../../../releases.html">Releases</a></li>
                <li><a href="../../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.geom._core</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is the geometrical part of the ToFu general package</span>
<span class="sd">It includes all functions and object classes necessary for tomography</span>
<span class="sd">on Tokamaks</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="c1"># Built-in</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">inspect</span>


<span class="c1"># Common</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="c1"># ToFu-specific</span>
<span class="kn">from</span> <span class="nn">tofu</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">__version__</span>
<span class="kn">import</span> <span class="nn">tofu.pathfile</span> <span class="k">as</span> <span class="nn">tfpf</span>
<span class="kn">import</span> <span class="nn">tofu.utils</span> <span class="k">as</span> <span class="nn">utils</span>


<span class="c1"># test global import else relative</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tofu.geom._def</span> <span class="k">as</span> <span class="nn">_def</span>
    <span class="kn">import</span> <span class="nn">tofu.geom._GG</span> <span class="k">as</span> <span class="nn">_GG</span>
    <span class="kn">import</span> <span class="nn">tofu.geom._comp</span> <span class="k">as</span> <span class="nn">_comp</span>
    <span class="kn">import</span> <span class="nn">tofu.geom._comp_solidangles</span> <span class="k">as</span> <span class="nn">_comp_solidangles</span>
    <span class="kn">import</span> <span class="nn">tofu.geom._plot</span> <span class="k">as</span> <span class="nn">_plot</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_def</span> <span class="k">as</span> <span class="n">_def</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_GG</span> <span class="k">as</span> <span class="n">_GG</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_comp</span> <span class="k">as</span> <span class="n">_comp</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_comp_solidangles</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_plot</span> <span class="k">as</span> <span class="n">_plot</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;PlasmaDomain&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Ves&quot;</span><span class="p">,</span>
    <span class="s2">&quot;PFC&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CoilPF&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CoilCS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Config&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Rays&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CamLOS1D&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CamLOS2D&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="n">_arrayorder</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
<span class="n">_Clock</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_Type</span> <span class="o">=</span> <span class="s2">&quot;Tor&quot;</span>

<span class="c1"># rotate / translate instance</span>
<span class="n">_UPDATE_EXTENT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">_RETURN_COPY</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># Parallelization</span>
<span class="n">_NUM_THREADS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">_PHITHETAPROJ_NPHI</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">_PHITHETAPROJ_NTHETA</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">_RES</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">_DREFLECT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specular&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;diffusive&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ccube&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="c1"># Saving</span>
<span class="n">_COMMENT</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                        Ves class and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">Struct</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A class defining a Linear or Toroidal vaccum vessel (i.e. a 2D polygon</span>
<span class="sd">    representing a cross-section and assumed to be linearly or toroidally</span>
<span class="sd">    invariant)</span>

<span class="sd">    A Ves object is mostly defined by a close 2D polygon, which can be</span>
<span class="sd">    understood as a poloidal cross-section in (R,Z) cylindrical coordinates</span>
<span class="sd">    if Type=&#39;Tor&#39; (toroidal shape) or as a straight cross-section through a</span>
<span class="sd">    cylinder in (Y,Z) cartesian coordinates if Type=&#39;Lin&#39; (linear shape).</span>
<span class="sd">    Attributes such as the surface, the angular volume (if Type=&#39;Tor&#39;) or the</span>
<span class="sd">    center of mass are automatically computed.</span>
<span class="sd">    The instance is identified thanks to an attribute Id (which is itself a</span>
<span class="sd">    tofu.ID class object) which contains informations on the specific instance</span>
<span class="sd">    (name, Type...).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :            str / tfpf.ID</span>
<span class="sd">        A name string or a pre-built tfpf.ID class to be used to identify this</span>
<span class="sd">        particular instance, if a string is provided, it is fed to tfpf.ID()</span>
<span class="sd">    Poly :          np.ndarray</span>
<span class="sd">        An array (2,N) or (N,2) defining the contour of the vacuum vessel in a</span>
<span class="sd">        cross-section, if not closed, will be closed automatically</span>
<span class="sd">    Type :          str</span>
<span class="sd">        Flag indicating whether the vessel will be a torus (&#39;Tor&#39;) or a linear</span>
<span class="sd">        device (&#39;Lin&#39;)</span>
<span class="sd">    Lim :         list / np.ndarray</span>
<span class="sd">        Array or list of len=2 indicating the limits of the linear device</span>
<span class="sd">        volume on the x axis</span>
<span class="sd">    Sino_RefPt :    None / np.ndarray</span>
<span class="sd">        Array specifying a reference point for computing the sinogram (i.e.</span>
<span class="sd">        impact parameter), if None automatically set to the (surfacic) center</span>
<span class="sd">        of mass of the cross-section</span>
<span class="sd">    Sino_NP :       int</span>
<span class="sd">        Number of points in [0,2*pi] to be used to plot the vessel sinogram</span>
<span class="sd">        envelop</span>
<span class="sd">    Clock :         bool</span>
<span class="sd">        Flag indicating whether the input polygon should be made clockwise</span>
<span class="sd">        (True) or counter-clockwise (False)</span>
<span class="sd">    arrayorder:     str</span>
<span class="sd">        Flag indicating whether the attributes of type=np.ndarray (e.g.: Poly)</span>
<span class="sd">        should be made C-contiguous (&#39;C&#39;) or Fortran-contiguous (&#39;F&#39;)</span>
<span class="sd">    Exp :           None / str</span>
<span class="sd">        Flag indicating which experiment the object corresponds to, allowed</span>
<span class="sd">        values are in [None,&#39;AUG&#39;,&#39;MISTRAL&#39;,&#39;JET&#39;,&#39;ITER&#39;,&#39;TCV&#39;,&#39;TS&#39;,&#39;Misc&#39;]</span>
<span class="sd">    shot :          None / int</span>
<span class="sd">        Shot number from which this Ves is usable (in case of change of</span>
<span class="sd">        geometry)</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, forces the default saving path of the object to the</span>
<span class="sd">        provided value</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Ves :        Ves object</span>
<span class="sd">        The created Ves object, with all necessary computed attributes and</span>
<span class="sd">        methods</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># __metaclass__ = ABCMeta</span>

    <span class="c1"># Fixed (class-wise) dictionary of default properties</span>
    <span class="n">_ddef</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Mod&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Cls&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Diag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;shot&quot;</span><span class="p">,</span>
                <span class="s2">&quot;version&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
        <span class="s2">&quot;dgeom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Tor&quot;</span><span class="p">,</span> <span class="s2">&quot;Lim&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;arrayorder&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">},</span>
        <span class="s2">&quot;dsino&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;dphys&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;dreflect&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;specular&quot;</span><span class="p">},</span>
        <span class="s2">&quot;dmisc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="n">_dplot</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cross&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Elt&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dP&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dI&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dBs&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;dBv&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;dVect&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;hor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Elt&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dP&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dI&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
            <span class="s2">&quot;dBs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
            <span class="s2">&quot;dBv&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
            <span class="s2">&quot;Nstep&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;3d&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Elt&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dP&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="s2">&quot;rstride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;cstride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;antialiased&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Lim&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;Nstep&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">_DREFLECT_DTYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;specular&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;diffusive&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;ccube&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

    <span class="c1"># Does not exist beofre Python 3.6 !!!</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="c1"># Python 2</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Struct</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="c1"># Python 3</span>
        <span class="c1"># super().__init_subclass__(**kwdargs)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Struct</span><span class="o">.</span><span class="n">_ddef</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Struct</span><span class="o">.</span><span class="n">_dplot</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_set_color_ddef</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_color</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_set_color_ddef</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;dmisc&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sino_RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sino_nP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorNP</span><span class="p">,</span>
        <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">,</span>
        <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">SavePath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">),</span>
        <span class="n">SavePath_Include</span><span class="o">=</span><span class="n">tfpf</span><span class="o">.</span><span class="n">defInclude</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nturns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">superconducting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mag_field_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">current_lim_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># Create a dplot at instance level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_dplot</span><span class="p">)</span>

        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Struct</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Struct</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dgeom</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dsino</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dphys</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dphys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dreflect</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dmisc</span><span class="p">())</span>
        <span class="c1"># self._dplot = copy.deepcopy(self.__class__._ddef[&#39;dplot&#39;])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_Id</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwdargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">Id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">Name</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Type</span> <span class="o">=</span> <span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
        <span class="k">if</span> <span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shot</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;shot&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dgeom&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;include&quot;</span><span class="p">]</span>

        <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s2">&quot;Exp&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Exp</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">shot</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span>
            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Tor&quot;</span><span class="p">,</span> <span class="s2">&quot;Lin&quot;</span><span class="p">]},</span>
            <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">include</span><span class="p">,</span> <span class="s2">&quot;listof&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">dins</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span>
                <span class="s2">&quot;Exp&quot;</span><span class="p">:</span> <span class="n">Exp</span><span class="p">,</span>
                <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="n">shot</span><span class="p">,</span>
                <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
                <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="n">include</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">kwdargs</span>

    <span class="c1">###########</span>
    <span class="c1"># Get largs</span>
    <span class="c1">###########</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dgeom</span><span class="p">(</span><span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Poly&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Lim&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Clock&quot;</span><span class="p">,</span>
            <span class="s2">&quot;arrayorder&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">sino</span><span class="p">:</span>
            <span class="n">lsino</span> <span class="o">=</span> <span class="n">Struct</span><span class="o">.</span><span class="n">_get_largs_dsino</span><span class="p">()</span>
            <span class="n">largs</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;sino_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lsino</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dsino</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dphys</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lSymbols&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dreflect</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">,</span> <span class="s2">&quot;coefs_reflect&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dmisc</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="c1">###########</span>
    <span class="c1"># Get check and format inputs</span>
    <span class="c1">###########</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_Lim</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">Lim</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">Lim</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">Lim</span><span class="o">.</span><span class="n">size</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">Lim</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Lim</span> <span class="o">=</span> <span class="n">Lim</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Lim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">Lim</span> <span class="o">=</span> <span class="n">Lim</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Lin&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All provided Lim must be increasing !&quot;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Lim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Lim</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Lim</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Lim</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_posextent</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">):</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">extent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lfloat</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lfloat</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lfloat</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Tor&quot;</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lfloat</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lfloat</span><span class="p">:</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">extent</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">extent</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All provided extent values must be &gt;0 !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Tor&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">extent</span> <span class="o">&lt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provided extent must be in ]0;2pi[ (radians)!&quot;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">extent</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_LimFromPosExtent</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]])</span> <span class="o">*</span> <span class="n">extent</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Tor&quot;</span><span class="p">:</span>
                <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Lim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Lim</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Lim</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_PosExtentFromLim</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="s2">&quot;Tor&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Lim</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Tor&quot;</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">extent</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">extent</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">extent</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0e-9</span><span class="p">:</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">extent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dgeom</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">Poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">arrayorder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arrayorder</span> <span class="o">=</span> <span class="n">Struct</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dgeom&quot;</span><span class="p">][</span><span class="s2">&quot;arrayorder&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Type</span> <span class="o">=</span> <span class="n">Struct</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dgeom&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>

        <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Poly&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Poly</span><span class="p">,</span>
                <span class="s2">&quot;iter2array&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                <span class="s2">&quot;ndim&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;inshape&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Clock&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Clock</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">},</span>
            <span class="s2">&quot;arrayorder&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">arrayorder</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]},</span>
            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Tor&quot;</span><span class="p">,</span> <span class="s2">&quot;Lin&quot;</span><span class="p">]},</span>
        <span class="p">}</span>
        <span class="n">dins</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">dins</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">Poly</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;Poly&quot;</span><span class="p">][</span><span class="s2">&quot;var&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">Poly</span> <span class="o">=</span> <span class="n">Poly</span><span class="o">.</span><span class="n">T</span>

        <span class="c1"># --------------------------------------</span>
        <span class="c1"># Elimininate any double identical point</span>

        <span class="c1"># Treat closed polygons seperately (no warning)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Poly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-12</span><span class="p">:</span>
            <span class="n">Poly</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Treat other points</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                             <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-12</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
            <span class="n">npts</span> <span class="o">=</span> <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Poly</span> <span class="o">=</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="o">~</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> instance: double identical points in Poly</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; </span><span class="si">%s</span><span class="s2"> points removed</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ind</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; Poly goes from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> points&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">npts</span><span class="p">,</span>
                <span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Poly</span><span class="p">,</span> <span class="n">Poly</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-12</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">ind</span>

        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">Lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide either Lim xor pos/extent pair!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Lim should be an array of limits</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;pos should be an array of centers and extent a float / array&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="c1"># Lim = np.asarray([],dtype=float)</span>
        <span class="k">elif</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_posextent</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">Type</span><span class="p">)</span>
            <span class="c1"># Lim = cls._get_LimFromPosExtent(pos, extent, Type)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_checkformat_Lim</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="n">Type</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_PosExtentFromLim</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="n">Type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">arrayorder</span>

    <span class="k">def</span> <span class="nf">_checkformat_inputs_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">nP</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">nP</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="n">RefPt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">RefPt</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RefPt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">RefPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;BaryS&quot;</span><span class="p">]</span>
        <span class="n">RefPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">RefPt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">RefPt</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;RefPt must be of size=2 !&quot;</span>
        <span class="k">return</span> <span class="n">RefPt</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dphys</span><span class="p">(</span><span class="n">lSymbols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lSymbols</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">lSymbols</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lSymbols</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lSymbols</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lSymbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">lSymbols</span><span class="p">]</span>
            <span class="n">lSymbols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lSymbols</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lSymbols</span>

    <span class="k">def</span> <span class="nf">_checkformat_inputs_dreflect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coefs_reflect</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Types</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Types</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Types</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DREFLECT_DTYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DREFLECT_DTYPES</span><span class="p">[</span><span class="n">Types</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="n">Types</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">Types</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nseg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,)</span>
            <span class="n">Typesu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Typesu</span> <span class="o">==</span> <span class="n">vv</span>
                           <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DREFLECT_DTYPES</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">assert</span> <span class="n">coefs_reflect</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Types</span><span class="p">,</span> <span class="n">coefs_reflect</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dmisc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">is_color_like</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

    <span class="c1">###########</span>
    <span class="c1"># Get keys of dictionnaries</span>
    <span class="c1">###########</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dgeom</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Poly&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">,</span>
            <span class="s2">&quot;extent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;noccur&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Multi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;P1Max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;P1Min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;P2Max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;P2Min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BaryP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BaryL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BaryS&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BaryV&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Surf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VolAng&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Vect&quot;</span><span class="p">,</span>
            <span class="s2">&quot;VIn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;circ-C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;circ-r&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Clock&quot;</span><span class="p">,</span>
            <span class="s2">&quot;arrayorder&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move_param&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move_kwdargs&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dsino</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">,</span> <span class="s2">&quot;EnvTheta&quot;</span><span class="p">,</span> <span class="s2">&quot;EnvMinMax&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dphys</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lSymbols&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dreflect</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">,</span> <span class="s2">&quot;coefs_reflect&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dmisc</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="c1">###########</span>
    <span class="c1"># _init</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="n">_Type</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Clock</span><span class="o">=</span><span class="n">_Clock</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="n">_arrayorder</span><span class="p">,</span>
        <span class="n">sino_RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sino_nP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorNP</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwdargs</span>
    <span class="p">):</span>
        <span class="n">allkwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dgeom</span><span class="p">(</span><span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">kwdgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">allkwds</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dphys</span><span class="p">()</span>
        <span class="n">kwdphys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">allkwds</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dreflect</span><span class="p">()</span>
        <span class="n">kwdreflect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">allkwds</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dmisc</span><span class="p">()</span>
        <span class="n">kwdmisc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">allkwds</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="o">**</span><span class="n">kwdgeom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dphys</span><span class="p">(</span><span class="o">**</span><span class="n">kwdphys</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dreflect</span><span class="p">(</span><span class="o">**</span><span class="n">kwdreflect</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dmisc</span><span class="p">(</span><span class="o">**</span><span class="n">kwdmisc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">###########</span>
    <span class="c1"># set dictionaries</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_set_dgeom</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="p">,</span>
        <span class="n">sino_RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sino_nP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorNP</span><span class="p">,</span>
        <span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dgeom</span><span class="p">(</span>
            <span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span>
            <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
            <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">Poly</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">arrayorder</span> <span class="o">=</span> <span class="n">out</span>
        <span class="n">dgeom</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Struct_set_Poly</span><span class="p">(</span>
            <span class="n">Poly</span><span class="p">,</span>
            <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
            <span class="n">arrayorder</span><span class="o">=</span><span class="n">arrayorder</span><span class="p">,</span>
            <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
            <span class="n">Clock</span><span class="o">=</span><span class="n">Clock</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;arrayorder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">arrayorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dgeom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sino</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dsino</span><span class="p">(</span><span class="n">sino_RefPt</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="n">sino_nP</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorNP</span><span class="p">):</span>
        <span class="n">RefPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dsino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="n">nP</span><span class="p">)</span>
        <span class="n">EnvTheta</span><span class="p">,</span> <span class="n">EnvMinMax</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">Sino_ImpactEnv</span><span class="p">(</span>
            <span class="n">RefPt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span> <span class="n">NP</span><span class="o">=</span><span class="n">nP</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;RefPt&quot;</span><span class="p">:</span> <span class="n">RefPt</span><span class="p">,</span>
            <span class="s2">&quot;nP&quot;</span><span class="p">:</span> <span class="n">nP</span><span class="p">,</span>
            <span class="s2">&quot;EnvTheta&quot;</span><span class="p">:</span> <span class="n">EnvTheta</span><span class="p">,</span>
            <span class="s2">&quot;EnvMinMax&quot;</span><span class="p">:</span> <span class="n">EnvMinMax</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">set_dphys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lSymbols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lSymbols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dphys</span><span class="p">(</span><span class="n">lSymbols</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dphys</span><span class="p">[</span><span class="s2">&quot;lSymbols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lSymbols</span>

    <span class="k">def</span> <span class="nf">set_dreflect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coefs_reflect</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Types</span><span class="p">,</span> <span class="n">coefs_reflect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dreflect</span><span class="p">(</span>
            <span class="n">Types</span><span class="o">=</span><span class="n">Types</span><span class="p">,</span> <span class="n">coefs_reflect</span><span class="o">=</span><span class="n">coefs_reflect</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span><span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span><span class="p">[</span><span class="s2">&quot;coefs_reflect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefs_reflect</span>

    <span class="k">def</span> <span class="nf">_set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dmisc</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;cross&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;hor&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;3d&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>

    <span class="k">def</span> <span class="nf">_set_dmisc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

    <span class="c1">###########</span>
    <span class="c1"># strip dictionaries</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_strip_dgeom</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Poly&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;extent&quot;</span><span class="p">,</span> <span class="s2">&quot;Clock&quot;</span><span class="p">,</span> <span class="s2">&quot;arrayorder&quot;</span><span class="p">,</span>
               <span class="s2">&quot;move&quot;</span><span class="p">,</span> <span class="s2">&quot;move_param&quot;</span><span class="p">,</span> <span class="s2">&quot;move_kwdargs&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_strip_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">]):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_strip_dphys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lSymbols&quot;</span><span class="p">]):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dphys</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_strip_dreflect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">,</span> <span class="s2">&quot;coefs_reflect&quot;</span><span class="p">]):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_strip_dmisc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>

    <span class="c1">###########</span>
    <span class="c1"># rebuild dictionaries</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_rebuild_dgeom</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Poly&quot;</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;extent&quot;</span><span class="p">,</span> <span class="s2">&quot;Clock&quot;</span><span class="p">,</span> <span class="s2">&quot;arrayorder&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_test_Rebuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_check_Fields4Rebuild</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">,</span> <span class="n">dname</span><span class="o">=</span><span class="s2">&quot;dgeom&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span>
                <span class="n">pos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">,</span>
                <span class="n">Clock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;Clock&quot;</span><span class="p">],</span>
                <span class="n">arrayorder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;arrayorder&quot;</span><span class="p">],</span>
                <span class="n">sino</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rebuild_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">]):</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_test_Rebuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_check_Fields4Rebuild</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">,</span> <span class="n">dname</span><span class="o">=</span><span class="s2">&quot;dsino&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dsino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">],</span> <span class="n">nP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;nP&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_rebuild_dphys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lSymbols&quot;</span><span class="p">]):</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_test_Rebuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dphys</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_check_Fields4Rebuild</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dphys</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">,</span> <span class="n">dname</span><span class="o">=</span><span class="s2">&quot;dphys&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dphys</span><span class="p">(</span><span class="n">lSymbols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dphys</span><span class="p">[</span><span class="s2">&quot;lSymbols&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_rebuild_dreflect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">,</span> <span class="s2">&quot;coefs_reflect&quot;</span><span class="p">]):</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_test_Rebuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_check_Fields4Rebuild</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">,</span> <span class="n">dname</span><span class="o">=</span><span class="s2">&quot;dreflect&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dreflect</span><span class="p">(</span>
                <span class="n">Types</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dreflect</span><span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">],</span>
                <span class="n">coefs_reflect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dreflect</span><span class="p">[</span><span class="s2">&quot;coefs_reflect&quot;</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rebuild_dmisc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]):</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_test_Rebuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_check_Fields4Rebuild</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">,</span> <span class="n">dname</span><span class="o">=</span><span class="s2">&quot;dmisc&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dmisc</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>

    <span class="c1">###########</span>
    <span class="c1"># _strip and get/from dict</span>
    <span class="c1">###########</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">])</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 1: Remove dsino expendables</span>
<span class="s2">                 2: Remove also dgeom, dphys, dreflect and dmisc expendables&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">nMax</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Struct</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dgeom</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dsino</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dphys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dreflect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dmisc</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dsino</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dgeom</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dphys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dreflect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dmisc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dsino</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dgeom</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dphys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dreflect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dmisc</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dgeom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dsino&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dphys&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dphys</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dreflect&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dreflect</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dmisc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmisc</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dplot&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">dout</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dgeom&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dsino&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dphys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dphys&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;dplot&quot;</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dplot&quot;</span><span class="p">])</span>

    <span class="c1">###########</span>
    <span class="c1"># Properties</span>
    <span class="c1">###########</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the type of structure &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">Type</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Poly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the polygon defining the structure cross-section&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Poly&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Poly_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returned the closed polygon &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Poly&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Poly&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nseg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Retunr the number of segmnents constituting the closed polygon &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Poly&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">extent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;extent&quot;</span><span class="p">],</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;extent&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;extent&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">extent</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">noccur</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;noccur&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Lim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_LimFromPosExtent</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;extent&quot;</span><span class="p">],</span> <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">Lim</span><span class="o">.</span><span class="n">T</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dphys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dphys</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dreflect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dmisc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span>

    <span class="c1">###########</span>
    <span class="c1"># public methods</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">just</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span>
        <span class="n">table_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Summary description of the object content &quot;&quot;&quot;</span>

        <span class="c1"># -----------------------</span>
        <span class="c1"># Build detailed view</span>
        <span class="n">col0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;class&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SaveName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;noccur&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">ar0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">SaveName</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nP&quot;</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;noccur&quot;</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">col0</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">]</span>
            <span class="n">ar0</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">],</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;move_param&quot;</span><span class="p">],</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">4</span><span class="p">))]</span>
        <span class="n">col0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">)</span>
        <span class="n">cstr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span>
                <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:4.2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]])</span>
                <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">ar0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ar0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">col0</span><span class="p">],</span>
            <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
            <span class="n">table_sep</span><span class="o">=</span><span class="n">table_sep</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">return_</span><span class="o">=</span><span class="n">return_</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1">###########</span>
    <span class="c1"># public methods for movement</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_update_or_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span>
                        <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">update_extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">update_extent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_extent</span> <span class="o">=</span> <span class="n">_UPDATE_EXTENT</span>
        <span class="k">if</span> <span class="n">return_copy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_copy</span> <span class="o">=</span> <span class="n">_RETURN_COPY</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span>
        <span class="k">if</span> <span class="n">update_extent</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">extent</span> <span class="o">=</span> <span class="n">extent</span><span class="o">*</span><span class="n">ratio</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">if</span> <span class="n">return_copy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span> <span class="s1">&#39;copy&#39;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">Poly</span><span class="o">=</span><span class="n">poly</span><span class="p">,</span>
                                  <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                                  <span class="n">sino_RefPt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s1">&#39;RefPt&#39;</span><span class="p">],</span>
                                  <span class="n">sino_nP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s1">&#39;nP&#39;</span><span class="p">],</span>
                                  <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
                                  <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
                                  <span class="n">Name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                  <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                                  <span class="n">SavePath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span><span class="p">,</span>
                                  <span class="n">Type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                            <span class="n">sino_RefPt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s1">&#39;RefPt&#39;</span><span class="p">],</span>
                            <span class="n">sino_nP</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s1">&#39;nP&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">translate_in_cross_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direction_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">update_extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Translate the structure in the poloidal plane &quot;&quot;&quot;</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_translate_pts_poloidal_plane_2D</span><span class="p">(</span>
            <span class="n">pts_rz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span>
            <span class="n">direction_rz</span><span class="o">=</span><span class="n">direction_rz</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">update_extent</span><span class="o">=</span><span class="n">update_extent</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rotate_in_cross_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">update_extent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Rotate the structure in the poloidal plane &quot;&quot;&quot;</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_pts_vectors_in_poloidal_plane_2D</span><span class="p">(</span>
            <span class="n">pts_rz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span>
            <span class="n">axis_rz</span><span class="o">=</span><span class="n">axis_rz</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="n">poly</span><span class="p">,</span> <span class="n">update_extent</span><span class="o">=</span><span class="n">update_extent</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rotate_around_torusaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Rotate the structure in the poloidal plane &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="s1">&#39;Tor&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Movement only available for Tor configurations!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">angle</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                                    <span class="n">update_extent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">move</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the default movement parameters</span>

<span class="sd">        A default movement can be set for the instance, it can be any of the</span>
<span class="sd">        pre-implemented movement (rotations or translations)</span>
<span class="sd">        This default movement is the one that will be called when using</span>
<span class="sd">        self.move()</span>

<span class="sd">        Specify the type of movement via the name of the method (passed as a</span>
<span class="sd">        str to move)</span>

<span class="sd">        Specify, for the geometry of the instance at the time of defining this</span>
<span class="sd">        default movement, the current value of the associated movement</span>
<span class="sd">        parameter (angle / distance). This is used to set an arbitrary</span>
<span class="sd">        difference for user who want to use absolute position values</span>
<span class="sd">        The desired incremental movement to be performed when calling self.move</span>
<span class="sd">        will be deduced by substracting the stored param value to the provided</span>
<span class="sd">        param value. Just set the current param value to 0 if you don&#39;t care</span>
<span class="sd">        about a custom absolute reference.</span>

<span class="sd">        kwdargs must be a parameters relevant to the chosen method (axis,</span>
<span class="sd">        direction...)</span>

<span class="sd">        e.g.:</span>
<span class="sd">            self.set_move(move=&#39;rotate_around_3daxis&#39;,</span>
<span class="sd">                          param=0.,</span>
<span class="sd">                          axis=([0.,0.,0.], [1.,0.,0.]))</span>
<span class="sd">            self.set_move(move=&#39;translate_3d&#39;,</span>
<span class="sd">                          param=0.,</span>
<span class="sd">                          direction=[0.,1.,0.])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">move</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_set_move</span><span class="p">(</span><span class="n">move</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_kwdargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwdargs</span>

    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set new position to desired param according to default movement</span>

<span class="sd">        Can only be used if default movement was set before</span>
<span class="sd">        See self.set_move()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">dictname</span><span class="o">=</span><span class="s1">&#39;_dgeom&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>

    <span class="c1">###########</span>
    <span class="c1"># Other public methods</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">isInside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s2">&quot;(X,Y,Z)&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an array of booleans indicating whether each point lies</span>
<span class="sd">        inside the Struct volume</span>

<span class="sd">        Tests for each point whether it lies inside the Struct object.</span>
<span class="sd">        The points coordinates can be provided in 2D or 3D</span>
<span class="sd">        You must specify which coordinate system is used with &#39;In&#39; kwdarg.</span>
<span class="sd">        An array of boolean flags is returned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pts :   np.ndarray</span>
<span class="sd">            (2,N) or (3,N) array, coordinates of the points to be tested</span>
<span class="sd">        In :    str</span>
<span class="sd">            Flag indicating the coordinate system in which pts are provided</span>
<span class="sd">            e.g.: &#39;(X,Y,Z)&#39; or &#39;(R,Z)&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :   np.ndarray</span>
<span class="sd">            (N,) array of booleans, True if a point is inside the volume</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;noccur&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span>
                <span class="n">pts</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span>
                <span class="n">ves_lims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lim</span><span class="p">),</span>
                <span class="n">nlim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;noccur&quot;</span><span class="p">],</span>
                <span class="n">ves_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
                <span class="n">in_format</span><span class="o">=</span><span class="n">In</span><span class="p">,</span>
                <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span>
                <span class="n">pts</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span>
                <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">nlim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">ves_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
                <span class="n">in_format</span><span class="o">=</span><span class="n">In</span><span class="p">,</span>
                <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ind</span>

    <span class="k">def</span> <span class="nf">get_InsideConvexPoly</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">RelOff</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorRelOff</span><span class="p">,</span>
        <span class="n">ZLim</span><span class="o">=</span><span class="s2">&quot;Def&quot;</span><span class="p">,</span>
        <span class="n">Spline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">Splprms</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorSplprms</span><span class="p">,</span>
        <span class="n">NP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorInsideNP</span><span class="p">,</span>
        <span class="n">Plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a polygon that is a smaller and smoothed approximation of</span>
<span class="sd">        Ves.Poly, useful for excluding the divertor region in a Tokamak</span>

<span class="sd">        For some uses, it can be practical to approximate the polygon defining</span>
<span class="sd">        the Ves object (which can be non-convex, like with a divertor), by a</span>
<span class="sd">        simpler, sligthly smaller and convex polygon.</span>
<span class="sd">        This method provides a fast solution for computing such a proxy.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        RelOff :    float</span>
<span class="sd">            Fraction by which an homothetic polygon should be reduced</span>
<span class="sd">            (1.-RelOff)*(Poly-BaryS)</span>
<span class="sd">        ZLim :      None / str / tuple</span>
<span class="sd">            Flag indicating what limits shall be put to the height of the</span>
<span class="sd">            polygon (used for excluding divertor)</span>
<span class="sd">        Spline :    bool</span>
<span class="sd">            Flag indiating whether the reduced and truncated polygon shall be</span>
<span class="sd">            smoothed by 2D b-spline curves</span>
<span class="sd">        Splprms :   list</span>
<span class="sd">            List of 3 parameters to be used for the smoothing</span>
<span class="sd">            [weights,smoothness,b-spline order], fed to</span>
<span class="sd">            scipy.interpolate.splprep()</span>
<span class="sd">        NP :        int</span>
<span class="sd">            Number of points to be used to define the smoothed polygon</span>
<span class="sd">        Plot :      bool</span>
<span class="sd">            Flag indicating whether the result shall be plotted for visual</span>
<span class="sd">            inspection</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Poly :      np.ndarray</span>
<span class="sd">            (2,N) polygon resulting from homothetic transform, truncating and</span>
<span class="sd">            optional smoothingop</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Ves_get_InsideConvexPoly</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P2Min&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P2Max&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;BaryS&quot;</span><span class="p">],</span>
            <span class="n">RelOff</span><span class="o">=</span><span class="n">RelOff</span><span class="p">,</span>
            <span class="n">ZLim</span><span class="o">=</span><span class="n">ZLim</span><span class="p">,</span>
            <span class="n">Spline</span><span class="o">=</span><span class="n">Spline</span><span class="p">,</span>
            <span class="n">Splprms</span><span class="o">=</span><span class="n">Splprms</span><span class="p">,</span>
            <span class="n">NP</span><span class="o">=</span><span class="n">NP</span><span class="p">,</span>
            <span class="n">Plot</span><span class="o">=</span><span class="n">Plot</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sampleEdge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offsetIn</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sample the polygon edges, with resolution res</span>

<span class="sd">        Sample each segment of the 2D polygon</span>
<span class="sd">        Sampling can be limited to a domain</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_RES</span>
        <span class="k">return</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Ves_get_sampleEdge</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
            <span class="n">offsetIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
            <span class="n">VIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;VIn&quot;</span><span class="p">],</span>
            <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sampleCross</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;flat&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sample, with resolution res, the 2D cross-section</span>

<span class="sd">        The sampling domain can be limited by domain or ind</span>

<span class="sd">        Depending on the value of mode, the method returns:</span>
<span class="sd">            - &#39;flat&#39;: (tuned for integrals computing)</span>
<span class="sd">                pts   : (2,npts) array of points coordinates</span>
<span class="sd">                dS    : (npts,) array of surfaces</span>
<span class="sd">                ind   : (npts,) array of integer indices</span>
<span class="sd">                reseff: (2,) array of effective resolution (R and Z)</span>
<span class="sd">            - &#39;imshow&#39; : (tuned for imshow plotting)</span>
<span class="sd">                pts : (2,n1,n2) array of points coordinates</span>
<span class="sd">                x1  : (n1,) vector of unique x1 coordinates</span>
<span class="sd">                x2  : (n2,) vector of unique x2 coordinates</span>
<span class="sd">                extent : the extent to be fed to mpl.pyplot.imshow()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_RES</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P1Min&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P1Max&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P2Min&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P2Max&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Ves_get_sampleCross</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sampleS</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">offsetIn</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">returnas</span><span class="o">=</span><span class="s2">&quot;(X,Y,Z)&quot;</span><span class="p">,</span>
        <span class="n">Ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sample, with resolution res, the surface defined by domain or ind</span>

<span class="sd">        An optionnal offset perpendicular to the surface can be used</span>
<span class="sd">        (offsetIn&gt;0 =&gt; inwards)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        res     :   float / list of 2 floats</span>
<span class="sd">            Desired resolution of the surfacic sample</span>
<span class="sd">                float   : same resolution for all directions of the sample</span>
<span class="sd">                list    : [dl,dXPhi] where:</span>
<span class="sd">                    dl      : res. along polygon contours (cross-section)</span>
<span class="sd">                    dXPhi   : res. along axis (toroidal/linear direction)</span>
<span class="sd">        domain :    None / list of 3 lists of 2 floats</span>
<span class="sd">            Limits of the domain in which the sample should be computed</span>
<span class="sd">                None : whole surface of the object</span>
<span class="sd">                list : [D1, D2, D3], where Di is a len()=2 list</span>
<span class="sd">                       (increasing floats, setting limits along coordinate i)</span>
<span class="sd">                    [DR, DZ, DPhi]: in toroidal geometry (self.Id.Type==&#39;Tor&#39;)</span>
<span class="sd">                    [DX, DY, DZ]  : in linear geometry (self.Id.Type==&#39;Lin&#39;)</span>
<span class="sd">        resMode  :   str</span>
<span class="sd">            Flag, specifies if res is absolute or relative to element sizes</span>
<span class="sd">                &#39;abs&#39;   :   res is an absolute distance</span>
<span class="sd">                &#39;rel&#39;   :   if res=0.1, each polygon segment is divided in 10,</span>
<span class="sd">                            as is the toroidal/linear length</span>
<span class="sd">        ind     :   None / np.ndarray of int</span>
<span class="sd">            If provided, DS is ignored and the sample points corresponding to</span>
<span class="sd">            the provided indices are returned</span>
<span class="sd">            Example (assuming obj is a Ves object)</span>
<span class="sd">                &gt; # We create a 5x5 cm2 sample of the whole surface</span>
<span class="sd">                &gt; pts, dS, ind, reseff = obj.get_sample(0.05)</span>
<span class="sd">                &gt; # Perform operations, save only the points indices</span>
<span class="sd">                &gt; # (save space)</span>
<span class="sd">                &gt; ...</span>
<span class="sd">                &gt; # Retrieve the points from their indices (requires same res)</span>
<span class="sd">                &gt; pts2, dS2, ind2, reseff2 = obj.get_sample(0.05, ind=ind)</span>
<span class="sd">                &gt; np.allclose(pts,pts2)</span>
<span class="sd">                True</span>
<span class="sd">        offsetIn:   float</span>
<span class="sd">            Offset distance from the actual surface of the object</span>
<span class="sd">            Inwards if positive</span>
<span class="sd">            Useful to avoid numerical errors</span>
<span class="sd">        returnas:   str</span>
<span class="sd">            Flag indicating the coordinate system of returned points</span>
<span class="sd">            e.g. : &#39;(X,Y,Z)&#39; or &#39;(R,Z,Phi)&#39;</span>
<span class="sd">        Ind     :   None / iterable of ints</span>
<span class="sd">            Array of indices of the entities to be considered</span>
<span class="sd">            (only when multiple entities, i.e.: self.nLim&gt;1)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pts     :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            Sample points coordinates, as a (3,N) array.</span>
<span class="sd">            A list is returned if the object has multiple entities</span>
<span class="sd">        dS      :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            The surface (in m^2) associated to each point</span>
<span class="sd">        ind     :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            The index of each point</span>
<span class="sd">        reseff  :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            Effective resolution in both directions after sample computation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;Multi&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_RES</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
            <span class="n">offsetIn</span><span class="o">=</span><span class="n">offsetIn</span><span class="p">,</span>
            <span class="n">VIn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;VIn&quot;</span><span class="p">],</span>
            <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
            <span class="n">VLim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lim</span><span class="p">),</span>
            <span class="n">nVLim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">noccur</span><span class="p">,</span>
            <span class="n">returnas</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
            <span class="n">Multi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;Multi&quot;</span><span class="p">],</span>
            <span class="n">Ind</span><span class="o">=</span><span class="n">Ind</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Ves_get_sampleS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sampleV</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">returnas</span><span class="o">=</span><span class="s2">&quot;(X,Y,Z)&quot;</span><span class="p">,</span>
        <span class="n">algo</span><span class="o">=</span><span class="s2">&quot;new&quot;</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="o">=</span><span class="mi">48</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sample, with resolution res, the volume defined by domain or ind</span>

<span class="sd">        The 3D volume is sampled in:</span>
<span class="sd">            - the whole volume (domain=None and ind=None)</span>
<span class="sd">            - a sub-domain defined by bounds on each coordinates (domain)</span>
<span class="sd">            - a pre-computed subdomain stored in indices (ind)</span>

<span class="sd">        The coordinatesd of the center of each volume elements are returned as</span>
<span class="sd">        pts in choosen coordinates (returnas)</span>

<span class="sd">        For a torus, the elementary volume is kept constant, meaning that the</span>
<span class="sd">        toroidal angular step is decreased as R increases</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        res     :   float / list of 3 floats</span>
<span class="sd">            Desired resolution of the surfacic sample</span>
<span class="sd">                float   : same resolution for all directions of the sample</span>
<span class="sd">                list    : [dYR, dZ, dXPhi] where:</span>
<span class="sd">                    dYR     : res. along in radial / Y direction</span>
<span class="sd">                    dZ      : res. along Z direction</span>
<span class="sd">                    dXPhi   : res. along axis (toroidal/linear direction)</span>
<span class="sd">        domain :    None / list of 3 lists of 2 floats</span>
<span class="sd">            Limits of the domain in which the sample should be computed</span>
<span class="sd">                None : whole surface of the object</span>
<span class="sd">                list : [D1, D2, D3], where Di is a len()=2 list</span>
<span class="sd">                       (increasing floats, setting limits along coordinate i)</span>
<span class="sd">                    [DR, DZ, DPhi]: in toroidal geometry (self.Id.Type==&#39;Tor&#39;)</span>
<span class="sd">                    [DX, DY, DZ]  : in linear geometry (self.Id.Type==&#39;Lin&#39;)</span>
<span class="sd">        resMode  :   str</span>
<span class="sd">            Flag, specifies if res is absolute or relative to element sizes</span>
<span class="sd">                &#39;abs&#39;   :   res is an absolute distance</span>
<span class="sd">                &#39;rel&#39;   :   if res=0.1, each polygon segment is divided in 10,</span>
<span class="sd">                            as is the toroidal/linear length</span>
<span class="sd">        ind     :   None / np.ndarray of int</span>
<span class="sd">            If provided, DS is ignored and the sample points corresponding to</span>
<span class="sd">            the provided indices are returned</span>
<span class="sd">            Example (assuming obj is a Ves object)</span>
<span class="sd">                &gt; # We create a 5x5 cm2 sample of the whole surface</span>
<span class="sd">                &gt; pts, dS, ind, reseff = obj.get_sample(0.05)</span>
<span class="sd">                &gt; # Perform operations, save only the points indices</span>
<span class="sd">                &gt; # (save space)</span>
<span class="sd">                &gt; ...</span>
<span class="sd">                &gt; # Retrieve the points from their indices (requires same res)</span>
<span class="sd">                &gt; pts2, dS2, ind2, reseff2 = obj.get_sample(0.05, ind=ind)</span>
<span class="sd">                &gt; np.allclose(pts,pts2)</span>
<span class="sd">                True</span>
<span class="sd">        returnas:   str</span>
<span class="sd">            Flag indicating the coordinate system of returned points</span>
<span class="sd">            e.g. : &#39;(X,Y,Z)&#39; or &#39;(R,Z,Phi)&#39;</span>
<span class="sd">        Ind     :   None / iterable of ints</span>
<span class="sd">            Array of indices of the entities to be considered</span>
<span class="sd">            (only when multiple entities, i.e.: self.nLim&gt;1)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pts     :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            Sample points coordinates, as a (3,N) array.</span>
<span class="sd">            A list is returned if the object has multiple entities</span>
<span class="sd">        dV      :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            The volume (in m^3) associated to each point</span>
<span class="sd">        ind     :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            The index of each point</span>
<span class="sd">        reseff  :   np.ndarray / list of np.ndarrays</span>
<span class="sd">            Effective resolution in both directions after sample computation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P1Min&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P1Max&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P2Min&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;P2Max&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span>
            <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
            <span class="n">VType</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
            <span class="n">VLim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Lim</span><span class="p">,</span>
            <span class="n">returnas</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
            <span class="n">algo</span><span class="o">=</span><span class="n">algo</span><span class="p">,</span>
            <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Ves_get_sampleV</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_phithetaproj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refpt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Prepare ax</span>
        <span class="k">if</span> <span class="n">refpt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide refpt (R,Z)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">refpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">refpt</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">refpt</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Struct_get_phithetaproj</span><span class="p">(</span>
            <span class="n">refpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noccur</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_phithetaproj_dist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">refpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="c1"># Prepare ax</span>
        <span class="k">if</span> <span class="n">refpt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide refpt (R,Z)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">refpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">refpt</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">refpt</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>

        <span class="c1"># Prepare theta and phi</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ntheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nphi</span> <span class="o">=</span> <span class="n">_PHITHETAPROJ_NTHETA</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">ntheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide either ntheta xor a theta vector !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nphi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nphi</span> <span class="o">=</span> <span class="n">_PHITHETAPROJ_NPHI</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nphi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide either nphi xor a phi vector !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">nphi</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get limits</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Struct_get_phithetaproj</span><span class="p">(</span>
            <span class="n">refpt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">noccur</span>
        <span class="p">)</span>
        <span class="n">nDphi</span><span class="p">,</span> <span class="n">Dphi</span><span class="p">,</span> <span class="n">nDtheta</span><span class="p">,</span> <span class="n">Dtheta</span> <span class="o">=</span> <span class="n">out</span>

        <span class="c1"># format inputs</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
        <span class="n">ntheta</span><span class="p">,</span> <span class="n">nphi</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">phi</span><span class="o">.</span><span class="n">size</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">ntheta</span><span class="p">,</span> <span class="n">nphi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Get dist</span>
        <span class="n">dist_theta</span><span class="p">,</span> <span class="n">indphi</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_get_phithetaproj_dist</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span>
            <span class="n">refpt</span><span class="p">,</span>
            <span class="n">Dtheta</span><span class="p">,</span>
            <span class="n">nDtheta</span><span class="p">,</span>
            <span class="n">Dphi</span><span class="p">,</span>
            <span class="n">nDphi</span><span class="p">,</span>
            <span class="n">theta</span><span class="p">,</span>
            <span class="n">phi</span><span class="p">,</span>
            <span class="n">ntheta</span><span class="p">,</span>
            <span class="n">nphi</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noccur</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">dist</span><span class="p">[:,</span> <span class="n">indphi</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_theta</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">nDphi</span><span class="p">,</span> <span class="n">Dphi</span><span class="p">,</span> <span class="n">nDtheta</span><span class="p">,</span> <span class="n">Dtheta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_reflections_ufromTypes</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">Types</span><span class="p">):</span>
        <span class="n">indspec</span> <span class="o">=</span> <span class="n">Types</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">inddiff</span> <span class="o">=</span> <span class="n">Types</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">indcorn</span> <span class="o">=</span> <span class="n">Types</span> <span class="o">==</span> <span class="mi">2</span>

        <span class="c1"># Get reflected unit vectors</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">indspec</span><span class="p">,</span> <span class="n">inddiff</span><span class="p">)):</span>
            <span class="n">vpar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">vperp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">vperp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">vperp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">vpar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vpar</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">vpar</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:],</span>
                    <span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">vpar</span> <span class="o">=</span> <span class="n">vpar</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vpar</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indspec</span><span class="p">):</span>
                <span class="c1"># Compute u2 for specular</span>
                <span class="n">sca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">u</span><span class="p">[:,</span> <span class="n">indspec</span><span class="p">]</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[:,</span> <span class="n">indspec</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">sca2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">u</span><span class="p">[:,</span> <span class="n">indspec</span><span class="p">]</span> <span class="o">*</span> <span class="n">vpar</span><span class="p">[:,</span> <span class="n">indspec</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sca</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sca</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sca2</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sca</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">u2</span><span class="p">[:,</span> <span class="n">indspec</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="o">-</span><span class="n">sca</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[:,</span> <span class="n">indspec</span><span class="p">]</span> <span class="o">+</span> <span class="n">sca2</span> <span class="o">*</span> <span class="n">vpar</span><span class="p">[:,</span> <span class="n">indspec</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">inddiff</span><span class="p">):</span>
                <span class="c1"># Compute u2 for diffusive</span>
                <span class="n">sca</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">inddiff</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">u2</span><span class="p">[:,</span> <span class="n">inddiff</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sca</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">vperp</span><span class="p">[:,</span> <span class="n">inddiff</span><span class="p">]</span>
                    <span class="o">+</span> <span class="n">sca</span> <span class="o">*</span> <span class="n">vpar</span><span class="p">[:,</span> <span class="n">inddiff</span><span class="p">]</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indcorn</span><span class="p">):</span>
            <span class="n">u2</span><span class="p">[:,</span> <span class="n">indcorn</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span><span class="p">[:,</span> <span class="n">indcorn</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">u2</span>

    <span class="k">def</span> <span class="nf">get_reflections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indout2</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vperp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the reflected unit vectors from input unit vectors and vperp</span>

<span class="sd">        The reflected unit vector depends on the incoming LOS (u),</span>
<span class="sd">        the local normal unit vector (vperp), and the polygon segment hit</span>
<span class="sd">        (indout2)</span>
<span class="sd">        Future releases: dependence on lambda</span>

<span class="sd">        Also return per-LOS reflection Types (0:specular, 1:diffusive, 2:ccube)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get per-LOS reflection Types and associated indices</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dreflect</span><span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">][</span><span class="n">indout2</span><span class="p">]</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">vperp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reflections_ufromTypes</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">Types</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Types</span><span class="p">,</span> <span class="n">u2</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="s2">&quot;PIBsBvV&quot;</span><span class="p">,</span>
        <span class="n">dP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dI</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorId</span><span class="p">,</span>
        <span class="n">dBs</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorBsd</span><span class="p">,</span>
        <span class="n">dBv</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorBvd</span><span class="p">,</span>
        <span class="n">dVect</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorVind</span><span class="p">,</span>
        <span class="n">dIHor</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorITord</span><span class="p">,</span>
        <span class="n">dBsHor</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorBsTord</span><span class="p">,</span>
        <span class="n">dBvHor</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorBvTord</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Nstep</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorNTheta</span><span class="p">,</span>
        <span class="n">dLeg</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
        <span class="n">indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the polygon defining the vessel, in chosen projection</span>

<span class="sd">        Generic method for plotting the Ves object</span>
<span class="sd">        The projections to be plotted, the elements to plot can be specified</span>
<span class="sd">        Dictionaries of properties for each elements can also be specified</span>
<span class="sd">        If an ax is not provided a default one is created.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Lax :       list or plt.Axes</span>
<span class="sd">            The axes to be used for plotting</span>
<span class="sd">            Provide a list of 2 axes if proj=&#39;All&#39;</span>
<span class="sd">            If None a new figure with axes is created</span>
<span class="sd">        proj :      str</span>
<span class="sd">            Flag specifying the kind of projection</span>
<span class="sd">                - &#39;Cross&#39; : cross-section projection</span>
<span class="sd">                - &#39;Hor&#39; : horizontal projection</span>
<span class="sd">                - &#39;All&#39; : both</span>
<span class="sd">                - &#39;3d&#39; : a 3d matplotlib plot</span>
<span class="sd">        element :   str</span>
<span class="sd">            Flag specifying which elements to plot</span>
<span class="sd">            Each capital letter corresponds to an element:</span>
<span class="sd">                * &#39;P&#39;: polygon</span>
<span class="sd">                * &#39;I&#39;: point used as a reference for impact parameters</span>
<span class="sd">                * &#39;Bs&#39;: (surfacic) center of mass</span>
<span class="sd">                * &#39;Bv&#39;: (volumic) center of mass for Tor type</span>
<span class="sd">                * &#39;V&#39;: vector pointing inward perpendicular to each segment</span>
<span class="sd">        dP :        dict / None</span>
<span class="sd">            Dict of properties for plotting the polygon</span>
<span class="sd">            Fed to plt.Axes.plot() or plt.plot_surface() if proj=&#39;3d&#39;</span>
<span class="sd">        dI :        dict / None</span>
<span class="sd">            Dict of properties for plotting point &#39;I&#39; in Cross-section</span>
<span class="sd">            projection</span>
<span class="sd">        dIHor :     dict / None</span>
<span class="sd">            Dict of properties for plotting point &#39;I&#39; in horizontal projection</span>
<span class="sd">        dBs :       dict / None</span>
<span class="sd">            Dict of properties for plotting point &#39;Bs&#39; in Cross-section</span>
<span class="sd">            projection</span>
<span class="sd">        dBsHor :    dict / None</span>
<span class="sd">            Dict of properties for plotting point &#39;Bs&#39; in horizontal projection</span>
<span class="sd">        dBv :       dict / None</span>
<span class="sd">            Dict of properties for plotting point &#39;Bv&#39; in Cross-section</span>
<span class="sd">            projection</span>
<span class="sd">        dBvHor :    dict / None</span>
<span class="sd">            Dict of properties for plotting point &#39;Bv&#39; in horizontal projection</span>
<span class="sd">        dVect :     dict / None</span>
<span class="sd">            Dict of properties for plotting point &#39;V&#39; in cross-section</span>
<span class="sd">            projection</span>
<span class="sd">        dLeg :      dict / None</span>
<span class="sd">            Dict of properties for plotting the legend, fed to plt.legend()</span>
<span class="sd">            The legend is not plotted if None</span>
<span class="sd">        Lim :       list or tuple</span>
<span class="sd">            Array of a lower and upper limit of angle (rad.) or length for</span>
<span class="sd">            plotting the &#39;3d&#39; proj</span>
<span class="sd">        Nstep :     int</span>
<span class="sd">            Number of points for sampling in ignorable coordinate (toroidal</span>
<span class="sd">            angle or length)</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called</span>
<span class="sd">            automatically</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be plotted in a4</span>
<span class="sd">            dimensions for printing</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        La          list / plt.Axes</span>
<span class="sd">            Handles of the axes used for plotting (list if several axes where</span>
<span class="sd">            used)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lout</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Struct_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_sino</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Ang</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSImpAng</span><span class="p">,</span>
        <span class="n">AngUnit</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSImpAngUnit</span><span class="p">,</span>
        <span class="n">Sketch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dLeg</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the sinogram of the vessel polygon, by computing its envelopp</span>
<span class="sd">        in a cross-section, can also plot a 3D version of it.</span>

<span class="sd">        The envelop of the polygon is computed using self.Sino_RefPt as a</span>
<span class="sd">        reference point in projection space,</span>
<span class="sd">        and plotted using the provided dictionary of properties.</span>
<span class="sd">        Optionaly a small sketch can be included illustrating how the angle</span>
<span class="sd">        and the impact parameters are defined (if the axes is not provided).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        proj :      str</span>
<span class="sd">            Flag indicating whether to plot a classic sinogram (&#39;Cross&#39;) from</span>
<span class="sd">            the vessel cross-section (assuming 2D)</span>
<span class="sd">            or an extended 3D version &#39;3d&#39; of it with additional angle</span>
<span class="sd">        ax   :      None or plt.Axes</span>
<span class="sd">            The axes on which the plot should be done, if None a new figure</span>
<span class="sd">            and axes is created</span>
<span class="sd">        Ang  :      str</span>
<span class="sd">            Flag indicating which angle to use for the impact parameter, the</span>
<span class="sd">            angle of the line itself (xi) or of its impact parameter (theta)</span>
<span class="sd">        AngUnit :   str</span>
<span class="sd">            Flag for the angle units to be displayed, &#39;rad&#39; for radians or</span>
<span class="sd">            &#39;deg&#39; for degrees</span>
<span class="sd">        Sketch :    bool</span>
<span class="sd">            Flag indicating whether a small skecth showing the definitions of</span>
<span class="sd">            angles &#39;theta&#39; and &#39;xi&#39; should be included or not</span>
<span class="sd">        Pdict :     dict</span>
<span class="sd">            Dictionary of properties used for plotting the polygon envelopp,</span>
<span class="sd">            fed to plt.plot() if proj=&#39;Cross&#39; and to plt.plot_surface()</span>
<span class="sd">            if proj=&#39;3d&#39;</span>
<span class="sd">        LegDict :   None or dict</span>
<span class="sd">            Dictionary of properties used for plotting the legend, fed to</span>
<span class="sd">            plt.legend(), the legend is not plotted if None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether the fig.canvas.draw() shall be called</span>
<span class="sd">            automatically</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be plotted in a4</span>
<span class="sd">            dimensions for printing</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs shall be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used to plot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Test</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The impact parameters must be set ! (self.set_dsino())&quot;</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>

        <span class="c1"># Only plot cross sino, from version 1.4.0</span>
        <span class="n">dP</span> <span class="o">=</span> <span class="n">_def</span><span class="o">.</span><span class="n">TorPFilld</span> <span class="k">if</span> <span class="n">dP</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dP</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Plot_Impact_PolProjPoly</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span>
            <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span>
            <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span>
            <span class="n">Leg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">NameLTX</span><span class="p">,</span>
            <span class="n">dP</span><span class="o">=</span><span class="n">dP</span><span class="p">,</span>
            <span class="n">dLeg</span><span class="o">=</span><span class="n">dLeg</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1"># Pdict = _def.TorP3DFilld if Pdict is None else Pdict</span>
        <span class="c1"># ax = _plot.Plot_Impact_3DPoly(self, ax=ax, Ang=Ang, AngUnit=AngUnit,</span>
        <span class="c1"># Pdict=Pdict, dLeg=LegDict, draw=False,</span>
        <span class="c1"># fs=fs, wintit=wintit, Test=Test)</span>
        <span class="k">if</span> <span class="n">draw</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ax</span>

    <span class="k">def</span> <span class="nf">save_to_txt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Mod&quot;</span><span class="p">,</span> <span class="s2">&quot;Cls&quot;</span><span class="p">,</span> <span class="s2">&quot;Exp&quot;</span><span class="p">,</span> <span class="s2">&quot;Name&quot;</span><span class="p">],</span>
        <span class="n">fmt_num</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.18e</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">footer</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_pfe</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Save the basic geometrical attributes only (polygon and pos/extent)</span>

<span class="sd">        The attributes are saved to a txt file with chosen encoding</span>
<span class="sd">        Usefu for easily sharing input with non-python users</span>

<span class="sd">        BEWARE: doesn&#39;t save all attributes !!!</span>
<span class="sd">        Only saves the basic geometrical inputs !!!</span>
<span class="sd">        Not equivalent to full tofu save (using self.save()) !!!</span>

<span class="sd">        The saving convention is:</span>
<span class="sd">            * data is saved on 2 columns</span>
<span class="sd">            * The first line gives 2 numbers: nP, no</span>
<span class="sd">                - nP = Number of points in the polygon</span>
<span class="sd">                (i.e.: the number of following lines describing the polygon)</span>
<span class="sd">                - no = Number of occurences (toroidal if in toroidal geometry)</span>
<span class="sd">                (i.e.: the nb. of pos/extent lines after the first nP lines)</span>
<span class="sd">            * Hence, the data is a 2D array of shape (1 + nP + no, 2)</span>
<span class="sd">            * The two columns of the nP lines describing the polygon represent:</span>
<span class="sd">                - 1st: R (resp. Y) coordinate of polygon points</span>
<span class="sd">                - 2nd: Z (resp. Z) coordinate of polygon points</span>
<span class="sd">            * The two columns of the no lines representing the occurences are:</span>
<span class="sd">                - 1st: pos, the tor. angle (resp. X) center of occurences</span>
<span class="sd">                - 2nd: extent, the tor. angle (resp. X) extension of occurences</span>

<span class="sd">        Hence, the polygon and pos/extent of the object can be retrieved with:</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; out = np.loadtxt(filename)</span>
<span class="sd">        &gt;&gt;&gt; nP, no = out[0,:]</span>
<span class="sd">        &gt;&gt;&gt; poly = out[1:1+nP,:]</span>
<span class="sd">        &gt;&gt;&gt; pos, extent = out[1+nP:,0], out[1+nP:,1]</span>

<span class="sd">        All parameters apart from path, name and include are fed to</span>
<span class="sd">        numpy.savetxt()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path:   None / str</span>
<span class="sd">            The path where to save the file</span>
<span class="sd">            If None -&gt; self.Id.SavePath</span>
<span class="sd">        name:   None / str</span>
<span class="sd">            The name to use for the saved file</span>
<span class="sd">            If None -&gt; self.Id.SaveName(include)</span>
<span class="sd">        include:    list</span>
<span class="sd">            List of attributes of to be used to built the default saving name</span>
<span class="sd">            Fed to tf.utils.ID.generate_SaveName()</span>
<span class="sd">            Recommended: [&#39;Mod&#39;,&#39;Cls&#39;,&#39;Exp&#39;,&#39;Name&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">generate_SaveName</span><span class="p">(</span><span class="n">include</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;txt&#39;</span>
        <span class="n">lfmtok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;txt&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fmt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lfmtok</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The only accpedted formats are: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lfmtok</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fmt</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">delimiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;txt&#39;</span><span class="p">:</span>
                <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>

        <span class="n">nPno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">noccur</span><span class="p">]</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Poly</span><span class="o">.</span><span class="n">T</span>
        <span class="n">posext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">nPno</span><span class="p">,</span> <span class="n">poly</span><span class="p">,</span> <span class="n">posext</span><span class="p">))</span>

        <span class="c1"># default standards</span>
        <span class="n">newline</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">comments</span> <span class="o">=</span> <span class="n">_COMMENT</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot; Cls = </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> Exp = </span><span class="si">{}</span><span class="se">\n</span><span class="s2"> Name = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">fmt</span><span class="o">=</span><span class="n">fmt_num</span><span class="p">,</span>
            <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span>
            <span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">,</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="n">footer</span><span class="o">=</span><span class="n">footer</span><span class="p">,</span>
            <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;encoding&quot;</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;encoding&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verb</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;save_to_txt in:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pfe</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_pfe</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pfe</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_txt</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">pfe</span><span class="p">,</span>
        <span class="n">returnas</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">,</span>
        <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">SavePath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">),</span>
        <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">warn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the polygon and pos/extent stored in a .txt or .csv file</span>

<span class="sd">        The file must have been generated by method save_to_txt() (resp. csv)</span>
<span class="sd">        All arguments appart from pfe and returnas are:</span>
<span class="sd">            - fed to the relevant tofu.geom.Struct subclass to instanciate it</span>
<span class="sd">            - used only if returnas = &#39;object&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pfe:    str</span>
<span class="sd">            Unique string containing the path and file name to be read</span>
<span class="sd">            The file must be formatted as if generated by self.save_to_txt():</span>
<span class="sd">                - Must contain a (N,2) array</span>
<span class="sd">                - Line 0 must contain 2 integers:</span>
<span class="sd">                    - npts : the nb. of points of the polygon</span>
<span class="sd">                    - noccur : the nb. of occurences (=0 if axisymmetric)</span>
<span class="sd">                - Hence the number of lines hould be N = npts + noccur + 1</span>
<span class="sd">                - Lines 1:npts+1 contain the polygon points</span>
<span class="sd">                - Lines npts+1: contain positions and extent of each occurence</span>
<span class="sd">        returnas:    str</span>
<span class="sd">            Flag indicating whether to return:</span>
<span class="sd">               - &#39;dict&#39;  : a dictionnary of np.ndarrays</span>
<span class="sd">               - &#39;object&#39;: a tofu.geom.Struct subclass, using the other kwdargs</span>
<span class="sd">        warn:       None / bool</span>
<span class="sd">            Whether to raise a warning if the formatting of the file is</span>
<span class="sd">            suspicious</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        obj:    tf.geom.Struct sublass instance  / dict</span>
<span class="sd">            Depending on the value of returnas, obj can be:</span>
<span class="sd">                - An instance of the relevant tofu.geom.Struct subclass</span>
<span class="sd">                - A dict with keys &#39;poly&#39;, &#39;pos&#39; and &#39;extent&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">returnas</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="s1">&#39;dict&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg returnas must be either:&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;object&#39;: return </span><span class="si">{}</span><span class="s2"> instance</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;dict&#39; : return a dict with polygon, pos and extent&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pfe</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.csv&#39;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Only accepts .txt and .csv files (fed to np.loadtxt) !</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">warn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">delimiter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pfe</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">):</span>
                <span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delimiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">comments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">_COMMENT</span>

        <span class="c1"># Extract polygon from file and check</span>
        <span class="n">oo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">oo</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">oo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The file should contain a (N,2) array !</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;  </span><span class="se">\t</span><span class="s2"> file : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> shape: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oo</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">c0</span> <span class="o">=</span> <span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="c1"># assume noccur = 0</span>
            <span class="n">npts</span><span class="p">,</span> <span class="n">noccur</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span>
            <span class="n">poly</span> <span class="o">=</span> <span class="n">oo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c1</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">npts</span><span class="p">,</span> <span class="n">noccur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">oo</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span> <span class="o">+</span> <span class="n">npts</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">npts</span><span class="p">,</span> <span class="n">noccur</span> <span class="o">=</span> <span class="n">oo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span>
                <span class="n">poly</span> <span class="o">=</span> <span class="n">oo</span>
                <span class="k">if</span> <span class="n">warn</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">sha</span> <span class="o">=</span> <span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">shastr</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">{0}</span><span class="s1"> + </span><span class="si">{1}</span><span class="s1"> + 1, 2)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">oo</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The shape of the array is not as expected!</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Expected shape: </span><span class="si">{0}</span><span class="s2"> = </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sha</span><span class="p">,</span> <span class="n">shastr</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Observed shape: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">oo</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">noccur</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">oo</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">npts</span><span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">oo</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">npts</span><span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Try reading Exp and Name if not provided</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span> <span class="n">Exp</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="n">Name</span><span class="p">)]</span> <span class="k">if</span> <span class="n">vv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dparam</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_txt_extract_params</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">lc</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;Exp&#39;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
                <span class="n">Exp</span> <span class="o">=</span> <span class="n">dparam</span><span class="p">[</span><span class="s1">&#39;Exp&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;Name&#39;</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">:</span>
                <span class="n">Name</span> <span class="o">=</span> <span class="n">dparam</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span>

        <span class="c1"># Return</span>
        <span class="k">if</span> <span class="n">returnas</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="s1">&#39;dict&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">:</span> <span class="n">Exp</span><span class="p">,</span> <span class="s1">&#39;Cls&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="p">,</span>
                    <span class="s2">&quot;poly&quot;</span><span class="p">:</span> <span class="n">poly</span><span class="p">,</span> <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="n">pos</span><span class="p">,</span> <span class="s2">&quot;extent&quot;</span><span class="p">:</span> <span class="n">extent</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SavePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">SavePath</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span>
                <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span>
                <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
                <span class="n">Poly</span><span class="o">=</span><span class="n">poly</span><span class="p">,</span>
                <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span>
                <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">save_to_imas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">refshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">refrun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description_2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tofu.imas2tofu</span> <span class="k">as</span> <span class="nn">_tfimas</span>

        <span class="n">_tfimas</span><span class="o">.</span><span class="n">_save_to_imas</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">tfversion</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
            <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span>
            <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
            <span class="n">refshot</span><span class="o">=</span><span class="n">refshot</span><span class="p">,</span>
            <span class="n">refrun</span><span class="o">=</span><span class="n">refrun</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">description_2d</span><span class="o">=</span><span class="n">description_2d</span><span class="p">,</span>
            <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
        <span class="p">)</span>



<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                      Effective Struct subclasses</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">StructIn</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
    <span class="n">_color</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span>
    <span class="n">_InOut</span> <span class="o">=</span> <span class="s2">&quot;in&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_set_color_ddef</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="c1"># super</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;cross&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;hor&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;3d&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dgeom</span><span class="p">(</span>
        <span class="n">Poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Clock</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">arrayorder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="c1"># super</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Struct</span><span class="o">.</span><span class="n">_checkformat_inputs_dgeom</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="n">Poly</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">arrayorder</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Tor&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;StructIn subclasses cannot have noccur&gt;0 if Type=&#39;Tor&#39;!&quot;</span>
            <span class="k">assert</span> <span class="n">pos</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">return</span> <span class="n">out</span>


<span class="k">class</span> <span class="nc">StructOut</span><span class="p">(</span><span class="n">Struct</span><span class="p">):</span>
    <span class="n">_color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">_InOut</span> <span class="o">=</span> <span class="s2">&quot;out&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_set_color_ddef</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;cross&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fc&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s2">&quot;ec&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;hor&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fc&quot;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s2">&quot;ec&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;3d&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>

    <span class="k">def</span> <span class="nf">_set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dmisc</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;cross&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;fc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;hor&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;fc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;3d&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>

    <span class="k">def</span> <span class="nf">get_sampleV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;StructOut subclasses cannot use get_sampleV()!&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<div class="viewcode-block" id="PlasmaDomain"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.PlasmaDomain">[docs]</a><span class="k">class</span> <span class="nc">PlasmaDomain</span><span class="p">(</span><span class="n">StructIn</span><span class="p">):</span>
    <span class="n">_color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Ves"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Ves">[docs]</a><span class="k">class</span> <span class="nc">Ves</span><span class="p">(</span><span class="n">StructIn</span><span class="p">):</span>
    <span class="n">_color</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span></div>


<div class="viewcode-block" id="PFC"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.PFC">[docs]</a><span class="k">class</span> <span class="nc">PFC</span><span class="p">(</span><span class="n">StructOut</span><span class="p">):</span>
    <span class="n">_color</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span></div>


<div class="viewcode-block" id="CoilPF"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF">[docs]</a><span class="k">class</span> <span class="nc">CoilPF</span><span class="p">(</span><span class="n">StructOut</span><span class="p">):</span>
    <span class="n">_color</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nturns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">superconducting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mag_field_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">current_lim_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwdargs</span>
    <span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">nturns</span><span class="o">=</span><span class="n">nturns</span><span class="p">,</span>
            <span class="n">superconducting</span><span class="o">=</span><span class="n">superconducting</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwdargs</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="CoilPF._reset"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dmag</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;nI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get largs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF._get_largs_dmag"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._get_largs_dmag">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dmag</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nturns&quot;</span><span class="p">,</span> <span class="s2">&quot;superconducting&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get check and format inputs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF._checkformat_inputs_dmag"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._checkformat_inputs_dmag">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dmag</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">nturns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">superconducting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature_nominal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">mag_field_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">current_lim_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nturns&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">nturns</span><span class="p">,</span> <span class="s2">&quot;NoneOrFloatPos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;superconducting&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">superconducting</span><span class="p">,</span> <span class="s2">&quot;NoneOrCls&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">},</span>
            <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">active</span><span class="p">,</span> <span class="s2">&quot;NoneOrCls&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">},</span>
            <span class="s2">&quot;temperature_nominal&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">temperature_nominal</span><span class="p">,</span>
                                    <span class="s2">&quot;NoneOrFloatPos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;mag_field_max&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">mag_field_max</span><span class="p">,</span>
                              <span class="s2">&quot;NoneOrFloatPos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;current_lim_max&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">current_lim_max</span><span class="p">,</span>
                                <span class="s2">&quot;NoneOrFloatPos&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">dins</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">dins</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dins</span><span class="p">[</span><span class="n">dd</span><span class="p">][</span><span class="s1">&#39;var&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nturns&#39;</span><span class="p">,</span> <span class="s1">&#39;superconducting&#39;</span><span class="p">,</span> <span class="s1">&#39;active&#39;</span><span class="p">]]</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get keys of dictionnaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF._get_keys_dmag"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._get_keys_dmag">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dmag</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nturns&quot;</span><span class="p">,</span> <span class="s2">&quot;superconducting&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="s2">&quot;current&quot;</span><span class="p">,</span> <span class="s2">&quot;nI&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _init</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF._init"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._init">[docs]</a>    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nturns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">superconducting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dmag</span><span class="p">(</span>
            <span class="n">nturns</span><span class="o">=</span><span class="n">nturns</span><span class="p">,</span> <span class="n">superconducting</span><span class="o">=</span><span class="n">superconducting</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="n">active</span>
        <span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># set dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF.set_dmag"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF.set_dmag">[docs]</a>    <span class="k">def</span> <span class="nf">set_dmag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">superconducting</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nturns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dmag</span><span class="p">(</span>
            <span class="n">nturns</span><span class="o">=</span><span class="n">nturns</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="n">active</span><span class="p">,</span> <span class="n">superconducting</span><span class="o">=</span><span class="n">superconducting</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;nturns&quot;</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;superconducting&quot;</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># strip dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF._strip_dmag"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._strip_dmag">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dmag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nturns&quot;</span><span class="p">,</span> <span class="s2">&quot;superconducting&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">]):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;nI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1">###########</span>
    <span class="c1"># rebuild dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF._rebuild_dmag"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._rebuild_dmag">[docs]</a>    <span class="k">def</span> <span class="nf">_rebuild_dmag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nturns&quot;</span><span class="p">,</span> <span class="s2">&quot;superconducting&quot;</span><span class="p">,</span> <span class="s2">&quot;active&quot;</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dmag</span><span class="p">(</span>
            <span class="n">nturns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nturns</span><span class="p">,</span>
            <span class="n">active</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">],</span>
            <span class="n">superconducting</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;superconducting&quot;</span><span class="p">],</span>
        <span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _strip and get/from dict</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF._strip_init"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._strip_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">])</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 1: Remove dsino and dmag expendables</span>
<span class="s2">                 2: Remove also dgeom, dphys and dmisc expendables&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">nMax</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="CoilPF.strip"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span></div>

<div class="viewcode-block" id="CoilPF._strip"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._strip">[docs]</a>    <span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rebuild_dmag</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dmag</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="CoilPF._to_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">()</span>
        <span class="n">dout</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;dmag&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmag</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="CoilPF._from_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF._from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_from_dict</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dmag&quot;</span><span class="p">])</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Properties</span>
    <span class="c1">###########</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dmag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nturns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;nturns&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span>

    <span class="c1">###########</span>
    <span class="c1"># public methods</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="CoilPF.get_summary"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF.get_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">just</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span>
        <span class="n">table_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Summary description of the object content &quot;&quot;&quot;</span>

        <span class="c1"># -----------------------</span>
        <span class="c1"># Build detailed view</span>
        <span class="n">col0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;class&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SaveName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;noccur&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nturns&quot;</span><span class="p">,</span>
            <span class="s2">&quot;active&quot;</span><span class="p">,</span>
            <span class="s2">&quot;superconducting&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">ar0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">SaveName</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nP&quot;</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;noccur&quot;</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s1">&#39;nturns&#39;</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s1">&#39;superconducting&#39;</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">col0</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">]</span>
            <span class="n">ar0</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">],</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;move_param&quot;</span><span class="p">],</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">4</span><span class="p">))]</span>
        <span class="n">col0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">)</span>
        <span class="n">cstr</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;(&#39;</span>
                <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:4.2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]])</span>
                <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="n">ar0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cstr</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ar0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">col0</span><span class="p">],</span>
            <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
            <span class="n">table_sep</span><span class="o">=</span><span class="n">table_sep</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">return_</span><span class="o">=</span><span class="n">return_</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CoilPF.set_current"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilPF.set_current">[docs]</a>    <span class="k">def</span> <span class="nf">set_current</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the current circulating on the coil (A) &quot;&quot;&quot;</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg current must be None, a float or an 1D np.ndarray !&quot;</span>
        <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span> <span class="ow">or</span> <span class="n">C2</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="n">C1</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">current</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">C2</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span>
        <span class="k">if</span> <span class="n">C0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;nI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dmag</span><span class="p">[</span><span class="s2">&quot;nI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">size</span></div></div>


<div class="viewcode-block" id="CoilCS"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CoilCS">[docs]</a><span class="k">class</span> <span class="nc">CoilCS</span><span class="p">(</span><span class="n">CoilPF</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                        Overall Config object</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="p">):</span>

    <span class="c1"># Special dict subclass with attr-like value access</span>

    <span class="c1"># Fixed (class-wise) dictionary of default properties</span>
    <span class="n">_ddef</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;shot&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;Tor&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">:</span> <span class="s1">&#39;Dummy&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;include&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span> <span class="s1">&#39;Cls&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">]},</span>
             <span class="s1">&#39;dStruct&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PlasmaDomain&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;Ves&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;PFC&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;CoilPF&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;CoilCS&#39;</span><span class="p">],</span>
                         <span class="s1">&#39;dextraprop&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;visible&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}}</span>
    <span class="n">_lclsstr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PlasmaDomain&#39;</span><span class="p">,</span> <span class="s1">&#39;Ves&#39;</span><span class="p">,</span> <span class="s1">&#39;PFC&#39;</span><span class="p">,</span> <span class="s1">&#39;CoilPF&#39;</span><span class="p">,</span> <span class="s1">&#39;CoilCS&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lStruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dextraprop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">SavePath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">),</span>
                 <span class="n">SavePath_Include</span><span class="o">=</span><span class="n">tfpf</span><span class="o">.</span><span class="n">defInclude</span><span class="p">,</span>
                 <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<div class="viewcode-block" id="Config._reset"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dStruct</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dextraprop</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dsino</span><span class="p">())</span></div>

<div class="viewcode-block" id="Config._checkformat_inputs_Id"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._checkformat_inputs_Id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_Id</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwdargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">Id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">Name</span><span class="p">,</span> <span class="n">shot</span> <span class="o">=</span> <span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">shot</span>
        <span class="k">if</span> <span class="n">Type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;Exp&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shot</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;shot&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;include&quot;</span><span class="p">]</span>

        <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Tor&quot;</span><span class="p">,</span> <span class="s2">&quot;Lin&quot;</span><span class="p">]},</span>
            <span class="s2">&quot;Exp&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Exp</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">shot</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span>
            <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">include</span><span class="p">,</span> <span class="s2">&quot;listof&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">dins</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">dins</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span>
                <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
                <span class="s2">&quot;Exp&quot;</span><span class="p">:</span> <span class="n">Exp</span><span class="p">,</span>
                <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="n">include</span><span class="p">,</span>
                <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="n">shot</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">kwdargs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get largs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._get_largs_dStruct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_largs_dStruct">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dStruct</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lStruct&quot;</span><span class="p">,</span> <span class="s2">&quot;Lim&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Config._get_largs_dextraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_largs_dextraprop">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dextraprop</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dextraprop&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Config._get_largs_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_largs_dsino">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dsino</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get check and format inputs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._checkformat_inputs_Struct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._checkformat_inputs_Struct">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_Struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">msgi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Struct</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msgi</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">- Not a struct subclass: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">struct</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
            <span class="n">c3</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">()</span>
            <span class="n">c4</span> <span class="o">=</span> <span class="n">c3</span> <span class="ow">and</span> <span class="s1">&#39;_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">and</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span> <span class="ow">and</span> <span class="n">c3</span><span class="p">):</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
                <span class="n">c3</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">()</span>
                <span class="n">c4</span> <span class="o">=</span> <span class="n">c3</span> <span class="ow">and</span> <span class="s1">&#39;_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span>
                <span class="n">msgi</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">- </span><span class="si">{0}</span><span class="s2"> :&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c1</span><span class="p">:</span>
                    <span class="n">msgi</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Exp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c2</span><span class="p">:</span>
                    <span class="n">msgi</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Type: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c3</span><span class="p">:</span>
                    <span class="n">msgi</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Name: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msgi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">err</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Non-conform struct:&quot;</span> <span class="o">+</span> <span class="n">msgi</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msgi</span></div>

<div class="viewcode-block" id="Config._errmsg_dStruct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._errmsg_dStruct">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_errmsg_dStruct</span><span class="p">(</span><span class="n">lStruct</span><span class="p">):</span>
        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tf.geom.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PlasmaDomain&quot;</span><span class="p">,</span> <span class="s2">&quot;Ves&quot;</span><span class="p">,</span> <span class="s2">&quot;PFC&quot;</span><span class="p">,</span> <span class="s2">&quot;CoilPF&quot;</span><span class="p">,</span> <span class="s2">&quot;CoilCS&quot;</span><span class="p">]]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg lStruct must be &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;a tofu.geom.Struct subclass or list of such!</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;Valid subclasses include:</span><span class="se">\n\t</span><span class="s2">- &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">- &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">You provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lStruct</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="Config._checkformat_inputs_dStruct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._checkformat_inputs_dStruct">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lStruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">lStruct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">((</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">lStruct</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lStruct</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
              <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Struct</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lStruct</span><span class="p">]))</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">lStruct</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Struct</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c1</span> <span class="ow">or</span> <span class="n">c2</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_errmsg_dStruct</span><span class="p">(</span><span class="n">lStruct</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">c1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lStruct</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">lStruct</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lStruct</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c2</span><span class="p">:</span>
            <span class="n">lStruct</span> <span class="o">=</span> <span class="p">[</span><span class="n">lStruct</span><span class="p">]</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lStruct</span><span class="p">:</span>
            <span class="n">msgi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_Struct</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">err</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msgi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="n">msgi</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The following objects have non-confrom Id:&quot;</span> <span class="o">+</span> <span class="n">msg</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  =&gt; Expected values are:&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      Exp: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      Type: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">      Name: a valid identifier, without &#39;_&#39;&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; (check str.isidentifier())&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Tor&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Issue with tf.geom.Config </span><span class="si">{0}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  If input Lim is None, Type should be &#39;Tor&#39;:&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Type = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Lim = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Lim</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">nLim</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Lin&quot;</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Issue with tf.geom.Config </span><span class="si">{0}</span><span class="s2">:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;  If input Lim!=None, Type should be &#39;Lin&#39;:&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Type = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Lim = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Lim</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">Lim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">Lim</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">Lim</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">nLim</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">lStruct</span><span class="p">,</span> <span class="n">Lim</span><span class="p">,</span> <span class="n">nLim</span></div>

<div class="viewcode-block" id="Config._checkformat_inputs_extraval"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._checkformat_inputs_extraval">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_extraval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">extraval</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="n">lsimple</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">]</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">extraval</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lsimple</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extraval</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extraval</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">multi</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span> <span class="ow">or</span> <span class="n">C2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">extraval</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">C0</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">extraval</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">multi</span> <span class="ow">and</span> <span class="n">C1</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">size</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">extraval</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">],))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">C</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The value for </span><span class="si">%s</span><span class="s2"> has wrong shape!&quot;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Expected: (</span><span class="si">{0}</span><span class="s2">,)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">])</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Got:      </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">extraval</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="k">elif</span> <span class="n">multi</span> <span class="ow">and</span> <span class="n">C2</span><span class="p">:</span>
            <span class="n">msg0</span> <span class="o">=</span> <span class="s2">&quot;If an extra attribute is provided as a dict,&quot;</span>
            <span class="n">msg0</span> <span class="o">+=</span> <span class="s2">&quot; it should have the same structure as self.dStruct !&quot;</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lCls&quot;</span><span class="p">])</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">lk</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">extraval</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The value for </span><span class="si">%s</span><span class="s2"> has wrong keys !&quot;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    expected : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    received : &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">extraval</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg0</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">extraval</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The value for </span><span class="si">%s</span><span class="s2"> shall be a dict of nested dict !&quot;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lk</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg0</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extraval</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">cc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]):</span>
                <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">c</span>
                    <span class="k">if</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The value for </span><span class="si">%s</span><span class="s2"> has wrong nested dict !&quot;</span> <span class="o">%</span> <span class="n">key</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lc</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg0</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">extraval</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lsimple</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    type(</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">][</span><span class="si">%s</span><span class="s2">])&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; should be in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">lsimple</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="nb">dict</span>
        <span class="k">elif</span> <span class="n">C0</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="nb">int</span>
        <span class="k">return</span> <span class="n">C</span></div>

<div class="viewcode-block" id="Config._checkformat_inputs_dextraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._checkformat_inputs_dextraprop">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dextraprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dextraprop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dextraprop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dextraprop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dStruct&quot;</span><span class="p">][</span><span class="s2">&quot;dextraprop&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dextraprop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dextraprop</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dextraprop</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">dC</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dextraprop</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dC</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_extraval</span><span class="p">(</span><span class="n">dextraprop</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dextraprop</span><span class="p">,</span> <span class="n">dC</span></div>

<div class="viewcode-block" id="Config._checkformat_inputs_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._checkformat_inputs_dsino">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">nP</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">nP</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">RefPt</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
        <span class="n">RefPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">RefPt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">RefPt</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;RefPt must be of size=2 !&quot;</span>
        <span class="k">return</span> <span class="n">RefPt</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get keys of dictionnaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._get_keys_dStruct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_keys_dStruct">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dStruct</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">,</span> <span class="s2">&quot;Lim&quot;</span><span class="p">,</span> <span class="s2">&quot;nLim&quot;</span><span class="p">,</span> <span class="s2">&quot;nObj&quot;</span><span class="p">,</span> <span class="s2">&quot;lorder&quot;</span><span class="p">,</span> <span class="s2">&quot;lCls&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Config._get_keys_dextraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_keys_dextraprop">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dextraprop</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Config._get_keys_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_keys_dsino">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dsino</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _init</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._init"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._init">[docs]</a>    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lStruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dextraprop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dStruct</span><span class="p">()</span>
        <span class="n">kwdStruct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dextraprop</span><span class="p">()</span>
        <span class="n">kwdextraprop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="nb">locals</span><span class="p">(),</span> <span class="n">largs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dStruct</span><span class="p">(</span><span class="o">**</span><span class="n">kwdStruct</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dextraprop</span><span class="p">(</span><span class="o">**</span><span class="n">kwdextraprop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamicattr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1">###########</span>
    <span class="c1"># set dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._set_dStruct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._set_dStruct">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lStruct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lStruct</span><span class="p">,</span> <span class="n">Lim</span><span class="p">,</span> <span class="n">nLim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dStruct</span><span class="p">(</span>
            <span class="n">lStruct</span><span class="o">=</span><span class="n">lStruct</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;Lim&quot;</span><span class="p">:</span> <span class="n">Lim</span><span class="p">,</span> <span class="s2">&quot;nLim&quot;</span><span class="p">:</span> <span class="n">nLim</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dlObj</span><span class="p">(</span><span class="n">lStruct</span><span class="p">,</span> <span class="n">din</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config._set_dextraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._set_dextraprop">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dextraprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dextraprop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dextraprop</span><span class="p">,</span> <span class="n">dC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dextraprop</span><span class="p">(</span><span class="n">dextraprop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dextraprop</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="c1"># Init dict</span>
        <span class="n">lCls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lCls&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">dextraprop</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dp</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">pp</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">lCls</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lCls</span><span class="p">:</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dp</span><span class="p">:</span> <span class="n">dd</span><span class="p">})</span>

        <span class="c1"># Populate</span>
        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">dextraprop</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_extraprop</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">dextraprop</span><span class="p">[</span><span class="n">pp</span><span class="p">])</span></div>

<div class="viewcode-block" id="Config.add_extraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.add_extraprop">[docs]</a>    <span class="k">def</span> <span class="nf">add_extraprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">dC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dextraprop</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Init dict</span>
        <span class="n">lCls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lCls&quot;</span><span class="p">]</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">key</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">lCls</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lCls</span><span class="p">:</span>
            <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">dp</span><span class="p">:</span> <span class="n">dd</span><span class="p">})</span>

        <span class="c1"># Populate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_extraprop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamicattr</span><span class="p">()</span></div>

<div class="viewcode-block" id="Config._set_extraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._set_extraprop">[docs]</a>    <span class="k">def</span> <span class="nf">_set_extraprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">pp</span>
        <span class="k">if</span> <span class="n">k0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_extraval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">C</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="n">C</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
                    <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">k1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_extraval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">C</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">C</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="n">C</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
                    <span class="n">kk</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">k0</span> <span class="o">==</span> <span class="n">kk</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                        <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_extraval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">C</span> <span class="ow">is</span> <span class="nb">int</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Config._get_extraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_extraprop">[docs]</a>    <span class="k">def</span> <span class="nf">_get_extraprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">k0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">pp</span>
        <span class="k">if</span> <span class="n">k0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">],),</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]))</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
                <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="n">val</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">k1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),),</span>
                           <span class="n">dtype</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]))</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k0</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">val</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span>
                    <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="n">dp</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Config._set_color"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._set_color">[docs]</a>    <span class="k">def</span> <span class="nf">_set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">val</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config._dynamicattr"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._dynamicattr">[docs]</a>    <span class="k">def</span> <span class="nf">_dynamicattr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get (key, val) pairs</span>

        <span class="c1"># Purge</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;dStruct&#39;</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
                <span class="c1"># exec(&quot;del self.{0}&quot;.format(k))</span>

        <span class="c1"># Set</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># Find a way to programmatically add dynamic properties to the</span>
            <span class="c1"># instances , like visible</span>
            <span class="c1"># In the meantime use a simple functions</span>
            <span class="n">lset</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;set_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]]</span>
            <span class="n">lget</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;get_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]:</span>
                        <span class="nb">setattr</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">],</span>
                            <span class="s2">&quot;set_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pp</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="n">kk</span><span class="p">:</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_set_extraprop</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span><span class="p">)</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">],</span>
                            <span class="s2">&quot;get_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span><span class="p">,</span>
                            <span class="k">lambda</span> <span class="n">pk</span><span class="o">=</span><span class="n">pp</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">k1</span><span class="o">=</span><span class="n">kk</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_extraprop</span><span class="p">(</span>
                                <span class="n">pk</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Dictattr</span><span class="p">(</span>
                    <span class="p">[</span><span class="s2">&quot;set_color&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lset</span> <span class="o">+</span> <span class="n">lget</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]:</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="n">dd</span><span class="p">,</span>
                        <span class="s2">&quot;set_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span><span class="p">,</span>
                        <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pp</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_extraprop</span><span class="p">(</span>
                            <span class="n">pk</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">k0</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                    <span class="nb">setattr</span><span class="p">(</span>
                        <span class="n">dd</span><span class="p">,</span>
                        <span class="s2">&quot;get_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span><span class="p">,</span>
                        <span class="k">lambda</span> <span class="n">pk</span><span class="o">=</span><span class="n">pp</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_extraprop</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">k0</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="n">dd</span><span class="p">,</span> <span class="s2">&quot;set_color&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">col</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_color</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s2">&quot;set_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">val</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pp</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_extraprop</span><span class="p">(</span><span class="n">pk</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;get_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pp</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">pk</span><span class="o">=</span><span class="n">pp</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_extraprop</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span></div>

<div class="viewcode-block" id="Config.set_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.set_dsino">[docs]</a>    <span class="k">def</span> <span class="nf">set_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorNP</span><span class="p">):</span>
        <span class="n">RefPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dsino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="n">nP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">set_dsino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">,</span> <span class="n">nP</span><span class="o">=</span><span class="n">nP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;RefPt&quot;</span><span class="p">:</span> <span class="n">RefPt</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">:</span> <span class="n">nP</span><span class="p">}</span></div>

    <span class="c1">###########</span>
    <span class="c1"># strip dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._strip_dStruct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._strip_dStruct">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">strip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">strip</span><span class="p">:</span>

            <span class="c1"># Reload if necessary</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">pfe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                                <span class="n">pfe</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span>
                            <span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    k = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    kk = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">kk</span><span class="p">))</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    type(pfe) = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
                            <span class="p">)</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    self._dstrip[&#39;strip&#39;] = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span>
                            <span class="p">)</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    strip = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>

            <span class="n">lkeep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dStruct</span><span class="p">()</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_test_Rebuild</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_check_Fields4Rebuild</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">,</span> <span class="n">dname</span><span class="o">=</span><span class="s2">&quot;dStruct&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dStruct</span><span class="p">(</span><span class="n">lStruct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;Lim&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dynamicattr</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lCls&quot;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>
                <span class="n">lkeep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dStruct</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lCls&quot;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">path</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span>
                        <span class="c1"># --- Check !</span>
                        <span class="n">lf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">ff</span>
                            <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lf</span>
                            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">ff</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;.npz&quot;</span><span class="p">]])</span>
                        <span class="p">]</span>
                        <span class="n">exist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="c1"># ----------</span>
                        <span class="n">pathfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npz&quot;</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;BEWARE:</span>
<span class="s2">                                You are about to delete the Struct objects</span>
<span class="s2">                                Only the path/name to saved objects will be</span>
<span class="s2">                                kept</span>

<span class="s2">                                But it appears that the following object has no</span>
<span class="s2">                                saved file where specified (obj.Id.SavePath)</span>
<span class="s2">                                Thus it won&#39;t be possible to retrieve it</span>
<span class="s2">                                (unless available in the current console:&quot;&quot;&quot;</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pathfile</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dynamicattr</span><span class="p">()</span>
                <span class="n">lkeep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dStruct</span><span class="p">()</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config._strip_dextraprop"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._strip_dextraprop">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dextraprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">lkeep</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config._strip_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._strip_dsino">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;nP&quot;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">_strip_dsino</span><span class="p">(</span><span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _strip and get/from dict</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._strip_init"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._strip_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">])</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 1: apply strip(1) to objects in self.lStruct</span>
<span class="s2">                 2: apply strip(2) to objects in self.lStruct</span>
<span class="s2">                 3: replace objects in self.lStruct by SavePath + SaveName&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">nMax</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="Config.strip"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Config</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config._strip"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._strip">[docs]</a>    <span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dStruct</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>
        <span class="c1"># self._strip_dextraprop()</span>
        <span class="c1"># self._strip_dsino()</span>

<div class="viewcode-block" id="Config._to_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dStruct&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dStruct</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dextraprop&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dsino&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="Config._checkformat_fromdict_dStruct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._checkformat_fromdict_dStruct">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_fromdict_dStruct</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dStruct</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">clsn</span> <span class="ow">in</span> <span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">clsn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">n</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span>
                    <span class="n">fromdict</span><span class="o">=</span><span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">n</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">issubclass</span><span class="p">(</span><span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Struct</span><span class="p">),</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">n</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config._from_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_fromdict_dStruct</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dStruct&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dStruct&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dextraprop&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dsino&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamicattr</span><span class="p">()</span></div>

    <span class="c1">###########</span>
    <span class="c1"># SOLEDGE3X</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config._from_SOLEDGE_extract_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._from_SOLEDGE_extract_dict">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_from_SOLEDGE_extract_dict</span><span class="p">(</span><span class="n">pfe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check input</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
              <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
              <span class="ow">and</span> <span class="n">pfe</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.mat&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg pfe must be a valid .mat file!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>

        <span class="c1"># Open file</span>
        <span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">scpio</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">scpio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>

        <span class="c1"># Check conformity of content</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Nwalls&#39;</span><span class="p">,</span> <span class="s1">&#39;coord&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">lk0</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
               <span class="k">if</span> <span class="n">kk</span> <span class="o">==</span> <span class="s1">&#39;walls&#39;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)]</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
              <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;walls&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
              <span class="ow">and</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;walls&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="n">lk</span>
              <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;walls&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Non-conform .mat file content from SOLEDGE3X:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- file: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Expected:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- a unique matlab structure &#39;walls&#39; with 3 fields</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">- Nwalls: int</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">- coord: 1xn struct</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">- type: 1xn double</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;Provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- variables: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- 1x</span><span class="si">{}</span><span class="s2"> struct with </span><span class="si">{}</span><span class="s2"> fields&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                       <span class="nb">len</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">lk0</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                       <span class="nb">len</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">lk0</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;walls&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get inside fields &#39;type&#39;, &#39;Nwalls&#39;, &#39;coord&#39;</span>
        <span class="n">di0</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;walls&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">}</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">di0</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="s1">&#39;Nwalls&#39;</span><span class="p">:</span> <span class="n">out</span><span class="p">[</span><span class="n">di0</span><span class="p">[</span><span class="s1">&#39;Nwalls&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">di0</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;Rwall&#39;</span><span class="p">,</span> <span class="s1">&#39;Zwall&#39;</span><span class="p">]</span>
              <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">==</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
              <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">oo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">oo</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Field </span><span class="si">{}</span><span class="s2"> not conform:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;coord&#39;</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- expected: 1x</span><span class="si">{}</span><span class="s2"> struct &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;with fields (&#39;Rwall&#39;, &#39;Zwall&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: 1x</span><span class="si">{}</span><span class="s2"> struct &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
                   <span class="o">+</span> <span class="s2">&quot;with fields </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">out</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span>
                         <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="Config.from_SOLEDGE3X"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.from_SOLEDGE3X">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_SOLEDGE3X</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pfe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Check input and extract dict from file</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_from_SOLEDGE_extract_dict</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
        <span class="n">npoly</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>

        <span class="c1"># Prepare lStruct</span>
        <span class="n">lcls</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ves</span> <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">PFC</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly</span><span class="p">)]</span>
        <span class="n">lnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Soledge3X</span><span class="si">{:02.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly</span><span class="p">)]</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="p">[</span><span class="n">lcls</span><span class="p">[</span><span class="n">ii</span><span class="p">](</span><span class="n">Poly</span><span class="o">=</span><span class="n">dout</span><span class="p">[</span><span class="s1">&#39;coord&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span>
                       <span class="n">Type</span><span class="o">=</span><span class="s1">&#39;Tor&#39;</span><span class="p">,</span>
                       <span class="n">Name</span><span class="o">=</span><span class="n">lnames</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                       <span class="n">pos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">lStruct</span><span class="o">=</span><span class="n">lS</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config._to_SOLEDGE3X_get_data"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._to_SOLEDGE3X_get_data">[docs]</a>    <span class="k">def</span> <span class="nf">_to_SOLEDGE3X_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">type_extraprop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">matlab_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">matlab_platform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">head</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">matlab_version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matlab_version</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg matlab_version must be provided as a str!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- example: &#39;5.0&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matlab_version</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># useful ? to be deprecated ?</span>
        <span class="k">if</span> <span class="n">matlab_platform</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;which matlab&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">keypath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">,</span> <span class="s1">&#39;matlab&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keypath</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">[:</span><span class="n">out</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">keypath</span><span class="p">)],</span> <span class="s1">&#39;etc&#39;</span><span class="p">)</span>
                <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ff</span><span class="p">))]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">matlab_platform</span> <span class="o">=</span> <span class="n">lf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Couldn&#39;t get matlab_platform from &#39;which matlab&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;  =&gt; Please provide the matlab platform</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;     Should be in </span><span class="si">{}</span><span class="s2">/../etc&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">matlab_platform</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">matlab_platform</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg matlab_platform must be provided as a str!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- example: &#39;GLNXA64&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matlab_platform</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">matlab_version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">matlab_platform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dtm</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">dtm</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1"> %b </span><span class="si">%d</span><span class="s1"> %H:%M:%S %Y&#39;</span><span class="p">)</span>
            <span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;MATLAB </span><span class="si">{}</span><span class="s1"> MAT-file, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matlab_version</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s1">&#39;Platform: </span><span class="si">{}</span><span class="s1">, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matlab_platform</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s1">&#39;Created on: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>

        <span class="c1"># Build walls</span>
        <span class="n">nwall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">nStruct</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># typ (from extraprop if any, else from Ves / Struct)</span>
        <span class="k">if</span> <span class="n">type_extraprop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_extraprop</span><span class="p">(</span><span class="n">type_extraprop</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s1">&#39;in&#39;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                             <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># Get coord</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Poly</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">Poly</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Rwall&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Zwall&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">)])],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Rwall&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Zwall&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">)])</span>

        <span class="c1"># put together</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;walls&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span>
            <span class="p">(</span><span class="n">nwall</span><span class="p">,</span> <span class="n">coord</span><span class="p">,</span> <span class="n">typ</span><span class="p">)]],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Nwalls&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;coord&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">)])}</span>

        <span class="c1"># Optinally set header and version</span>
        <span class="k">if</span> <span class="n">head</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;__header__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="Config.to_SOLEDGE3X"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.to_SOLEDGE3X">[docs]</a>    <span class="k">def</span> <span class="nf">to_SOLEDGE3X</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">type_extraprop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">matlab_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">matlab_platform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">verb</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg name must be a str!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.mat&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.mat&#39;</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Provided path is not a valid dir!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- path: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Get data in proper shape</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_SOLEDGE3X_get_data</span><span class="p">(</span><span class="n">type_extraprop</span><span class="o">=</span><span class="n">type_extraprop</span><span class="p">,</span>
                                           <span class="n">matlab_version</span><span class="o">=</span><span class="n">matlab_version</span><span class="p">,</span>
                                           <span class="n">matlab_platform</span><span class="o">=</span><span class="n">matlab_platform</span><span class="p">)</span>
        <span class="c1"># save</span>
        <span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">scpio</span>
        <span class="n">scpio</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">dout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved in:</span><span class="se">\n\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Properties</span>
    <span class="c1">###########</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lStruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of Struct that was used for creation</span>

<span class="sd">        As tofu objects or SavePath+SaveNames (according to strip status)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lStruct</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
            <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">lStruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">lStruct</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lStructIn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of StructIn contained in self.lStruct</span>

<span class="sd">        As tofu objects or SavePath+SaveNames (according to strip status)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lStruct</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
            <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Ves&quot;</span><span class="p">,</span> <span class="s2">&quot;PlasmaDomain&quot;</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">lStruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">StructIn</span><span class="p">):</span>
                <span class="n">lStruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">lStruct</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Lim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;Lim&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nLim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nLim&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dextraprop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span>

    <span class="c1">###########</span>
    <span class="c1"># public methods</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Config.add_Struct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.add_Struct">[docs]</a>    <span class="k">def</span> <span class="nf">add_Struct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">struct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Poly</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dextraprop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a Struct instance to the config</span>

<span class="sd">        An already existing Struct subclass instance can be added</span>
<span class="sd">        Or it will be created from the (Cls,Name,Poly,Lim) keyword args</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="n">C0a</span> <span class="o">=</span> <span class="n">struct</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="n">C1a</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Cls</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Poly</span><span class="p">,</span> <span class="n">Lim</span><span class="p">,</span> <span class="n">Type</span><span class="p">]])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">C0a</span><span class="p">,</span> <span class="n">C1a</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provide either:&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - struct: a Struct subclass instance&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - the keyword args to create one&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        (Cls,Name,Poly,Lim,Type)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> You provded:&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - struct: </span><span class="si">{0}</span><span class="s2">, </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">struct</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">struct</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Create struct if not provided</span>
        <span class="k">if</span> <span class="n">C0a</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Cls</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">Cls</span><span class="p">,</span> <span class="n">Struct</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cls must be either:&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - a Struct subclass&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - the str Name of it (e.g.: &#39;PFC&#39;,&#39;CoilPF&#39;,...)&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">Cls</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">Cls</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">Cls</span><span class="p">)</span>

            <span class="c1"># Preformat Lim and Type</span>
            <span class="k">if</span> <span class="n">Lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Lim</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>

            <span class="c1"># Create instance</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="n">Cls</span><span class="p">(</span>
                <span class="n">Poly</span><span class="o">=</span><span class="n">Poly</span><span class="p">,</span>
                <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span>
                <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
                <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span>
                <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">C0b</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">Struct</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">C0b</span><span class="p">,</span> <span class="s2">&quot;struct must be a Struct subclass instance !&quot;</span>

        <span class="c1"># Prepare dextraprop</span>
        <span class="n">dextra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dextraprop</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dextra</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;lprop&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">dextraprop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dextra</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">{}]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The current Config instance has the following extraprop:&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  =&gt; Please specify a dextraprop for struct !&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">     (using the same keys !)&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dextraprop</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dextraprop</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="n">dextraprop</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">])</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="n">dk</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">k</span>
                <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dextra</span><span class="p">[</span><span class="n">dk</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">dextra</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dextra</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">:</span> <span class="n">dextraprop</span><span class="p">[</span><span class="n">k</span><span class="p">]}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">][</span><span class="n">struct</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dextraprop</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="c1"># Set self.lStruct</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span> <span class="o">+</span> <span class="p">[</span><span class="n">struct</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="n">lStruct</span><span class="o">=</span><span class="n">lS</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Lim</span><span class="p">,</span> <span class="n">dextraprop</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.remove_Struct"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.remove_Struct">[docs]</a>    <span class="k">def</span> <span class="nf">remove_Struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check inputs</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Cls</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">Cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lCls&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">C0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The Cls must be a class existing in self.dStruct[&#39;lCls&#39;]:&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lCls&quot;</span><span class="p">]))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">Name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">Cls</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">C0</span><span class="p">:</span>
            <span class="n">ln</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">Cls</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The Name must match an instance in&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; self.dStruct[&#39;dObj&#39;][</span><span class="si">{0}</span><span class="s2">].keys():&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Cls</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ln</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Create list</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Cls</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">Name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The desired instance is not in self.dStruct[&#39;lorder&#39;] !&quot;</span>
            <span class="n">lord</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">])</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    lorder = [</span><span class="si">{0}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lord</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Cls_Name = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Cls</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">Name</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">Cls</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">Name</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">lS</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="c1"># Important : also remove from dict ! (no reset() !)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">Cls</span><span class="p">][</span><span class="n">Name</span><span class="p">]</span>

        <span class="c1"># Prepare dextraprop</span>
        <span class="n">dextra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dextraprop</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dextra</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;lprop&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">dextra</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]][</span><span class="n">cc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dextra</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">cc</span><span class="p">])</span>
            <span class="k">del</span> <span class="n">dx</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">:]][</span><span class="n">Cls</span><span class="p">][</span><span class="n">Name</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="n">lStruct</span><span class="o">=</span><span class="n">lS</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Lim</span><span class="p">,</span> <span class="n">dextraprop</span><span class="o">=</span><span class="n">dx</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.get_color"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.get_color">[docs]</a>    <span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the array of rgba colors (same order as lStruct) &quot;&quot;&quot;</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
            <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">col</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">()</span>
            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">col</span></div>

<div class="viewcode-block" id="Config.set_colors_random"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.set_colors_random">[docs]</a>    <span class="k">def</span> <span class="nf">set_colors_random</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Accent</span><span class="p">):</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">]:</span>
            <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="s2">&quot;k&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;lh&quot;</span> <span class="ow">in</span> <span class="n">k1</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;ic&quot;</span> <span class="ow">in</span> <span class="n">k1</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;div&quot;</span> <span class="ow">in</span> <span class="n">k1</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;bump&quot;</span> <span class="ow">in</span> <span class="n">k1</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">ii</span> <span class="o">%</span> <span class="n">ncol</span><span class="p">]</span>
                <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">col</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.get_summary"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.get_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">just</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span>
        <span class="n">table_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Summary description of the object content &quot;&quot;&quot;</span>

        <span class="c1"># -----------------------</span>
        <span class="c1"># Build overview</span>
        <span class="n">col0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tot. Struct&quot;</span><span class="p">,</span> <span class="s2">&quot;tot. occur&quot;</span><span class="p">,</span> <span class="s2">&quot;tot. points&quot;</span><span class="p">]</span>
        <span class="n">noccur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;noccur&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span><span class="p">])</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nP&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span><span class="p">])</span>
        <span class="n">ar0</span> <span class="o">=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">nStruct</span><span class="p">,</span> <span class="n">noccur</span><span class="p">,</span> <span class="n">npts</span><span class="p">)]</span>

        <span class="c1"># -----------------------</span>
        <span class="c1"># Build detailed view</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;class&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SaveName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;noccur&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move&quot;</span><span class="p">,</span>
            <span class="s2">&quot;color&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">]</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dStruct&quot;</span><span class="p">][</span><span class="s2">&quot;order&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">otemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;dObj&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">lu</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">k</span><span class="p">,</span>
                    <span class="n">otemp</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">],</span>
                    <span class="n">otemp</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">_Id</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s2">&quot;SaveName&quot;</span><span class="p">],</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">otemp</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nP&quot;</span><span class="p">]),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">otemp</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;noccur&quot;</span><span class="p">]),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">otemp</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;move&quot;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:4.2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">otemp</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]])</span>
                     <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">),</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]:</span>
                    <span class="n">lu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;d&quot;</span> <span class="o">+</span> <span class="n">pp</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">kk</span><span class="p">])</span>
                <span class="n">ar1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lu</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ar0</span><span class="p">,</span> <span class="n">ar1</span><span class="p">],</span>
            <span class="p">[</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">],</span>
            <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
            <span class="n">table_sep</span><span class="o">=</span><span class="n">table_sep</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">return_</span><span class="o">=</span><span class="n">return_</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Config.get_reflections"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.get_reflections">[docs]</a>    <span class="k">def</span> <span class="nf">get_reflections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indout</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vperp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Get global Types array</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span>

        <span class="c1"># Version only usable when indout returns npts+1 and npts+2 instead of</span>
        <span class="c1"># -1 and -2</span>
        <span class="c1"># ls = [ss._dreflect[&#39;Types&#39;].size for ss in lS]</span>
        <span class="c1"># Types = np.empty((len(lS), np.max(ls)), dtype=int)</span>
        <span class="c1"># for ii,ss in enumerate(lS):</span>
        <span class="c1"># Types[ii,:ls[ii]] = ss._dreflect[&#39;Types&#39;]</span>
        <span class="c1"># # Deduce Types</span>
        <span class="c1"># Types = Types[indout[0,:], indout[2,:]]</span>

        <span class="n">iu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">indout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">iu</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">indout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">ii</span>
            <span class="n">Types</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_dreflect</span><span class="p">[</span><span class="s2">&quot;Types&quot;</span><span class="p">][</span><span class="n">indout</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">ind</span><span class="p">]]</span>

        <span class="c1"># Deduce u2</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">vperp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">u2</span> <span class="o">=</span> <span class="n">Struct</span><span class="o">.</span><span class="n">_get_reflections_ufromTypes</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">Types</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Types</span><span class="p">,</span> <span class="n">u2</span></div>

<div class="viewcode-block" id="Config._get_phithetaproj_dist"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._get_phithetaproj_dist">[docs]</a>    <span class="k">def</span> <span class="nf">_get_phithetaproj_dist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">refpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="c1"># Prepare repf</span>
        <span class="k">if</span> <span class="n">refpt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">refpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">refpt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide refpt (R,Z)&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">refpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">refpt</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">refpt</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)</span>

        <span class="c1"># Prepare theta and phi</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ntheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ntheta</span> <span class="o">=</span> <span class="n">_PHITHETAPROJ_NTHETA</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">ntheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide either ntheta xor a theta vector !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nphi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nphi</span> <span class="o">=</span> <span class="n">_PHITHETAPROJ_NPHI</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nphi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide either nphi xor a phi vector !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">nphi</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># format inputs</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>
        <span class="n">ntheta</span><span class="p">,</span> <span class="n">nphi</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">phi</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># Get limits</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">ntheta</span><span class="p">,</span> <span class="n">nphi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">indStruct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntheta</span><span class="p">,</span> <span class="n">nphi</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nStruct</span><span class="p">):</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_Struct_get_phithetaproj</span><span class="p">(</span>
                <span class="n">refpt</span><span class="p">,</span> <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span> <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Lim</span><span class="p">,</span> <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">noccur</span>
            <span class="p">)</span>
            <span class="n">nDphi</span><span class="p">,</span> <span class="n">Dphi</span><span class="p">,</span> <span class="n">nDtheta</span><span class="p">,</span> <span class="n">Dtheta</span> <span class="o">=</span> <span class="n">out</span>

            <span class="c1"># Get dist</span>
            <span class="n">dist_theta</span><span class="p">,</span> <span class="n">indphi</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">_get_phithetaproj_dist</span><span class="p">(</span>
                <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">,</span>
                <span class="n">refpt</span><span class="p">,</span>
                <span class="n">Dtheta</span><span class="p">,</span>
                <span class="n">nDtheta</span><span class="p">,</span>
                <span class="n">Dphi</span><span class="p">,</span>
                <span class="n">nDphi</span><span class="p">,</span>
                <span class="n">theta</span><span class="p">,</span>
                <span class="n">phi</span><span class="p">,</span>
                <span class="n">ntheta</span><span class="p">,</span>
                <span class="n">nphi</span><span class="p">,</span>
                <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">noccur</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntheta</span><span class="p">,</span> <span class="n">nphi</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">indok</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dist_theta</span><span class="p">)</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">indphi</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">dist_theta</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dist</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">indphi</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">dist_theta</span><span class="p">,</span> <span class="p">(</span><span class="n">nphi</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">indStruct</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>

        <span class="n">dist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">dist</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">dist</span><span class="p">,</span> <span class="n">indStruct</span></div>

<div class="viewcode-block" id="Config.plot_phithetaproj_dist"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.plot_phithetaproj_dist">[docs]</a>    <span class="k">def</span> <span class="nf">plot_phithetaproj_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nphi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">theta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invertx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">draw</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">indStruct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_phithetaproj_dist</span><span class="p">(</span><span class="n">refpt</span><span class="o">=</span><span class="n">refpt</span><span class="p">,</span>
                                                      <span class="n">ntheta</span><span class="o">=</span><span class="n">ntheta</span><span class="p">,</span> <span class="n">nphi</span><span class="o">=</span><span class="n">nphi</span><span class="p">,</span>
                                                      <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Config_phithetaproj_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refpt</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">indStruct</span><span class="p">,</span>
                                              <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
                                              <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
                                              <span class="n">invertx</span><span class="o">=</span><span class="n">invertx</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.isInside"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.isInside">[docs]</a>    <span class="k">def</span> <span class="nf">isInside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">In</span><span class="o">=</span><span class="s2">&quot;(X,Y,Z)&quot;</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Return a 2D array of bool</span>

<span class="sd">        Equivalent to applying isInside to each Struct</span>
<span class="sd">        Check self.lStruct[0].isInside? for details</span>

<span class="sd">        Arg log determines how Struct with multiple Limits are treated</span>
<span class="sd">            - &#39;all&#39; : True only if pts belong to all elements</span>
<span class="sd">            - &#39;any&#39; : True if pts belong to any element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg pts must be a 1D or 2D np.ndarray !&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">msg</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg log must be in [&#39;any&#39;,&#39;all&#39;]&quot;</span>
        <span class="k">assert</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">],</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg pts must contain the coordinates of a point !&quot;</span>
            <span class="k">assert</span> <span class="n">pts</span><span class="o">.</span><span class="n">size</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">msg</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">pts</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg pts must contain the coordinates of points !&quot;</span>
            <span class="k">assert</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">pts</span>
        <span class="n">nP</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">],</span> <span class="n">nP</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">lStruct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">noccur</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">indi</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Poly</span><span class="p">),</span>
                    <span class="n">ves_lims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Lim</span><span class="p">),</span>
                    <span class="n">nlim</span><span class="o">=</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">noccur</span><span class="p">,</span>
                    <span class="n">ves_type</span><span class="o">=</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
                    <span class="n">in_format</span><span class="o">=</span><span class="n">In</span><span class="p">,</span>
                    <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indi</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">_Ves_isInside</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">pts</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Poly</span><span class="p">),</span>
                    <span class="n">ves_lims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">nlim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">ves_type</span><span class="o">=</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
                    <span class="n">in_format</span><span class="o">=</span><span class="n">In</span><span class="p">,</span>
                    <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">noccur</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
                    <span class="n">indi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">indi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">indi</span>
        <span class="k">return</span> <span class="n">ind</span></div>

    <span class="c1"># TBF</span>
<div class="viewcode-block" id="Config.fdistfromwall"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.fdistfromwall">[docs]</a>    <span class="k">def</span> <span class="nf">fdistfromwall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a callable (function) for detecting trajectory collisions</span>
<span class="sd">        with wall</span>

<span class="sd">        The function is continuous wrt time and space</span>
<span class="sd">        It takes into account all Struct in Config, including non-axisymmetric</span>
<span class="sd">        ones</span>

<span class="sd">        It is desined for iterative root-finding algorithms and is thus called</span>
<span class="sd">        for a unique position</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># LM: ... function NOT finished (TBF)</span>
        <span class="c1"># LM: ... since we are in devel this is too dangerous to keep</span>
        <span class="c1"># LM: ... commenting and raising warning</span>
        <span class="c1"># isin = [ss._InOut == &quot;in&quot; for ss in self.lStruct]</span>
        <span class="c1"># inside = self.isInside(np.r_[r, z, phi], In=&quot;(R,Z,Phi)&quot;, log=&quot;any&quot;)</span>

        <span class="c1"># distRZ, indStruct = self._get_phithetaproj_dist(</span>
        <span class="c1">#     refpt=np.r_[r, z], ntheta=ntheta, nphi=nphi, theta=theta, phi=phi</span>
        <span class="c1"># )</span>
        <span class="c1"># lSlim = [ss for ss in self.lStruct if ss.noccur &gt; 0]</span>
        <span class="c1"># distPhi = r * np.min([np.min(np.abs(phi - ss.Lim)) for ss in lSlim])</span>
        <span class="c1"># if inside:</span>
        <span class="c1">#     return min(distRZ, distPhi)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     return -min(distRZ, distPhi)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;FUNCTION NOT DEFINED&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="c1"># Method handling reflections</span>

<div class="viewcode-block" id="Config._reflect_Types"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._reflect_Types">[docs]</a>    <span class="k">def</span> <span class="nf">_reflect_Types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nRays</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an array indicating the Type of reflection for each LOS</span>

<span class="sd">        Return a (nRays,) np.ndarray of int indices, each index corresponds to:</span>
<span class="sd">            - 0: specular reflections</span>
<span class="sd">            - 1: diffusive reflections</span>
<span class="sd">            - 2: ccube reflections (corner cube)</span>

<span class="sd">        If indout is provided, the Types are computed according to the</span>
<span class="sd">        information stored in each corresponding Struct</span>

<span class="sd">        If Type is provided, the Type is forced (user-defined) for all LOS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;specular&quot;</span><span class="p">,</span> <span class="s2">&quot;diffusive&quot;</span><span class="p">,</span> <span class="s2">&quot;ccube&quot;</span><span class="p">]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nRays</span><span class="p">,),</span> <span class="n">_DREFLECT</span><span class="p">[</span><span class="n">Type</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reflections</span><span class="p">(</span><span class="n">indout</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">Types</span></div>

<div class="viewcode-block" id="Config._reflect_geom"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config._reflect_geom">[docs]</a>    <span class="k">def</span> <span class="nf">_reflect_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vperp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">vperp</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">indout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">indout</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Get Types of relection for each Ray</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reflect_Types</span><span class="p">(</span><span class="n">indout</span><span class="o">=</span><span class="n">indout</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">nRays</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Deduce u2</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">Struct</span><span class="o">.</span><span class="n">_get_reflections_ufromTypes</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">Types</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u2</span><span class="p">,</span> <span class="n">Types</span></div>

<div class="viewcode-block" id="Config.plot"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="n">dLeg</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
        <span class="n">indices</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Nstep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="n">tit</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tit</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span>
        <span class="n">lStruct</span><span class="p">,</span> <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">vis</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span>
                <span class="n">lS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">tit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span>
        <span class="n">lax</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Struct_plot</span><span class="p">(</span>
            <span class="n">lS</span><span class="p">,</span>
            <span class="n">lax</span><span class="o">=</span><span class="n">lax</span><span class="p">,</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span>
            <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span>
            <span class="n">Nstep</span><span class="o">=</span><span class="n">Nstep</span><span class="p">,</span>
            <span class="n">dLeg</span><span class="o">=</span><span class="n">dLeg</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">lax</span></div>

<div class="viewcode-block" id="Config.plot_sino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.plot_sino">[docs]</a>    <span class="k">def</span> <span class="nf">plot_sino</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Ang</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSImpAng</span><span class="p">,</span>
        <span class="n">AngUnit</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSImpAngUnit</span><span class="p">,</span>
        <span class="n">Sketch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dLeg</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Set the sino params before plotting !&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    =&gt; run self.set_sino(...)&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="n">tit</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tit</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="c1"># Check uniformity of sinogram parameters</span>
        <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> has different&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="n">msgf</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    =&gt; run self.set_sino(...)&quot;</span>
            <span class="n">msg0</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot; sino RefPt&quot;</span> <span class="o">+</span> <span class="n">msgf</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">],</span> <span class="n">ss</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">]),</span> <span class="n">msg0</span>
            <span class="n">msg1</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot; sino nP&quot;</span> <span class="o">+</span> <span class="n">msgf</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;nP&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ss</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s2">&quot;nP&quot;</span><span class="p">],</span> <span class="n">msg1</span>

        <span class="k">if</span> <span class="n">tit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span>

        <span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_visible</span><span class="p">()</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="p">[</span><span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dStruct</span><span class="p">[</span><span class="s2">&quot;nObj&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">vis</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Plot_Impact_PolProjPoly</span><span class="p">(</span>
            <span class="n">lS</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span>
            <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span>
            <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span>
            <span class="n">dP</span><span class="o">=</span><span class="n">dP</span><span class="p">,</span>
            <span class="n">dLeg</span><span class="o">=</span><span class="n">dLeg</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Config.from_svg"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.from_svg">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_svg</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">pfe</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">point_ref1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">point_ref2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">length_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">r0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">z0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">SavePath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">),</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">returnas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Build a config from a svg file (Inkscape)</span>

<span class="sd">        The svg shall have only:</span>
<span class="sd">            - closed polygons (possibly inc. Bezier curves)</span>
<span class="sd">            - an optional unique 2-points straight line (non-closed)</span>
<span class="sd">              used for auto-scaling</span>

<span class="sd">        If Beziers curves are included, they will be discretized according to</span>
<span class="sd">        resolution parameter res (absolute maximum tolerated distance between</span>
<span class="sd">        points)</span>

<span class="sd">        All closed polygons will be interpreted as:</span>
<span class="sd">            - a Ves instance if it has no fill color</span>
<span class="sd">            - a PFC instance if it has a fill color</span>
<span class="sd">        The names are derived from Inkscape objects id</span>

<span class="sd">        The coordinates are extracted from the svg</span>
<span class="sd">        They can be rescaled either:</span>
<span class="sd">            - automatically:</span>
<span class="sd">                scaling computed from the unique straight line</span>
<span class="sd">                and from the corresponding 2 points real-life coordinates</span>
<span class="sd">                provided by the user as 2 iterables (list, arrays or tuples)</span>
<span class="sd">                of len() = 2 (point_ref1 and point_ref2)</span>
<span class="sd">                Alternatively a single point (point_ref1) and the length_ref</span>
<span class="sd">                of the line can be provided</span>
<span class="sd">            - forcefully:</span>
<span class="sd">                the origin (r0, z0) and a common scaling factor (scale) are</span>
<span class="sd">                provided by the user</span>

<span class="sd">        The result Config instance must have a Name and be associated to an</span>
<span class="sd">        experiment (Exp).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">returnas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">returnas</span> <span class="o">=</span> <span class="nb">object</span>
        <span class="k">if</span> <span class="n">returnas</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Arg returnas must be either:&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;object&#39;: return Config instance</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;dict&#39; : return a dict with polygon, cls, color&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Extract polygon from file and check</span>
        <span class="n">dpath</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">get_paths_from_svg</span><span class="p">(</span>
            <span class="n">pfe</span><span class="o">=</span><span class="n">pfe</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
            <span class="n">point_ref1</span><span class="o">=</span><span class="n">point_ref1</span><span class="p">,</span> <span class="n">point_ref2</span><span class="o">=</span><span class="n">point_ref2</span><span class="p">,</span>
            <span class="n">length_ref</span><span class="o">=</span><span class="n">length_ref</span><span class="p">,</span>
            <span class="n">r0</span><span class="o">=</span><span class="n">r0</span><span class="p">,</span> <span class="n">z0</span><span class="o">=</span><span class="n">z0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dpath</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No Struct found in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">returnas</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dpath</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">derr</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lstruct</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dpath</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">clss</span> <span class="o">=</span> <span class="n">Ves</span> <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;cls&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Ves&#39;</span> <span class="k">else</span> <span class="n">PFC</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">lstruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">clss</span><span class="p">(</span>
                            <span class="n">Name</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">Poly</span><span class="o">=</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">],</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span> <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">derr</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">derr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lerr</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">derr</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The following Struct could not be created:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lerr</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">SavePath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">SavePath</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">Exp</span><span class="o">=</span><span class="n">Exp</span><span class="p">,</span>
                <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span>
                <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
                <span class="n">lStruct</span><span class="o">=</span><span class="n">lstruct</span><span class="p">,</span>
                <span class="n">SavePath</span><span class="o">=</span><span class="n">SavePath</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Config.save_to_imas"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.save_to_imas">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_imas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">refshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">refrun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">description_2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tofu.imas2tofu</span> <span class="k">as</span> <span class="nn">_tfimas</span>

        <span class="n">_tfimas</span><span class="o">.</span><span class="n">_save_to_imas</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">tfversion</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
            <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span>
            <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
            <span class="n">refshot</span><span class="o">=</span><span class="n">refshot</span><span class="p">,</span>
            <span class="n">refrun</span><span class="o">=</span><span class="n">refrun</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
            <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">description_2d</span><span class="o">=</span><span class="n">description_2d</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Config.get_kwdargs_LOS_isVis"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.get_kwdargs_LOS_isVis">[docs]</a>    <span class="k">def</span> <span class="nf">get_kwdargs_LOS_isVis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lStruct</span>

        <span class="c1"># -- Getting &quot;vessels&quot; or IN structures -------------------------------</span>
        <span class="n">lSIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span> <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lSIn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;self.config must have at least a StructIn subclass !&quot;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lSIn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lSIn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">lSIn</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;Surf&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lSIn</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">lSIn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># ... and its poly, limts, type, etc.</span>
        <span class="n">VPoly</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">Poly_closed</span>
        <span class="n">VVIn</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;VIn&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">Lim</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">S</span><span class="o">.</span><span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="o">.</span><span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">Lim</span>
        <span class="n">VType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>

        <span class="c1"># -- Getting OUT structures -------------------------------------------</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span> <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">lSLim</span><span class="p">,</span> <span class="n">lSnLim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">num_lim_structs</span><span class="p">,</span> <span class="n">num_tot_structs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="n">lSPolyx</span><span class="p">,</span> <span class="n">lSPolyy</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">lSVInx</span><span class="p">,</span> <span class="n">lSVIny</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">lsnvert</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Lims</span>
            <span class="n">lSLim</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span><span class="o">.</span><span class="n">Lim</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">]</span>
            <span class="n">lSnLim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">noccur</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">])</span>

            <span class="c1"># Nb of structures and of structures inc. Lims (toroidal occurence)</span>
            <span class="n">num_lim_structs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lS</span><span class="p">)</span>
            <span class="n">num_tot_structs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">noccur</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">]))</span>

            <span class="c1"># build concatenated C-contiguous arrays of x and y coordinates</span>
            <span class="n">lSPolyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">])</span>
            <span class="n">lSPolyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">])</span>
            <span class="n">lSVInx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;VIn&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">])</span>
            <span class="n">lSVIny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;VIn&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">])</span>

            <span class="c1"># lsnvert = cumulated number of points in the poly of each Struct</span>
            <span class="n">lsnvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span>
                <span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Now setting keyword arguments:</span>
        <span class="n">dkwd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">ves_poly</span><span class="o">=</span><span class="n">VPoly</span><span class="p">,</span>
            <span class="n">ves_norm</span><span class="o">=</span><span class="n">VVIn</span><span class="p">,</span>
            <span class="n">ves_lims</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span>
            <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">num_tot_structs</span><span class="p">,</span>
            <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">num_lim_structs</span><span class="p">,</span>
            <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lSPolyx</span><span class="p">,</span>
            <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lSPolyy</span><span class="p">,</span>
            <span class="n">lstruct_lims</span><span class="o">=</span><span class="n">lSLim</span><span class="p">,</span>
            <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">lSnLim</span><span class="p">,</span>
            <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lSVInx</span><span class="p">,</span>
            <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lSVIny</span><span class="p">,</span>
            <span class="n">lnvert</span><span class="o">=</span><span class="n">lsnvert</span><span class="p">,</span>
            <span class="n">ves_type</span><span class="o">=</span><span class="n">VType</span><span class="p">,</span>
            <span class="n">rmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">forbid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">eps_uz</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span>
            <span class="n">eps_vz</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
            <span class="n">eps_a</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
            <span class="n">eps_b</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
            <span class="n">eps_plane</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
            <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">dkwd</span></div>

<div class="viewcode-block" id="Config.calc_solidangle_particle"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.calc_solidangle_particle">[docs]</a>    <span class="k">def</span> <span class="nf">calc_solidangle_particle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">part_traj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">part_radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">approx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">aniso</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the solid angle subtended by a particle along a trajectory</span>

<span class="sd">        The particle has radius r, and trajectory (array of points) traj</span>
<span class="sd">        It is observed from pts (array of points)</span>
<span class="sd">        Takes into account blocking of the field of view by structural elements</span>

<span class="sd">        traj and pts are (3, N) and (3, M) arrays of cartesian coordinates</span>

<span class="sd">        approx = True =&gt; use approximation</span>
<span class="sd">        aniso = True =&gt; return also unit vector of emission</span>
<span class="sd">        block = True consider LOS collisions (with Ves, Struct...)</span>

<span class="sd">        if block:</span>
<span class="sd">            config used for LOS collisions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        traj:       np.ndarray</span>
<span class="sd">            Array of (3, N) pts coordinates (X, Y, Z) representing the particle</span>
<span class="sd">            positions</span>
<span class="sd">        pts:        np.ndarray</span>
<span class="sd">            Array of (3, M) pts coordinates (X, Y, Z) representing points from</span>
<span class="sd">            which the particle is observed</span>
<span class="sd">        rad:        float / np.ndarray</span>
<span class="sd">            Unique of multiple values for the radius of the spherical particle</span>
<span class="sd">                if multiple, rad is a np.ndarray of shape (N,)</span>
<span class="sd">        approx:     None / bool</span>
<span class="sd">            Flag indicating whether to compute the solid angle using a</span>
<span class="sd">            1st-order series development (in which case the solid angle becomes</span>
<span class="sd">            proportional to the radius of the particle, see Notes_Upgrades/)</span>
<span class="sd">        aniso:      None / bool</span>
<span class="sd">            Flag indicating whether to consider anisotropic emissivity,</span>
<span class="sd">            meaning the routine must also compute and return the unit vector</span>
<span class="sd">            directing the flux from each pts to each position on the trajectory</span>
<span class="sd">        block:      None / bool</span>
<span class="sd">            Flag indicating whether to check for vignetting by structural</span>
<span class="sd">            elements provided by config</span>

<span class="sd">        Return:</span>
<span class="sd">        -------</span>
<span class="sd">        sang: np.ndarray</span>
<span class="sd">            (N, M) Array of floats, solid angles</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_comp_solidangles</span><span class="o">.</span><span class="n">calc_solidangle_particle</span><span class="p">(</span>
            <span class="n">pts</span><span class="o">=</span><span class="n">pts</span><span class="p">,</span>
            <span class="n">part_traj</span><span class="o">=</span><span class="n">part_traj</span><span class="p">,</span>
            <span class="n">part_radius</span><span class="o">=</span><span class="n">part_radius</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">approx</span><span class="o">=</span><span class="n">approx</span><span class="p">,</span>
            <span class="n">aniso</span><span class="o">=</span><span class="n">aniso</span><span class="p">,</span>
            <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Config.calc_solidangle_particle_integrated"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Config.calc_solidangle_particle_integrated">[docs]</a>    <span class="k">def</span> <span class="nf">calc_solidangle_particle_integrated</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">part_traj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">part_radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">approx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">block</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">DR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">DZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">DPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">returnax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the integrated solid angle map subtended by particles</span>

<span class="sd">        Integrates the solid angle toroidally on a volume sampling of Config</span>

<span class="sd">        The particle has radius r, and trajectory (array of points) traj</span>
<span class="sd">        It is observed from pts (array of points)</span>
<span class="sd">        Takes into account blocking of the field of view by structural elements</span>

<span class="sd">        traj and pts are (3, N) and (3, M) arrays of cartesian coordinates</span>

<span class="sd">        approx = True =&gt; use approximation</span>
<span class="sd">        block = True consider LOS collisions (with Ves, Struct...)</span>

<span class="sd">        if block:</span>
<span class="sd">            config used for LOS collisions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        traj:       np.ndarray</span>
<span class="sd">            Array of (3, N) pts coordinates (X, Y, Z) representing the particle</span>
<span class="sd">            positions</span>
<span class="sd">        pts:        np.ndarray</span>
<span class="sd">            Array of (3, M) pts coordinates (X, Y, Z) representing points from</span>
<span class="sd">            which the particle is observed</span>
<span class="sd">        rad:        float / np.ndarray</span>
<span class="sd">            Unique of multiple values for the radius of the spherical particle</span>
<span class="sd">                if multiple, rad is a np.ndarray of shape (N,)</span>
<span class="sd">        approx:     None / bool</span>
<span class="sd">            Flag indicating whether to compute the solid angle using a</span>
<span class="sd">            1st-order series development (in which case the solid angle becomes</span>
<span class="sd">            proportional to the radius of the particle, see Notes_Upgrades/)</span>
<span class="sd">        block:      None / bool</span>
<span class="sd">            Flag indicating whether to check for vignetting by structural</span>
<span class="sd">            elements provided by config</span>

<span class="sd">        Return:</span>
<span class="sd">        -------</span>
<span class="sd">        sang: np.ndarray</span>
<span class="sd">            (N, M) Array of floats, solid angles</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">returnax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">returnax</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># -------------------</span>
        <span class="c1"># Compute</span>
        <span class="p">(</span>
            <span class="n">ptsRZ</span><span class="p">,</span> <span class="n">sang</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">_comp_solidangles</span><span class="o">.</span><span class="n">calc_solidangle_particle_integ</span><span class="p">(</span>
            <span class="n">part_traj</span><span class="o">=</span><span class="n">part_traj</span><span class="p">,</span>
            <span class="n">part_radius</span><span class="o">=</span><span class="n">part_radius</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
            <span class="n">DR</span><span class="o">=</span><span class="n">DR</span><span class="p">,</span>
            <span class="n">DZ</span><span class="o">=</span><span class="n">DZ</span><span class="p">,</span>
            <span class="n">DPhi</span><span class="o">=</span><span class="n">DPhi</span><span class="p">,</span>
            <span class="n">block</span><span class="o">=</span><span class="n">block</span><span class="p">,</span>
            <span class="n">approx</span><span class="o">=</span><span class="n">approx</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ptsRZ</span><span class="p">,</span> <span class="n">sang</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">reseff</span>

        <span class="c1"># -------------------</span>
        <span class="c1"># plot</span>
        <span class="n">dax</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Config_plot_solidangle_map_particle</span><span class="p">(</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">part_traj</span><span class="o">=</span><span class="n">part_traj</span><span class="p">,</span>
            <span class="n">part_radius</span><span class="o">=</span><span class="n">part_radius</span><span class="p">,</span>
            <span class="n">ptsRZ</span><span class="o">=</span><span class="n">ptsRZ</span><span class="p">,</span>
            <span class="n">sang</span><span class="o">=</span><span class="n">sang</span><span class="p">,</span>
            <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
            <span class="n">reseff</span><span class="o">=</span><span class="n">reseff</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
            <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">returnax</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ptsRZ</span><span class="p">,</span> <span class="n">sang</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">dax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ptsRZ</span><span class="p">,</span> <span class="n">sang</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">reseff</span></div></div>



<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">###############################################################################</span>
<span class="sd">###############################################################################</span>
<span class="sd">                        Rays-derived classes and functions</span>
<span class="sd">###############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Rays"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays">[docs]</a><span class="k">class</span> <span class="nc">Rays</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parent class of rays (ray-tracing), LOS, CamLOS1D and CamLOS2D</span>

<span class="sd">    Focused on optimizing the computation time for many rays.</span>

<span class="sd">    Each ray is defined by a starting point (D) and a unit vector(u).</span>
<span class="sd">    If a vessel (Ves) and structural elements (LStruct) are provided,</span>
<span class="sd">    the intersection points are automatically computed.</span>

<span class="sd">    Methods for plootting, computing synthetic signal are provided.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Id :            str  / :class:`~tofu.pathfile.ID`</span>
<span class="sd">        A name string or a :class:`~tofu.pathfile.ID` to identify this</span>
<span class="sd">        instance,</span>
<span class="sd">        if a string is provided, it is fed to :class:`~tofu.pathfile.ID`</span>
<span class="sd">    Du :            iterable</span>
<span class="sd">        Iterable of len=2, containing 2 np.ndarrays represnting, for N rays:</span>
<span class="sd">            - Ds: a (3,N) array of the (X,Y,Z) coordinates of starting points</span>
<span class="sd">            - us: a (3,N) array of the (X,Y,Z) coordinates of the unit vectors</span>
<span class="sd">    Ves :           None / :class:`~tofu.geom.Ves`</span>
<span class="sd">        A :class:`~tofu.geom.Ves` instance to be associated to the rays</span>
<span class="sd">    LStruct:        None / :class:`~tofu.geom.Struct` / list</span>
<span class="sd">        A :class:`~tofu.geom.Struct` instance or list of such, for obstructions</span>
<span class="sd">    Sino_RefPt :    None / np.ndarray</span>
<span class="sd">        Iterable of len=2 with the coordinates of the sinogram reference point</span>
<span class="sd">            - (R,Z) coordinates if the vessel is of Type &#39;Tor&#39;</span>
<span class="sd">            - (Y,Z) coordinates if the vessel is of Type &#39;Lin&#39;</span>
<span class="sd">    Exp        :    None / str</span>
<span class="sd">        Experiment to which the LOS belongs:</span>
<span class="sd">            - if both Exp and Ves are provided: Exp==Ves.Id.Exp</span>
<span class="sd">            - if Ves is provided but not Exp: Ves.Id.Exp is used</span>
<span class="sd">    Diag       :    None / str</span>
<span class="sd">        Diagnostic to which the LOS belongs</span>
<span class="sd">    shot       :    None / int</span>
<span class="sd">        Shot number from which this LOS is valid</span>
<span class="sd">    SavePath :      None / str</span>
<span class="sd">        If provided, default saving path of the object</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Fixed (class-wise) dictionary of default properties</span>
    <span class="n">_ddef</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Id&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Mod&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Cls&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Exp&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Diag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;shot&quot;</span><span class="p">,</span>
                <span class="s2">&quot;version&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">},</span>
        <span class="s2">&quot;dgeom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Tor&quot;</span><span class="p">,</span> <span class="s2">&quot;Lim&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;arrayorder&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">},</span>
        <span class="s2">&quot;dsino&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;dmisc&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">},</span>
    <span class="p">}</span>
    <span class="n">_dplot</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cross&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Elt&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dP&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dI&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dBs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dBv&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">:</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;mew&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dVect&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;scale&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;hor&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Elt&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dP&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
            <span class="s2">&quot;dI&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
            <span class="s2">&quot;dBs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
            <span class="s2">&quot;dBv&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;ls&quot;</span><span class="p">:</span> <span class="s2">&quot;--&quot;</span><span class="p">},</span>
            <span class="s2">&quot;Nstep&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;3d&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Elt&quot;</span><span class="p">:</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dP&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="s2">&quot;rstride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;cstride&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;antialiased&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;Lim&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;Nstep&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">_dcases</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">,</span> <span class="s2">&quot;lk&quot;</span><span class="p">:</span> <span class="p">[]},</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;lk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">]},</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;lk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;pinhole&quot;</span><span class="p">]},</span>
        <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;lk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;nIn&quot;</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">]},</span>
        <span class="s2">&quot;E&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;lk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;nIn&quot;</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">,</span> <span class="s2">&quot;l1&quot;</span><span class="p">,</span> <span class="s2">&quot;n1&quot;</span><span class="p">]},</span>
        <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;lk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">]},</span>
        <span class="s2">&quot;G&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="s2">&quot;lk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;angles&quot;</span><span class="p">,</span> <span class="s2">&quot;l1&quot;</span><span class="p">,</span> <span class="s2">&quot;n1&quot;</span><span class="p">]},</span>
    <span class="p">}</span>

    <span class="n">_method</span> <span class="o">=</span> <span class="s2">&quot;optimized&quot;</span>

    <span class="c1"># Does not exist beofre Python 3.6 !!!</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="c1"># Python 2</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Rays</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="c1"># Python 3</span>
        <span class="c1"># super().__init_subclass__(**kwdargs)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Rays</span><span class="o">.</span><span class="n">_ddef</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dplot</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Rays</span><span class="o">.</span><span class="n">_dplot</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_set_color_ddef</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_dcases</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">][</span><span class="s2">&quot;lk&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;e2&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">]</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_dcases</span><span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">][</span><span class="s2">&quot;lk&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;e2&quot;</span><span class="p">,</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span> <span class="s2">&quot;n2&quot;</span><span class="p">]</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_dcases</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">][</span><span class="s2">&quot;lk&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_dcases</span><span class="p">[</span><span class="s2">&quot;G&quot;</span><span class="p">][</span><span class="s2">&quot;lk&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;l2&quot;</span><span class="p">,</span> <span class="s2">&quot;n2&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="Rays._set_color_ddef"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._set_color_ddef">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_set_color_ddef</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;dmisc&#39;</span><span class="p">][</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgeom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lOptics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Etendues</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span>
                 <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sino_RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;optimized&#39;</span><span class="p">,</span>
                 <span class="n">SavePath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Create a dplot at instance level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_dplot</span><span class="p">)</span>

        <span class="c1"># Extra-early fix for Exp</span>
        <span class="c1"># Workflow to be cleaned up later ?</span>
        <span class="k">if</span> <span class="n">Exp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Exp</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span>

        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s2">&quot;self&quot;</span><span class="p">]</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Rays</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<div class="viewcode-block" id="Rays._reset"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Rays</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dgeom</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dX12</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dOptics</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dOptics</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dconfig</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dsino</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dchans</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dmisc</span><span class="p">())</span></div>
        <span class="c1"># self._dplot = copy.deepcopy(self.__class__._ddef[&#39;dplot&#39;])</span>

<div class="viewcode-block" id="Rays._checkformat_inputs_Id"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_inputs_Id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_Id</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwdargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">Id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">Name</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span> <span class="o">=</span> <span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
        <span class="k">if</span> <span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shot</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;shot&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;Id&quot;</span><span class="p">][</span><span class="s2">&quot;include&quot;</span><span class="p">]</span>

        <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s2">&quot;Exp&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Exp</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s2">&quot;Diag&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">Diag</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
            <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">shot</span><span class="p">,</span> <span class="s2">&quot;cls&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span>
            <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">include</span><span class="p">,</span> <span class="s2">&quot;listof&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="n">dins</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">dins</span><span class="p">,</span> <span class="n">tab</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">Name</span><span class="p">,</span>
                <span class="s2">&quot;Exp&quot;</span><span class="p">:</span> <span class="n">Exp</span><span class="p">,</span>
                <span class="s2">&quot;shot&quot;</span><span class="p">:</span> <span class="n">shot</span><span class="p">,</span>
                <span class="s2">&quot;Diag&quot;</span><span class="p">:</span> <span class="n">Diag</span><span class="p">,</span>
                <span class="s2">&quot;include&quot;</span><span class="p">:</span> <span class="n">include</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">kwdargs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get largs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays._get_largs_dgeom"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_largs_dgeom">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dgeom</span><span class="p">(</span><span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dgeom&quot;</span><span class="p">,</span> <span class="s2">&quot;Etendues&quot;</span><span class="p">,</span> <span class="s2">&quot;Surfaces&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sino</span><span class="p">:</span>
            <span class="n">lsino</span> <span class="o">=</span> <span class="n">Rays</span><span class="o">.</span><span class="n">_get_largs_dsino</span><span class="p">()</span>
            <span class="n">largs</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;sino_</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lsino</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Rays._get_largs_dX12"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_largs_dX12">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dX12</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Rays._get_largs_dOptics"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_largs_dOptics">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dOptics</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lOptics&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Rays._get_largs_dconfig"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_largs_dconfig">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dconfig</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Rays._get_largs_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_largs_dsino">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dsino</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Rays._get_largs_dchans"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_largs_dchans">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dchans</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dchans&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Rays._get_largs_dmisc"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_largs_dmisc">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dmisc</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get check and format inputs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays._checkformat_inputs_dES"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_inputs_dES">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dES</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">C0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span>
            <span class="k">if</span> <span class="n">C0</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">val</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Rays._checkformat_inputs_dgeom"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_inputs_dgeom">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgeom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">dgeom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dgeom</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dgeom</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
              <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dgeom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcases</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                  <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">kk</span> <span class="ow">in</span> <span class="n">dgeom</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>  <span class="c1"># noqa</span>
                           <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcases</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;lk&#39;</span><span class="p">]]))]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;lk&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcases</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg dgeom must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  - dict with keys:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  - tuple of len()==2 containing (D,u)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">case</span> <span class="o">=</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">_checkformat_Du</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg </span><span class="si">%s</span><span class="s2"> must be an iterable convertible into either:&quot;</span> <span class="o">%</span> <span class="n">name</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - a 1D np.ndarray of size=3&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - a 2D np.ndarray of shape (3,N)&quot;</span>
            <span class="k">assert</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">msg</span>
            <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">msg</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="mi">3</span> <span class="ow">in</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">msg</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">T</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">arr</span>

        <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span> <span class="k">else</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">case</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span> <span class="k">else</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">_checkformat_Du</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">_checkformat_Du</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">)</span>
            <span class="c1"># Normalize u</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">nD</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">C0</span> <span class="o">=</span> <span class="n">nD</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nu</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="n">nD</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nu</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">C2</span> <span class="o">=</span> <span class="n">nD</span> <span class="o">==</span> <span class="n">nu</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The number of rays is ambiguous from D and u shapes !&quot;</span>
            <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span> <span class="ow">or</span> <span class="n">C2</span><span class="p">,</span> <span class="n">msg</span>
            <span class="n">nRays</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nD</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span>
            <span class="n">dgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">u</span><span class="p">,</span> <span class="s2">&quot;isImage&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">case</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">_checkformat_Du</span><span class="p">(</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">],</span> <span class="s1">&#39;D&#39;</span><span class="p">)</span>
            <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pinhole&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;var&#39;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;pinhole&#39;</span><span class="p">],</span> <span class="s1">&#39;vectnd&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}}</span>
            <span class="n">dins</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">pinhole</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">][</span><span class="s2">&quot;var&quot;</span><span class="p">]</span>
            <span class="n">dgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="n">D</span><span class="p">,</span> <span class="s2">&quot;pinhole&quot;</span><span class="p">:</span> <span class="n">pinhole</span><span class="p">,</span> <span class="s2">&quot;isImage&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
            <span class="n">nRays</span> <span class="o">=</span> <span class="n">D</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pinhole&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">],</span> <span class="s2">&quot;vectnd&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="s2">&quot;F&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">],</span> <span class="s2">&quot;int2float&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">]:</span>
                <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;nIn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;nIn&quot;</span><span class="p">],</span> <span class="s2">&quot;unitvectnd&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
                <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;e1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;e1&quot;</span><span class="p">],</span> <span class="s2">&quot;unitvectnd&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
                <span class="k">if</span> <span class="s2">&quot;e2&quot;</span> <span class="ow">in</span> <span class="n">dgeom</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;e2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;e2&quot;</span><span class="p">],</span> <span class="s2">&quot;unitvectnd&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;angles&quot;</span><span class="p">],</span> <span class="s2">&quot;vectnd&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]:</span>
                <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span> <span class="s2">&quot;vectnd&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                <span class="k">if</span> <span class="s2">&quot;x2&quot;</span><span class="p">:</span>
                    <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">],</span> <span class="s2">&quot;vectnd&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;l1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;l1&quot;</span><span class="p">],</span> <span class="s2">&quot;int2float&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;n1&quot;</span><span class="p">],</span> <span class="s2">&quot;float2int&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                <span class="k">if</span> <span class="s2">&quot;l2&quot;</span> <span class="ow">in</span> <span class="n">dgeom</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;l2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;l2&quot;</span><span class="p">],</span> <span class="s2">&quot;int2float&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                    <span class="n">dins</span><span class="p">[</span><span class="s2">&quot;n2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;n2&quot;</span><span class="p">],</span> <span class="s2">&quot;float2int&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

            <span class="n">dins</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_InputsGeneric</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">dgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dX12&quot;</span><span class="p">:</span> <span class="p">{}}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dins</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;pinhole&quot;</span><span class="p">:</span>
                    <span class="n">dgeom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;var&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;var&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]:</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;l1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                    <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;n1&quot;</span><span class="p">],</span> <span class="n">end_point</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;x1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
                    <span class="n">x2</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;l2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;n2&quot;</span><span class="p">],</span> <span class="n">end_point</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x2</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
                <span class="n">nRays</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;n1&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;n2&quot;</span><span class="p">]</span>
                <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">indr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ind12r_n12</span><span class="p">(</span>
                    <span class="n">n1</span><span class="o">=</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;n1&quot;</span><span class="p">],</span> <span class="n">n2</span><span class="o">=</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;n2&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;ind1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind1</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;ind2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind2</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;indr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indr</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;isImage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nRays</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;n1&quot;</span><span class="p">]</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;isImage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">,</span> <span class="s2">&quot;nRays&quot;</span><span class="p">:</span> <span class="n">nRays</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">dgeom</span></div>

<div class="viewcode-block" id="Rays._checkformat_dX12"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_dX12">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_dX12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">dX12</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">dX12</span> <span class="o">==</span> <span class="s2">&quot;geom&quot;</span> <span class="ow">or</span> <span class="n">dX12</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;geom&quot;</span><span class="p">},</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">dX12</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dX12 must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - None</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - &#39;geom&#39; : will be derived from the 3D geometry</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - dict : containing {&#39;x1&#39;  : array of coords.,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                         &#39;x2&#39;  : array of coords.,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                         &#39;ind1&#39;: array of int indices,</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                         &#39;ind2&#39;: array of int indices}&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dX12</span><span class="p">()</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c2</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dX12 is not provided as input (dX12 = None)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; self._dgeom[&#39;dX12&#39;] (computed) used as fallback</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - It should have non-None keys: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - it is:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;geom&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;ind1&quot;</span><span class="p">,</span> <span class="s2">&quot;ind2&quot;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">dX12</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dX12</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dX12</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x2</span><span class="o">.</span><span class="n">size</span>
            <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">indr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ind12r_n12</span><span class="p">(</span>
                <span class="n">ind1</span><span class="o">=</span><span class="n">dX12</span><span class="p">[</span><span class="s2">&quot;ind1&quot;</span><span class="p">],</span> <span class="n">ind2</span><span class="o">=</span><span class="n">dX12</span><span class="p">[</span><span class="s2">&quot;ind2&quot;</span><span class="p">],</span> <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span>
            <span class="p">)</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span>
                <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span>
                <span class="s2">&quot;n1&quot;</span><span class="p">:</span> <span class="n">n1</span><span class="p">,</span>
                <span class="s2">&quot;n2&quot;</span><span class="p">:</span> <span class="n">n2</span><span class="p">,</span>
                <span class="s2">&quot;ind1&quot;</span><span class="p">:</span> <span class="n">ind1</span><span class="p">,</span>
                <span class="s2">&quot;ind2&quot;</span><span class="p">:</span> <span class="n">ind2</span><span class="p">,</span>
                <span class="s2">&quot;indr&quot;</span><span class="p">:</span> <span class="n">indr</span><span class="p">,</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="s2">&quot;self&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">dX12</span></div>

<div class="viewcode-block" id="Rays._checkformat_dOptics"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_dOptics">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_dOptics</span><span class="p">(</span><span class="n">lOptics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lOptics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lOptics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">lOptics</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
        <span class="n">lcls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Apert3D&quot;</span><span class="p">,</span> <span class="s2">&quot;Cryst2D&quot;</span><span class="p">]</span>
        <span class="n">nOptics</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lOptics</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nOptics</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">lOptics</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="n">lcls</span>
        <span class="k">return</span> <span class="n">lOptics</span></div>

<div class="viewcode-block" id="Rays._checkformat_inputs_dconfig"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_inputs_dconfig">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dconfig</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check config has proper class</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">Config</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg config must be a Config instance!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- expected: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Config</span><span class="p">))</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check all structures</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">lStruct</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="s2">&quot;_InOut&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">]</span>
              <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All Struct in config must have self._InOut in [&#39;in&#39;,&#39;out&#39;]&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check there is at least one struct which is a subclass of StructIn</span>
        <span class="n">lSIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span> <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lSIn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lclsnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">,</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Config </span><span class="si">{}</span><span class="s2"> is missing a StructIn!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">- &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lclsnames</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Add &#39;compute&#39; parameter if not present</span>
        <span class="k">if</span> <span class="s2">&quot;compute&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">_dextraprop</span><span class="p">[</span><span class="s2">&quot;lprop&quot;</span><span class="p">]:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_extraprop</span><span class="p">(</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span></div>

<div class="viewcode-block" id="Rays._checkformat_inputs_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_inputs_dsino">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">RefPt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">RefPt</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">RefPt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">RefPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">RefPt</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">RefPt</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;RefPt must be of size=2 !&quot;</span>
        <span class="k">return</span> <span class="n">RefPt</span></div>

<div class="viewcode-block" id="Rays._checkformat_inputs_dchans"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_inputs_dchans">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dchans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">dchans</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dchans</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dchans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dchans</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dchans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dchans</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">]</span>
            <span class="n">dchans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
        <span class="k">return</span> <span class="n">dchans</span></div>

<div class="viewcode-block" id="Rays._checkformat_inputs_dmisc"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_inputs_dmisc">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_dmisc</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s2">&quot;dmisc&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">is_color_like</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">color</span><span class="p">))</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get keys of dictionnaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays._get_keys_dgeom"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_keys_dgeom">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dgeom</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;D&quot;</span><span class="p">,</span>
            <span class="s2">&quot;u&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pinhole&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nRays&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kIn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kOut&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PkIn&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PkOut&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vperp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;indout&quot;</span><span class="p">,</span>
            <span class="s2">&quot;indStruct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;kRMin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PRMin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;RMin&quot;</span><span class="p">,</span>
            <span class="s2">&quot;isImage&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Etendues&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Surfaces&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dX12&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dreflect&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move_param&quot;</span><span class="p">,</span>
            <span class="s2">&quot;move_kwdargs&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Rays._get_keys_dX12"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_keys_dX12">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dX12</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="s2">&quot;n1&quot;</span><span class="p">,</span> <span class="s2">&quot;n2&quot;</span><span class="p">,</span> <span class="s2">&quot;ind1&quot;</span><span class="p">,</span> <span class="s2">&quot;ind2&quot;</span><span class="p">,</span> <span class="s2">&quot;indr&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Rays._get_keys_dOptics"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_keys_dOptics">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dOptics</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lorder&quot;</span><span class="p">,</span> <span class="s2">&quot;lCls&quot;</span><span class="p">,</span> <span class="s2">&quot;nObj&quot;</span><span class="p">,</span> <span class="s2">&quot;dObj&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Rays._get_keys_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_keys_dsino">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dsino</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="s2">&quot;pts&quot;</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Rays._get_keys_dconfig"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_keys_dconfig">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dconfig</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Rays._get_keys_dchans"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_keys_dchans">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dchans</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Rays._get_keys_dmisc"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_keys_dmisc">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dmisc</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _init</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays._init"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._init">[docs]</a>    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dgeom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Etendues</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sino_RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;optimized&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dgeom</span><span class="p">(</span><span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">kwdgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dconfig</span><span class="p">()</span>
        <span class="n">kwdconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dchans</span><span class="p">()</span>
        <span class="n">kwdchans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dOptics</span><span class="p">()</span>
        <span class="n">kwdOptics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dmisc</span><span class="p">()</span>
        <span class="n">kwdmisc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dconfig</span><span class="p">(</span><span class="n">calcdgeom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdconfig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdgeom</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="n">kwdX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dX12</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dX12</span><span class="p">(</span><span class="o">**</span><span class="n">kwdX12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dOptics</span><span class="p">(</span><span class="o">**</span><span class="n">kwdOptics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dchans</span><span class="p">(</span><span class="o">**</span><span class="n">kwdchans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dmisc</span><span class="p">(</span><span class="o">**</span><span class="n">kwdmisc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="c1">###########</span>
    <span class="c1"># set dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays.set_dconfig"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.set_dconfig">[docs]</a>    <span class="k">def</span> <span class="nf">set_dconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calcdgeom</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dconfig</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">calcdgeom</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_dgeom</span><span class="p">()</span></div>

<div class="viewcode-block" id="Rays._update_dgeom_from_TransRotFoc"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._update_dgeom_from_TransRotFoc">[docs]</a>    <span class="k">def</span> <span class="nf">_update_dgeom_from_TransRotFoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">):</span>
        <span class="c1"># To be finished for 1.4.1</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Not coded yet !&quot;</span><span class="p">)</span></div>
        <span class="c1"># assert False, &quot;Not implemented yet, for future versions&quot;</span>
        <span class="c1"># if key in [&#39;x&#39;,&#39;y&#39;,&#39;z&#39;]:</span>
        <span class="c1"># if key == &#39;x&#39;:</span>
        <span class="c1"># trans = np.r_[val,0.,0.]</span>
        <span class="c1"># elif key == &#39;y&#39;:</span>
        <span class="c1"># trans = np.r_[0.,val,0.]</span>
        <span class="c1"># else:</span>
        <span class="c1"># trans = np.r_[0.,0.,val]</span>
        <span class="c1"># if self._dgeom[&#39;pinhole&#39;] is not None:</span>
        <span class="c1"># self._dgeom[&#39;pinhole&#39;] += trans</span>
        <span class="c1"># self._dgeom[&#39;D&#39;] += trans[:,np.newaxis]</span>
        <span class="c1"># if key in [&#39;nIn&#39;,&#39;e1&#39;,&#39;e2&#39;]:</span>
        <span class="c1"># if key == &#39;nIn&#39;:</span>
        <span class="c1"># e1 = (np.cos(val)*self._dgeom[&#39;dX12&#39;][&#39;e1&#39;]</span>
        <span class="c1"># + np.sin(val)*self._dgeom[&#39;dX12&#39;][&#39;e2&#39;])</span>
        <span class="c1"># e2 = (np.cos(val)*self._dgeom[&#39;dX12&#39;][&#39;e2&#39;]</span>
        <span class="c1"># - np.sin(val)*self._dgeom[&#39;dX12&#39;][&#39;e1&#39;])</span>
        <span class="c1"># self._dgeom[&#39;dX12&#39;][&#39;e1&#39;] = e1</span>
        <span class="c1"># self._dgeom[&#39;dX12&#39;][&#39;e2&#39;] = e2</span>
        <span class="c1"># elif key == &#39;e1&#39;:</span>
        <span class="c1"># nIn = (np.cos(val)*self._dgeom[&#39;dX12&#39;][&#39;nIn&#39;]</span>
        <span class="c1"># + np.sin(val)*self._dgeom[&#39;dX12&#39;][&#39;e2&#39;])</span>
        <span class="c1"># e2 = (np.cos(val)*self._dgeom[&#39;dX12&#39;][&#39;e2&#39;]</span>
        <span class="c1"># - np.sin(val)*self._dgeom[&#39;dX12&#39;][&#39;nIn&#39;])</span>
        <span class="c1"># self._dgeom[&#39;dX12&#39;][&#39;nIn&#39;] = nIn</span>
        <span class="c1"># self._dgeom[&#39;dX12&#39;][&#39;e2&#39;] = e2</span>
        <span class="c1"># else:</span>
        <span class="c1"># nIn = (np.cos(val)*self._dgeom[&#39;dX12&#39;][&#39;nIn&#39;]</span>
        <span class="c1"># + np.sin(val)*self._dgeom[&#39;dX12&#39;][&#39;e1&#39;])</span>
        <span class="c1"># e1 = (np.cos(val)*self._dgeom[&#39;dX12&#39;][&#39;e1&#39;]</span>
        <span class="c1"># - np.sin(val)*self._dgeom[&#39;dX12&#39;][&#39;nIn&#39;])</span>
        <span class="c1"># self._dgeom[&#39;dX12&#39;][&#39;nIn&#39;] = nIn</span>
        <span class="c1"># self._dgeom[&#39;dX12&#39;][&#39;e1&#39;] = e1</span>
        <span class="c1"># if key == &#39;F&#39;:</span>
        <span class="c1"># self._dgeom[&#39;F&#39;] += val</span>

<div class="viewcode-block" id="Rays._get_x12_fromflat"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_x12_fromflat">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_x12_fromflat</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">X12</span><span class="p">):</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x2</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span> <span class="o">!=</span> <span class="n">X12</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">X12</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">100.0</span>
            <span class="n">tolmag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tol</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="o">-</span><span class="n">tolmag</span><span class="p">))</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="o">-</span><span class="n">tolmag</span><span class="p">))</span>
            <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">ind1u</span><span class="p">,</span> <span class="n">ind2u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind2</span><span class="p">)</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind1</span> <span class="o">==</span> <span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind1u</span><span class="p">])</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind2</span> <span class="o">==</span> <span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ind2u</span><span class="p">])</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x2</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span> <span class="o">!=</span> <span class="n">X12</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The provided X12 array does not seem to correspond to&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;a n1 x n2 2D matrix, even within tolerance</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  n1*n2 = </span><span class="si">%s</span><span class="s2"> x </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">n1</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">n2</span><span class="p">),</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  X12.shape = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">X12</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">ind1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">X12</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">indr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_get_ind12r_n12</span><span class="p">(</span>
            <span class="n">ind1</span><span class="o">=</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="o">=</span><span class="n">ind2</span><span class="p">,</span> <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">indr</span></div>

<div class="viewcode-block" id="Rays._complete_dX12"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._complete_dX12">[docs]</a>    <span class="k">def</span> <span class="nf">_complete_dX12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dgeom</span><span class="p">):</span>

        <span class="c1"># Test if unique starting point</span>
        <span class="k">if</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]:</span>
            <span class="c1"># Test if pinhole</span>
            <span class="k">if</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;nRays&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;pinhole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;case&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sca2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sca2</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.e-9</span><span class="p">):</span>
                    <span class="n">DDb</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">DDb</span><span class="o">*</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sca2</span><span class="p">)</span><span class="o">*</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">:]),</span>
                               <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">sca2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-3</span><span class="p">,</span>
                                                <span class="n">rtol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">):</span>
                        <span class="n">pinhole</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
                        <span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;pinhole&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pinhole</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">])):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Some LOS have nan as starting point !</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;The geometry may not be provided !&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Test if all D are on a common plane or line</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># critetrion of unique D</span>
            <span class="n">crit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">va</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">crit</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-9</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;2D camera but dgeom cannot be obtained !</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  crit = </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">crit</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  dgeom = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dgeom</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">dgeom</span>

            <span class="c1"># To avoid ||v0|| = 0</span>
            <span class="k">if</span> <span class="n">crit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0e-12</span><span class="p">:</span>
                <span class="c1"># Take first one by default to ensure square grid for CamLOS2D</span>
                <span class="n">ind0</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">crit</span><span class="p">)</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">va</span><span class="p">[:,</span> <span class="n">ind0</span><span class="p">]</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
            <span class="n">indok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">crit</span> <span class="o">&gt;</span> <span class="mf">1.0e-12</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">van</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">va</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">van</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="n">va</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">]</span> <span class="o">/</span> <span class="n">crit</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">indok</span><span class="p">]</span>
            <span class="n">vect2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">van</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">van</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">van</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">van</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v0</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">van</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">van</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">v0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="c1"># Don&#39;t forget that vect2[0] is nan</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">vect2</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0e-9</span><span class="p">):</span>
                <span class="c1"># All D are aligned</span>
                <span class="n">e1</span> <span class="o">=</span> <span class="n">v0</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">va</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">kref</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">e1</span><span class="p">)</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">-</span> <span class="n">kref</span>
                <span class="c1"># l1 = np.nanmax(x1) - np.nanmin(x1)</span>
                <span class="k">if</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;e1&quot;</span><span class="p">:</span> <span class="n">e1</span><span class="p">,</span> <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span> <span class="s2">&quot;n1&quot;</span><span class="p">:</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">})</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">vect2</span><span class="p">)</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">van</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span>
                <span class="n">nn</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
                <span class="n">scaabs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nn</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">va</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">scaabs</span> <span class="o">&lt;</span> <span class="mf">1.0e-9</span><span class="p">):</span>
                    <span class="c1"># All D are in a common plane, but not aligned</span>
                    <span class="c1"># check nIn orientation</span>
                    <span class="n">sca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">*</span> <span class="n">nn</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sca</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">sca</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)]</span>

                    <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
                    <span class="n">nIn</span> <span class="o">=</span> <span class="n">nn</span> <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="o">-</span><span class="n">nn</span>
                    <span class="n">e1</span> <span class="o">=</span> <span class="n">v0</span>
                    <span class="n">e2</span> <span class="o">=</span> <span class="n">v1</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">nIn</span><span class="p">)</span> <span class="o">*</span> <span class="n">e2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">e2</span> <span class="o">=</span> <span class="o">-</span><span class="n">e2</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="c1"># Try to set e2 closer to ez if possible</span>
                        <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="o">-</span><span class="n">e2</span><span class="p">,</span> <span class="n">e1</span>

                    <span class="k">if</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;nIn&quot;</span><span class="p">:</span> <span class="n">nIn</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">:</span> <span class="n">e1</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">:</span> <span class="n">e2</span><span class="p">})</span>

                    <span class="c1"># Test binning</span>
                    <span class="k">if</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">k1ref</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">e1</span>
                        <span class="p">)</span>
                        <span class="n">k2ref</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">e2</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">k1ref</span><span class="p">,</span> <span class="n">k2ref</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                    <span class="n">x12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">va</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">k1ref</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">va</span> <span class="o">*</span> <span class="n">e2</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">k2ref</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">out_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_x12_fromflat</span><span class="p">(</span><span class="n">x12</span><span class="p">)</span>
                        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">indr</span> <span class="o">=</span> <span class="n">out_loc</span>
                        <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">x1</span><span class="p">,</span>
                                <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">x2</span><span class="p">,</span>
                                <span class="s2">&quot;n1&quot;</span><span class="p">:</span> <span class="n">n1</span><span class="p">,</span>
                                <span class="s2">&quot;n2&quot;</span><span class="p">:</span> <span class="n">n2</span><span class="p">,</span>
                                <span class="s2">&quot;ind1&quot;</span><span class="p">:</span> <span class="n">ind1</span><span class="p">,</span>
                                <span class="s2">&quot;ind2&quot;</span><span class="p">:</span> <span class="n">ind2</span><span class="p">,</span>
                                <span class="s2">&quot;indr&quot;</span><span class="p">:</span> <span class="n">indr</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
                        <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;isImage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  nIn = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">nIn</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  e1 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  e2 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  k1ref, k2ref = </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">k1ref</span><span class="p">),</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">k2ref</span><span class="p">),</span>
                        <span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  va = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">va</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  x12 = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">x12</span><span class="p">)</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">]:</span>
                <span class="c1"># Get unit vectors from angles</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not implemented yet, angles will be available for 1.4.1&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Get D and x12 from x1, x2</span>
            <span class="n">x12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;x1&quot;</span><span class="p">][</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;ind1&quot;</span><span class="p">]],</span>
                    <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;x2&quot;</span><span class="p">][</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;ind2&quot;</span><span class="p">]],</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;F&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;nIn&quot;</span><span class="p">]</span>
            <span class="n">D</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">D</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">x12</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;e1&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">x12</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">][</span><span class="s2">&quot;e2&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span>
        <span class="k">return</span> <span class="n">dgeom</span></div>

<div class="viewcode-block" id="Rays._prepare_inputs_kInOut"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._prepare_inputs_kInOut">[docs]</a>    <span class="k">def</span> <span class="nf">_prepare_inputs_kInOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indStruct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Prepare input: D, u</span>
        <span class="k">if</span> <span class="n">D</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">D</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Get reference: lS</span>
        <span class="k">if</span> <span class="n">indStruct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indIn</span><span class="p">,</span> <span class="n">indOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_indStruct_computeInOut</span><span class="p">(</span><span class="n">unique_In</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">indStruct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">indIn</span><span class="p">,</span> <span class="n">indOut</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indIn</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">indStruct</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indIn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;Surf&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">indIn</span>
                <span class="p">])</span>
                <span class="n">indStruct</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">indStruct</span>
                             <span class="k">if</span> <span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indIn</span> <span class="ow">or</span> <span class="n">ii</span> <span class="o">==</span> <span class="n">ind</span><span class="p">]</span>
                <span class="n">indIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">indIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span>
            <span class="n">indOut</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">indStruct</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indIn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;self.config must have at least a StructIn subclass !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">[</span><span class="n">indIn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">VPoly</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">Poly_closed</span>
        <span class="n">VVIn</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;VIn&quot;</span><span class="p">]</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">VPoly</span><span class="p">,</span> <span class="n">VVIn</span><span class="p">]</span>

        <span class="n">lS</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">indOut</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span><span class="p">:</span>

            <span class="n">Lim</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">Lim</span>
            <span class="n">nLim</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">noccur</span>
            <span class="n">VType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>

            <span class="n">lSPoly</span><span class="p">,</span> <span class="n">lSVIn</span><span class="p">,</span> <span class="n">lSLim</span><span class="p">,</span> <span class="n">lSnLim</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">:</span>
                <span class="n">lSPoly</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">)</span>
                <span class="n">lSVIn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;VIn&quot;</span><span class="p">])</span>
                <span class="n">lSLim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Lim</span><span class="p">)</span>
                <span class="n">lSnLim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">noccur</span><span class="p">)</span>
            <span class="n">dkwd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span>
                <span class="n">nLim</span><span class="o">=</span><span class="n">nLim</span><span class="p">,</span>
                <span class="n">LSPoly</span><span class="o">=</span><span class="n">lSPoly</span><span class="p">,</span>
                <span class="n">LSLim</span><span class="o">=</span><span class="n">lSLim</span><span class="p">,</span>
                <span class="n">lSnLim</span><span class="o">=</span><span class="n">lSnLim</span><span class="p">,</span>
                <span class="n">LSVIn</span><span class="o">=</span><span class="n">lSVIn</span><span class="p">,</span>
                <span class="n">VType</span><span class="o">=</span><span class="n">VType</span><span class="p">,</span>
                <span class="n">RMin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">Forbid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">EpsUz</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">,</span>
                <span class="n">EpsVz</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
                <span class="n">EpsA</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
                <span class="n">EpsB</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
                <span class="n">EpsPlane</span><span class="o">=</span><span class="mf">1.0e-9</span><span class="p">,</span>
                <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;optimized&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">Lim</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">S</span><span class="o">.</span><span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">S</span><span class="o">.</span><span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Lim</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">Lim</span>
            <span class="n">nLim</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">noccur</span>
            <span class="n">VType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>

            <span class="n">lSPolyx</span><span class="p">,</span> <span class="n">lSVInx</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">lSPolyy</span><span class="p">,</span> <span class="n">lSVIny</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">lSLim</span><span class="p">,</span> <span class="n">lSnLim</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="n">lsnvert</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">num_tot_structs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">num_lim_structs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lS</span><span class="p">:</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">[</span><span class="n">lSPolyx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">lp</span><span class="p">]</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">[</span><span class="n">lSPolyy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">lp</span><span class="p">]</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;VIn&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">[</span><span class="n">lSVInx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">lp</span><span class="p">]</span>
                <span class="n">lp</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s2">&quot;VIn&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">[</span><span class="n">lSVIny</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">lp</span><span class="p">]</span>
                <span class="n">lSLim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Lim</span><span class="p">)</span>
                <span class="n">lSnLim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">noccur</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lsnvert</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lsnvert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lsnvert</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Poly_closed</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">lsnvert</span><span class="p">[</span><span class="n">num_lim_structs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="n">num_lim_structs</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">Lim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Lim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">num_tot_structs</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_tot_structs</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">Lim</span><span class="p">)</span>

            <span class="n">lsnvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lsnvert</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">lSPolyx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lSPolyx</span><span class="p">)</span>
            <span class="n">lSPolyy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lSPolyy</span><span class="p">)</span>
            <span class="n">lSVInx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lSVInx</span><span class="p">)</span>
            <span class="n">lSVIny</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lSVIny</span><span class="p">)</span>

            <span class="n">dkwd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ves_lims</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span>
                        <span class="n">nstruct_tot</span><span class="o">=</span><span class="n">num_tot_structs</span><span class="p">,</span>
                        <span class="n">nstruct_lim</span><span class="o">=</span><span class="n">num_lim_structs</span><span class="p">,</span>
                        <span class="n">lstruct_polyx</span><span class="o">=</span><span class="n">lSPolyx</span><span class="p">,</span>
                        <span class="n">lstruct_polyy</span><span class="o">=</span><span class="n">lSPolyy</span><span class="p">,</span>
                        <span class="n">lstruct_lims</span><span class="o">=</span><span class="n">lSLim</span><span class="p">,</span>
                        <span class="n">lstruct_nlim</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lSnLim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                        <span class="n">lstruct_normx</span><span class="o">=</span><span class="n">lSVInx</span><span class="p">,</span>
                        <span class="n">lstruct_normy</span><span class="o">=</span><span class="n">lSVIny</span><span class="p">,</span>
                        <span class="n">lnvert</span><span class="o">=</span><span class="n">lsnvert</span><span class="p">,</span>
                        <span class="n">ves_type</span><span class="o">=</span><span class="n">VType</span><span class="p">,</span>
                        <span class="n">rmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">forbid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps_uz</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">,</span> <span class="n">eps_vz</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">,</span>
                        <span class="n">eps_a</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">,</span> <span class="n">eps_b</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">,</span> <span class="n">eps_plane</span><span class="o">=</span><span class="mf">1.e-9</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">indStruct</span><span class="p">,</span> <span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span></div>

<div class="viewcode-block" id="Rays._compute_kInOut"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._compute_kInOut">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_kInOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">largs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dkwd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indStruct</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Prepare inputs</span>
        <span class="k">if</span> <span class="n">largs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indStruct</span><span class="p">,</span> <span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs_kInOut</span><span class="p">(</span>
                <span class="n">indStruct</span><span class="o">=</span><span class="n">indStruct</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">dkwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">indStruct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span><span class="p">:</span>
            <span class="c1"># call the dedicated function</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">SLOW_LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="o">*</span><span class="n">largs</span><span class="p">,</span> <span class="o">**</span><span class="n">dkwd</span><span class="p">)</span>
            <span class="c1"># Currently computes and returns too many things</span>
            <span class="n">PIn</span><span class="p">,</span> <span class="n">POut</span><span class="p">,</span> <span class="n">kIn</span><span class="p">,</span> <span class="n">kOut</span><span class="p">,</span> <span class="n">VperpIn</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">IIn</span><span class="p">,</span> <span class="n">indout</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;optimized&quot;</span><span class="p">:</span>
            <span class="c1"># call the dedicated function</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="o">*</span><span class="n">largs</span><span class="p">,</span> <span class="o">**</span><span class="n">dkwd</span><span class="p">)</span>
            <span class="c1"># Currently computes and returns too many things</span>
            <span class="n">kIn</span><span class="p">,</span> <span class="n">kOut</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">indout</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Make sure indices refer to lStruct</span>
        <span class="n">indout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">indStruct</span><span class="p">[</span><span class="n">indout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]]</span>
        <span class="k">return</span> <span class="n">kIn</span><span class="p">,</span> <span class="n">kOut</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">indout</span><span class="p">,</span> <span class="n">indStruct</span></div>

<div class="viewcode-block" id="Rays.compute_dgeom"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.compute_dgeom">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_debug_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute dictionnary of geometrical attributes (dgeom)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_debug_plot:    bool</span>
<span class="sd">            In case some lines of sight have no visibility inside the tokamak,</span>
<span class="sd">            they will be considered invalid. tofu will issue a warning with</span>
<span class="sd">            their indices and if show_debug_plot is True, try to plot a 3d</span>
<span class="sd">            figure to help understand why these los have no visibility</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Can only be computed if config if provided</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Attribute dgeom cannot be computed without a config!&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># dX12</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete_dX12</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">)</span>

        <span class="c1"># Perform computation of kIn and kOut</span>
        <span class="n">kIn</span><span class="p">,</span> <span class="n">kOut</span><span class="p">,</span> <span class="n">vperp</span><span class="p">,</span> <span class="n">indout</span><span class="p">,</span> <span class="n">indStruct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kInOut</span><span class="p">()</span>

        <span class="c1"># Check for LOS that have no visibility inside the plasma domain (nan)</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kIn</span><span class="p">)</span>
        <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kOut</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">kOut</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Some LOS have no visibility inside the plasma domain!</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;Nb. of LOS concerned: </span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                                                              <span class="n">kOut</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;Indices of LOS ok:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="nb">repr</span><span class="p">((</span><span class="o">~</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Indices of LOS with no visibility:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">show_debug_plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">PIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">kIn</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
                <span class="n">POut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="n">kOut</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
                <span class="n">msg2</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">D = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">])</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">u = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">])</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">PIn = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">PIn</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">POut = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">POut</span><span class="p">))</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
                <span class="c1"># plot 3d debug figure</span>
                <span class="c1"># _plot._LOS_calc_InOutPolProj_Debug(</span>
                <span class="c1"># self.config,</span>
                <span class="c1"># self.D[:, ind],</span>
                <span class="c1"># self.u[:, ind],</span>
                <span class="c1"># PIn,</span>
                <span class="c1"># POut,</span>
                <span class="c1"># nptstot=kOut.size,</span>
                <span class="c1"># Lim=[np.pi / 4.0, 2.0 * np.pi / 4],</span>
                <span class="c1"># Nstep=50,</span>
                <span class="c1"># )</span>
            <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Handle particular cases with kIn &gt; kOut</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">kIn</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">ind</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kOut</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ind</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Update dgeom</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kIn&quot;</span><span class="p">:</span> <span class="n">kIn</span><span class="p">,</span>
            <span class="s2">&quot;kOut&quot;</span><span class="p">:</span> <span class="n">kOut</span><span class="p">,</span>
            <span class="s2">&quot;vperp&quot;</span><span class="p">:</span> <span class="n">vperp</span><span class="p">,</span>
            <span class="s2">&quot;indout&quot;</span><span class="p">:</span> <span class="n">indout</span><span class="p">,</span>
            <span class="s2">&quot;indStruct&quot;</span><span class="p">:</span> <span class="n">indStruct</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>

        <span class="c1"># Run extra computations</span>
        <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dgeom_kRMin</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dgeom_extra1</span><span class="p">()</span></div>

<div class="viewcode-block" id="Rays._compute_dgeom_kRMin"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._compute_dgeom_kRMin">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_dgeom_kRMin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get RMin if Type is Tor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="s2">&quot;Tor&quot;</span><span class="p">:</span>
            <span class="n">kRMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>
                <span class="n">_comp</span><span class="o">.</span><span class="n">LOS_PRMin</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">kOut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kOut</span><span class="p">,</span> <span class="n">Eps</span><span class="o">=</span><span class="mf">1.0e-12</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kRMin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;kRMin&quot;</span><span class="p">:</span> <span class="n">kRMin</span><span class="p">})</span></div>

<div class="viewcode-block" id="Rays._compute_dgeom_extra1"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._compute_dgeom_extra1">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_dgeom_extra1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kRMin&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">PRMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kRMin&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
            <span class="n">RMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">PRMin</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">PRMin</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PRMin</span><span class="p">,</span> <span class="n">RMin</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">PkIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kIn&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
        <span class="n">PkOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kOut&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;PkIn&quot;</span><span class="p">:</span> <span class="n">PkIn</span><span class="p">,</span> <span class="s2">&quot;PkOut&quot;</span><span class="p">:</span> <span class="n">PkOut</span><span class="p">,</span> <span class="s2">&quot;PRMin&quot;</span><span class="p">:</span> <span class="n">PRMin</span><span class="p">,</span> <span class="s2">&quot;RMin&quot;</span><span class="p">:</span> <span class="n">RMin</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._compute_dgeom_extra2D"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._compute_dgeom_extra2D">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_dgeom_extra2D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;2d&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">CD0</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">C</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">CD1</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">C</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">CD1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">CD0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">CD1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">CD0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">CD1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">CD0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">CD1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">CD0</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">CD1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">CD0</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">CD1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">CD0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">crossn2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cross</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">crossn2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0e-12</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Is </span><span class="si">%s</span><span class="s2"> really a 2D camera ? (LOS aligned?)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">cross</span> <span class="o">=</span> <span class="n">cross</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">crossn2</span><span class="p">)]</span>
        <span class="n">cross</span> <span class="o">=</span> <span class="n">cross</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cross</span><span class="p">)</span>
        <span class="n">nIn</span> <span class="o">=</span> <span class="n">cross</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cross</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="o">-</span><span class="n">cross</span>

        <span class="c1"># Find most relevant e1 (for pixels alignment), without a priori info</span>
        <span class="n">D0D</span> <span class="o">=</span> <span class="n">D</span> <span class="o">-</span> <span class="n">D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D0D</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">D</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">D</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">crossbis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">D0D</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">D0D</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">D0D</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">D0D</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">D0D</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">D0D</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="n">D0D</span> <span class="o">=</span> <span class="n">D0D</span><span class="p">[:,</span> <span class="n">crossbis</span> <span class="o">&lt;</span> <span class="n">dd</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">]</span>
        <span class="n">sca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">D0D</span> <span class="o">*</span> <span class="n">e1</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">D0D</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sca</span><span class="p">))]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tofu.geom.utils</span> <span class="k">as</span> <span class="nn">geom_utils</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">geom_utils</span>

        <span class="n">nIn</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">geom_utils</span><span class="o">.</span><span class="n">get_nIne1e2</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">nIn</span><span class="o">=</span><span class="n">nIn</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nIn</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.0e-12</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">e2</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e2</span><span class="p">,</span> <span class="n">e1</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">e2</span> <span class="k">if</span> <span class="n">e2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="o">-</span><span class="n">e2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">C</span><span class="p">,</span> <span class="s2">&quot;nIn&quot;</span><span class="p">:</span> <span class="n">nIn</span><span class="p">,</span> <span class="s2">&quot;e1&quot;</span><span class="p">:</span> <span class="n">e1</span><span class="p">,</span> <span class="s2">&quot;e2&quot;</span><span class="p">:</span> <span class="n">e2</span><span class="p">})</span></div>

<div class="viewcode-block" id="Rays.set_Etendues"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.set_Etendues">[docs]</a>    <span class="k">def</span> <span class="nf">set_Etendues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dES</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Etendues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Rays.set_Surfaces"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.set_Surfaces">[docs]</a>    <span class="k">def</span> <span class="nf">set_Surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dES</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Surfaces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span></div>

<div class="viewcode-block" id="Rays._set_dgeom"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._set_dgeom">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dgeom</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dgeom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Etendues</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Surfaces</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sino_RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">dgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dgeom</span><span class="p">(</span><span class="n">dgeom</span><span class="o">=</span><span class="n">dgeom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dgeom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_dgeom</span><span class="p">(</span><span class="n">extra</span><span class="o">=</span><span class="n">extra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Etendues</span><span class="p">(</span><span class="n">Etendues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_Surfaces</span><span class="p">(</span><span class="n">Surfaces</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sino</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dsino</span><span class="p">(</span><span class="n">sino_RefPt</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.set_dX12"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.set_dX12">[docs]</a>    <span class="k">def</span> <span class="nf">set_dX12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_dX12</span><span class="p">(</span><span class="n">dX12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dX12</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._compute_dsino_extra"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._compute_dsino_extra">[docs]</a>    <span class="k">def</span> <span class="nf">_compute_dsino_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">DR</span> <span class="o">=</span> <span class="n">R</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">DZ</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">DR</span><span class="p">,</span> <span class="n">DZ</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">DZ</span><span class="p">,</span> <span class="n">DR</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">&lt;</span> <span class="mi">0</span>
            <span class="n">p</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">theta</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">phipts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">pts</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">etheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phipts</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phipts</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">etheta</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pts&quot;</span><span class="p">:</span> <span class="n">pts</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="n">phi</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.set_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.set_dsino">[docs]</a>    <span class="k">def</span> <span class="nf">set_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RefPt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">RefPt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dsino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;RefPt&quot;</span><span class="p">:</span> <span class="n">RefPt</span><span class="p">})</span>
        <span class="n">VType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
        <span class="k">if</span> <span class="n">RefPt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_dsino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">RefPt</span><span class="p">)</span>
            <span class="n">kOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kOut&quot;</span><span class="p">])</span>
            <span class="n">kOut</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kOut</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_sino</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">RefPt</span><span class="p">,</span> <span class="n">kOut</span><span class="p">,</span> <span class="n">Mode</span><span class="o">=</span><span class="s2">&quot;LOS&quot;</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="n">VType</span>
                <span class="p">)</span>
                <span class="n">Pt</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">Theta</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">Phi</span> <span class="o">=</span> <span class="n">out</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error while computing sinogram !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dsino_extra</span><span class="p">()</span></div>

<div class="viewcode-block" id="Rays._set_dOptics"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._set_dOptics">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dOptics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lOptics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lOptics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_dOptics</span><span class="p">(</span><span class="n">lOptics</span><span class="o">=</span><span class="n">lOptics</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dlObj</span><span class="p">(</span><span class="n">lOptics</span><span class="p">,</span> <span class="n">din</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dOptics</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.set_dchans"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.set_dchans">[docs]</a>    <span class="k">def</span> <span class="nf">set_dchans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dchans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dchans</span><span class="p">(</span><span class="n">dchans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span> <span class="o">=</span> <span class="n">dchans</span></div>

<div class="viewcode-block" id="Rays._set_color"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._set_color">[docs]</a>    <span class="k">def</span> <span class="nf">_set_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dmisc</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;cross&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;hor&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dplot</span><span class="p">[</span><span class="s2">&quot;3d&quot;</span><span class="p">][</span><span class="s2">&quot;dP&quot;</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span></div>

<div class="viewcode-block" id="Rays._set_dmisc"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._set_dmisc">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dmisc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_color</span><span class="p">(</span><span class="n">color</span><span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Reflections</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays.get_reflections_as_cam"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.get_reflections_as_cam">[docs]</a>    <span class="k">def</span> <span class="nf">get_reflections_as_cam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a camera made of reflected LOS</span>

<span class="sd">        Reflected LOS can be of 3 types:</span>
<span class="sd">            - &#39;speculiar&#39;:  standard mirror-like reflection</span>
<span class="sd">            - &#39;diffusive&#39;:  random reflection</span>
<span class="sd">            - &#39;ccube&#39;:      corner-cube reflection (ray goes back its way)</span>

<span class="sd">        As opposed to self.add_reflections(), the reflected rays are</span>
<span class="sd">        return as an independent camera (CamLOS1D)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">nb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nb</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">Name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span> <span class="s2">&quot;_Reflect</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">Type</span><span class="p">)</span>
        <span class="n">clas</span> <span class="o">=</span> <span class="n">Rays</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="n">Rays</span> <span class="k">else</span> <span class="n">CamLOS1D</span>

        <span class="c1"># Run first iteration</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kOut&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">1.0e-12</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
        <span class="n">us</span><span class="p">,</span> <span class="n">Types</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_reflect_geom</span><span class="p">(</span>
            <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span>
            <span class="n">vperp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;vperp&quot;</span><span class="p">],</span>
            <span class="n">indout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;indout&quot;</span><span class="p">],</span>
            <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">lcam</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">clas</span><span class="p">(</span>
                <span class="n">dgeom</span><span class="o">=</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">),</span>
                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
                <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span>
                <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">nb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lcam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Types</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

        <span class="n">indStruct</span><span class="p">,</span> <span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs_kInOut</span><span class="p">(</span>
            <span class="n">D</span><span class="o">=</span><span class="n">Ds</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">us</span><span class="p">,</span> <span class="n">indStruct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;indStruct&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">outi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kInOut</span><span class="p">(</span>
            <span class="n">largs</span><span class="o">=</span><span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span><span class="o">=</span><span class="n">dkwd</span><span class="p">,</span> <span class="n">indStruct</span><span class="o">=</span><span class="n">indStruct</span>
        <span class="p">)</span>
        <span class="n">kouts</span><span class="p">,</span> <span class="n">vperps</span><span class="p">,</span> <span class="n">indouts</span> <span class="o">=</span> <span class="n">outi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Run other iterations</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span><span class="p">):</span>
            <span class="n">Ds</span> <span class="o">=</span> <span class="n">Ds</span> <span class="o">+</span> <span class="p">(</span><span class="n">kouts</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">1.0e-12</span><span class="p">)</span> <span class="o">*</span> <span class="n">us</span>
            <span class="n">us</span><span class="p">,</span> <span class="n">Types</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_reflect_geom</span><span class="p">(</span>
                <span class="n">u</span><span class="o">=</span><span class="n">us</span><span class="p">,</span> <span class="n">vperp</span><span class="o">=</span><span class="n">vperps</span><span class="p">,</span> <span class="n">indout</span><span class="o">=</span><span class="n">indouts</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span>
            <span class="p">)</span>
            <span class="n">outi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kInOut</span><span class="p">(</span>
                <span class="n">largs</span><span class="o">=</span><span class="p">[</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">largs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">largs</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                <span class="n">dkwd</span><span class="o">=</span><span class="n">dkwd</span><span class="p">,</span>
                <span class="n">indStruct</span><span class="o">=</span><span class="n">indStruct</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">kouts</span><span class="p">,</span> <span class="n">vperps</span><span class="p">,</span> <span class="n">indouts</span> <span class="o">=</span> <span class="n">outi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lcam</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">clas</span><span class="p">(</span>
                    <span class="n">dgeom</span><span class="o">=</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">),</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
                    <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span>
                    <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span>
                    <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">lcam</span><span class="p">,</span> <span class="n">Types</span></div>

<div class="viewcode-block" id="Rays.add_reflections"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.add_reflections">[docs]</a>    <span class="k">def</span> <span class="nf">add_reflections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add relfected LOS to the camera</span>

<span class="sd">        Reflected LOS can be of 3 types:</span>
<span class="sd">            - &#39;speculiar&#39;:  standard mirror-like reflection</span>
<span class="sd">            - &#39;diffusive&#39;:  random reflection</span>
<span class="sd">            - &#39;ccube&#39;:      corner-cube reflection (ray goes back its way)</span>

<span class="sd">        As opposed to self.get_reflections_as_cam(), the reflected rays are</span>
<span class="sd">        stored in the camera object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">nb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nb</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">nb</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Prepare output</span>
        <span class="n">nRays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nRays</span><span class="p">,</span> <span class="n">nb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nRays</span><span class="p">,</span> <span class="n">nb</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nRays</span><span class="p">,</span> <span class="n">nb</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">kouts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nRays</span><span class="p">,</span> <span class="n">nb</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">indouts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nRays</span><span class="p">,</span> <span class="n">nb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">vperps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">nRays</span><span class="p">,</span> <span class="n">nb</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Run first iteration</span>
        <span class="n">Ds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kOut&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mf">1.0e-12</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
        <span class="p">)</span>
        <span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">Types</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_reflect_geom</span><span class="p">(</span>
            <span class="n">u</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span>
            <span class="n">vperp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;vperp&quot;</span><span class="p">],</span>
            <span class="n">indout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;indout&quot;</span><span class="p">],</span>
            <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">indStruct</span><span class="p">,</span> <span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_inputs_kInOut</span><span class="p">(</span>
            <span class="n">D</span><span class="o">=</span><span class="n">Ds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="o">=</span><span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">indStruct</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;indStruct&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">outi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kInOut</span><span class="p">(</span>
            <span class="n">largs</span><span class="o">=</span><span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span><span class="o">=</span><span class="n">dkwd</span><span class="p">,</span> <span class="n">indStruct</span><span class="o">=</span><span class="n">indStruct</span>
        <span class="p">)</span>
        <span class="n">kouts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vperps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">indouts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">outi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Run other iterations</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span><span class="p">):</span>
            <span class="n">Dsi</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Ds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">(</span><span class="n">kouts</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0e-12</span><span class="p">)</span> <span class="o">*</span> <span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">usi</span><span class="p">,</span> <span class="n">Types</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">_reflect_geom</span><span class="p">(</span>
                <span class="n">u</span><span class="o">=</span><span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">vperp</span><span class="o">=</span><span class="n">vperps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">indout</span><span class="o">=</span><span class="n">indouts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">outi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_kInOut</span><span class="p">(</span>
                <span class="n">largs</span><span class="o">=</span><span class="p">[</span><span class="n">Dsi</span><span class="p">,</span> <span class="n">usi</span><span class="p">,</span> <span class="n">largs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">largs</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span>
                <span class="n">dkwd</span><span class="o">=</span><span class="n">dkwd</span><span class="p">,</span>
                <span class="n">indStruct</span><span class="o">=</span><span class="n">indStruct</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">kouts</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">vperps</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">indouts</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">outi</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Ds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dsi</span><span class="p">,</span> <span class="n">usi</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nb&quot;</span><span class="p">:</span> <span class="n">nb</span><span class="p">,</span>
            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
            <span class="s2">&quot;Types&quot;</span><span class="p">:</span> <span class="n">Types</span><span class="p">,</span>
            <span class="s2">&quot;Ds&quot;</span><span class="p">:</span> <span class="n">Ds</span><span class="p">,</span>
            <span class="s2">&quot;us&quot;</span><span class="p">:</span> <span class="n">us</span><span class="p">,</span>
            <span class="s2">&quot;kouts&quot;</span><span class="p">:</span> <span class="n">kouts</span><span class="p">,</span>
            <span class="s2">&quot;indouts&quot;</span><span class="p">:</span> <span class="n">indouts</span><span class="p">,</span>
        <span class="p">}</span></div>

    <span class="c1">###########</span>
    <span class="c1"># strip dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays._strip_dgeom"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._strip_dgeom">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">strip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">strip</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]:</span>
            <span class="c1"># Reload</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dgeom_extra1</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dgeom_kRMin</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dgeom_kRMin</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dgeom_extra1</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># strip</span>
            <span class="k">if</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lkeep</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;D&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;u&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pinhole&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;nRays&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;kIn&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;kOut&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;vperp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;indout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;indStruct&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;kRMin&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Etendues&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Surfaces&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;isImage&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dX12&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dreflect&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;move&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;move_param&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;move_kwdargs&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">strip</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">lkeep</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;D&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;u&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pinhole&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;nRays&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;kIn&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;kOut&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;vperp&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;indout&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;indStruct&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Etendues&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Surfaces&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;isImage&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dX12&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;dreflect&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;move&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;move_param&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;move_kwdargs&quot;</span><span class="p">,</span>
                <span class="p">]</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._strip_dconfig"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._strip_dconfig">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">strip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">strip</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">pfe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    type(pfe) = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">pfe</span><span class="p">)))</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    self._dstrip[&#39;strip&#39;] = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    strip = </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strip</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strip</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span>
                <span class="c1"># --- Check !</span>
                <span class="n">lf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lf</span> <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">ff</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;.npz&quot;</span><span class="p">]])</span>
                <span class="p">]</span>
                <span class="n">exist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="c1"># ----------</span>
                <span class="n">pathfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.npz&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;BEWARE:</span>
<span class="s2">                        You are about to delete the Config object</span>
<span class="s2">                        Only the path/name to saved a object will be kept</span>

<span class="s2">                        But it appears that the following object has no</span>
<span class="s2">                        saved file where specified (obj.Id.SavePath)</span>
<span class="s2">                        Thus it won&#39;t be possible to retrieve it</span>
<span class="s2">                        (unless available in the current console:&quot;&quot;&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pathfile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathfile</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._strip_dsino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._strip_dsino">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">strip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">strip</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">strip</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dsino_extra</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;strip&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Rays._strip_dmisc"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._strip_dmisc">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dmisc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]):</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="o">.</span><span class="n">_strip_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">,</span> <span class="n">lkeep</span><span class="o">=</span><span class="n">lkeep</span><span class="p">)</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _strip and get/from dict</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays._strip_init"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._strip_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s2">&quot;allowed&quot;</span><span class="p">])</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 1: dgeom w/o pts + config.strip(1)</span>
<span class="s2">                 2: dgeom w/o pts + config.strip(2) + dsino empty</span>
<span class="s2">                 3: dgeom w/o pts + config.strip(3) + dsino empty</span>
<span class="s2">                 4: dgeom w/o pts + config=pathfile + dsino empty</span>
<span class="s2">                 &quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">nMax</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="Rays.strip"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Rays</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._strip"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._strip">[docs]</a>    <span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dconfig</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dgeom</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dsino</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._to_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;dconfig&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dgeom&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dchans&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dchans</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
            <span class="s2">&quot;dsino&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="n">dout</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="p">,</span> <span class="s2">&quot;lexcept&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="Rays._checkformat_fromdict_dconfig"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._checkformat_fromdict_dconfig">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_fromdict_dconfig</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dconfig</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">fromdict</span><span class="o">=</span><span class="n">dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">])</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">],</span> <span class="n">Config</span><span class="p">),</span>
            <span class="nb">type</span><span class="p">(</span><span class="n">dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._from_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_fromdict_dconfig</span><span class="p">(</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dconfig&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dconfig&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dgeom&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dsino&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;dchans&quot;</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dchans&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">])</span></div>


    <span class="c1">###########</span>
    <span class="c1"># properties</span>
    <span class="c1">###########</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dchans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dsino</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lOptics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dOptics</span><span class="p">[</span><span class="s1">&#39;dobj&#39;</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="n">k1</span><span class="p">]</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">k1</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_dOptics</span><span class="p">[</span><span class="s1">&#39;lorder&#39;</span><span class="p">])]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isPinhole</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="s2">&quot;pinhole&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">c0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isInPoloidalPlane</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phiD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">phiD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phiD</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">phiD</span> <span class="o">=</span> <span class="n">phiD</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ephi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phiD</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phiD</span><span class="p">),</span> <span class="mf">0.</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">ephi</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nRays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">]:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">D</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> \
          <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;nRays&#39;</span><span class="p">]:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPinhole</span><span class="p">:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;pinhole&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">u</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;nRays&#39;</span><span class="p">]:</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;nRays&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">u</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pinhole</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;This is not a pinhole camera =&gt; pinhole is None&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Etendues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Etendues&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Etendues&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">]:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Etendues&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Etendues&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Etendues&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Stored Etendues is not conform !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">E</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Surfaces&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Surfaces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">]:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Surfaces&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Surfaces&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;Surfaces&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;nRays&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Stored Surfaces not conform !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">S</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kIn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kIn&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kOut</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kOut&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kMin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPinhole</span><span class="p">:</span>
            <span class="n">kMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;pinhole&quot;</span><span class="p">][:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;D&quot;</span><span class="p">]</span>
            <span class="n">kMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kMin</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kMin</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">kMin</span>

<div class="viewcode-block" id="Rays._is2D"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._is2D">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_is2D</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="s2">&quot;2d&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">c0</span></div>

<div class="viewcode-block" id="Rays._isLOS"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._isLOS">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_isLOS</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="s2">&quot;los&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">c0</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Movement methods</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays._update_or_copy"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._update_or_copy">[docs]</a>    <span class="k">def</span> <span class="nf">_update_or_copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">pinhole</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">return_copy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">return_copy</span> <span class="o">=</span> <span class="n">_RETURN_COPY</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPinhole</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">dgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pinhole&#39;</span><span class="p">:</span> <span class="n">pinhole</span><span class="p">,</span>
                     <span class="s1">&#39;D&#39;</span><span class="p">:</span> <span class="n">D</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dgeom</span> <span class="o">=</span> <span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_copy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span> <span class="s1">&#39;copy&#39;</span>
            <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
            <span class="k">if</span> <span class="n">dchans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dchans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dchans</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">dgeom</span><span class="o">=</span><span class="n">dgeom</span><span class="p">,</span>
                                  <span class="n">lOptics</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lOptics</span><span class="p">,</span>
                                  <span class="n">Etendues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Etendues</span><span class="p">,</span>
                                  <span class="n">Surfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Surfaces</span><span class="p">,</span>
                                  <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                  <span class="n">sino_RefPt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s1">&#39;RefPt&#39;</span><span class="p">],</span>
                                  <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dmisc</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">],</span>
                                  <span class="n">dchans</span><span class="o">=</span><span class="n">dchans</span><span class="p">,</span>
                                  <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
                                  <span class="n">Diag</span><span class="o">=</span><span class="n">diag</span><span class="p">,</span>
                                  <span class="n">Name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                  <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                                  <span class="n">SavePath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dgeom0</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pinhole</span><span class="p">)</span>
                      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPinhole</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="n">dgeom</span><span class="o">=</span><span class="n">dgeom</span><span class="p">,</span>
                                <span class="n">Etendues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Etendues</span><span class="p">,</span>
                                <span class="n">Surfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Surfaces</span><span class="p">,</span>
                                <span class="n">sino_RefPt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s1">&#39;RefPt&#39;</span><span class="p">],</span>
                                <span class="n">extra</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="c1"># Make sure instance does not move</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="n">dgeom</span><span class="o">=</span><span class="n">dgeom0</span><span class="p">,</span>
                                <span class="n">Etendues</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Etendues</span><span class="p">,</span>
                                <span class="n">Surfaces</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Surfaces</span><span class="p">,</span>
                                <span class="n">sino_RefPt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s1">&#39;RefPt&#39;</span><span class="p">],</span>
                                <span class="n">extra</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">sino</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">An exception occured during updating</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;  =&gt; instance unmoved&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays._rotate_DPinholeu"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._rotate_DPinholeu">[docs]</a>    <span class="k">def</span> <span class="nf">_rotate_DPinholeu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="n">pinhole</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPinhole</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;pinhole&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]),</span>
                               <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pts</span><span class="o">=</span><span class="n">D</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="n">D</span><span class="p">,</span> <span class="n">pinhole</span> <span class="o">=</span> <span class="n">D</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">D</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;rotate&#39;</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="n">D</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
        <span class="k">return</span> <span class="n">D</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span> <span class="n">u</span></div>

<div class="viewcode-block" id="Rays.translate_in_cross_section"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.translate_in_cross_section">[docs]</a>    <span class="k">def</span> <span class="nf">translate_in_cross_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direction_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Translate the instance in the cross-section &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInPoloidalPlane</span><span class="p">:</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPinhole</span><span class="p">:</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;pinhole&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Instance not associated to a specific poloidal plane</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Please specify which poloidal plane (phi) to use&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_DPinholeu</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_translate_pts_poloidal_plane</span><span class="p">,</span>
            <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">,</span> <span class="n">direction_rz</span><span class="o">=</span><span class="n">direction_rz</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span>
                                    <span class="n">diag</span><span class="o">=</span><span class="n">diag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="n">dchans</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.translate_3d"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.translate_3d">[docs]</a>    <span class="k">def</span> <span class="nf">translate_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Translate the instance in provided direction &quot;&quot;&quot;</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_DPinholeu</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_translate_pts_3d</span><span class="p">,</span>
            <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span>
                                    <span class="n">diag</span><span class="o">=</span><span class="n">diag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="n">dchans</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.rotate_in_cross_section"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.rotate_in_cross_section">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_in_cross_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis_rz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Rotate the instance in the cross-section &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isInPoloidalPlane</span><span class="p">:</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isPinhole</span><span class="p">:</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;pinhole&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Camera not associated to a specific poloidal plane</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Please specify which poloidal plane (phi) to use&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_DPinholeu</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_pts_vectors_in_poloidal_plane</span><span class="p">,</span>
            <span class="n">axis_rz</span><span class="o">=</span><span class="n">axis_rz</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span>
                                    <span class="n">diag</span><span class="o">=</span><span class="n">diag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="n">dchans</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.rotate_around_torusaxis"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.rotate_around_torusaxis">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_around_torusaxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Rotate the instance around the torus axis &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="s1">&#39;Tor&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Movement only available for Tor configurations!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_DPinholeu</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_pts_vectors_around_torusaxis</span><span class="p">,</span>
            <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span>
                                    <span class="n">diag</span><span class="o">=</span><span class="n">diag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="n">dchans</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.rotate_around_3daxis"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.rotate_around_3daxis">[docs]</a>    <span class="k">def</span> <span class="nf">rotate_around_3daxis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">return_copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Rotate the instance around the provided 3d axis &quot;&quot;&quot;</span>
        <span class="n">D</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_DPinholeu</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rotate_pts_vectors_around_3daxis</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_or_copy</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">pinhole</span><span class="p">,</span>
                                    <span class="n">return_copy</span><span class="o">=</span><span class="n">return_copy</span><span class="p">,</span>
                                    <span class="n">diag</span><span class="o">=</span><span class="n">diag</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="n">dchans</span><span class="p">)</span></div>

<div class="viewcode-block" id="Rays.set_move"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.set_move">[docs]</a>    <span class="k">def</span> <span class="nf">set_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">move</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the default movement parameters</span>

<span class="sd">        A default movement can be set for the instance, it can be any of the</span>
<span class="sd">        pre-implemented movement (rotations or translations)</span>
<span class="sd">        This default movement is the one that will be called when using</span>
<span class="sd">        self.move()</span>

<span class="sd">        Specify the type of movement via the name of the method (passed as a</span>
<span class="sd">        str to move)</span>

<span class="sd">        Specify, for the geometry of the instance at the time of defining this</span>
<span class="sd">        default movement, the current value of the associated movement</span>
<span class="sd">        parameter (angle / distance). This is used to set an arbitrary</span>
<span class="sd">        difference for user who want to use absolute position values</span>
<span class="sd">        The desired incremental movement to be performed when calling self.move</span>
<span class="sd">        will be deduced by substracting the stored param value to the provided</span>
<span class="sd">        param value. Just set the current param value to 0 if you don&#39;t care</span>
<span class="sd">        about a custom absolute reference.</span>

<span class="sd">        kwdargs must be a parameters relevant to the chosen method (axis,</span>
<span class="sd">        direction...)</span>

<span class="sd">        e.g.:</span>
<span class="sd">            self.set_move(move=&#39;rotate_around_3daxis&#39;,</span>
<span class="sd">                          param=0.,</span>
<span class="sd">                          axis=([0.,0.,0.], [1.,0.,0.]))</span>
<span class="sd">            self.set_move(move=&#39;translate_3d&#39;,</span>
<span class="sd">                          param=0.,</span>
<span class="sd">                          direction=[0.,1.,0.])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">move</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">kwdargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_set_move</span><span class="p">(</span><span class="n">move</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">kwdargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_kwdargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwdargs</span></div>

<div class="viewcode-block" id="Rays.move"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set new position to desired param according to default movement</span>

<span class="sd">        Can only be used if default movement was set before</span>
<span class="sd">        See self.set_move()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_move</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">dictname</span><span class="o">=</span><span class="s1">&#39;_dgeom&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_param&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span></div>

    <span class="c1">###########</span>
    <span class="c1"># public methods</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Rays.get_indStruct_computeInOut"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.get_indStruct_computeInOut">[docs]</a>    <span class="k">def</span> <span class="nf">get_indStruct_computeInOut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_In</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The indices of structures with compute = True</span>

<span class="sd">        The indidces refer to self.config.lStruct</span>
<span class="sd">            - The first array corresponds to Struct of type In</span>
<span class="sd">            - The second array corresponds to Struct of type Out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">unique_In</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unique_In</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">compute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_compute</span><span class="p">()</span>
        <span class="n">indIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compute</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;in&quot;</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unique_In</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">indIn</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">iind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;Surf&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">indIn</span>
            <span class="p">])</span>
            <span class="n">indIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">indIn</span><span class="p">[</span><span class="n">iind</span><span class="p">]]</span>

        <span class="n">indOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compute</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">_InOut</span> <span class="o">==</span> <span class="s2">&quot;out&quot;</span>
        <span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indIn</span><span class="p">,</span> <span class="n">indOut</span></div>

<div class="viewcode-block" id="Rays._check_indch"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._check_indch">[docs]</a>    <span class="k">def</span> <span class="nf">_check_indch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ind</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                    <span class="n">indch</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indch</span> <span class="o">=</span> <span class="n">ind</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span>
                <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="n">indch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="n">indch</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indch</span> <span class="o">=</span> <span class="n">ind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
                <span class="n">indch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="n">indch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">indch</span></div>

<div class="viewcode-block" id="Rays.select"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">touch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the indices of the rays matching selection criteria</span>

<span class="sd">        The criterion can be of two types:</span>
<span class="sd">            - a key found in self.dchans, with a matching value</span>
<span class="sd">            - a touch tuple (indicating which element in self.config is touched</span>
<span class="sd">                by the desired rays)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key :    None / str</span>
<span class="sd">            A key to be found in self.dchans</span>
<span class="sd">        val :   int / str / float / list of such</span>
<span class="sd">            The value to be matched</span>
<span class="sd">            If a list of values is provided, the behaviour depends on log</span>
<span class="sd">        log :   str</span>
<span class="sd">            A flag indicating which behaviour to use when val is a list</span>
<span class="sd">                - any : Returns indices of rays matching any value in val</span>
<span class="sd">                - all : Returns indices of rays matching all values in val</span>
<span class="sd">                - not : Returns indices of rays matching None of the val</span>
<span class="sd">        touch:  None / str / int / tuple</span>
<span class="sd">            Used if key is None</span>
<span class="sd">            Tuple that can be of len()=1, 2 or 3</span>
<span class="sd">            Tuple indicating you want the rays that are touching some specific</span>
<span class="sd">            elements of self.config:</span>
<span class="sd">                - touch[0] : str / int or list of such</span>
<span class="sd">                    str : a &#39;Cls_Name&#39; string indicating the element</span>
<span class="sd">                    int : the index of the element in self.config.lStruct</span>
<span class="sd">                - touch[1] : int / list of int</span>
<span class="sd">                    Indices of the desired segments on the polygon</span>
<span class="sd">                    (i.e.: of the cross-section polygon of the above element)</span>
<span class="sd">                - touch[2] : int / list of int</span>
<span class="sd">                    Indices, if relevant, of the toroidal / linear unit</span>
<span class="sd">                    Only relevant when the element has noccur&gt;1</span>
<span class="sd">            In this case only log=&#39;not&#39; has an effect</span>
<span class="sd">        out :   str</span>
<span class="sd">            Flag indicating whether to return:</span>
<span class="sd">                - bool : a (nRays,) boolean array of indices</span>
<span class="sd">                - int :  a (N,) array of int indices (N=number of matching</span>
<span class="sd">                         rays)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ind :   np.ndarray</span>
<span class="sd">            The array of matching rays</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;not&quot;</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">touch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">ltypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
                <span class="n">C0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span>
                <span class="n">C1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span>
                <span class="k">if</span> <span class="n">C0</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="s2">&quot;any&quot;</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">log</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">touch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lint</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
                <span class="n">larr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
                <span class="n">touch</span> <span class="o">=</span> <span class="p">[</span><span class="n">touch</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="k">else</span> <span class="n">touch</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>

                <span class="k">def</span> <span class="nf">_check_touch</span><span class="p">(</span><span class="n">tt</span><span class="p">):</span>
                    <span class="n">cS</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lint</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="ow">in</span> <span class="n">larr</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                    <span class="n">c1</span> <span class="o">=</span> <span class="n">c1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lint</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tt</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">cS</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span>

                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">touch</span><span class="p">)):</span>
                    <span class="n">touch</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

                <span class="n">ntouch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">ntouch</span> <span class="o">==</span> <span class="mi">3</span>

                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntouch</span><span class="p">):</span>
                    <span class="n">cS</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">_check_touch</span><span class="p">(</span><span class="n">touch</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cS</span> <span class="ow">or</span> <span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provided touch is not valid:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">touch</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">touch</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Please provide either:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - str in the form &#39;Cls_Name&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - int (index)</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - array of int indices&quot;</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cS</span><span class="p">:</span>
                        <span class="n">k0</span><span class="p">,</span> <span class="n">k1</span> <span class="o">=</span> <span class="n">touch</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">jj</span>
                            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lS</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span> <span class="o">==</span> <span class="n">k0</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="o">==</span> <span class="n">k1</span>
                        <span class="p">]</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="n">touch</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">elif</span> <span class="n">c0</span><span class="p">:</span>
                        <span class="n">touch</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">touch</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>

                <span class="c1"># Common part</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntouch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ntouch</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">touch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">touch</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                            <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                                <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;indout&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">touch</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">],</span>
                            <span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="s2">&quot;not&quot;</span><span class="p">:</span>
                    <span class="n">ind</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">~</span><span class="n">ind</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ind</span></div>

<div class="viewcode-block" id="Rays.get_subset"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.get_subset">[docs]</a>    <span class="k">def</span> <span class="nf">get_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an instance which is a sub-set of the camera</span>

<span class="sd">        The subset is the same camera but with only the LOS selected by indch</span>
<span class="sd">        It can be assigned a new Name (str), or the same one (True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">indch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_indch</span><span class="p">(</span><span class="n">indch</span><span class="p">)</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                   <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">kk</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dId&#39;</span><span class="p">,</span> <span class="s1">&#39;dall&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">]])][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">sep</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># Name</span>
            <span class="k">assert</span> <span class="n">Name</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
            <span class="k">if</span> <span class="n">Name</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;dId&#39;</span><span class="p">,</span> <span class="s1">&#39;dall&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="n">Name</span>
            <span class="k">elif</span> <span class="n">Name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;dId&#39;</span><span class="p">,</span> <span class="s1">&#39;dall&#39;</span><span class="p">,</span> <span class="s1">&#39;Name&#39;</span><span class="p">])]</span> <span class="o">+=</span> <span class="s2">&quot;-subset&quot;</span>

            <span class="c1"># Resize all np.ndarrays</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span> <span class="ow">in</span> <span class="n">vv</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">vv</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="n">indch</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">vv</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">vv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">:</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[:,</span> <span class="n">indch</span><span class="p">]</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;dgeom&#39;</span><span class="p">,</span> <span class="s1">&#39;nRays&#39;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">dd</span><span class="p">[</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;dgeom&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Recreate from dict</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">fromdict</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="Rays._get_plotL"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._get_plotL">[docs]</a>    <span class="k">def</span> <span class="nf">_get_plotL</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">reflections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">Lplot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">proj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">return_pts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the (R,Z) coordinates of the cross-section projections &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="k">if</span> <span class="n">Lplot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Lplot</span> <span class="o">=</span> <span class="s1">&#39;tot&#39;</span>
        <span class="k">if</span> <span class="n">proj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="s1">&#39;All&#39;</span>

        <span class="c1"># Compute</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_indch</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">us</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">kOuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">Lplot</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tot&quot;</span><span class="p">:</span>
                <span class="n">Ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kIn</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">*</span> <span class="n">us</span>
                <span class="n">kOuts</span> <span class="o">=</span> <span class="n">kOuts</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">])[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">us</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">us</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># kRMin = None</span>

            <span class="c1"># Add reflections ?</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">reflections</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dreflect&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;us&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">Dsadd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;Ds&quot;</span><span class="p">][:,</span> <span class="n">ind</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">usadd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;us&quot;</span><span class="p">][:,</span> <span class="n">ind</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">kOutsadd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;kouts&quot;</span><span class="p">][</span><span class="n">ind</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Dsadd</span><span class="p">,</span> <span class="n">usadd</span> <span class="o">=</span> <span class="n">Dsadd</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">usadd</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">kOutsadd</span> <span class="o">=</span> <span class="n">kOutsadd</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">Ds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Ds</span><span class="p">,</span> <span class="n">Dsadd</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">us</span><span class="p">,</span> <span class="n">usadd</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">kOuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">kOuts</span><span class="p">,</span> <span class="n">kOutsadd</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># if self.config.Id.Type == &quot;Tor&quot;:</span>
                <span class="c1"># kRMin = _comp.LOS_PRMin(</span>
                <span class="c1"># Ds, us, kOut=kOuts, Eps=1.0e-12, squeeze=False</span>
                <span class="c1"># )</span>

                <span class="c1"># elif self.config.Id.Type == &quot;Tor&quot;:</span>
                <span class="c1"># kRMin = self._dgeom[&quot;kRMin&quot;][ind][:, None]</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">LOS_CrossProj</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span>
                <span class="n">Ds</span><span class="p">,</span>
                <span class="n">us</span><span class="p">,</span>
                <span class="n">kOuts</span><span class="p">,</span>
                <span class="n">proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span>
                <span class="n">return_pts</span><span class="o">=</span><span class="n">return_pts</span><span class="p">,</span>
                <span class="n">multi</span><span class="o">=</span><span class="n">multi</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Rays.get_sample"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.get_sample">[docs]</a>    <span class="k">def</span> <span class="nf">get_sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span>
        <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="o">=</span><span class="n">_NUM_THREADS</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a linear sampling of the LOS</span>

<span class="sd">        The LOS is sampled into a series a points and segments lengths</span>
<span class="sd">        The resolution (segments length) is &lt;= res</span>
<span class="sd">        The sampling can be done according to different methods</span>
<span class="sd">        It is possible to sample only a subset of the LOS</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        res:        float</span>
<span class="sd">            Desired resolution</span>
<span class="sd">        resMode:    str</span>
<span class="sd">            Flag indicating res should be understood as:</span>
<span class="sd">                - &#39;abs&#39;:    an absolute distance in meters</span>
<span class="sd">                - &#39;rel&#39;:    a relative distance (fraction of the LOS length)</span>
<span class="sd">        DL:         None / iterable</span>
<span class="sd">            The fraction [L1;L2] of the LOS that should be sampled, where</span>
<span class="sd">            L1 and L2 are distances from the starting point of the LOS (LOS.D)</span>
<span class="sd">            DL can be an iterable of len()==2 (identical to all los), or a</span>
<span class="sd">            (2,nlos) array</span>
<span class="sd">        method:     str</span>
<span class="sd">            Flag indicating which to use for sampling:</span>
<span class="sd">                - &#39;sum&#39;:    the LOS is sampled into N segments of equal length,</span>
<span class="sd">                            where N is the smallest int such that:</span>
<span class="sd">                                * segment length &lt;= resolution(res,resMode)</span>
<span class="sd">                            The points returned are the center of each segment</span>
<span class="sd">                - &#39;simps&#39;:  the LOS is sampled into N segments of equal length,</span>
<span class="sd">                            where N is the smallest int such that:</span>
<span class="sd">                                * segment length &lt;= resolution(res,resMode)</span>
<span class="sd">                                * N is even</span>
<span class="sd">                            The points returned are the egdes of each segment</span>
<span class="sd">                - &#39;romb&#39;:   the LOS is sampled into N segments of equal length,</span>
<span class="sd">                            where N is the smallest int such that:</span>
<span class="sd">                                * segment length &lt;= resolution(res,resMode)</span>
<span class="sd">                                * N = 2^k + 1</span>
<span class="sd">                            The points returned are the egdes of each segment</span>
<span class="sd">        ind:        None / iterable of int</span>
<span class="sd">            indices of the LOS to be sampled</span>
<span class="sd">        pts:        bool</span>
<span class="sd">            Flag indicating whether to return only the abscissa parameter k</span>
<span class="sd">            (False) or the 3D pts coordinates (True)</span>
<span class="sd">        compact:    bool</span>
<span class="sd">            Flag incating whether to retrun the sampled pts of all los in a</span>
<span class="sd">            single concatenated array (True) or splitted into</span>
<span class="sd">            a list of nlos arrays)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        k:      np.ndarray</span>
<span class="sd">            if pts == False:</span>
<span class="sd">                A (npts,) array of the abscissa parameters</span>
<span class="sd">                  (i.e.: points distances from the LOS starting points)</span>
<span class="sd">                In order to get the 3D cartesian coordinates of pts do:</span>
<span class="sd">            if pts == True:</span>
<span class="sd">                A (3,npts) array of the sampled points 3D cartesian coordinates</span>
<span class="sd">        reseff: np.ndarray</span>
<span class="sd">            A (nlos,) array of the effective resolution (&lt;= res input), as an</span>
<span class="sd">            absolute distance</span>
<span class="sd">        ind:    np.ndarray</span>
<span class="sd">            A (nlos-1,) array of integere indices (where to split k to separate</span>
<span class="sd">            the points of each los). e.g.: lk = np.split(k,ind)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_RES</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_indch</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="c1"># preload k</span>
        <span class="n">kIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kIn</span>
        <span class="n">kOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kOut</span>

        <span class="c1"># Preformat DL</span>
        <span class="k">if</span> <span class="n">DL</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">DL</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">DL</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span> <span class="s2">&quot;Arg DL has wrong shape !&quot;</span>

        <span class="c1"># Check consistency of limits</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ii</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ii</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ii</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>

        <span class="c1"># Preformat Ds, us</span>
        <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">Ds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">us</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">Ds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">us</span><span class="p">)</span>

        <span class="c1"># Launch    # NB : find a way to exclude cases with DL[0,:]&gt;=DL[1,:] !!</span>
        <span class="c1"># Todo : reverse in _GG : make compact default for faster computation !</span>
        <span class="n">nlos</span> <span class="o">=</span> <span class="n">Ds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">lind</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_get_sample</span><span class="p">(</span>
            <span class="n">nlos</span><span class="p">,</span>
            <span class="n">res</span><span class="p">,</span>
            <span class="n">DL</span><span class="p">,</span>
            <span class="n">dmethod</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">pts</span><span class="p">:</span>
            <span class="n">nbrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">lind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lind</span><span class="p">),</span> <span class="n">k</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">lind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Ds</span><span class="p">,</span> <span class="n">nbrep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">us</span><span class="p">,</span> <span class="n">nbrep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">compact</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">lind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">lind</span></div>

<div class="viewcode-block" id="Rays._kInOut_Isoflux_inputs"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._kInOut_Isoflux_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">_kInOut_Isoflux_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;ref&quot;</span><span class="p">:</span>
            <span class="n">D</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
            <span class="n">Lim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Lim</span>
            <span class="n">nLim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nLim</span>
            <span class="n">Type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>

            <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lVIn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">dkwd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span> <span class="n">nLim</span><span class="o">=</span><span class="n">nLim</span><span class="p">,</span> <span class="n">VType</span><span class="o">=</span><span class="n">Type</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;optimized&quot;</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Lim</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Lim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Lim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">Lim</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># in case self.config.Lim = [[L0, L1]]</span>
                    <span class="n">Lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">Lim</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">nLim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nLim</span>
            <span class="n">Type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Type</span>
            <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lVIn</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">dkwd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ves_lims</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span> <span class="n">ves_type</span><span class="o">=</span><span class="n">Type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># To be adjusted later</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span></div>

<div class="viewcode-block" id="Rays._kInOut_Isoflux_inputs_usr"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._kInOut_Isoflux_inputs_usr">[docs]</a>    <span class="k">def</span> <span class="nf">_kInOut_Isoflux_inputs_usr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">lPoly</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span>

        <span class="c1"># Check lPoly</span>
        <span class="k">if</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">lPoly</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">lPoly</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">lPoly</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">lPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">lPoly</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lPoly</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">lPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">lPoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lPoly</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">lPoly</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">lPoly</span><span class="p">]</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">pp</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">pp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">lPoly</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg lPoly must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - a (2,N) np.ndarray (signle polygon of N points)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - a list of M polygons, each a (2,Ni) np.ndarray</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        - where Ni is the number of pts of each polygon</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - a (M,2,N) np.ndarray where:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        - M is the number of polygons</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        - N is the (common) number of points per polygon</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">nPoly</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lPoly</span><span class="p">)</span>

        <span class="c1"># Check anti-clockwise and closed</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lPoly</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPoly</span><span class="p">):</span>
                <span class="c1"># Check closed and anti-clockwise</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span>
                    <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_GG</span><span class="o">.</span><span class="n">Poly_isClockwise</span><span class="p">(</span><span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">]):</span>
                        <span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For structure &quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="s2">&quot; : &quot;</span><span class="p">,</span> <span class="n">excp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check closed and anti-clockwise</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">lPoly</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">lPoly</span><span class="p">[:,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mf">0.</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">):</span>
                <span class="n">lPoly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">lPoly</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All poly in lPoly should be closed or all non-closed!&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nPoly</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">_GG</span><span class="o">.</span><span class="n">Poly_isClockwise</span><span class="p">(</span><span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">]):</span>
                        <span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">][:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">excp</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For structure &quot;</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="s2">&quot; : &quot;</span><span class="p">,</span> <span class="n">excp</span><span class="p">)</span>

        <span class="c1"># Check lVIn</span>
        <span class="k">if</span> <span class="n">lVIn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lVIn</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">lPoly</span><span class="p">:</span>
                <span class="n">vIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vIn</span> <span class="o">=</span> <span class="n">vIn</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vIn</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">vIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">([</span><span class="o">-</span><span class="n">vIn</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">vIn</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]])</span>
                <span class="n">lVIn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vIn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">lVIn</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">lVIn</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">lVIn</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">lVIn</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">lVIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lVIn</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">lVIn</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">lVIn</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nPoly</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">lPoly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">lVIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">lVIn</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lVIn</span><span class="p">)</span> <span class="o">==</span> <span class="n">nPoly</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">vv</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">vv</span><span class="p">,</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lVIn</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                        <span class="n">lVIn</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">lVIn</span><span class="p">]</span>

            <span class="c1"># Check normalization and direction</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nPoly</span><span class="p">):</span>
                <span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vect</span> <span class="o">=</span> <span class="n">vect</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">det</span> <span class="o">=</span> <span class="n">vect</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">vect</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">det</span><span class="p">),</span> <span class="mf">1.</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Each lVIn must be perp. to each lPoly segment !&quot;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">det</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.e-12</span>
                <span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">][:,</span> <span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">][:,</span> <span class="n">ind</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">nPoly</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span></div>

<div class="viewcode-block" id="Rays.calc_kInkOut_Isoflux"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.calc_kInkOut_Isoflux">[docs]</a>    <span class="k">def</span> <span class="nf">calc_kInkOut_Isoflux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">kInOut</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Calculate the intersection points of each ray with each isoflux</span>

<span class="sd">        The isofluxes are provided as a list of 2D closed polygons</span>

<span class="sd">        The intersections are the inward and outward intersections</span>
<span class="sd">        They are retruned as two np.ndarrays: kIn and kOut</span>
<span class="sd">        Each array contains the length parameter along the ray for each isoflux</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Preformat input</span>
        <span class="n">nPoly</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kInOut_Isoflux_inputs_usr</span><span class="p">(</span><span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span><span class="o">=</span><span class="n">lVIn</span><span class="p">)</span>

        <span class="c1"># Prepare output</span>
        <span class="n">kIn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nPoly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">kOut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nPoly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># Compute intersections</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="s1">&#39;optimized&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s1">&#39;ref&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nPoly</span><span class="p">):</span>
                <span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kInOut_Isoflux_inputs</span><span class="p">([</span><span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                          <span class="n">lVIn</span><span class="o">=</span><span class="p">[</span><span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">SLOW_LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="o">*</span><span class="n">largs</span><span class="p">,</span> <span class="o">**</span><span class="n">dkwd</span><span class="p">)</span>
                <span class="c1"># PIn, POut, kin, kout, VperpIn, vperp, IIn, indout = out[]</span>
                <span class="n">kIn</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method</span> <span class="o">==</span> <span class="s2">&quot;optimized&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nPoly</span><span class="p">):</span>
                <span class="n">largs</span><span class="p">,</span> <span class="n">dkwd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kInOut_Isoflux_inputs</span><span class="p">([</span><span class="n">lPoly</span><span class="p">[</span><span class="n">ii</span><span class="p">]],</span>
                                                          <span class="n">lVIn</span><span class="o">=</span><span class="p">[</span><span class="n">lVIn</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>

                <span class="n">out</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_Calc_PInOut_VesStruct</span><span class="p">(</span><span class="o">*</span><span class="n">largs</span><span class="p">,</span> <span class="o">**</span><span class="n">dkwd</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">kIn</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">if</span> <span class="n">kInOut</span><span class="p">:</span>
            <span class="n">indok</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kIn</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nPoly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">kInref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kIn</span><span class="p">,</span> <span class="p">(</span><span class="n">nPoly</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">kOutref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kOut</span><span class="p">,</span> <span class="p">(</span><span class="n">nPoly</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kIn</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">kInref</span><span class="p">[</span><span class="n">indok</span><span class="p">])</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">kIn</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kOutref</span><span class="p">[</span><span class="n">indok</span><span class="p">])</span>
            <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">ind</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">indok</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">kOut</span><span class="p">)</span>
            <span class="n">ind</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">kOut</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">kInref</span><span class="p">[</span><span class="n">indok</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span>
                <span class="n">kOut</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kOutref</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">kIn</span><span class="p">,</span> <span class="n">kOut</span></div>

<div class="viewcode-block" id="Rays.calc_length_in_isoflux"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.calc_length_in_isoflux">[docs]</a>    <span class="k">def</span> <span class="nf">calc_length_in_isoflux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kInOut</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the length of each LOS inside each isoflux</span>

<span class="sd">        Uses self.calc_kInkOut_Isoflux() to compute the linear abscissa (k) of</span>
<span class="sd">        the entry points (kIn) and exit points (kOut) for each LOS</span>

<span class="sd">        The isofluxes must be provided as a list of polygons</span>

<span class="sd">        The length is returned as a (nPoly, nLOS) 2d array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kIn</span><span class="p">,</span> <span class="n">kOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_kInkOut_Isoflux</span><span class="p">(</span><span class="n">lPoly</span><span class="p">,</span> <span class="n">lVIn</span><span class="o">=</span><span class="n">lVIn</span><span class="p">,</span> <span class="n">Lim</span><span class="o">=</span><span class="n">Lim</span><span class="p">,</span>
                                              <span class="n">kInOut</span><span class="o">=</span><span class="n">kInOut</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kOut</span><span class="o">-</span><span class="n">kIn</span></div>

<div class="viewcode-block" id="Rays.calc_min_geom_radius"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.calc_min_geom_radius">[docs]</a>    <span class="k">def</span> <span class="nf">calc_min_geom_radius</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the minimum geom. radius of each LOS, from an arbitrary axis</span>

<span class="sd">        The axis mut be provided as a (R,Z) iterable</span>
<span class="sd">        Uses self.set_dsino()</span>

<span class="sd">        Return:</span>
<span class="sd">        -------</span>
<span class="sd">        p:      np.ndarray</span>
<span class="sd">            (nLOS,) array of minimal radius (or impact parameter)</span>
<span class="sd">        theta:  np.ndarray</span>
<span class="sd">            (nLOS,) array of associated theta with respect to axis</span>
<span class="sd">        pts:    np.ndarray</span>
<span class="sd">            (3,nLOS) array of (X,Y,Z) coordinates of associated points on LOS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dsino</span><span class="p">(</span><span class="n">RefPt</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">p</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dsino</span><span class="p">[</span><span class="s1">&#39;pts&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">pts</span></div>

<div class="viewcode-block" id="Rays.calc_min_rho_from_Plasma2D"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.calc_min_rho_from_Plasma2D">[docs]</a>    <span class="k">def</span> <span class="nf">calc_min_rho_from_Plasma2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plasma</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span>
                                   <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resMode</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
                                   <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the min/max value of scalar field quant for each LOS</span>

<span class="sd">        Typically used to get the minimal normalized minor radius</span>
<span class="sd">        But can be used for any quantity available in plasma if:</span>
<span class="sd">            - it is a 2d profile</span>
<span class="sd">            - it is a 1d profile that can be interpolated on a 2d mesh</span>

<span class="sd">        Currently sample each LOS with desired resolution and returns the</span>
<span class="sd">        absolute min/max interpolated value (and associated point)</span>

<span class="sd">        See self.get_sample() for details on sampling arguments:</span>
<span class="sd">            - res, resMode, method</span>
<span class="sd">        See Plasma2D.interp_pts2profile() for details on interpolation args:</span>
<span class="sd">            - t, quant, q2dref, q1dref, interp_t, interp_space, fill_value</span>

<span class="sd">        Returns:</span>
<span class="sd">        --------</span>
<span class="sd">        val:        np.ndarray</span>
<span class="sd">            (nt, nLOS) array of min/max values</span>
<span class="sd">        pts:        np.ndarray</span>
<span class="sd">            (nt, nLOS, 3) array of (X,Y,Z) coordinates of associated points</span>
<span class="sd">            Only returned if pts = True</span>
<span class="sd">        t:          np.ndarray</span>
<span class="sd">            (nt,) array of time steps at which the interpolations were made</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Sample LOS</span>
        <span class="n">ptsi</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">lind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample</span><span class="p">(</span><span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span> <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">pts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Interpolate values</span>
        <span class="n">val</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">plasma</span><span class="o">.</span><span class="n">interp_pts2profile</span><span class="p">(</span>
            <span class="n">pts</span><span class="o">=</span><span class="n">ptsi</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
            <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>

        <span class="c1"># Separate val per LOS and compute min / max</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span> <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span>
        <span class="k">if</span> <span class="n">pts</span><span class="p">:</span>
            <span class="n">funcarg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span> <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span>

        <span class="k">if</span> <span class="n">pts</span><span class="p">:</span>
            <span class="n">nt</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,</span> <span class="n">nt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="c1"># indt = np.arange(0, nt)</span>
            <span class="n">lind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lind</span><span class="p">,</span> <span class="n">ptsi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">):</span>
                <span class="n">indok</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">val</span><span class="p">[:,</span> <span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span><span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indok</span><span class="p">):</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span><span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span>
                                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">funcarg</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">indok</span><span class="p">,</span> <span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span><span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">pts</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="n">ptsi</span><span class="p">[:,</span> <span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span><span class="n">lind</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]][:,</span> <span class="n">ind</span><span class="p">]</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">T</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">func</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">lind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">vals</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="n">t</span></div>

<div class="viewcode-block" id="Rays.get_inspector"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.get_inspector">[docs]</a>    <span class="k">def</span> <span class="nf">get_inspector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ff</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([(</span><span class="n">pp</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
                      <span class="ow">and</span> <span class="n">pp</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">pp</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">])</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">[</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pars</span> <span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">pp</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span>
                                         <span class="ow">and</span> <span class="n">pp</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pp</span><span class="o">.</span><span class="n">empty</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">na</span><span class="p">,</span> <span class="n">kw</span></div>

<div class="viewcode-block" id="Rays.check_ff"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.check_ff">[docs]</a>    <span class="k">def</span> <span class="nf">check_ff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ani</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Initialization of function wrapper</span>
        <span class="n">wrapped_ff</span> <span class="o">=</span> <span class="n">ff</span>

        <span class="c1"># Define unique error message giving all info in a concise way</span>
        <span class="c1"># Optionnally add error-specific line afterwards</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;User-defined emissivity function ff must:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- be a callable (function)</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- take only one positional arg &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;and at least one keyword arg:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> - ff(pts, t=None), where:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> - pts is a (3, npts) of (x, y, z) coordinates</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> - t can be None / scalar / iterable of len(t) = nt</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Always return a 2d (nt, npts) np.ndarray, where:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> - nt = len(t) if t is an iterable</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> - nt = 1 if t is None or scalar</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> - npts is the number of pts (pts.shape[1])</span><span class="se">\n\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Optionally, ff can take an extra keyword arg:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> - ff(pts, vect=None, t=None), where:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> - vect is a (3, npts) np.ndarray</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2"> - vect contains the (x, y, z) coordinates &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;of the units vectors of the photon emission directions&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;for each pts. Present only for anisotropic emissivity, &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;unless specifically indicated otherwise &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;(with ani=False in LOS_calc_signal).</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">Does not affect the outpout shape (still (nt, npts))&quot;</span><span class="p">)</span>

        <span class="c1"># .. Checking basic definition of function ..........................</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; ff must be a callable (function)!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">npos_args</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inspector</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npos_args</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; ff must take only 1 positional arg: ff(pts)!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; ff must have kwarg &#39;t=None&#39; for time vector!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># .. Checking time vector .........................................</span>
        <span class="n">ltypeok</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
        <span class="n">is_t_type_valid</span> <span class="o">=</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypeok</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">is_t_type_valid</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; t must be None, scalar or iterable !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">nt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="c1"># .. Test anisotropic case .......................................</span>
        <span class="k">if</span> <span class="n">ani</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">is_ani</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;vect&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ani</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">is_ani</span> <span class="o">=</span> <span class="n">ani</span>

        <span class="c1"># .. Testing outputs ...............................................</span>
        <span class="n">test_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]])</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="n">test_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_ani</span><span class="p">:</span>
            <span class="n">vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">test_pts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">test_pts</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="n">vect</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; ff must take ff(pts, vect=vect, t=t) !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">test_pts</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; ff must take a ff(pts, t=t) !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">npts</span><span class="p">)</span>
                                                 <span class="ow">or</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">npts</span><span class="p">,))):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; wrong output (always 2d np.ndarray) !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nt</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">npts</span><span class="p">,):</span>
            <span class="k">def</span> <span class="nf">wrapped_ff</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">res_ff</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">res_ff</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">is_ani</span><span class="p">,</span> <span class="n">wrapped_ff</span></div>

<div class="viewcode-block" id="Rays._calc_signal_preformat"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._calc_signal_preformat">[docs]</a>    <span class="k">def</span> <span class="nf">_calc_signal_preformat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">out</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span> <span class="n">Brightness</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg out must be in [object,np.ndarray]&quot;</span>
        <span class="k">assert</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">msg</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Brightness</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">,</span> <span class="s2">&quot;Arg Brightness must be a bool !&quot;</span>
        <span class="k">if</span> <span class="n">Brightness</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Etendues</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Etendue must be set if Brightness is False !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Preformat ind</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_indch</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="c1"># Preformat DL</span>
        <span class="n">kIn</span><span class="p">,</span> <span class="n">kOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kIn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kOut</span>
        <span class="k">if</span> <span class="n">DL</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
        <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">DL</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="n">DL</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)),</span> <span class="s2">&quot;Arg DL has wrong shape !&quot;</span>

        <span class="c1"># check limits</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ii</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;=</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ii</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kOut</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">ii</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">kIn</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>

        <span class="c1"># Preformat Ds, us and Etendue</span>
        <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">]</span>
        <span class="n">E</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">Brightness</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Etendues</span>
            <span class="k">if</span> <span class="n">E</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">:</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">E</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>

        <span class="c1"># Preformat signal</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">Ds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">us</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">indok</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">DL</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">DL</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">((</span><span class="n">DL</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">DL</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indok</span><span class="p">):</span>
            <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">Ds</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">],</span> <span class="n">us</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">],</span> <span class="n">DL</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">indok</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">Ds</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">us</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">DL</span> <span class="o">=</span> <span class="n">DL</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">Ds</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">us</span><span class="p">)</span>
            <span class="n">DL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">DL</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">DL</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">indok</span><span class="p">,</span> <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">E</span></div>

<div class="viewcode-block" id="Rays._calc_signal_postformat"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays._calc_signal_postformat">[docs]</a>    <span class="k">def</span> <span class="nf">_calc_signal_postformat</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sig</span><span class="p">,</span>
        <span class="n">Brightness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dataname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">E</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">Brightness</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataname</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;LOS-integral x Etendue&quot;</span>
            <span class="k">if</span> <span class="n">E</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">E</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot use etendue, it was not set properly !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">E</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">E</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span> <span class="o">*</span> <span class="n">E</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;origin x $m^3.sr$&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dataname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dataname</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;LOS-integral&quot;</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">units</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;origin x m&quot;</span>

        <span class="k">if</span> <span class="n">plot</span> <span class="ow">or</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">]:</span>
            <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">lCam</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">Name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span>
                <span class="n">dlabels</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">dataname</span><span class="p">}},</span>
                <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
                <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="kn">import</span> <span class="nn">tofu.data</span> <span class="k">as</span> <span class="nn">tfd</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
                <span class="n">osig</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DataCam2D</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">osig</span> <span class="o">=</span> <span class="n">tfd</span><span class="o">.</span><span class="n">DataCam1D</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">osig</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
                    <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span>
                    <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
                    <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span>
                    <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
                    <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">osig</span><span class="p">,</span> <span class="n">units</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sig</span><span class="p">,</span> <span class="n">units</span></div>

<div class="viewcode-block" id="Rays.calc_signal"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.calc_signal">[docs]</a>    <span class="k">def</span> <span class="nf">calc_signal</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">func</span><span class="p">,</span>
        <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ani</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fkwdargs</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">Brightness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
        <span class="n">minimize</span><span class="o">=</span><span class="s2">&quot;calls&quot;</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">reflections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">coefs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">coefs_reflect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">returnas</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dataname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">newcalc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the line-integrated emissivity</span>

<span class="sd">        Beware, by default, Brightness=True and it is only a line-integral !</span>

<span class="sd">        Indeed, to get the received power, you need an estimate of the Etendue</span>
<span class="sd">        (previously set using self.set_Etendues()) and use Brightness=False.</span>

<span class="sd">        Hence, if Brightness=True and if</span>
<span class="sd">        the emissivity is provided in W/m3 (resp. W/m3/sr),</span>
<span class="sd">        =&gt; the method returns W/m2 (resp. W/m2/sr)</span>
<span class="sd">        The line is sampled using :meth:`~tofu.geom.LOS.get_sample`,</span>

<span class="sd">        Except func, arguments common to :meth:`~tofu.geom.LOS.get_sample`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func :    callable</span>
<span class="sd">            The user-provided emissivity function</span>
<span class="sd">            Shall take at least:</span>
<span class="sd">                func(pts, t=None, vect=None)</span>
<span class="sd">            where:</span>
<span class="sd">                - pts : (3,N) np.ndarray, (X,Y,Z) coordinates of points</span>
<span class="sd">                - t   : None / (nt,) np.ndarray, time vector</span>
<span class="sd">                - vect: None / (3,N) np.ndarray, unit direction vectors (X,Y,Z)</span>
<span class="sd">            Should return at least:</span>
<span class="sd">                - val : (N,) np.ndarray, local emissivity values</span>
<span class="sd">        method : string, the integral can be computed using 3 different methods</span>
<span class="sd">            - &#39;sum&#39;:    A numpy.sum() on the local values (x segments) DEFAULT</span>
<span class="sd">            - &#39;simps&#39;:  using :meth:`scipy.integrate.simps`</span>
<span class="sd">            - &#39;romb&#39;:   using :meth:`scipy.integrate.romb`</span>
<span class="sd">        minimize : string, method to minimize for computation optimization</span>
<span class="sd">            - &quot;calls&quot;: minimal number of calls to `func` (default)</span>
<span class="sd">            - &quot;memory&quot;: slowest method, to use only if &quot;out of memory&quot; error</span>
<span class="sd">            - &quot;hybrid&quot;: mix of before-mentioned methods.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sig :   np.ndarray</span>
<span class="sd">            The computed signal, a 1d or 2d array depending on whether a time</span>
<span class="sd">            vector was provided.</span>
<span class="sd">        units:  str</span>
<span class="sd">            Units of the result</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Format input</span>

        <span class="n">indok</span><span class="p">,</span> <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_signal_preformat</span><span class="p">(</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">DL</span><span class="o">=</span><span class="n">DL</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span> <span class="n">Brightness</span><span class="o">=</span><span class="n">Brightness</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">Ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_RES</span>

        <span class="c1"># Launch    # NB : find a way to exclude cases with DL[0,:]&gt;=DL[1,:] !!</span>
        <span class="c1"># Exclude Rays not seeing the plasma</span>
        <span class="k">if</span> <span class="n">newcalc</span><span class="p">:</span>
            <span class="n">ani</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_ff</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">ani</span><span class="o">=</span><span class="n">ani</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_calc_signal</span><span class="p">(</span>
                <span class="n">func</span><span class="p">,</span>
                <span class="n">Ds</span><span class="p">,</span>
                <span class="n">us</span><span class="p">,</span>
                <span class="n">res</span><span class="p">,</span>
                <span class="n">DL</span><span class="p">,</span>
                <span class="n">dmethod</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">ani</span><span class="o">=</span><span class="n">ani</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">fkwdargs</span><span class="o">=</span><span class="n">fkwdargs</span><span class="p">,</span>
                <span class="n">minimize</span><span class="o">=</span><span class="n">minimize</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">reflections</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coefs_reflect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">coefs_reflect</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;nb&quot;</span><span class="p">]):</span>
                    <span class="n">Dsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;Ds&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">usi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;us&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">coefs_reflect</span> <span class="o">*</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_calc_signal</span><span class="p">(</span>
                        <span class="n">func</span><span class="p">,</span>
                        <span class="n">Dsi</span><span class="p">,</span>
                        <span class="n">usi</span><span class="p">,</span>
                        <span class="n">res</span><span class="p">,</span>
                        <span class="n">DL</span><span class="p">,</span>
                        <span class="n">dmethod</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                        <span class="n">ani</span><span class="o">=</span><span class="n">ani</span><span class="p">,</span>
                        <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                        <span class="n">fkwdargs</span><span class="o">=</span><span class="n">fkwdargs</span><span class="p">,</span>
                        <span class="n">minimize</span><span class="o">=</span><span class="n">minimize</span><span class="p">,</span>
                        <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># Integrate</span>
            <span class="c1"># Creating the arrays with null everywhere..........</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get ptsRZ along LOS // Which to choose ???</span>
            <span class="n">pts</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">indpts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample</span><span class="p">(</span>
                <span class="n">res</span><span class="p">,</span>
                <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                <span class="n">DL</span><span class="o">=</span><span class="n">DL</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
                <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">pts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">ani</span><span class="p">:</span>
                <span class="n">nbrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span>
                    <span class="n">indpts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">indpts</span><span class="p">),</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indpts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">vect</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">nbrep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vect</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Get quantity values at ptsRZ</span>
            <span class="c1"># This is the slowest step (~3.8 s with res=0.02</span>
            <span class="c1">#    and interferometer)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="n">vect</span><span class="p">)</span>
            <span class="c1"># Integrate</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduceat</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">indpts</span><span class="p">],</span>
                                  <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">reseff</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Apply user-provided coefs</span>
        <span class="k">if</span> <span class="n">coefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">coefs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span>
                <span class="k">if</span> <span class="n">sig</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">coefs</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">sig</span> <span class="o">*=</span> <span class="n">coefs</span>

        <span class="c1"># Format output</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_signal_postformat</span><span class="p">(</span>
            <span class="n">sig</span><span class="p">,</span>
            <span class="n">Brightness</span><span class="o">=</span><span class="n">Brightness</span><span class="p">,</span>
            <span class="n">dataname</span><span class="o">=</span><span class="n">dataname</span><span class="p">,</span>
            <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
            <span class="n">E</span><span class="o">=</span><span class="n">E</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
            <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Rays.calc_signal_from_Plasma2D"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.calc_signal_from_Plasma2D">[docs]</a>    <span class="k">def</span> <span class="nf">calc_signal_from_Plasma2D</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plasma2d</span><span class="p">,</span>
        <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">newcalc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">q2dR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">q2dPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">q2dZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Brightness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">interp_t</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
        <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">resMode</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
        <span class="n">minimize</span><span class="o">=</span><span class="s2">&quot;calls&quot;</span><span class="p">,</span>
        <span class="n">num_threads</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">reflections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">coefs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">coefs_reflect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">returnas</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">dataname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># Format input</span>
        <span class="n">indok</span><span class="p">,</span> <span class="n">Ds</span><span class="p">,</span> <span class="n">us</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_signal_preformat</span><span class="p">(</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">Brightness</span><span class="o">=</span><span class="n">Brightness</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">Ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_RES</span>

        <span class="k">if</span> <span class="n">newcalc</span><span class="p">:</span>
            <span class="c1"># Get time vector</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">plasma2d</span><span class="o">.</span><span class="n">_checkformat_qr12RPZ</span><span class="p">(</span>
                     <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span>
                     <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span>
                     <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                     <span class="n">q2dR</span><span class="o">=</span><span class="n">q2dR</span><span class="p">,</span>
                     <span class="n">q2dPhi</span><span class="o">=</span><span class="n">q2dPhi</span><span class="p">,</span>
                     <span class="n">q2dZ</span><span class="o">=</span><span class="n">q2dZ</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">plasma2d</span><span class="o">.</span><span class="n">_get_tcom</span><span class="p">(</span><span class="o">*</span><span class="n">out</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">plasma2d</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">func</span> <span class="o">=</span> <span class="n">plasma2d</span><span class="o">.</span><span class="n">get_finterp2d</span><span class="p">(</span>
                <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span>
                <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span>
                <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                <span class="n">q2dR</span><span class="o">=</span><span class="n">q2dR</span><span class="p">,</span>
                <span class="n">q2dPhi</span><span class="o">=</span><span class="n">q2dPhi</span><span class="p">,</span>
                <span class="n">q2dZ</span><span class="o">=</span><span class="n">q2dZ</span><span class="p">,</span>
                <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">funcbis</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">DL</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># set to [kIn,kOut]</span>
                <span class="n">DL</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">ani</span> <span class="o">=</span> <span class="n">quant</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">num_threads</span> <span class="o">=</span> <span class="n">_NUM_THREADS</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">indok</span><span class="p">):</span>
                <span class="n">D</span><span class="p">,</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">u</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">])</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">[:,</span> <span class="n">indok</span><span class="p">])</span>

            <span class="n">sig</span> <span class="o">=</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_calc_signal</span><span class="p">(</span>
                <span class="n">funcbis</span><span class="p">,</span>
                <span class="n">D</span><span class="p">,</span>
                <span class="n">u</span><span class="p">,</span>
                <span class="n">res</span><span class="p">,</span>
                <span class="n">DL</span><span class="p">,</span>
                <span class="n">dmethod</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">ani</span><span class="o">=</span><span class="n">ani</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">fkwdargs</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">minimize</span><span class="o">=</span><span class="n">minimize</span><span class="p">,</span>
                <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">reflections</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coefs_reflect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">coefs_reflect</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;nb&quot;</span><span class="p">]):</span>
                    <span class="n">Dsi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;Ds&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">usi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dreflect&quot;</span><span class="p">][</span><span class="s2">&quot;us&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">ii</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">sig</span> <span class="o">+=</span> <span class="n">coefs_reflect</span> <span class="o">*</span> <span class="n">_GG</span><span class="o">.</span><span class="n">LOS_calc_signal</span><span class="p">(</span>
                        <span class="n">funcbis</span><span class="p">,</span>
                        <span class="n">Dsi</span><span class="p">,</span>
                        <span class="n">usi</span><span class="p">,</span>
                        <span class="n">res</span><span class="p">,</span>
                        <span class="n">DL</span><span class="p">,</span>
                        <span class="n">dmethod</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                        <span class="n">ani</span><span class="o">=</span><span class="n">ani</span><span class="p">,</span>
                        <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                        <span class="n">fkwdargs</span><span class="o">=</span><span class="p">{},</span>
                        <span class="n">minimize</span><span class="o">=</span><span class="n">minimize</span><span class="p">,</span>
                        <span class="n">num_threads</span><span class="o">=</span><span class="n">num_threads</span><span class="p">,</span>
                        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get ptsRZ along LOS // Which to choose ???</span>
            <span class="n">pts</span><span class="p">,</span> <span class="n">reseff</span><span class="p">,</span> <span class="n">indpts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample</span><span class="p">(</span>
                <span class="n">res</span><span class="p">,</span>
                <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                <span class="n">DL</span><span class="o">=</span><span class="n">DL</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
                <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">pts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">q2dR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">vect</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nbrep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span>
                    <span class="n">indpts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">indpts</span><span class="p">),</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">indpts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">vect</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">nbrep</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fill_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fill_value</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="c1"># Get quantity values at ptsRZ</span>
            <span class="c1"># This is the slowest step (~3.8 s with res=0.02</span>
            <span class="c1">#    and interferometer)</span>
            <span class="n">val</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">plasma2d</span><span class="o">.</span><span class="n">interp_pts2profile</span><span class="p">(</span>
                <span class="n">pts</span><span class="o">=</span><span class="n">pts</span><span class="p">,</span>
                <span class="n">vect</span><span class="o">=</span><span class="n">vect</span><span class="p">,</span>
                <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span>
                <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span>
                <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                <span class="n">q2dR</span><span class="o">=</span><span class="n">q2dR</span><span class="p">,</span>
                <span class="n">q2dPhi</span><span class="o">=</span><span class="n">q2dPhi</span><span class="p">,</span>
                <span class="n">q2dZ</span><span class="o">=</span><span class="n">q2dZ</span><span class="p">,</span>
                <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span>
                <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Integrate using ufunc reduceat for speed</span>
            <span class="c1"># (cf. https://stackoverflow.com/questions/59079141)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduceat</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">indpts</span><span class="p">],</span>
                                  <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">reseff</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># Apply user-provided coefs</span>
        <span class="k">if</span> <span class="n">coefs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coefs</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
                <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">coefs</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">coefs</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],)</span>
                <span class="k">if</span> <span class="n">sig</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">coefs</span> <span class="o">=</span> <span class="n">coefs</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">sig</span> <span class="o">*=</span> <span class="n">coefs</span>

        <span class="c1"># Format output</span>
        <span class="c1"># this is the secod slowest step (~0.75 s)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_signal_postformat</span><span class="p">(</span>
            <span class="n">sig</span><span class="p">,</span>
            <span class="n">Brightness</span><span class="o">=</span><span class="n">Brightness</span><span class="p">,</span>
            <span class="n">dataname</span><span class="o">=</span><span class="n">dataname</span><span class="p">,</span>
            <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
            <span class="n">E</span><span class="o">=</span><span class="n">E</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span>
            <span class="n">out</span><span class="o">=</span><span class="n">returnas</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
            <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Rays.plot"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">proj</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">reflections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">Lplot</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSLplot</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="s2">&quot;L&quot;</span><span class="p">,</span>
        <span class="n">element_config</span><span class="o">=</span><span class="s2">&quot;P&quot;</span><span class="p">,</span>
        <span class="n">Leg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">dL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dPtD</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span>
        <span class="n">dPtI</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span>
        <span class="n">dPtO</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span>
        <span class="n">dPtR</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span>
        <span class="n">dPtP</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSMd</span><span class="p">,</span>
        <span class="n">dLeg</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
        <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the Rays / LOS, in the chosen projection(s)</span>

<span class="sd">        Optionnally also plot associated :class:`~tofu.geom.Ves` and Struct</span>
<span class="sd">        The plot can also include:</span>
<span class="sd">            - special points</span>
<span class="sd">            - the unit directing vector</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lax :       list / plt.Axes</span>
<span class="sd">            The axes for plotting (list of 2 axes if Proj=&#39;All&#39;)</span>
<span class="sd">            If None a new figure with new axes is created</span>
<span class="sd">        proj :      str</span>
<span class="sd">            Flag specifying the kind of projection:</span>
<span class="sd">                - &#39;Cross&#39; : cross-section</span>
<span class="sd">                - &#39;Hor&#39; : horizontal</span>
<span class="sd">                - &#39;All&#39; : both cross-section and horizontal (on 2 axes)</span>
<span class="sd">                - &#39;3d&#39; : a (matplotlib) 3d plot</span>
<span class="sd">        projections:bool</span>
<span class="sd">            Flag indicating whether to plot also the reflected rays</span>
<span class="sd">            Assuming some reflected rays are present (self.add_reflections())</span>
<span class="sd">        element :   str</span>
<span class="sd">            Flag specifying which elements to plot</span>
<span class="sd">            Each capital letter corresponds to an element:</span>
<span class="sd">                * &#39;L&#39;: LOS</span>
<span class="sd">                * &#39;D&#39;: Starting point of the LOS</span>
<span class="sd">                * &#39;I&#39;: Input point (i.e.: where the LOS enters the Vessel)</span>
<span class="sd">                * &#39;O&#39;: Output point (i.e.: where the LOS exits the Vessel)</span>
<span class="sd">                * &#39;R&#39;: Point of minimal major radius R (only if Ves.Type=&#39;Tor&#39;)</span>
<span class="sd">                * &#39;P&#39;: Point of used for impact parameter (i.e.: with minimal</span>
<span class="sd">                        distance to reference point Sino_RefPt)</span>
<span class="sd">        Lplot :     str</span>
<span class="sd">            Flag specifying the length to plot:</span>
<span class="sd">                - &#39;Tot&#39;: total length, from starting point (D) to output point</span>
<span class="sd">                - &#39;In&#39; : only the in-vessel fraction (from input to output)</span>
<span class="sd">        element_config : str</span>
<span class="sd">            Fed to self.config.plot()</span>
<span class="sd">        Leg :       str</span>
<span class="sd">            Legend, if Leg=&#39;&#39; the LOS name is used</span>
<span class="sd">        dL :     dict / None</span>
<span class="sd">            Dictionary of properties for plotting the lines</span>
<span class="sd">            Fed to plt.Axes.plot(), set to default if None</span>
<span class="sd">        dPtD :      dict</span>
<span class="sd">            Dictionary of properties for plotting point &#39;D&#39;</span>
<span class="sd">        dPtI :      dict</span>
<span class="sd">            Dictionary of properties for plotting point &#39;I&#39;</span>
<span class="sd">        dPtO :      dict</span>
<span class="sd">            Dictionary of properties for plotting point &#39;O&#39;</span>
<span class="sd">        dPtR :      dict</span>
<span class="sd">            Dictionary of properties for plotting point &#39;R&#39;</span>
<span class="sd">        dPtP :      dict</span>
<span class="sd">            Dictionary of properties for plotting point &#39;P&#39;</span>
<span class="sd">        dLeg :      dict or None</span>
<span class="sd">            Dictionary of properties for plotting the legend</span>
<span class="sd">            Fed to plt.legend(), the legend is not plotted if None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether fig.canvas.draw() shall be called</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether to plot the figure in a4 dimensions</span>
<span class="sd">        Test :      bool</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether to plot the figure in a4 dimensions</span>
<span class="sd">        Test :      bool</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether to plot the figure in a4 dimensions</span>
<span class="sd">        Test :      bool</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether to plot the figure in a4 dimensions</span>
<span class="sd">        Test :      bool</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs should be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        La :        list / plt.Axes</span>
<span class="sd">            Handles of the axes used for plotting (list if Proj=&#39;All&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Rays_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">Lax</span><span class="o">=</span><span class="n">lax</span><span class="p">,</span>
            <span class="n">Proj</span><span class="o">=</span><span class="n">proj</span><span class="p">,</span>
            <span class="n">reflections</span><span class="o">=</span><span class="n">reflections</span><span class="p">,</span>
            <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span>
            <span class="n">element</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">element_config</span><span class="o">=</span><span class="n">element_config</span><span class="p">,</span>
            <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span>
            <span class="n">dL</span><span class="o">=</span><span class="n">dL</span><span class="p">,</span>
            <span class="n">dPtD</span><span class="o">=</span><span class="n">dPtD</span><span class="p">,</span>
            <span class="n">dPtI</span><span class="o">=</span><span class="n">dPtI</span><span class="p">,</span>
            <span class="n">dPtO</span><span class="o">=</span><span class="n">dPtO</span><span class="p">,</span>
            <span class="n">dPtR</span><span class="o">=</span><span class="n">dPtR</span><span class="p">,</span>
            <span class="n">dPtP</span><span class="o">=</span><span class="n">dPtP</span><span class="p">,</span>
            <span class="n">dLeg</span><span class="o">=</span><span class="n">dLeg</span><span class="p">,</span>
            <span class="n">multi</span><span class="o">=</span><span class="n">multi</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Rays.plot_sino"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.plot_sino">[docs]</a>    <span class="k">def</span> <span class="nf">plot_sino</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">element</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSImpElt</span><span class="p">,</span>
        <span class="n">Sketch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">Ang</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSImpAng</span><span class="p">,</span>
        <span class="n">AngUnit</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSImpAngUnit</span><span class="p">,</span>
        <span class="n">Leg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dL</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">LOSMImpd</span><span class="p">,</span>
        <span class="n">dVes</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorPFilld</span><span class="p">,</span>
        <span class="n">dLeg</span><span class="o">=</span><span class="n">_def</span><span class="o">.</span><span class="n">TorLegd</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">multi</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">Test</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the LOS in projection space (sinogram)</span>

<span class="sd">        Plot the Rays in projection space (cf. sinograms) as points.</span>
<span class="sd">        Can also optionnally plot the associated :class:`~tofu.geom.Ves`</span>

<span class="sd">        Can plot the conventional projection-space (in 2D in a cross-section),</span>
<span class="sd">        or a 3D extrapolation of it, where the third coordinate is provided by</span>
<span class="sd">        the angle that the LOS makes with the cross-section plane</span>
<span class="sd">        (useful in case of multiple LOS with a partially tangential view)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Proj :      str</span>
<span class="sd">            Flag indicating whether to plot:</span>
<span class="sd">                - &#39;Cross&#39;:  a classic sinogram (vessel cross-section)</span>
<span class="sd">                - &#39;3d&#39;: an extended 3D version (&#39;3d&#39;), with an additional angle</span>
<span class="sd">        ax :        None / plt.Axes</span>
<span class="sd">            The axes on which to plot, if None a new figure is created</span>
<span class="sd">        Elt :       str</span>
<span class="sd">            Flag indicating which elements to plot (one per capital letter):</span>
<span class="sd">                * &#39;L&#39;: LOS</span>
<span class="sd">                * &#39;V&#39;: Vessel</span>
<span class="sd">        Ang  :      str</span>
<span class="sd">            Flag indicating which angle to use for the impact parameter:</span>
<span class="sd">                - &#39;xi&#39;: the angle of the line itself</span>
<span class="sd">                - &#39;theta&#39;: its impact parameter (theta)</span>
<span class="sd">        AngUnit :   str</span>
<span class="sd">            Flag for the angle units to be displayed:</span>
<span class="sd">                - &#39;rad&#39;: for radians</span>
<span class="sd">                - &#39;deg&#39;: for degrees</span>
<span class="sd">        Sketch :    bool</span>
<span class="sd">            Flag indicating whether to plot a skecth with angles definitions</span>
<span class="sd">        dL :        dict</span>
<span class="sd">            Dictionary of properties for plotting the Rays points</span>
<span class="sd">        dV :        dict</span>
<span class="sd">            Dictionary of properties for plotting the vessel envelopp</span>
<span class="sd">        dLeg :      None / dict</span>
<span class="sd">            Dictionary of properties for plotting the legend</span>
<span class="sd">            The legend is not plotted if None</span>
<span class="sd">        draw :      bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        a4 :        bool</span>
<span class="sd">            Flag indicating whether the figure should be a4</span>
<span class="sd">        Test :      bool</span>
<span class="sd">            Flag indicating whether the inputs shall be tested for conformity</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ax :        plt.Axes</span>
<span class="sd">            The axes used to plot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsino</span><span class="p">[</span><span class="s2">&quot;RefPt&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The sinogram ref. point is not set !&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  =&gt; run self.set_dsino()&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_plot</span><span class="o">.</span><span class="n">GLOS_plot_Sino</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">Proj</span><span class="o">=</span><span class="s2">&quot;Cross&quot;</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">Elt</span><span class="o">=</span><span class="n">element</span><span class="p">,</span>
            <span class="n">Leg</span><span class="o">=</span><span class="n">Leg</span><span class="p">,</span>
            <span class="n">Sketch</span><span class="o">=</span><span class="n">Sketch</span><span class="p">,</span>
            <span class="n">Ang</span><span class="o">=</span><span class="n">Ang</span><span class="p">,</span>
            <span class="n">AngUnit</span><span class="o">=</span><span class="n">AngUnit</span><span class="p">,</span>
            <span class="n">dL</span><span class="o">=</span><span class="n">dL</span><span class="p">,</span>
            <span class="n">dVes</span><span class="o">=</span><span class="n">dVes</span><span class="p">,</span>
            <span class="n">dLeg</span><span class="o">=</span><span class="n">dLeg</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
            <span class="n">Test</span><span class="o">=</span><span class="n">Test</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Rays.get_touch_dict"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.get_touch_dict">[docs]</a>    <span class="k">def</span> <span class="nf">get_touch_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a dictionnary of Cls_Name struct with indices of Rays touching</span>

<span class="sd">        Only includes Struct object with compute = True</span>
<span class="sd">            (as returned by self.lStruct__computeInOut_computeInOut)</span>
<span class="sd">        Also return the associated colors</span>
<span class="sd">        If in is not None, the indices for each Struct are split between:</span>
<span class="sd">            - indok : rays touching Struct and in ind</span>
<span class="sd">            - indout: rays touching Struct but not in ind</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Config must be set in order to get touch dict !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dElt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lStruct</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_indch</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_indStruct_computeInOut</span><span class="p">(</span><span class="n">unique_In</span><span class="o">=</span><span class="kc">True</span><span class="p">)]:</span>
            <span class="n">kn</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
            <span class="n">indtouch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">touch</span><span class="o">=</span><span class="n">kn</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indtouch</span><span class="p">):</span>
                <span class="n">indok</span> <span class="o">=</span> <span class="n">indtouch</span> <span class="o">&amp;</span> <span class="n">ind</span>
                <span class="n">indout</span> <span class="o">=</span> <span class="n">indtouch</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ind</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indok</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indout</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">out</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                        <span class="n">indok</span> <span class="o">=</span> <span class="n">indok</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">indout</span> <span class="o">=</span> <span class="n">indout</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dElt</span><span class="p">[</span><span class="n">kn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;indok&quot;</span><span class="p">:</span> <span class="n">indok</span><span class="p">,</span>
                        <span class="s2">&quot;indout&quot;</span><span class="p">:</span> <span class="n">indout</span><span class="p">,</span>
                        <span class="s2">&quot;col&quot;</span><span class="p">:</span> <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get_color</span><span class="p">(),</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">dElt</span></div>

<div class="viewcode-block" id="Rays.get_touch_colors"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.get_touch_colors">[docs]</a>    <span class="k">def</span> <span class="nf">get_touch_colors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dElt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cbck</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
        <span class="n">rgba</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get array of colors per LOS (color set by the touched Struct) &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dElt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dElt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_touch_dict</span><span class="p">(</span><span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dElt</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dElt</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">rgba</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">cbck</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dElt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">colors</span><span class="p">[:,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;indok&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgba</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])][</span>
                    <span class="p">:,</span> <span class="kc">None</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">cbck</span><span class="p">),</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dElt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">colors</span><span class="p">[:,</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;indok&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_rgb</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;col&quot;</span><span class="p">])][</span>
                    <span class="p">:,</span> <span class="kc">None</span>
                <span class="p">]</span>
        <span class="k">return</span> <span class="n">colors</span></div>

<div class="viewcode-block" id="Rays.plot_touch"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.Rays.plot_touch">[docs]</a>    <span class="k">def</span> <span class="nf">plot_touch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">quant</span><span class="o">=</span><span class="s2">&quot;lengths&quot;</span><span class="p">,</span>
        <span class="n">Lplot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">invert</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Interactive plot of the camera and the structures it touches</span>

<span class="sd">        The camera LOS are plotted in poloidal and horizontal projections</span>
<span class="sd">        The associated Config is also plotted</span>
<span class="sd">        The plot shows which strutural element is touched by each LOS</span>

<span class="sd">        In addition, an extra quantity can be mapped to alpha (transparency)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        key:        None / str</span>
<span class="sd">            Only relevant if self.dchans was defined</span>
<span class="sd">            key is then a key to sekf.dchans</span>
<span class="sd">        quant:      None / str</span>
<span class="sd">            Flag indicating which extra quantity is used to map alpha:</span>
<span class="sd">            - &#39;lengths&#39; (default): the length of each LOS</span>
<span class="sd">            - &#39;angles&#39; : the angle of incidence of each LOS</span>
<span class="sd">                         (with respect to the normal of the surface touched,</span>
<span class="sd">                          useful for assessing reflection probabilities)</span>
<span class="sd">            - &#39;indices&#39;: the index of each LOS</span>
<span class="sd">                         (useful for checking numbering)</span>
<span class="sd">            - &#39;Etendues&#39;: the etendue associated to each LOS (user-provided)</span>
<span class="sd">            - &#39;Surfaces&#39;: the surfaces associated to each LOS (user-provided)</span>
<span class="sd">        Lplot:      None / str</span>
<span class="sd">            Flag indicating whether to plot:</span>
<span class="sd">                - &#39;tot&#39;: the full length of the LOS</span>
<span class="sd">                - &#39;in&#39;: only the part that is inside the vessel</span>
<span class="sd">        invert:     None / bool</span>
<span class="sd">            Flag indicating whether to plot 2D camera images inverted (pinhole)</span>
<span class="sd">        ind:        None / np.ndarray</span>
<span class="sd">            Array of bool indices used to select only a subset of the LOS</span>
<span class="sd">        Bck:        None / bool</span>
<span class="sd">            Flag indicating whether to plot the background LOS</span>
<span class="sd">        fs:         None / tuple</span>
<span class="sd">            figure size in inches</span>
<span class="sd">        wintit:     None / str</span>
<span class="sd">            Title for the window</span>
<span class="sd">        tit:        None / str</span>
<span class="sd">            Title for the figure</span>
<span class="sd">        connect:    None / bool</span>
<span class="sd">            Flag indicating to connect interactive actuators</span>
<span class="sd">        draw:       None / bool</span>
<span class="sd">            Flag indicating whether to draw the figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Rays_plot_touch</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
            <span class="n">Bck</span><span class="o">=</span><span class="n">Bck</span><span class="p">,</span>
            <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span>
            <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
            <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span>
            <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span>
            <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">,</span>
            <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
            <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
            <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
            <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div></div>


<span class="c1">########################################</span>
<span class="c1">#       CamLOS subclasses</span>
<span class="c1">########################################</span>

<span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">Rays</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span>


<div class="viewcode-block" id="CamLOS1D"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CamLOS1D">[docs]</a><span class="k">class</span> <span class="nc">CamLOS1D</span><span class="p">(</span><span class="n">Rays</span><span class="p">):</span>
<div class="viewcode-block" id="CamLOS1D.get_summary"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CamLOS1D.get_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">just</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span>
        <span class="n">table_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># Prepare</span>
        <span class="n">kout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kOut&quot;</span><span class="p">]</span>
        <span class="n">indout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;indout&quot;</span><span class="p">]</span>
        <span class="n">lS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dconfig</span><span class="p">[</span><span class="s2">&quot;Config&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lStruct</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;vperp&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># ar0</span>
        <span class="n">col0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nb. los&quot;</span><span class="p">,</span> <span class="s2">&quot;av. length&quot;</span><span class="p">,</span> <span class="s2">&quot;min length&quot;</span><span class="p">,</span> <span class="s2">&quot;max length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nb. touch&quot;</span><span class="p">,</span> <span class="s2">&quot;av. angle&quot;</span><span class="p">,</span> <span class="s2">&quot;min angle&quot;</span><span class="p">,</span> <span class="s2">&quot;max angle&quot;</span><span class="p">]</span>
        <span class="n">ar0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">kout</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">kout</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">kout</span><span class="p">)),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">col0</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">]</span>
            <span class="n">ar0</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">],</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_param&#39;</span><span class="p">],</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">4</span><span class="p">))]</span>

        <span class="c1"># ar1</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;los index&quot;</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;touch&quot;</span><span class="p">,</span> <span class="s2">&quot;angle (rad)&quot;</span><span class="p">]</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">kout</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">,</span> <span class="n">lS</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">indout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">col1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ar1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ar1</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>

        <span class="c1"># call base method</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ar0</span><span class="p">,</span> <span class="n">ar1</span><span class="p">],</span>
            <span class="p">[</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">],</span>
            <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
            <span class="n">table_sep</span><span class="o">=</span><span class="n">table_sep</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">return_</span><span class="o">=</span><span class="n">return_</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Operator defined only for same-class operations !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Operation only valid if objects have identical (Diag, Exp) !&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Operation only valid if objects have identical config !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">Name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">+</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">D</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">u</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">dgeom</span><span class="o">=</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">u</span><span class="p">),</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">Name</span><span class="o">=</span><span class="n">Name</span><span class="p">,</span>
            <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span>
            <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="CamLOS1D.save_to_imas"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CamLOS1D.save_to_imas">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_imas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">refshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">refrun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">database</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">restore_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">config_description_2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">config_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span> <span class="nn">tofu.imas2tofu</span> <span class="k">as</span> <span class="nn">_tfimas</span>

        <span class="n">_tfimas</span><span class="o">.</span><span class="n">_save_to_imas</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">tfversion</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
            <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span>
            <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span>
            <span class="n">refshot</span><span class="o">=</span><span class="n">refshot</span><span class="p">,</span>
            <span class="n">refrun</span><span class="o">=</span><span class="n">refrun</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">database</span><span class="o">=</span><span class="n">database</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
            <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span>
            <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span>
            <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">,</span>
            <span class="n">restore_size</span><span class="o">=</span><span class="n">restore_size</span><span class="p">,</span>
            <span class="n">config_description_2d</span><span class="o">=</span><span class="n">config_description_2d</span><span class="p">,</span>
            <span class="n">config_occ</span><span class="o">=</span><span class="n">config_occ</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<span class="n">lp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;dX12&quot;</span><span class="p">]</span>
<span class="n">CamLOS1D</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">lp</span><span class="p">)</span>


<div class="viewcode-block" id="CamLOS2D"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CamLOS2D">[docs]</a><span class="k">class</span> <span class="nc">CamLOS2D</span><span class="p">(</span><span class="n">Rays</span><span class="p">):</span>
<div class="viewcode-block" id="CamLOS2D.get_summary"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CamLOS2D.get_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;  &quot;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
        <span class="n">just</span><span class="o">=</span><span class="s2">&quot;l&quot;</span><span class="p">,</span>
        <span class="n">table_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">return_</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># Prepare</span>
        <span class="n">kout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;kOut&quot;</span><span class="p">]</span>
        <span class="n">indout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;indout&quot;</span><span class="p">]</span>
        <span class="c1"># lS = self._dconfig[&quot;Config&quot;].lStruct</span>
        <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;vperp&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># ar0</span>
        <span class="n">col0</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nb. los&quot;</span><span class="p">,</span> <span class="s2">&quot;av. length&quot;</span><span class="p">,</span> <span class="s2">&quot;min length&quot;</span><span class="p">,</span> <span class="s2">&quot;max length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nb. touch&quot;</span><span class="p">,</span> <span class="s2">&quot;av. angle&quot;</span><span class="p">,</span> <span class="s2">&quot;min angle&quot;</span><span class="p">,</span> <span class="s2">&quot;max angle&quot;</span><span class="p">]</span>
        <span class="n">ar0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nRays</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">kout</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">kout</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">kout</span><span class="p">)),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span>
            <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">angles</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">col0</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">]</span>
            <span class="n">ar0</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move&#39;</span><span class="p">],</span>
                    <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;move_param&#39;</span><span class="p">],</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">4</span><span class="p">))]</span>

        <span class="c1"># call base method</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">(</span>
            <span class="p">[</span><span class="n">ar0</span><span class="p">],</span>
            <span class="p">[</span><span class="n">col0</span><span class="p">],</span>
            <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span>
            <span class="n">table_sep</span><span class="o">=</span><span class="n">table_sep</span><span class="p">,</span>
            <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
            <span class="n">return_</span><span class="o">=</span><span class="n">return_</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CamLOS2D._isImage"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CamLOS2D._isImage">[docs]</a>    <span class="k">def</span> <span class="nf">_isImage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;isImage&quot;</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dX12</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;geom&quot;</span><span class="p">:</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s2">&quot;dX12&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span>
        <span class="k">return</span> <span class="n">dX12</span>

<div class="viewcode-block" id="CamLOS2D.get_X12plot"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._core.CamLOS2D.get_X12plot">[docs]</a>    <span class="k">def</span> <span class="nf">get_X12plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="s2">&quot;imshow&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="s2">&quot;imshow&quot;</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dX12</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dX12</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span>
            <span class="n">x1min</span><span class="p">,</span> <span class="n">Dx1min</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x1max</span><span class="p">,</span> <span class="n">Dx1max</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">x2min</span><span class="p">,</span> <span class="n">Dx2min</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x2max</span><span class="p">,</span> <span class="n">Dx2max</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">x1min</span> <span class="o">-</span> <span class="n">Dx1min</span><span class="p">,</span>
                <span class="n">x1max</span> <span class="o">+</span> <span class="n">Dx1max</span><span class="p">,</span>
                <span class="n">x2min</span> <span class="o">-</span> <span class="n">Dx2min</span><span class="p">,</span>
                <span class="n">x2max</span> <span class="o">+</span> <span class="n">Dx2max</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">indr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dX12</span><span class="p">[</span><span class="s2">&quot;indr&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">indr</span><span class="p">,</span> <span class="n">extent</span></div>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    def set_e12(self, e1=None, e2=None):</span>
<span class="sd">        assert e1 is None or (hasattr(e1,&#39;__iter__&#39;) and len(e1)==3)</span>
<span class="sd">        assert e2 is None or (hasattr(e2,&#39;__iter__&#39;) and len(e2)==3)</span>
<span class="sd">        if e1 is None:</span>
<span class="sd">            e1 = self._dgeom[&#39;e1&#39;]</span>
<span class="sd">        else:</span>
<span class="sd">            e1 = np.asarray(e1).astype(float).ravel()</span>
<span class="sd">        e1 = e1 / np.linalg.norm(e1)</span>
<span class="sd">        if e2 is None:</span>
<span class="sd">            e2 = self._dgeom[&#39;e2&#39;]</span>
<span class="sd">        else:</span>
<span class="sd">            e2 = np.asarray(e1).astype(float).ravel()</span>
<span class="sd">        e2 = e2 / np.linalg.norm(e2)</span>
<span class="sd">        assert np.abs(np.sum(e1*self._dgeom[&#39;nIn&#39;]))&lt;1.e-12</span>
<span class="sd">        assert np.abs(np.sum(e2*self._dgeom[&#39;nIn&#39;]))&lt;1.e-12</span>
<span class="sd">        assert np.abs(np.sum(e1*e2))&lt;1.e-12</span>
<span class="sd">        self._dgeom[&#39;e1&#39;] = e1</span>
<span class="sd">        self._dgeom[&#39;e2&#39;] = e2</span>

<span class="sd">    def get_ind_flatimg(self, direction=&#39;flat2img&#39;):</span>
<span class="sd">        assert direction in [&#39;flat2img&#39;,&#39;img2flat&#39;]</span>
<span class="sd">        assert self._dgeom[&#39;ddetails&#39;] is not None</span>
<span class="sd">        assert all([ss in self._dgeom[&#39;ddetails&#39;].keys()</span>
<span class="sd">                    for ss in [&#39;x12&#39;,&#39;x1&#39;,&#39;x2&#39;]])</span>
<span class="sd">        x1b = 0.5*(self._dgeom[&#39;ddetails&#39;][&#39;x1&#39;][1:]</span>
<span class="sd">                   + self._dgeom[&#39;ddetails&#39;][&#39;x1&#39;][:-1])</span>
<span class="sd">        x2b = 0.5*(self._dgeom[&#39;ddetails&#39;][&#39;x2&#39;][1:]</span>
<span class="sd">                   + self._dgeom[&#39;ddetails&#39;][&#39;x2&#39;][:-1])</span>
<span class="sd">        ind = np.array([np.digitize(self._dgeom[&#39;ddetails&#39;][&#39;x12&#39;][0,:], x1b),</span>
<span class="sd">                        np.digitize(self._dgeom[&#39;ddetails&#39;][&#39;x12&#39;][0,:], x2b)])</span>
<span class="sd">        if direction == &#39;flat2img&#39;:</span>
<span class="sd">            indr = np.zeros((self._dgeom[&#39;ddetails&#39;][&#39;x1&#39;].size,</span>
<span class="sd">                             self._dgeom[&#39;ddetails&#39;][&#39;x2&#39;].size),dtype=int)</span>
<span class="sd">            indr[ind[0,:],ind[1,:]] = np.arange(0,self._dgeom[&#39;nRays&#39;])</span>
<span class="sd">            ind = indr</span>
<span class="sd">        return ind</span>

<span class="sd">    def get_X12(self, out=&#39;imshow&#39;):</span>

<span class="sd">        if out == &#39;imshow&#39;:</span>
<span class="sd">            x1, x2 = self._dgeom[&#39;x1&#39;], self._dgeom[&#39;x2&#39;]</span>
<span class="sd">            dx1, dx2 = 0.5*(x1[1]-x1[0]), 0.5*(x2[1]-x2[0])</span>
<span class="sd">            extent = (x1[0]-dx1, x1[-1]+dx1, x2[0]-dx2, x2[-1]+dx2)</span>
<span class="sd">            return x1, x2, extent</span>

<span class="sd">        # TBF</span>
<span class="sd">        if self._X12 is None:</span>
<span class="sd">            Ds = self.D</span>
<span class="sd">            C = np.mean(Ds,axis=1)</span>
<span class="sd">            X12 = Ds-C[:,np.newaxis]</span>
<span class="sd">            X12 = np.array([np.sum(X12*self._dgeom[&#39;e1&#39;][:,np.newaxis],axis=0),</span>
<span class="sd">                            np.sum(X12*self._dgeom[&#39;e2&#39;][:,np.newaxis],axis=0)])</span>
<span class="sd">        else:</span>
<span class="sd">            X12 = self._X12</span>
<span class="sd">        if X12 is None or out.lower()==&#39;1d&#39;:</span>
<span class="sd">            DX12 = None</span>
<span class="sd">        else:</span>
<span class="sd">            x1u, x2u, ind, DX12 = utils.get_X12fromflat(X12)</span>
<span class="sd">            if out.lower()==&#39;2d&#39;:</span>
<span class="sd">                X12 = [x1u, x2u, ind]</span>
<span class="sd">        return X12, DX12</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<span class="n">lp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">CamLOS2D</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">lp</span><span class="p">)</span>


<span class="sd">&quot;&quot;&quot; Return the indices or instances of all LOS matching criteria</span>

<span class="sd">The selection can be done according to 2 different mechanisms</span>

<span class="sd">Mechanism (1): provide the value (Val) a criterion (Crit) should match</span>
<span class="sd">The criteria are typically attributes of :class:`~tofu.pathfile.ID`</span>
<span class="sd">(i.e.: name, or user-defined attributes like the camera head...)</span>

<span class="sd">Mechanism (2): (used if Val=None)</span>
<span class="sd">Provide a str expression (or a list of such) to be fed to eval()</span>
<span class="sd">Used to check on quantitative criteria.</span>
<span class="sd">    - PreExp: placed before the criterion value (e.g.: &#39;not &#39; or &#39;&lt;=&#39;)</span>
<span class="sd">    - PostExp: placed after the criterion value</span>
<span class="sd">    - you can use both</span>

<span class="sd">Other parameters are used to specify logical operators for the selection</span>
<span class="sd">(match any or all the criterion...) and the type of output.</span>

<span class="sd">Parameters</span>
<span class="sd">----------</span>
<span class="sd">Crit :      str</span>
<span class="sd">    Flag indicating which criterion to use for discrimination</span>
<span class="sd">    Can be set to:</span>
<span class="sd">        - any attribute of :class:`~tofu.pathfile.ID`</span>
<span class="sd">    A str (or list of such) expression to be fed to eval()</span>
<span class="sd">    Placed after the criterion value</span>
<span class="sd">    Used for selection mechanism (2)</span>
<span class="sd">Log :       str</span>
<span class="sd">    Flag indicating whether the criterion shall match:</span>
<span class="sd">        - &#39;all&#39;: all provided values</span>
<span class="sd">        - &#39;any&#39;: at least one of them</span>
<span class="sd">InOut :     str</span>
<span class="sd">    Flag indicating whether the returned indices are:</span>
<span class="sd">        - &#39;In&#39;: the ones matching the criterion</span>
<span class="sd">        - &#39;Out&#39;: the ones not matching it</span>
<span class="sd">Out :       type / str</span>
<span class="sd">    Flag indicating in which form to return the result:</span>
<span class="sd">        - int: as an array of integer indices</span>
<span class="sd">        - bool: as an array of boolean indices</span>
<span class="sd">        - &#39;Name&#39;: as a list of names</span>
<span class="sd">        - &#39;LOS&#39;: as a list of :class:`~tofu.geom.LOS` instances</span>

<span class="sd">Returns</span>
<span class="sd">-------</span>
<span class="sd">ind :       list / np.ndarray</span>
<span class="sd">    The computed output, of nature defined by parameter Out</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">&gt;&gt;&gt; import tofu.geom as tfg</span>
<span class="sd">&gt;&gt;&gt; VPoly, VLim = [[0.,1.,1.,0.],[0.,0.,1.,1.]], [-1.,1.]</span>
<span class="sd">&gt;&gt;&gt; V = tfg.Ves(&#39;ves&#39;, VPoly, Lim=VLim, Type=&#39;Lin&#39;, Exp=&#39;Misc&#39;, shot=0)</span>
<span class="sd">&gt;&gt;&gt; Du1 = ([0.,-0.1,-0.1],[0.,1.,1.])</span>
<span class="sd">&gt;&gt;&gt; Du2 = ([0.,-0.1,-0.1],[0.,0.5,1.])</span>
<span class="sd">&gt;&gt;&gt; Du3 = ([0.,-0.1,-0.1],[0.,1.,0.5])</span>
<span class="sd">&gt;&gt;&gt; l1 = tfg.LOS(&#39;l1&#39;, Du1, Ves=V, Exp=&#39;Misc&#39;, Diag=&#39;A&#39;, shot=0)</span>
<span class="sd">&gt;&gt;&gt; l2 = tfg.LOS(&#39;l2&#39;, Du2, Ves=V, Exp=&#39;Misc&#39;, Diag=&#39;A&#39;, shot=1)</span>
<span class="sd">&gt;&gt;&gt; l3 = tfg.LOS(&#39;l3&#39;, Du3, Ves=V, Exp=&#39;Misc&#39;, Diag=&#39;B&#39;, shot=1)</span>
<span class="sd">&gt;&gt;&gt; gl = tfg.GLOS(&#39;gl&#39;, [l1,l2,l3])</span>
<span class="sd">&gt;&gt;&gt; Arg1 = dict(Val=[&#39;l1&#39;,&#39;l3&#39;],Log=&#39;any&#39;,Out=&#39;LOS&#39;)</span>
<span class="sd">&gt;&gt;&gt; Arg2 = dict(Val=[&#39;l1&#39;,&#39;l3&#39;],Log=&#39;any&#39;,InOut=&#39;Out&#39;,Out=int)</span>
<span class="sd">&gt;&gt;&gt; Arg3 = dict(Crit=&#39;Diag&#39;, Val=&#39;A&#39;, Out=&#39;Name&#39;)</span>
<span class="sd">&gt;&gt;&gt; Arg4 = dict(Crit=&#39;shot&#39;, PostExp=&#39;&gt;=1&#39;)</span>
<span class="sd">&gt;&gt;&gt; gl.select(**Arg1)</span>
<span class="sd">[l1,l3]</span>
<span class="sd">&gt;&gt;&gt; gl.select(**Arg2)</span>
<span class="sd">array([1])</span>
<span class="sd">&gt;&gt;&gt; gl.select(**Arg3)</span>
<span class="sd">[&#39;l1&#39;,&#39;l2&#39;]</span>
<span class="sd">&gt;&gt;&gt; gl.select(**Arg4)</span>
<span class="sd">array([False, True, True], dtype=bool)</span>

<span class="sd">&quot;&quot;&quot;</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on Nov 15, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>