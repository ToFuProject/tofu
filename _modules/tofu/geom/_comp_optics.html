<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.geom._comp_optics &#8212; Tofu 1.4.15</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.15</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../contributing.html">Contributing</a></li>
                <li><a href="../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../aboutus.html">About</a></li>
                <li><a href="../../../releases.html">Releases</a></li>
                <li><a href="../../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.geom._comp_optics</h1><div class="highlight"><pre>
<span></span>

<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">scpinterp</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">scpstats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="n">_LTYPES</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float_</span><span class="p">]</span>
<span class="n">_USE_NON_PARALLELISM</span> <span class="o">=</span> <span class="kc">True</span>


<span class="c1"># ###############################################</span>
<span class="c1">#           utility</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="_check_bool"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics._check_bool">[docs]</a><span class="k">def</span> <span class="nf">_check_bool</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">vardef</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">vardef</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Arg </span><span class="si">{}</span><span class="s2"> must be a bool</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;  You provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">var</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">var</span></div>


<div class="viewcode-block" id="_are_broadcastable"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics._are_broadcastable">[docs]</a><span class="k">def</span> <span class="nf">_are_broadcastable</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>

    <span class="c1"># Check if broadcastable</span>
    <span class="n">lv</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwdargs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
        <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">lv</span><span class="p">])</span>
        <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span>
            <span class="nb">all</span><span class="p">([</span>
                <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vv</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="p">])</span>
            <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">lv</span>
        <span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># raise Exception if strict</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;All args must be broadcastable with each other!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;You provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">.shape = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">v0</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">kwdargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">])</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>


<span class="c1"># ###############################################</span>
<span class="c1"># ###############################################</span>
<span class="c1">#           CrystalBragg</span>
<span class="c1"># ###############################################</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="_checkformat_xixj"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics._checkformat_xixj">[docs]</a><span class="k">def</span> <span class="nf">_checkformat_xixj</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">xi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">xj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Arg xi and xj must be provided!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- xi: </span><span class="si">{</span><span class="n">xi</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- xj: </span><span class="si">{</span><span class="n">xj</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">xj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xi</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">xj</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span>
            <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s1">&#39;ij&#39;</span><span class="p">,</span>
        <span class="p">)</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           sampling</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="_check_dthetapsi"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics._check_dthetapsi">[docs]</a><span class="k">def</span> <span class="nf">_check_dthetapsi</span><span class="p">(</span>
    <span class="n">dtheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extenthalf_psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extenthalf_dtheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ntheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npsi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">include_summit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="n">dtheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">psi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># if envelop =&gt; get all points around cryst + summit</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">vv</span> <span class="o">==</span> <span class="s1">&#39;envelop&#39;</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtheta</span><span class="p">,</span> <span class="n">psi</span><span class="p">]]):</span>
        <span class="n">psi</span><span class="p">,</span> <span class="n">dtheta</span> <span class="o">=</span> <span class="n">CrystBragg_sample_outline_sphrect</span><span class="p">(</span>
            <span class="n">extenthalf_psi</span><span class="p">,</span> <span class="n">extenthalf_dtheta</span><span class="p">,</span>
            <span class="n">npsi</span><span class="o">=</span><span class="n">npsi</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="n">ntheta</span><span class="p">,</span>
            <span class="n">include_summit</span><span class="o">=</span><span class="n">include_summit</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">c0</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span>
        <span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">_LTYPES</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dtheta</span><span class="p">,</span> <span class="n">psi</span><span class="p">]</span>
    <span class="p">])</span>

    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">psi</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">dtheta</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;dtheta and psi should have the same shape</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- dtheta.shape = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dtheta</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- psi.shape = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psi</span></div>


<div class="viewcode-block" id="CrystBragg_sample_outline_sphrect"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.CrystBragg_sample_outline_sphrect">[docs]</a><span class="k">def</span> <span class="nf">CrystBragg_sample_outline_sphrect</span><span class="p">(</span>
    <span class="n">extent_psi</span><span class="p">,</span> <span class="n">extent_dtheta</span><span class="p">,</span>
    <span class="n">npsi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">include_summit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># check inputs</span>
    <span class="k">if</span> <span class="n">include_summit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">include_summit</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">ntheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ntheta</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">npsi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">npsi</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># compute</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">extent_psi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">npsi</span><span class="p">)</span>
    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">extent_dtheta</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">ntheta</span><span class="p">)</span>
    <span class="n">psimin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">ntheta</span><span class="p">,),</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">psimax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">ntheta</span><span class="p">,),</span> <span class="n">psi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dthetamin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npsi</span><span class="p">,),</span> <span class="n">dtheta</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dthetamax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npsi</span><span class="p">,),</span> <span class="n">dtheta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">psi</span><span class="p">,</span> <span class="n">psimax</span><span class="p">,</span> <span class="n">psi</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">psimin</span><span class="p">))</span>
    <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dthetamin</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">dthetamax</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">include_summit</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">psi</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">dtheta</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">psi</span><span class="p">,</span> <span class="n">dtheta</span></div>


<div class="viewcode-block" id="CrystBragg_get_noute1e2_from_psitheta"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.CrystBragg_get_noute1e2_from_psitheta">[docs]</a><span class="k">def</span> <span class="nf">CrystBragg_get_noute1e2_from_psitheta</span><span class="p">(</span>
    <span class="n">nout</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span>
    <span class="n">psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">e1e2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sameshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extenthalf_psi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extenthalf_dtheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ntheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npsi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">include_summit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># check inputs</span>
    <span class="k">if</span> <span class="n">e1e2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">e1e2</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">sameshape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sameshape</span> <span class="o">=</span> <span class="n">psi</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">nout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">sameshape</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">psi</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">nout</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="n">dtheta</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">_check_dthetapsi</span><span class="p">(</span>
        <span class="n">dtheta</span><span class="o">=</span><span class="n">dtheta</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="n">psi</span><span class="p">,</span>
        <span class="n">extenthalf_psi</span><span class="o">=</span><span class="n">extenthalf_psi</span><span class="p">,</span>
        <span class="n">extenthalf_dtheta</span><span class="o">=</span><span class="n">extenthalf_dtheta</span><span class="p">,</span>
        <span class="n">ntheta</span><span class="o">=</span><span class="n">ntheta</span><span class="p">,</span> <span class="n">npsi</span><span class="o">=</span><span class="n">npsi</span><span class="p">,</span>
        <span class="n">include_summit</span><span class="o">=</span><span class="n">include_summit</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Prepare</span>
    <span class="k">if</span> <span class="n">sameshape</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">psi</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">psi</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nout</span> <span class="o">=</span> <span class="n">nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">psi</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">nout</span> <span class="o">=</span> <span class="n">nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">psi</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">nout</span> <span class="o">=</span> <span class="n">nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nout</span> <span class="o">=</span> <span class="n">nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">e2</span> <span class="o">=</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># Not necessary for broadcasting (last dims first)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">dtheta</span>  <span class="c1"># + np.pi/2.</span>
    <span class="c1"># psi = psi[None, ...]</span>

    <span class="c1"># Compute</span>
    <span class="c1"># vout = (</span>
    <span class="c1"># (np.cos(psi)*nout + np.sin(psi)*e1)*np.sin(theta) + np.cos(theta)*e2</span>
    <span class="c1"># )</span>
    <span class="n">vout</span> <span class="o">=</span> <span class="p">(</span>
         <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="n">nout</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span>
         <span class="p">)</span>
    <span class="k">if</span> <span class="n">e1e2</span><span class="p">:</span>
        <span class="n">ve1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="n">nout</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span>
        <span class="n">ve2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vout</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">ve1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">vout</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">ve1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
                        <span class="n">vout</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">ve1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">vout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">ve1</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
                        <span class="n">vout</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">ve1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">-</span> <span class="n">vout</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">ve1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">...</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">vout</span><span class="p">,</span> <span class="n">ve1</span><span class="p">,</span> <span class="n">ve2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vout</span></div>


<div class="viewcode-block" id="CrystBragg_sample_outline_plot_sphrect"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.CrystBragg_sample_outline_plot_sphrect">[docs]</a><span class="k">def</span> <span class="nf">CrystBragg_sample_outline_plot_sphrect</span><span class="p">(</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">nout</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span>
    <span class="n">rcurve</span><span class="p">,</span> <span class="n">extenthalf</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get the set of points in (x, y, z) coordinates sampling the crystal</span>
<span class="sd">    outline</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check inputs</span>
    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">extenthalf</span><span class="p">)</span><span class="o">/</span><span class="mf">5.</span>

    <span class="c1"># compute</span>
    <span class="n">npsi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">extenthalf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">res</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">ntheta</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">extenthalf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">res</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">psi</span><span class="p">,</span> <span class="n">dtheta</span> <span class="o">=</span> <span class="n">CrystBragg_sample_outline_sphrect</span><span class="p">(</span>
        <span class="n">extenthalf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">extenthalf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">npsi</span><span class="o">=</span><span class="n">npsi</span><span class="p">,</span> <span class="n">ntheta</span><span class="o">=</span><span class="n">ntheta</span><span class="p">,</span>
        <span class="n">include_summit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">vout</span> <span class="o">=</span> <span class="n">CrystBragg_get_noute1e2_from_psitheta</span><span class="p">(</span>
        <span class="n">nout</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span>
        <span class="n">e1e2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sameshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">center</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">rcurve</span><span class="o">*</span><span class="n">vout</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           lamb &lt;=&gt; bragg</span>
<span class="c1"># ###############################################</span>

<div class="viewcode-block" id="get_bragg_from_lamb"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_bragg_from_lamb">[docs]</a><span class="k">def</span> <span class="nf">get_bragg_from_lamb</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; n*lamb = 2d*sin(bragg)</span>
<span class="sd">    The angle bragg is defined as the angle of incidence of the emissed photon</span>
<span class="sd">    vector and the crystal mesh, and not the crystal dioptre.</span>
<span class="sd">    For record, both are parallel and coplanar when is defined parallelism</span>
<span class="sd">    into the crystal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">bragg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">lamb</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">sin</span> <span class="o">=</span> <span class="n">n</span><span class="o">*</span><span class="n">lamb</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>
    <span class="n">indok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sin</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.</span>
    <span class="n">bragg</span><span class="p">[</span><span class="n">indok</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">sin</span><span class="p">[</span><span class="n">indok</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">bragg</span></div>


<div class="viewcode-block" id="get_lamb_from_bragg"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_lamb_from_bragg">[docs]</a><span class="k">def</span> <span class="nf">get_lamb_from_bragg</span><span class="p">(</span><span class="n">bragg</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; n*lamb = 2d*sin(bragg)</span>
<span class="sd">    The angle bragg is defined as the angle of incidence of the emissed photon</span>
<span class="sd">    vector and the crystal mesh, and not the crystal dioptre.</span>
<span class="sd">    For record, both are parallel and coplanar when is defined parallelism</span>
<span class="sd">    into the crystal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           vectors &lt;=&gt; angles</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="get_vectors_from_angles"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_vectors_from_angles">[docs]</a><span class="k">def</span> <span class="nf">get_vectors_from_angles</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">nout</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return new unit vectors according to alpha and beta entries from user</span>
<span class="sd">    caused by the non parallelism assumed on the crystal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">e1_bis</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">nout</span>
    <span class="p">)</span>

    <span class="n">e2_bis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span>

    <span class="n">nout_bis</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="n">nout</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">nin_bis</span> <span class="o">=</span> <span class="o">-</span><span class="n">nout_bis</span>

    <span class="k">return</span> <span class="n">nin_bis</span><span class="p">,</span> <span class="n">nout_bis</span><span class="p">,</span> <span class="n">e1_bis</span><span class="p">,</span> <span class="n">e2_bis</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           Approximate solution</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="get_rowland_dist_from_bragg"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_rowland_dist_from_bragg">[docs]</a><span class="k">def</span> <span class="nf">get_rowland_dist_from_bragg</span><span class="p">(</span><span class="n">bragg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcurve</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rcurve</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_approx_detector_rel"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_approx_detector_rel">[docs]</a><span class="k">def</span> <span class="nf">get_approx_detector_rel</span><span class="p">(</span><span class="n">rcurve</span><span class="p">,</span> <span class="n">bragg</span><span class="p">,</span>
                            <span class="n">braggref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xiref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">bragg01</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dist01</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">tangent_to_rowland</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return the approximative detector position on the Rowland circle</span>
<span class="sd">    relatively to the Bragg crystal.</span>
<span class="sd">    Possibility to define tangential position of the detector to the Rowland</span>
<span class="sd">    circle or not.</span>
<span class="sd">    On WEST, the maximum non-parallelism between two halves can be up to few</span>
<span class="sd">    arcmin so here, doesn&#39;t need to define the precise location of the detector</span>
<span class="sd">    The bragg angle is provided and naturally defined as the angle between the</span>
<span class="sd">    emissed photon vector and the crystal mesh.</span>
<span class="sd">    So, if non parallelism approuved, bragg is relative</span>
<span class="sd">    to the vector basis dmat(nout,e1,e2).</span>
<span class="sd">    The position of the detector, relatively to the crystal, will be so in</span>
<span class="sd">    another Rowland circle with its center shifted from the original one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">tangent_to_rowland</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tangent_to_rowland</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># distance crystal - det_center</span>
    <span class="c1"># bragg between incident vector and mesh</span>
    <span class="n">det_dist</span> <span class="o">=</span> <span class="n">rcurve</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span>

    <span class="c1"># det_nout and det_e1 in (nout, e1, e2) (det_e2 = e2)</span>
    <span class="n">n_crystdet_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bragg</span><span class="p">),</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tangent_to_rowland</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">bragg2</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">bragg</span>
        <span class="n">det_nout_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bragg2</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg2</span><span class="p">),</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">det_ei_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg2</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bragg2</span><span class="p">),</span> <span class="mf">0.</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">det_nout_rel</span> <span class="o">=</span> <span class="o">-</span><span class="n">n_crystdet_rel</span>
        <span class="n">det_ei_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bragg</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># update with bragg01 and dist01</span>
    <span class="k">if</span> <span class="n">bragg01</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">bragg01</span><span class="p">))</span>
        <span class="c1"># h = l1 tan(theta1) = l2 tan(theta2)</span>
        <span class="c1"># l = l2 (tan(theta1) + tan(theta2)) / tan(theta1)</span>
        <span class="c1"># l = l2 / cos(theta2)</span>
        <span class="c1"># l = l tan(theta1) / (cos(theta2) * (tan(theta1) + tan(theta2)))</span>
        <span class="n">theta2</span> <span class="o">=</span> <span class="n">bragg</span> <span class="k">if</span> <span class="n">tangent_to_rowland</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bragg</span><span class="o">-</span><span class="n">bragg01</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tan1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span>
        <span class="n">d0</span> <span class="o">=</span> <span class="n">det_dist</span> <span class="o">*</span> <span class="n">tan1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">tan1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta2</span><span class="p">)))</span>
        <span class="n">theta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bragg</span><span class="o">-</span><span class="n">bragg01</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">tan1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta1</span><span class="p">)</span>
        <span class="n">d1</span> <span class="o">=</span> <span class="n">det_dist</span> <span class="o">*</span> <span class="n">tan1</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">tan1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">theta2</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">bragg01</span><span class="o">-</span><span class="n">bragg</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">d01</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d0</span> <span class="o">-</span> <span class="n">d1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d01</span> <span class="o">=</span> <span class="n">d0</span> <span class="o">+</span> <span class="n">d1</span>
        <span class="n">det_dist</span> <span class="o">=</span> <span class="n">det_dist</span> <span class="o">*</span> <span class="n">dist01</span> <span class="o">/</span> <span class="n">d01</span>

    <span class="k">return</span> <span class="n">det_dist</span><span class="p">,</span> <span class="n">n_crystdet_rel</span><span class="p">,</span> <span class="n">det_nout_rel</span><span class="p">,</span> <span class="n">det_ei_rel</span></div>


<div class="viewcode-block" id="get_det_abs_from_rel"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_det_abs_from_rel">[docs]</a><span class="k">def</span> <span class="nf">get_det_abs_from_rel</span><span class="p">(</span><span class="n">det_dist</span><span class="p">,</span> <span class="n">n_crystdet_rel</span><span class="p">,</span> <span class="n">det_nout_rel</span><span class="p">,</span> <span class="n">det_ei_rel</span><span class="p">,</span>
                         <span class="n">summit</span><span class="p">,</span> <span class="n">nout</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">,</span>
                         <span class="n">ddist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">di</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">dtheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dpsi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return the absolute detector position, according to tokamak&#39;s frame,</span>
<span class="sd">    on the Rowland circle from its relative position to the Bragg crystal.</span>
<span class="sd">    If non parallelism approuved, bragg is relative to the vector basis</span>
<span class="sd">    dmat(nout,e1,e2).</span>
<span class="sd">    The position of the detector, relatively to the crystal, will be so in</span>
<span class="sd">    another Rowland circle with its center shifted from the original one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Reference on detector</span>
    <span class="n">det_nout</span> <span class="o">=</span> <span class="p">(</span><span class="n">det_nout_rel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nout</span>
                <span class="o">+</span> <span class="n">det_nout_rel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">e1</span> <span class="o">+</span> <span class="n">det_nout_rel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">e2</span><span class="p">)</span>
    <span class="n">det_ei</span> <span class="o">=</span> <span class="p">(</span><span class="n">det_ei_rel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nout</span>
                <span class="o">+</span> <span class="n">det_ei_rel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">e1</span> <span class="o">+</span> <span class="n">det_ei_rel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">e2</span><span class="p">)</span>
    <span class="n">det_ej</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">det_nout</span><span class="p">,</span> <span class="n">det_ei</span><span class="p">)</span>

    <span class="c1"># Apply translation of center (ddist, di, dj)</span>
    <span class="k">if</span> <span class="n">ddist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ddist</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">di</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">di</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">dj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dj</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">det_dist</span> <span class="o">+=</span> <span class="n">ddist</span>

    <span class="n">n_crystdet</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_crystdet_rel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nout</span>
                  <span class="o">+</span> <span class="n">n_crystdet_rel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">e1</span> <span class="o">+</span> <span class="n">n_crystdet_rel</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">e2</span><span class="p">)</span>
    <span class="n">det_cent</span> <span class="o">=</span> <span class="n">summit</span> <span class="o">+</span> <span class="n">det_dist</span><span class="o">*</span><span class="n">n_crystdet</span> <span class="o">+</span> <span class="n">di</span><span class="o">*</span><span class="n">det_ei</span> <span class="o">+</span> <span class="n">dj</span><span class="o">*</span><span class="n">det_ej</span>

    <span class="c1"># Apply angles on unit vectors with respect to themselves</span>
    <span class="k">if</span> <span class="n">dtheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">dpsi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dpsi</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">tilt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tilt</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># dtheta and dpsi</span>
    <span class="n">det_nout2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span><span class="o">*</span><span class="n">det_nout</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span><span class="o">*</span><span class="n">det_ei</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dtheta</span><span class="p">)</span><span class="o">*</span><span class="n">det_ej</span>
    <span class="p">)</span>
    <span class="n">det_ei2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span><span class="o">*</span><span class="n">det_ei</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dpsi</span><span class="p">)</span><span class="o">*</span><span class="n">det_nout</span><span class="p">)</span>
    <span class="n">det_ej2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">det_nout2</span><span class="p">,</span> <span class="n">det_ei2</span><span class="p">)</span>

    <span class="c1"># tilt</span>
    <span class="n">det_ei3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span><span class="o">*</span><span class="n">det_ei2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tilt</span><span class="p">)</span><span class="o">*</span><span class="n">det_ej2</span>
    <span class="n">det_ej3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">det_nout2</span><span class="p">,</span> <span class="n">det_ei3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">det_cent</span><span class="p">,</span> <span class="n">det_nout2</span><span class="p">,</span> <span class="n">det_ei3</span><span class="p">,</span> <span class="n">det_ej3</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           Sagital / meridional focus</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="calc_meridional_sagital_focus"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.calc_meridional_sagital_focus">[docs]</a><span class="k">def</span> <span class="nf">calc_meridional_sagital_focus</span><span class="p">(</span>
    <span class="n">rcurve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bragg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">use_non_parallelism</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>

    <span class="c1"># Check input</span>
    <span class="k">if</span> <span class="n">rcurve</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bragg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Args rcurve and bragg must be provided!&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">verb</span> <span class="o">=</span> <span class="n">_check_bool</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">vardef</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;verb&#39;</span><span class="p">)</span>
    <span class="n">use_non_parallelism</span> <span class="o">=</span> <span class="n">_check_bool</span><span class="p">(</span>
        <span class="n">use_non_parallelism</span><span class="p">,</span>
        <span class="n">vardef</span><span class="o">=</span><span class="n">_USE_NON_PARALLELISM</span><span class="p">,</span>
        <span class="n">varname</span><span class="o">=</span><span class="s1">&#39;use_non_parallelism&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Compute</span>
    <span class="n">s_merid_ref</span> <span class="o">=</span> <span class="n">rcurve</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span>
    <span class="n">s_sagit_ref</span> <span class="o">=</span> <span class="o">-</span><span class="n">s_merid_ref</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">bragg</span><span class="p">)</span>

    <span class="n">s_merid_unp</span> <span class="o">=</span> <span class="n">rcurve</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>
    <span class="n">s_sagit_unp</span> <span class="o">=</span> <span class="o">-</span><span class="n">s_merid_unp</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="o">+</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

    <span class="c1"># verb</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">s_merid_ref</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sr</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">s_sagit_ref</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Assuming a perfect crystal:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- meridonal focus at </span><span class="si">{</span><span class="n">mr</span><span class="si">}</span><span class="s2"> m</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- sagittal focus at </span><span class="si">{</span><span class="n">sr</span><span class="si">}</span><span class="s2"> m</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">use_non_parallelism</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">delta_merid</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s_merid_unp</span> <span class="o">-</span> <span class="n">s_merid_ref</span><span class="p">)</span>
            <span class="n">delta_sagit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s_sagit_unp</span> <span class="o">-</span> <span class="n">s_sagit_ref</span><span class="p">)</span>
            <span class="n">mnp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">s_merid_unp</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">snp</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">s_sagit_unp</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">mca</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">delta_merid</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">sca</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">delta_sagit</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">mcr</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">100.</span> <span class="o">*</span> <span class="n">delta_merid</span> <span class="o">/</span> <span class="n">s_merid_ref</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">scr</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mf">100.</span> <span class="o">*</span> <span class="n">delta_sagit</span> <span class="o">/</span> <span class="n">s_sagit_ref</span><span class="p">,</span> <span class="n">ndigits</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Considering non-parallelism (alpha = </span><span class="si">{</span><span class="n">alpha</span><span class="si">}</span><span class="s2"> rad):</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- meridonal focus at </span><span class="si">{</span><span class="n">mnp</span><span class="si">}</span><span class="s2"> m (delta = </span><span class="si">{</span><span class="n">mca</span><span class="si">}</span><span class="s2"> m / </span><span class="si">{</span><span class="n">mcr</span><span class="si">}</span><span class="s2"> %)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- sagital focus at </span><span class="si">{</span><span class="n">snp</span><span class="si">}</span><span class="s2"> m (delta = </span><span class="si">{</span><span class="n">sca</span><span class="si">}</span><span class="s2"> m / </span><span class="si">{</span><span class="n">scr</span><span class="si">}</span><span class="s2"> %)&quot;</span>
            <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s_merid_ref</span><span class="p">,</span> <span class="n">s_sagit_ref</span><span class="p">,</span> <span class="n">s_merid_unp</span><span class="p">,</span> <span class="n">s_sagit_unp</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           Coordinates transforms</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="_checkformat_pts"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics._checkformat_pts">[docs]</a><span class="k">def</span> <span class="nf">_checkformat_pts</span><span class="p">(</span><span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;pts must be a (3, ...) array of (X, Y, Z) coordinates!&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pts</span></div>


<div class="viewcode-block" id="checkformat_vectang"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.checkformat_vectang">[docs]</a><span class="k">def</span> <span class="nf">checkformat_vectang</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">frame_cent</span><span class="p">,</span> <span class="n">frame_ang</span><span class="p">):</span>
    <span class="c1"># Check / format inputs</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">nn</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="n">nn</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>

    <span class="n">frame_cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">frame_cent</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">frame_cent</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">frame_ang</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">frame_ang</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Z</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">frame_cent</span><span class="p">,</span> <span class="n">frame_ang</span></div>


<div class="viewcode-block" id="get_e1e2_detectorplane"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_e1e2_detectorplane">[docs]</a><span class="k">def</span> <span class="nf">get_e1e2_detectorplane</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nIn</span><span class="p">):</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">nIn</span><span class="p">)</span>
    <span class="n">e1n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">e1n</span> <span class="o">&lt;</span> <span class="mf">1.e-10</span><span class="p">:</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">nIn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="n">nIn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">])</span>
        <span class="n">e1n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">/</span> <span class="n">e1n</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span> <span class="n">e1</span><span class="p">)</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">e2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span></div>


<span class="c1"># To be made cleaner vs option 0/ 1 =&gt; grid = True, False</span>
<div class="viewcode-block" id="calc_xixj_from_braggphi"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.calc_xixj_from_braggphi">[docs]</a><span class="k">def</span> <span class="nf">calc_xixj_from_braggphi</span><span class="p">(</span>
    <span class="n">det_cent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">det_nout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">det_ei</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">det_ej</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">det_outline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">summit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">bragg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">option</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Several options for shapes</span>

<span class="sd">    de_cent, det_nout, det_ei and det_ej are always of shape (3,)</span>

<span class="sd">    option:</span>
<span class="sd">        0:</span>
<span class="sd">            (summit, e1, e2).shape = (3,)</span>
<span class="sd">            (bragg, phi).shape = (nbragg,)</span>
<span class="sd">            =&gt; (xi, xj).shape = (nbragg,)</span>
<span class="sd">        1:</span>
<span class="sd">            (summit, e1, e2).shape = (3, nlamb, npts, nbragg)</span>
<span class="sd">            (bragg, phi).shape = (nlamb, npts, nbragg)</span>
<span class="sd">            =&gt; (xi, xj).shape = (nlamb, npts, nbragg)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check inputs</span>
    <span class="k">if</span> <span class="n">strict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">strict</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Check option</span>
    <span class="n">gdet</span> <span class="o">=</span> <span class="p">[</span><span class="n">det_cent</span><span class="p">,</span> <span class="n">det_nout</span><span class="p">,</span> <span class="n">det_ei</span><span class="p">,</span> <span class="n">det_ej</span><span class="p">]</span>
    <span class="n">g0</span> <span class="o">=</span> <span class="p">[</span><span class="n">summit</span><span class="p">,</span> <span class="n">nout</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">]</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="p">[</span><span class="n">bragg</span><span class="p">,</span> <span class="n">phi</span><span class="p">]</span>

    <span class="c1"># check nbroadcastable</span>
    <span class="n">_are_broadcastable</span><span class="p">(</span><span class="n">bragg</span><span class="o">=</span><span class="n">bragg</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="k">for</span> <span class="n">gg</span> <span class="ow">in</span> <span class="n">gdet</span><span class="p">]),</span> <span class="s2">&quot;gdet no broadcast!&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">gg</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">gg</span> <span class="ow">in</span> <span class="n">g0</span><span class="p">]),</span> <span class="s2">&quot;g0 no broadcast!&quot;</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">g1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="ow">and</span> <span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="ow">and</span> <span class="n">phi</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">- </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="n">vv</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;summit&#39;</span><span class="p">,</span> <span class="n">summit</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;nout&#39;</span><span class="p">,</span> <span class="n">nout</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;e1&#39;</span><span class="p">,</span> <span class="n">e1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;e2&#39;</span><span class="p">,</span> <span class="n">e2</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;bragg&#39;</span><span class="p">,</span> <span class="n">bragg</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="n">phi</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Please provide either:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- option 0:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- (summit, nout, e1, e2).shape[0] = 3</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- (bragg, phi).ndim = 1</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- option 1:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- (summit, nout, e1, e2).ndim in [4, 5]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- (bragg, phi).shape[0] = 3</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;You provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lstr</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Multiple options!&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">option</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">lc</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">summit</span> <span class="o">=</span> <span class="n">summit</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">nout</span><span class="p">,</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">nout</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">e1</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">e2</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">det_cent</span> <span class="o">=</span> <span class="n">det_cent</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">det_nout</span> <span class="o">=</span> <span class="n">det_nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">det_ei</span><span class="p">,</span> <span class="n">det_ej</span> <span class="o">=</span> <span class="n">det_ei</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">det_ej</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">summit</span><span class="p">,</span> <span class="n">nout</span> <span class="o">=</span> <span class="n">summit</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">det_cent</span> <span class="o">=</span> <span class="n">det_cent</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">det_nout</span> <span class="o">=</span> <span class="n">det_nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">det_ei</span> <span class="o">=</span> <span class="n">det_ei</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">det_ej</span> <span class="o">=</span> <span class="n">det_ej</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">g0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">det_cent</span> <span class="o">=</span> <span class="n">det_cent</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">det_nout</span> <span class="o">=</span> <span class="n">det_nout</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">det_ei</span> <span class="o">=</span> <span class="n">det_ei</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">det_ej</span> <span class="o">=</span> <span class="n">det_ej</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># Not necessary for broadcasting (last dims first)</span>
    <span class="c1"># bragg = bragg[None, ...]</span>
    <span class="c1"># phi = phi[None, ...]</span>

    <span class="c1"># Compute</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="p">(</span>
        <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span><span class="o">*</span><span class="n">nout</span>
        <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">e1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">e2</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
        <span class="p">(</span><span class="n">det_cent</span><span class="o">-</span><span class="n">summit</span><span class="p">)</span><span class="o">*</span><span class="n">det_nout</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">det_nout</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pts</span> <span class="o">=</span> <span class="n">summit</span> <span class="o">+</span> <span class="n">k</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">vect</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pts</span> <span class="o">-</span> <span class="n">det_cent</span><span class="p">)</span><span class="o">*</span><span class="n">det_ei</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">xj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pts</span> <span class="o">-</span> <span class="n">det_cent</span><span class="p">)</span><span class="o">*</span><span class="n">det_ej</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Optional: eliminate points outside the det outline</span>
    <span class="k">if</span> <span class="n">det_outline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">strict</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">xi</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">det_outline</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">xi</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">det_outline</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">xj</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">det_outline</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">xj</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">det_outline</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]))</span>
        <span class="p">)</span>
        <span class="n">xi</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">xj</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="n">strict</span></div>


<div class="viewcode-block" id="_calc_braggphi_from_pts_summits"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics._calc_braggphi_from_pts_summits">[docs]</a><span class="k">def</span> <span class="nf">_calc_braggphi_from_pts_summits</span><span class="p">(</span>
    <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">summits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ve1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ve2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># check inputs</span>
    <span class="n">_are_broadcastable</span><span class="p">(</span><span class="n">pts</span><span class="o">=</span><span class="n">pts</span><span class="p">,</span> <span class="n">summits</span><span class="o">=</span><span class="n">summits</span><span class="p">,</span> <span class="n">vin</span><span class="o">=</span><span class="n">vin</span><span class="p">,</span> <span class="n">ve1</span><span class="o">=</span><span class="n">ve1</span><span class="p">,</span> <span class="n">ve2</span><span class="o">=</span><span class="n">ve2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">summits</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Differents dimensions!&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># compute</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="n">pts</span> <span class="o">-</span> <span class="n">summits</span>
    <span class="n">vect</span> <span class="o">=</span> <span class="n">vect</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">bragg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">vin</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">bragg</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;There seems to be negative bragg angles!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;  =&gt; double-check inputs!&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">ve2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vect</span><span class="o">*</span><span class="n">ve1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bragg</span><span class="p">,</span> <span class="n">phi</span></div>


<div class="viewcode-block" id="calc_braggphi_from_xixjpts"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.calc_braggphi_from_xixjpts">[docs]</a><span class="k">def</span> <span class="nf">calc_braggphi_from_xixjpts</span><span class="p">(</span>
    <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">xi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">det</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">summit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return bragg phi for pts or (xj, xi) seen from (summit, nin, e1, e2)</span>

<span class="sd">    Either provide:</span>
<span class="sd">        pts =&gt; (3, npts)</span>
<span class="sd">        xi, xj =&gt; pts with shape (3, nxi, nxj)</span>

<span class="sd">    summit, nin, e1, e2 must have the same shape (3, nsumm)</span>

<span class="sd">    bragg.shape = (nsum, )</span>

<span class="sd">    if grid is True:</span>
<span class="sd">        all pts evaluated for all summ/nin</span>
<span class="sd">        return  (nsumm, npts) or (nsum, nxi, nxj) arrays</span>
<span class="sd">    else:</span>
<span class="sd">        each pts has a unique corresponding summ/nin (except possibly ndtheta)</span>
<span class="sd">        return (npts,) or (nxi, nxj) arrays</span>
<span class="sd">            or (npts, ndtheta) or (nxi, nxj, ndtheta) arrays</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --------------</span>
    <span class="c1"># Check format</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Either pts or (xi, xj)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">pts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="p">([</span><span class="n">xx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">xx</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">]])]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provide either pts xor (xi, xj)!&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># pts</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">_checkformat_pts</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>

        <span class="c1"># xi, xj =&gt; compute pts using det</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span>
                <span class="n">ss</span> <span class="ow">in</span> <span class="n">det</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="n">ss</span><span class="p">])</span> <span class="o">==</span> <span class="mi">3</span>
                <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cent&#39;</span><span class="p">,</span> <span class="s1">&#39;ei&#39;</span><span class="p">,</span> <span class="s1">&#39;ej&#39;</span><span class="p">]</span>
            <span class="p">])</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Arg det must be provided as a dict if xi, xj are provided!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># pts from xi, xj</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="p">(</span><span class="n">xii</span><span class="p">,</span> <span class="n">xjj</span><span class="p">)</span> <span class="o">=</span> <span class="n">_checkformat_xixj</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xii</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">xjj</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;xi and xj must have the same shape!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">xii</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">xii</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;cent&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
                   <span class="o">+</span> <span class="n">xii</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;ei&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]</span>
                   <span class="o">+</span> <span class="n">xjj</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span><span class="o">*</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;ej&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;cent&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                   <span class="o">+</span> <span class="n">xii</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;ei&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                   <span class="o">+</span> <span class="n">xjj</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">*</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;ej&#39;</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="n">c0</span> <span class="o">=</span> <span class="n">summit</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">nin</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">e1</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">e2</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;(summit, nin, e1, e2) must all have the same shape&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span>
            <span class="n">grid</span> <span class="ow">is</span> <span class="kc">True</span>
            <span class="ow">and</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">summit</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span>
            <span class="n">grid</span> <span class="ow">is</span> <span class="kc">False</span>
            <span class="ow">and</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">summit</span><span class="o">.</span><span class="n">ndim</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Args pts and summit/nin/e1/e2 must be such that:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- grid = True:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">pts.ndim in [1, 2, 3] and pts.shape[0] == 3</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">summit.ndim in [1, 2, 3, 4, 5]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- grid = False:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">pts can be directly broadcasted to summit (and same dim)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- grid: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- pts.shape = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- summit.shape = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summit</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># --------------</span>
    <span class="c1"># Prepare</span>
    <span class="c1"># This part should be re-checked for all combinations!</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_calc_braggphi_from_pts_summits</span><span class="p">(</span>
            <span class="n">pts</span><span class="o">=</span><span class="n">pts</span><span class="p">,</span>
            <span class="n">summits</span><span class="o">=</span><span class="n">summit</span><span class="p">,</span>
            <span class="n">vin</span><span class="o">=</span><span class="n">nin</span><span class="p">,</span> <span class="n">ve1</span><span class="o">=</span><span class="n">e1</span><span class="p">,</span> <span class="n">ve2</span><span class="o">=</span><span class="n">e2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Typical dim</span>
        <span class="c1"># (3, npts, nlamb, ndtheta, 2)</span>
        <span class="c1"># (3, nxi, nxj, nlamb, ndtheta, 2)</span>
        <span class="n">ptsdim</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">sumdim</span> <span class="o">=</span> <span class="n">summit</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">if</span> <span class="n">ptsdim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sumdim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">summit</span> <span class="o">=</span> <span class="n">summit</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">nin</span> <span class="o">=</span> <span class="n">nin</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">summit</span> <span class="o">=</span> <span class="n">summit</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="n">nin</span> <span class="o">=</span> <span class="n">nin</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sumdim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">summit</span> <span class="o">=</span> <span class="n">summit</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">nin</span> <span class="o">=</span> <span class="n">nin</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">summit</span> <span class="o">=</span> <span class="n">summit</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="n">nin</span> <span class="o">=</span> <span class="n">nin</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="o">=</span> <span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sumdim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">sumdim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">sumdim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">pts</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># --------------</span>
        <span class="c1"># Compute</span>
        <span class="c1"># Everything has shape (3, nxi0, nxi1, npts0, npts1) =&gt; sum on axis=0</span>
        <span class="c1"># or is broadcastable</span>
        <span class="k">return</span> <span class="n">_calc_braggphi_from_pts_summits</span><span class="p">(</span>
            <span class="n">pts</span><span class="o">=</span><span class="n">pts</span><span class="p">,</span>
            <span class="n">summits</span><span class="o">=</span><span class="n">summit</span><span class="p">,</span>
            <span class="n">vin</span><span class="o">=</span><span class="n">nin</span><span class="p">,</span> <span class="n">ve1</span><span class="o">=</span><span class="n">e1</span><span class="p">,</span> <span class="n">ve2</span><span class="o">=</span><span class="n">e2</span><span class="p">,</span>
        <span class="p">)</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           2D spectra to 1D</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="get_lambphifit"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.get_lambphifit">[docs]</a><span class="k">def</span> <span class="nf">get_lambphifit</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">nxi</span><span class="p">,</span> <span class="n">nxj</span><span class="p">):</span>
    <span class="n">lambD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>
    <span class="n">lambfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambD</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxi</span><span class="p">)</span>
    <span class="n">phiD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">phifit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">phiD</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lambfit</span><span class="p">,</span> <span class="n">phifit</span></div>


<div class="viewcode-block" id="_calc_spect1d_from_data2d"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics._calc_spect1d_from_data2d">[docs]</a><span class="k">def</span> <span class="nf">_calc_spect1d_from_data2d</span><span class="p">(</span><span class="n">ldata</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span>
                              <span class="n">nlambfit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nphifit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">spect1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">vertsum1d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Check / format inputs</span>
    <span class="k">if</span> <span class="n">spect1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spect1d</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ldata</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">ldata</span> <span class="o">=</span> <span class="p">[</span><span class="n">ldata</span><span class="p">]</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">spect1d</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">spect1d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span>
          <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">spect1d</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
           <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
                    <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">spect1d</span><span class="p">])),</span>
          <span class="n">spect1d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;cent&#39;</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">spect1d</span> <span class="o">=</span> <span class="p">[</span><span class="n">spect1d</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">lc</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">spect1d</span> <span class="o">==</span> <span class="s1">&#39;cent&#39;</span><span class="p">:</span>
            <span class="n">spect1d</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)]</span>
            <span class="n">nspect</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;spect1d must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;mean&#39;: the avearge spectrum</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;cent&#39;: the central spectrum +/- 20%</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- (target, tol); a tuple of 2 floats:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">target: the central value of the window in [-1,1]</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">tol:    the window tolerance (width) in [0,1]</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- list of (target, tol)&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nlambfit</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nphifit</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nlambfit and nphifit must be int!</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- nlambfit provided: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nlambfit</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- nphifit provided : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nphifit</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vertsum1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vertsum1d</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Compute lambfit / phifit and spectrum1d</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ldata</span><span class="p">)):</span>
            <span class="n">ldata</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">lambfit</span><span class="p">,</span> <span class="n">phifit</span> <span class="o">=</span> <span class="n">get_lambphifit</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">nlambfit</span><span class="p">,</span> <span class="n">nphifit</span><span class="p">)</span>
    <span class="n">lambfitbins</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">lambfit</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">lambfit</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="n">lambfitbins</span><span class="p">)</span>

    <span class="c1"># Get phi window</span>
    <span class="k">if</span> <span class="n">spect1d</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">phiminmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">phifit</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">phifit</span><span class="o">.</span><span class="n">max</span><span class="p">()][</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">spect1d_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">ind</span> <span class="o">==</span> <span class="n">jj</span><span class="p">])</span>
                                 <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)])[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                       <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ldata</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nspect</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spect1d</span><span class="p">)</span>
        <span class="n">dphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">phifit</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">phifit</span><span class="p">)</span>
        <span class="n">spect1d_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nspect</span><span class="p">,</span> <span class="n">lambfit</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ldata</span><span class="p">]</span>
        <span class="n">phiminmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nspect</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspect</span><span class="p">):</span>
            <span class="n">phicent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">phifit</span><span class="p">)</span> <span class="o">+</span> <span class="n">spect1d</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dphi</span><span class="o">/</span><span class="mf">2.</span>
            <span class="n">indphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">phicent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">spect1d</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dphi</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                <span class="n">indj</span> <span class="o">=</span> <span class="n">indphi</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ind</span> <span class="o">==</span> <span class="n">jj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indj</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">ij</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ldata</span><span class="p">)):</span>
                        <span class="n">spect1d_out</span><span class="p">[</span><span class="n">ij</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ldata</span><span class="p">[</span><span class="n">ij</span><span class="p">][</span><span class="n">indj</span><span class="p">])</span>
            <span class="n">phiminmax</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">indphi</span><span class="p">]),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">indphi</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">vertsum1d</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">phifitbins</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">phifit</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">phifit</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">phifitbins</span><span class="p">)</span>
        <span class="n">vertsum1d</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">ind</span> <span class="o">==</span> <span class="n">ii</span><span class="p">])</span>
                               <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ind</span><span class="p">)])</span>
                     <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ldata</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ldata</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">spect1d_out</span> <span class="o">=</span> <span class="n">spect1d_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vertsum1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">vertsum1d</span> <span class="o">=</span> <span class="n">vertsum1d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">spect1d_out</span><span class="p">,</span> <span class="n">lambfit</span><span class="p">,</span> <span class="n">phifit</span><span class="p">,</span> <span class="n">vertsum1d</span><span class="p">,</span> <span class="n">phiminmax</span></div>


<span class="c1"># ###############################################</span>
<span class="c1">#           From plasma pts</span>
<span class="c1"># ###############################################</span>


<div class="viewcode-block" id="calc_dthetapsiphi_from_lambpts"><a class="viewcode-back" href="../../../tofu.geom.html#tofu.geom._comp_optics.calc_dthetapsiphi_from_lambpts">[docs]</a><span class="k">def</span> <span class="nf">calc_dthetapsiphi_from_lambpts</span><span class="p">(</span>
    <span class="n">pts</span><span class="p">,</span>
    <span class="n">bragg</span><span class="p">,</span>
    <span class="n">summit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rcurve</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">nout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">e2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">extenthalf</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ndtheta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return (dtheta, psi) of pts on crystal where bragg diffraction happens</span>

<span class="sd">    For given pts and lamb/bragg</span>

<span class="sd">    For each pts/lamb, there may be up to 2 arcs on the crystal</span>
<span class="sd">    Only returns valid solution (inside extenthalf), with nan elsewhere</span>

<span class="sd">    psi and dtheta returned as (nlamb, npts, 2, ndtheta) arrays</span>

<span class="sd">    Here nout, e1, e2 are at the unique crystal summit!</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check input</span>
    <span class="k">if</span> <span class="n">ndtheta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ndtheta</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">npts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nlamb</span> <span class="o">=</span> <span class="n">bragg</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nlamb</span> <span class="o">!=</span> <span class="n">npts</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;If grid = False, lamb.shape should be (pts.shape[1],)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Prepare output</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">scaPCem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">angextra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">dtheta_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">psi_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">sol1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">sol2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlamb</span><span class="p">,</span> <span class="n">npts</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scaPCem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">dtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">angextra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">dtheta_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">psi_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">sol1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">sol2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">npts</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Get to scalar product scaPCem</span>
    <span class="c1"># Already ok for non-parallelism (via nout)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">summit</span> <span class="o">-</span> <span class="n">rcurve</span><span class="o">*</span><span class="n">nout</span>
    <span class="n">PC</span> <span class="o">=</span> <span class="n">center</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">pts</span>
    <span class="n">PCnorm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PC</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cos2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1"># PM.CM = Rsca + R**2  (ok)</span>
    <span class="c1"># PMCM = PMnR*sin       (ok)</span>
    <span class="c1"># PMn2 = PCn2*sin2 + 2Rsin2*sca + R2sin2</span>
    <span class="c1">#</span>
    <span class="c1"># sca**2 + 2Rcos2*sca + R2cos2 - PCnsin2 = 0</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">deltaon4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span>
            <span class="n">PCnorm2</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">rcurve</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">cos2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deltaon4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">bragg</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">PCnorm2</span> <span class="o">-</span> <span class="n">rcurve</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">cos2</span><span class="p">)</span>

    <span class="c1"># Get two relevant solutions</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">deltaon4</span> <span class="o">&gt;=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">cos2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">cos2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">npts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">PCnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">PCnorm2</span><span class="p">),</span> <span class="p">(</span><span class="n">nlamb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cos2</span> <span class="o">=</span> <span class="n">cos2</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">PCnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">PCnorm2</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">sol1</span> <span class="o">=</span> <span class="o">-</span><span class="n">rcurve</span><span class="o">*</span><span class="n">cos2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">deltaon4</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="n">sol2</span> <span class="o">=</span> <span class="o">-</span><span class="n">rcurve</span><span class="o">*</span><span class="n">cos2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">deltaon4</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>

    <span class="c1"># Only keep solution going outward sphere</span>
    <span class="c1"># scaPMem = scaPCem + rcurve &gt;= 0</span>
    <span class="n">ind1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sol1</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">rcurve</span><span class="p">)</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sol2</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">rcurve</span><span class="p">)</span>

    <span class="n">sol1</span> <span class="o">=</span> <span class="n">sol1</span><span class="p">[</span><span class="n">ind1</span><span class="p">]</span>
    <span class="n">sol2</span> <span class="o">=</span> <span class="n">sol2</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">indn</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="p">[</span><span class="n">indn</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind1</span><span class="p">],</span> <span class="n">indn</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind1</span><span class="p">]]</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="p">[</span><span class="n">indn</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ind2</span><span class="p">],</span> <span class="n">indn</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ind2</span><span class="p">]]</span>
        <span class="n">scaPCem</span><span class="p">[</span><span class="n">ind1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ind1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol1</span>
        <span class="n">scaPCem</span><span class="p">[</span><span class="n">ind2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ind2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indn</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scaPCem</span><span class="p">[</span><span class="n">indn</span><span class="p">[</span><span class="n">ind1</span><span class="p">],</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol1</span>
        <span class="n">scaPCem</span><span class="p">[</span><span class="n">indn</span><span class="p">[</span><span class="n">ind2</span><span class="p">],</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol2</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scaPCem</span><span class="p">)</span>

    <span class="c1"># Get equation on PCem</span>
    <span class="c1"># CM = rcurve * (sin(dtheta)e2 + cos(dtheta)(cos(psi)nout + sin(psi)e1))</span>
    <span class="c1"># PC.eM = scaPCem, thus introducing Z = PC.e2, Y = PC.e1, X = PC.nout</span>
    <span class="c1"># Xcos(dtheta)cos(psi) + Ycos(dtheta)sin(psi) + Zsin(dtheta) = scaPCem</span>
    <span class="c1"># dtheta is specified, psi is deduced</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PC</span><span class="o">*</span><span class="n">nout</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PC</span><span class="o">*</span><span class="n">e1</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">PC</span><span class="o">*</span><span class="n">e2</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">scaPCem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">scaPCem</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scaPCem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">scaPCem</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># broadcast and specify dtheta</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scaPCem</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">XYnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nlamb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="n">ndtheta</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nlamb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="n">ndtheta</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
        <span class="c1"># Define angextra to get</span>
        <span class="c1"># sin(psi + angextra) = (scaPCem - Z*sin(theta)) / (XYnorm*cos(theta))</span>
        <span class="n">angextra</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">nlamb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="n">ndtheta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">dtheta</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                    <span class="n">extenthalf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span>
                    <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
                <span class="n">npts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">nlamb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">XYnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Z</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">angextra</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">ndtheta</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
            <span class="mi">2</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">dtheta</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">extenthalf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndtheta</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">],</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">npts</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)[</span><span class="n">ind</span><span class="p">]</span>

    <span class="n">num</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">scaPCem</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">-</span> <span class="n">Z</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dtheta</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">XYnorm</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">dtheta</span><span class="p">[</span><span class="n">ind</span><span class="p">]))</span>
    <span class="p">)</span>
    <span class="n">ind</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1.</span>
    <span class="n">psi</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">-</span> <span class="n">angextra</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
    <span class="n">ind</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">psi</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">extenthalf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">psi</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">dtheta</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Double solutions found for </span><span class="si">{}</span><span class="s2"> / </span><span class="si">{}</span><span class="s2"> points!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">grid</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on Nov 15, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>