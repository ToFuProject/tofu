<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.openadas2tofu._read_files &#8212; Tofu 1.4.10</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-rendered-html.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.10</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../contributing.html">Contributing</a></li>
                <li><a href="../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../aboutus.html">About</a></li>
                <li><a href="../../../releases.html">Releases</a></li>
                <li><a href="../../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.openadas2tofu._read_files</h1><div class="highlight"><pre>
<span></span>
<span class="c1"># Built-in</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">itt</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="c1"># Common</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span> <span class="k">as</span> <span class="n">scpRectSpl</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;step03_read&#39;</span><span class="p">,</span> <span class="s1">&#39;step03_read_all&#39;</span><span class="p">]</span>


<span class="n">_DTYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;adf11&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;acd&#39;</span><span class="p">,</span> <span class="s1">&#39;ccd&#39;</span><span class="p">,</span> <span class="s1">&#39;scd&#39;</span><span class="p">,</span> <span class="s1">&#39;plt&#39;</span><span class="p">,</span> <span class="s1">&#39;prb&#39;</span><span class="p">],</span>
           <span class="s1">&#39;adf15&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<span class="n">_DEG</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">_PECASFUNC</span> <span class="o">=</span> <span class="kc">True</span>


<span class="c1"># #############################################################################</span>
<span class="c1"># #############################################################################</span>
<span class="c1">#                       Utility functions</span>
<span class="c1"># #############################################################################</span>


<span class="k">def</span> <span class="nf">_get_PATH_LOCAL</span><span class="p">():</span>
    <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;.tofu&#39;</span><span class="p">,</span> <span class="s1">&#39;openadas2tofu&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pfe</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pfe</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_subdir_from_pattern</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Get list of files matching patterns in path</span>

<span class="sd">    If no match =&gt; Exception</span>
<span class="sd">    If multiple matches</span>
<span class="sd">        =&gt; mult = True: pass</span>
<span class="sd">        =&gt; mult = &#39;warn&#39;: warning</span>
<span class="sd">        =&gt; mult = &#39;err&#39;: Exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="n">mult</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="s1">&#39;err&#39;</span>
    <span class="k">if</span> <span class="n">mult</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;err&#39;</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Arg mult must be in [True, &#39;warn&#39;, &#39;err&#39;]!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mult</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>

    <span class="c1"># Get matches</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dd</span><span class="p">))</span>
        <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">pp</span> <span class="ow">in</span> <span class="n">dd</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;You have no / many directories in your local &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;~/.tofu/openadas2tofu/ matching the desired file type:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- path: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided (all): </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- available: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;  =&gt; download the data with &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;tf.openadas2tofu.step02_download()&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ld</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mult</span> <span class="o">==</span> <span class="s1">&#39;err&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mult</span> <span class="o">==</span> <span class="s1">&#39;warn&#39;</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ld</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_get_available_elements_from_path</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">typ1</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Check inputs</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Provided path is not an existing directory!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">ltyp</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;adf15&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">typ1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ltyp</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Only the following types of files are handled up to now:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- handled: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ltyp</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;adf15&#39;</span><span class="p">:</span>
        <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">ff</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pec&#39;</span><span class="p">,</span> <span class="s1">&#39;][&#39;</span><span class="p">]])</span>
        <span class="p">]</span>
        <span class="n">element</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span><span class="p">[</span><span class="n">ff</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;][&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lf</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">element</span>



<span class="k">def</span> <span class="nf">_format_for_DataCollection_adf15</span><span class="p">(</span>
    <span class="n">dout</span><span class="p">,</span>
    <span class="n">dsource0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ddata0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dlines0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format dout from step03_read_all() for SPectralLines object</span>
<span class="sd">    (separated te, ne, ions, sources, lines)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Remove already known lines of dlines0 provided</span>
    <span class="k">if</span> <span class="n">dlines0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Check for mistakes</span>
        <span class="n">dk0</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k0</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">k1</span> <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">dlines0</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([(</span>
                    <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">],</span>
                    <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
                <span class="p">)])</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">dk0</span> <span class="o">=</span> <span class="p">{</span><span class="n">k0</span><span class="p">:</span> <span class="n">v0</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dk0</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dk0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Possible error in openadas detected,</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;the following lines have same ion and transition but &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;different symbol (typ0typ1-isoel):</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dk0</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  =&gt; There might be redundancy / errors in openadas&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k0</span><span class="p">:</span> <span class="n">v0</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span>
                <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">dlines0</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
            <span class="p">])</span>
        <span class="p">}</span>

    <span class="c1"># Get dict of unique sources</span>
    <span class="n">lsource</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
    <span class="n">dsource</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">dsource0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dsource</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;oa-adf15-</span><span class="si">{:02}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ii</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">ss</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lsource</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check against existing sources</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">k0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dsource0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;oa-adf15&#39;</span> <span class="ow">in</span> <span class="n">k0</span>
        <span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">ss</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lsource</span><span class="p">):</span>
            <span class="n">lk0</span> <span class="o">=</span> <span class="p">[</span><span class="n">k0</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dsource0</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ss</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">k0</span> <span class="o">=</span> <span class="s1">&#39;oa-adf15-</span><span class="si">{:02}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nmax</span><span class="p">)</span>
                <span class="n">nmax</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">k0</span> <span class="o">=</span> <span class="n">lk0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Multiple possible matches for source </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">dsource</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;long&#39;</span><span class="p">:</span> <span class="n">ss</span><span class="p">}</span>

    <span class="c1"># Get dict of unique Te and ne</span>
    <span class="n">dte</span><span class="p">,</span> <span class="n">dne</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">dref0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ite</span><span class="p">,</span> <span class="n">ine</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ite</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">k0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dref0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;Te-&#39;</span> <span class="ow">in</span> <span class="n">k0</span> <span class="ow">and</span> <span class="s1">&#39;oa-adf15&#39;</span> <span class="ow">in</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ine</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">k0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dref0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;ne-&#39;</span> <span class="ow">in</span> <span class="n">k0</span> <span class="ow">and</span> <span class="s1">&#39;oa-adf15&#39;</span> <span class="ow">in</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="p">]))</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c1"># Get source</span>
        <span class="n">sour</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">k1</span> <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">dsource</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># fill dte</span>
        <span class="n">kte</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dte</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;te&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;te&#39;</span><span class="p">],</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="ow">and</span> <span class="n">sour</span> <span class="o">==</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">dref0</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">normal</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Check vs existing Te</span>
            <span class="n">lk0</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">k1</span> <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">dref0</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sour</span>
                <span class="ow">and</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;te&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;te&#39;</span><span class="p">],</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">normal</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">keyte</span> <span class="o">=</span> <span class="n">lk0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dte</span><span class="p">[</span><span class="n">keyte</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">lk0</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;te_units&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">sour</span><span class="p">,</span>
                    <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Multiple matches for dout[</span><span class="si">{}</span><span class="s2">] in dref0:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normal</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kte</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">keyte</span> <span class="o">=</span> <span class="s1">&#39;Te-</span><span class="si">{:02}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ite</span><span class="p">)</span>
                <span class="n">dte</span><span class="p">[</span><span class="n">keyte</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;te&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;te_units&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">sour</span><span class="p">,</span>
                    <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="s1">&#39;temperature&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ite</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kte</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;len(kte) != 1:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- kte = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kte</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;keyte&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyte</span>

        <span class="c1"># fill dne</span>
        <span class="n">kne</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dne</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ne&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ne&#39;</span><span class="p">],</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="ow">and</span> <span class="n">sour</span> <span class="o">==</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">dref0</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">normal</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Check vs existing ne</span>
            <span class="n">lk0</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">k1</span> <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">dref0</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sour</span>
                <span class="ow">and</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ne&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ne&#39;</span><span class="p">],</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">k1</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">normal</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">keyne</span> <span class="o">=</span> <span class="n">lk0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dne</span><span class="p">[</span><span class="n">keyne</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ddata0</span><span class="p">[</span><span class="n">lk0</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ne_units&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">sour</span><span class="p">,</span>
                    <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="s1">&#39;density&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Multiple matches for dout[</span><span class="si">{}</span><span class="s2">] in dref0:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lk0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normal</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kne</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">keyne</span> <span class="o">=</span> <span class="s1">&#39;ne-</span><span class="si">{:02}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ine</span><span class="p">)</span>
                <span class="n">dne</span><span class="p">[</span><span class="n">keyne</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ne&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ne_units&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">sour</span><span class="p">,</span>
                    <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="s1">&#39;density&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="n">ine</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">kne</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;len(kne) != 1:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- kne = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kne</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;keyne&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keyne</span>

    <span class="c1"># Get dict of pec</span>
    <span class="n">dpec</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-pec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">):</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;pec&#39;</span><span class="p">],</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;pec_units&#39;</span><span class="p">],</span>
            <span class="s1">&#39;ref&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;keyne&#39;</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;keyte&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">k1</span> <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">dsource</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;sigma v&gt;&#39;</span><span class="p">,</span>
            <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="s1">&#39;pec&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1"># dlines</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">([</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;lambda0&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">lk0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dout</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)[</span><span class="n">inds</span><span class="p">]</span>
    <span class="n">dlines</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k0</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;ion&#39;</span><span class="p">:</span> <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;ion&#39;</span><span class="p">],</span>
            <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">k1</span> <span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">dsource</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">v1</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;lambda0&#39;</span><span class="p">:</span> <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;lambda0&#39;</span><span class="p">],</span>
            <span class="s1">&#39;pec&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-pec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">),</span>
            <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;symbol&#39;</span><span class="p">],</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">],</span>
            <span class="s1">&#39;transition&#39;</span><span class="p">:</span> <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;transition&#39;</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">lk0</span>
    <span class="p">}</span>

    <span class="c1"># Get dict of unique ions</span>
    <span class="n">lion</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>

    <span class="k">return</span> <span class="n">dne</span><span class="p">,</span> <span class="n">dte</span><span class="p">,</span> <span class="n">dpec</span><span class="p">,</span> <span class="n">lion</span><span class="p">,</span> <span class="n">dsource</span><span class="p">,</span> <span class="n">dlines</span>


<span class="c1"># #############################################################################</span>
<span class="c1"># #############################################################################</span>
<span class="c1">#                       Main functions</span>
<span class="c1"># #############################################################################</span>


<div class="viewcode-block" id="step03_read"><a class="viewcode-back" href="../../../tofu.openadas2tofu.html#tofu.openadas2tofu._read_files.step03_read">[docs]</a><span class="k">def</span> <span class="nf">step03_read</span><span class="p">(</span>
    <span class="n">adas_path</span><span class="p">,</span>
    <span class="n">pec_as_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwdargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read openadas-formatted files and return a dict with the data</span>

<span class="sd">    Povide the full adas file name</span>
<span class="sd">    The result is returned as a dict</span>

<span class="sd">    example</span>
<span class="sd">    -------</span>
<span class="sd">        &gt;&gt;&gt; import tofu as tf</span>
<span class="sd">        &gt;&gt;&gt; fn = &#39;/adf11/scd74/scd74_ar.dat&#39;</span>
<span class="sd">        &gt;&gt;&gt; out = tf.openadas2tofu.step03_read(fn)</span>
<span class="sd">        &gt;&gt;&gt; fn = &#39;/adf15/pec40][ar/pec40][ar_ca][ar16.dat&#39;</span>
<span class="sd">        &gt;&gt;&gt; out = tf.openadas2tofu.step03_read(fn)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path_local</span> <span class="o">=</span> <span class="n">_get_PATH_LOCAL</span><span class="p">()</span>

    <span class="c1"># Check whether the local .tofu repo exists, if not recommend tofu-custom</span>
    <span class="k">if</span> <span class="n">path_local</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;.tofu&#39;</span><span class="p">,</span> <span class="s1">&#39;openadas2tofu&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;You do not seem to have a local ./tofu repository</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;tofu uses that local repository to store all user-specific &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;data and downloads</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;In particular, openadas files are downloaded and saved in:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;  =&gt; to set-up your local .tofu repo, run in a terminal:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">tofu-custom&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Determine whether adas_path is an absolute path or an adas full name</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">adas_path</span><span class="p">):</span>
        <span class="n">pfe</span> <span class="o">=</span> <span class="n">adas_path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># make sure adas_path is not understood as absolute local path</span>
        <span class="k">if</span> <span class="n">adas_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">adas_path</span> <span class="o">=</span> <span class="n">adas_path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Check file was downloaded locally</span>
        <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_local</span><span class="p">,</span> <span class="n">adas_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pfe</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Provided file does not seem to exist:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;  =&gt; Search it online with &quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;tofu.openadas2tofu.step01_search_online()</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;  =&gt; Download it with &quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;tofu.openadas2tofu.step02_download()&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">_DTYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">pfe</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;File type could not be derived from absolute path:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided:  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- supported: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">_DTYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;_read_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="step03_read_all"><a class="viewcode-back" href="../../../tofu.openadas2tofu.html#tofu.openadas2tofu._read_files.step03_read_all">[docs]</a><span class="k">def</span> <span class="nf">step03_read_all</span><span class="p">(</span>
    <span class="n">element</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">typ1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">typ2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pec_as_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">format_for_DataCollection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dsource0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dref0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ddata0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dlines0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">verb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read all relevant openadas files for chosen typ1</span>

<span class="sd">    Please specify:</span>
<span class="sd">        - typ1:</span>
<span class="sd">            - &#39;adf11&#39;: ionisation / recombination data</span>
<span class="sd">            - &#39;adf15&#39;: pec data</span>
<span class="sd">        - element: the symbol of the element</span>

<span class="sd">    If typ1 = &#39;adf11&#39;, you can also provide typ2 to specify the coefficients:</span>
<span class="sd">        - &#39;scd&#39;: effective ionisation coefficients</span>
<span class="sd">        - &#39;acd&#39;: effective electron-impact recombination coefficients</span>
<span class="sd">        - &#39;ccd&#39;: effective hydrogen-impact recombination coefficients</span>
<span class="sd">        - &#39;plt&#39;: line power due to electron-impact excitation</span>
<span class="sd">        - &#39;prc&#39;: line power due to hydrogen-impact excitation</span>
<span class="sd">        - &#39;prb&#39;: rad. recombination and bremmstrahlung due to electron-impact</span>

<span class="sd">    If typ1 = &#39;adf15&#39;, you can optioanlly provide a min/max wavelength</span>

<span class="sd">    The result is returned as a dict</span>

<span class="sd">    examples</span>
<span class="sd">    --------</span>
<span class="sd">        &gt;&gt;&gt; import tofu as tf</span>
<span class="sd">        &gt;&gt;&gt; dout = tf.openadas2tofu.step03_read_all(element=&#39;ar&#39;, typ1=&#39;adf11&#39;)</span>
<span class="sd">        &gt;&gt;&gt; dout = tf.openadas2tofu.step03_read_all(element=&#39;ar&#39;, typ1=&#39;adf15&#39;,</span>
<span class="sd">                                                    charge=16,</span>
<span class="sd">                                                    lambmin=3.94e-10,</span>
<span class="sd">                                                    lambmax=4.e-10)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Check whether the local .tofu repo exists, if not recommend tofu-custom</span>
    <span class="n">path_local</span> <span class="o">=</span> <span class="n">_get_PATH_LOCAL</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">path_local</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;.tofu&#39;</span><span class="p">,</span> <span class="s1">&#39;openadas2tofu&#39;</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;You do not seem to have a local ./tofu repository</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;tofu uses that local repository to store all user-specific &quot;</span>
               <span class="o">+</span> <span class="s2">&quot;data and downloads</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;In particular, openadas files are downloaded and saved in:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;  =&gt; to set-up your local .tofu repo, run in a terminal:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">tofu-custom&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Check / format input</span>
    <span class="k">if</span> <span class="n">typ1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">typ1</span> <span class="o">=</span> <span class="s1">&#39;adf15&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ1</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">typ1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_DTYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Please choose a valid adas file type:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- allowed:  </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_DTYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ1</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">typ1</span> <span class="o">=</span> <span class="n">typ1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;adf11&#39;</span> <span class="ow">and</span> <span class="n">typ2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">typ2</span> <span class="o">=</span> <span class="n">_DTYPES</span><span class="p">[</span><span class="n">typ1</span><span class="p">]</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_local</span><span class="p">,</span> <span class="n">typ1</span><span class="p">))</span>
        <span class="n">typ2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sorted</span><span class="p">([</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">fd</span> <span class="k">if</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">typ2</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">typ2</span> <span class="o">=</span> <span class="p">[</span><span class="n">typ2</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_DTYPES</span><span class="p">[</span><span class="n">typ1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ2</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
             <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="n">s1</span> <span class="ow">in</span> <span class="n">ss</span> <span class="k">for</span> <span class="n">s1</span> <span class="ow">in</span> <span class="n">_DTYPES</span><span class="p">[</span><span class="n">typ1</span><span class="p">]])</span>
                         <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">typ2</span><span class="p">]))):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;typ2 must be a list of valid openadas file types for typ1:</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided:         </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ2</span><span class="p">)</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- available for </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ1</span><span class="p">,</span> <span class="n">_DTYPES</span><span class="p">[</span><span class="n">typ1</span><span class="p">]))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Get elevant directory</span>
    <span class="c1"># Level 1: Type</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">_get_subdir_from_pattern</span><span class="p">(</span><span class="n">path_local</span><span class="p">,</span> <span class="n">typ1</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="s1">&#39;err&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># element</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">element</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">element</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please choose an element!&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">el</span> <span class="o">=</span> <span class="n">_get_available_elements_from_path</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">typ1</span><span class="o">=</span><span class="n">typ1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">el</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">element</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">ee</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">element</span><span class="p">])</span>
            <span class="n">element</span> <span class="o">=</span> <span class="p">[</span><span class="n">ee</span> <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">el</span> <span class="k">if</span> <span class="n">ee</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">element</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="p">]</span>
    <span class="n">element</span> <span class="o">=</span> <span class="p">[</span><span class="n">ee</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">element</span><span class="p">]</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># charge</span>
    <span class="k">if</span> <span class="n">charge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">charge</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
                <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">charge</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg charge must be a int or list (e.g.: 16 or [0])</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">charge</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="p">[</span><span class="n">charge</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">charge</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">charge</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">format_for_DataCollection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">format_for_DataCollection</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">verb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">verb</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Get list of relevant directories per element</span>

    <span class="c1"># Level 2: element or typ2</span>
    <span class="k">if</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;adf11&#39;</span><span class="p">:</span>
        <span class="n">lpath</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_get_subdir_from_pattern</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="s1">&#39;err&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">typ2</span>
        <span class="p">]</span>
    <span class="k">elif</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;adf15&#39;</span><span class="p">:</span>
        <span class="n">lpath</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="n">_get_subdir_from_pattern</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pec&#39;</span><span class="p">,</span> <span class="s1">&#39;][</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ee</span><span class="p">)],</span> <span class="n">mult</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">element</span>
        <span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Get list of relevant files pfe</span>
    <span class="n">lpfe</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itt</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">([[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ff</span><span class="p">)</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ff</span><span class="p">))</span>
            <span class="ow">and</span> <span class="n">ff</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.dat&#39;</span>
            <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;][</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ee</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ff</span> <span class="k">for</span> <span class="n">ee</span> <span class="ow">in</span> <span class="n">element</span><span class="p">])</span>
        <span class="p">)]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">lpath</span>
    <span class="p">]))</span>

    <span class="k">if</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;adf15&#39;</span><span class="p">:</span>
        <span class="n">kwdargs</span><span class="p">[</span><span class="s1">&#39;pec_as_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pec_as_func</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">lpfe</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lpfe</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;][&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>
                    <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span>
                    <span class="o">==</span> <span class="n">cc</span>
                    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">charge</span>
                <span class="p">])</span>
            <span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">charge</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">lpfe</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lpfe</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span>
                    <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;][&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()])</span>
                    <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span>
                    <span class="o">==</span> <span class="n">cc</span>
                    <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">charge</span>
                <span class="p">])</span>
            <span class="p">]</span>

    <span class="c1"># --------------------</span>
    <span class="c1"># Extract data from each file</span>
    <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;_read_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ1</span><span class="p">))</span>
    <span class="n">dout</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pfe</span> <span class="ow">in</span> <span class="n">lpfe</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Loading data from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">dout</span><span class="o">=</span><span class="n">dout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;adf15&#39;</span> <span class="ow">and</span> <span class="n">format_for_DataCollection</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_format_for_DataCollection_adf15</span><span class="p">(</span>
            <span class="n">dout</span><span class="p">,</span>
            <span class="n">dsource0</span><span class="o">=</span><span class="n">dsource0</span><span class="p">,</span>
            <span class="n">dref0</span><span class="o">=</span><span class="n">dref0</span><span class="p">,</span>
            <span class="n">ddata0</span><span class="o">=</span><span class="n">ddata0</span><span class="p">,</span>
            <span class="n">dlines0</span><span class="o">=</span><span class="n">dlines0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dout</span></div>


<span class="c1"># #############################################################################</span>
<span class="c1">#                      Specialized functions for ADF 11</span>
<span class="c1"># #############################################################################</span>


<span class="k">def</span> <span class="nf">_read_adf11</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dout</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">deg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="n">_DEG</span>
    <span class="k">if</span> <span class="n">dout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Get second order file type</span>
    <span class="n">typ1</span> <span class="o">=</span> <span class="p">[</span><span class="n">vv</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">_DTYPES</span><span class="p">[</span><span class="s1">&#39;adf11&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">pfe</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">typ1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Second order file type could not be inferred from file name!</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- available: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_DTYPES</span><span class="p">[</span><span class="s1">&#39;adf11&#39;</span><span class="p">])</span>
               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">typ1</span> <span class="o">=</span> <span class="n">typ1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Get element</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">pfe</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">comline</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">60</span>
    <span class="n">comline2</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span><span class="o">+</span><span class="n">comline</span>

    <span class="k">if</span> <span class="n">typ1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;acd&#39;</span><span class="p">,</span> <span class="s1">&#39;ccd&#39;</span><span class="p">,</span> <span class="s1">&#39;scd&#39;</span><span class="p">,</span> <span class="s1">&#39;plt&#39;</span><span class="p">,</span> <span class="s1">&#39;prb&#39;</span><span class="p">]:</span>

        <span class="c1"># read blocks</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span> <span class="k">as</span> <span class="n">search</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">search</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">comline2</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="c1"># Get atomic number (transitions) stored in this file</span>
                <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lstr</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="n">lin</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                           <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">lin</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lin</span><span class="p">]),</span>
                        <span class="n">elem</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">lstr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="c1"># &#39;ADF11&#39; in lstr[-1],</span>
                    <span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;File header format seems to have changed!</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- pfe: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- lc = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- lstr = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lstr</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">Z</span><span class="p">,</span> <span class="n">nne</span><span class="p">,</span> <span class="n">nte</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">qend</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">lin</span><span class="p">)</span>
                    <span class="n">nelog10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="n">telog10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="n">in_ne</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">comline</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get nelog10</span>
                <span class="k">if</span> <span class="n">in_ne</span><span class="p">:</span>
                    <span class="n">li</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                    <span class="n">nelog10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nelog10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">nelog10</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nne</span><span class="p">:</span>
                        <span class="n">in_ne</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">in_te</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Get telog10</span>
                <span class="k">elif</span> <span class="n">in_te</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">li</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                    <span class="n">telog10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">telog10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">telog10</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nte</span><span class="p">:</span>
                        <span class="n">in_te</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">in_ion</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Get ion block</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">in_ion</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="s1">&#39;Z1=&#39;</span> <span class="ow">in</span> <span class="n">line</span>
                      <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;------/&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;DATE=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">)):</span>
                    <span class="n">nion</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">line</span><span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Z1=&#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;Z1=&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">typ1</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;scd&#39;</span><span class="p">,</span> <span class="s1">&#39;plt&#39;</span><span class="p">]:</span>
                        <span class="n">charge</span> <span class="o">=</span> <span class="n">nion</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">charge</span> <span class="o">=</span> <span class="n">nion</span>
                    <span class="n">coefslog10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">elif</span> <span class="n">in_ion</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">charge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">li</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                          <span class="k">if</span> <span class="n">ss</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
                    <span class="n">coefslog10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coefslog10</span><span class="p">,</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">li</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">coefslog10</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nne</span><span class="o">*</span><span class="n">nte</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">charge</span><span class="p">)</span>
                        <span class="n">tkv</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;element&#39;</span><span class="p">,</span> <span class="n">elem</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">Z</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="n">charge</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span> <span class="o">==</span> <span class="n">vv</span> <span class="k">for</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">tkv</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">ss</span><span class="p">:</span> <span class="n">vv</span> <span class="k">for</span> <span class="n">ss</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">tkv</span><span class="p">}</span>
                        <span class="k">if</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;scd&#39;</span><span class="p">:</span>
                            <span class="c1"># nelog10+6 to convert /cm3 -&gt; /m3</span>
                            <span class="c1"># coefslog10-6 to convert cm3/s -&gt; m3/s</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">scpRectSpl</span><span class="p">(</span><span class="n">nelog10</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">telog10</span><span class="p">,</span>
                                              <span class="n">coefslog10</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nne</span><span class="p">,</span> <span class="n">nte</span><span class="p">))</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span>
                                              <span class="n">kx</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                            <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;ionis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
                                                  <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;log10_nete&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;log10(m3/s)&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">pfe</span><span class="p">}</span>
                        <span class="k">elif</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;acd&#39;</span><span class="p">:</span>
                            <span class="c1"># nelog10+6 to convert /cm3 -&gt; /m3</span>
                            <span class="c1"># coefslog10-6 to convert cm3/s -&gt; m3/s</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">scpRectSpl</span><span class="p">(</span><span class="n">nelog10</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">telog10</span><span class="p">,</span>
                                              <span class="n">coefslog10</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nne</span><span class="p">,</span> <span class="n">nte</span><span class="p">))</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span>
                                              <span class="n">kx</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                            <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;recomb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
                                                   <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;log10_nete&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;log10(m3/s)&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">pfe</span><span class="p">}</span>
                        <span class="k">elif</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;ccd&#39;</span><span class="p">:</span>
                            <span class="c1"># nelog10+6 to convert /cm3 -&gt; /m3</span>
                            <span class="c1"># coefslog10-6 to convert cm3/s -&gt; m3/s</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">scpRectSpl</span><span class="p">(</span><span class="n">nelog10</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">telog10</span><span class="p">,</span>
                                              <span class="n">coefslog10</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nne</span><span class="p">,</span> <span class="n">nte</span><span class="p">))</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span>
                                              <span class="n">kx</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                            <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;recomb_ce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
                                                      <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;log10_nete&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;log10(m3/s)&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">pfe</span><span class="p">}</span>
                        <span class="k">elif</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;plt&#39;</span><span class="p">:</span>
                            <span class="c1"># nelog10+6 to convert /cm3 -&gt; /m3</span>
                            <span class="c1"># coefslog10+6 to convert W.cm3 -&gt; W.m3</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">scpRectSpl</span><span class="p">(</span><span class="n">nelog10</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">telog10</span><span class="p">,</span>
                                              <span class="n">coefslog10</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nne</span><span class="p">,</span> <span class="n">nte</span><span class="p">))</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span>
                                              <span class="n">kx</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                            <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;rad_bb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
                                                   <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;log10_nete&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;log10(W.m3)&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">pfe</span><span class="p">}</span>
                        <span class="k">elif</span> <span class="n">typ1</span> <span class="o">==</span> <span class="s1">&#39;prb&#39;</span><span class="p">:</span>
                            <span class="c1"># nelog10+6 to convert /cm3 -&gt; /m3</span>
                            <span class="c1"># coefslog10+6 to convert W.cm3 -&gt; W.m3</span>
                            <span class="n">func</span> <span class="o">=</span> <span class="n">scpRectSpl</span><span class="p">(</span><span class="n">nelog10</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">telog10</span><span class="p">,</span>
                                              <span class="n">coefslog10</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nne</span><span class="p">,</span> <span class="n">nte</span><span class="p">))</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span>
                                              <span class="n">kx</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span> <span class="n">ky</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                            <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;rad_fffb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="n">func</span><span class="p">,</span>
                                                     <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;log10_nete&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;log10(W.m3)&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">pfe</span><span class="p">}</span>
                        <span class="k">if</span> <span class="n">nion</span> <span class="o">==</span> <span class="n">Z</span><span class="p">:</span>
                            <span class="k">break</span>

    <span class="k">return</span> <span class="n">dout</span>


<span class="c1"># #############################################################################</span>
<span class="c1">#                      Specialized functions for ADF 15</span>
<span class="c1"># #############################################################################</span>


<span class="k">def</span> <span class="nf">_get_adf15_key</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">isoel</span><span class="p">,</span> <span class="n">typ0</span><span class="p">,</span> <span class="n">typ1</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">_oa_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">isoel</span><span class="p">,</span> <span class="n">typ0</span><span class="p">,</span> <span class="n">typ1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_read_adf15</span><span class="p">(</span>
    <span class="n">pfe</span><span class="p">,</span>
    <span class="n">dout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lambmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">lambmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pec_as_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">deg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Here lambmin and lambmax are provided in m</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">deg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">deg</span> <span class="o">=</span> <span class="n">_DEG</span>
    <span class="k">if</span> <span class="n">pec_as_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pec_as_func</span> <span class="o">=</span> <span class="n">_PECASFUNC</span>
    <span class="k">if</span> <span class="n">dout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Get summary of transitions</span>
    <span class="n">flagblock</span> <span class="o">=</span> <span class="s1">&#39;/isel =&#39;</span>
    <span class="n">flag0</span> <span class="o">=</span> <span class="s1">&#39;superstage partition information&#39;</span>

    <span class="c1"># Get file markers from name (elem, charge, typ0, typ1)</span>
    <span class="n">typ0</span><span class="p">,</span> <span class="n">typ1</span><span class="p">,</span> <span class="n">elemq</span> <span class="o">=</span> <span class="n">pfe</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;][&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d&#39;</span><span class="p">,</span> <span class="n">elemq</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">elemq</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
    <span class="n">charge</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elemq</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">elem</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">typ0</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">elem</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">typ1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">typ0</span> <span class="o">=</span> <span class="n">typ0</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">typ1</span> <span class="o">=</span> <span class="n">typ1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Extract data from file</span>
    <span class="n">nlines</span><span class="p">,</span> <span class="n">nblock</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">in_ne</span><span class="p">,</span> <span class="n">in_te</span><span class="p">,</span> <span class="n">in_pec</span><span class="p">,</span> <span class="n">in_tab</span><span class="p">,</span> <span class="n">itab</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span> <span class="k">as</span> <span class="n">search</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">search</span><span class="p">):</span>

            <span class="c1"># Get number of lines (transitions) stored in this file</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lstr</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">nlines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lstr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Get info about the transition being scanned (block)</span>
            <span class="k">if</span> <span class="n">flagblock</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;C&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">nblock</span> <span class="o">&lt;</span> <span class="n">nlines</span><span class="p">:</span>
                <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lstr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">1.e-10</span>
                <span class="n">isoel</span> <span class="o">=</span> <span class="n">nblock</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">nblock</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="p">((</span><span class="n">lambmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lamb</span> <span class="o">&lt;</span> <span class="n">lambmin</span><span class="p">)</span>
                      <span class="ow">or</span> <span class="p">(</span><span class="n">lambmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lamb</span> <span class="o">&gt;</span> <span class="n">lambmax</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">continue</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">nne</span><span class="p">,</span> <span class="n">nte</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lstr</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">lstr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span><span class="p">[</span><span class="n">ss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;type=&#39;</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;type=&#39;</span><span class="p">):</span><span class="n">ss</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;/ispb&#39;</span><span class="p">)]</span>
                       <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">lstr</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="k">if</span> <span class="s1">&#39;type=&#39;</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="c1"># To be updated : proper reading from line</span>
                <span class="n">in_ne</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="n">te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="n">pec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nne</span><span class="o">*</span><span class="n">nte</span><span class="p">,),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># il = 0</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="s1">&#39;root partition information&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">skip</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Check lamb is ok</span>
            <span class="k">if</span> <span class="n">skip</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Get ne for the transition being scanned (block)</span>
            <span class="k">if</span> <span class="n">in_ne</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ne</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ne</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nne</span><span class="p">:</span>
                    <span class="n">in_ne</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">in_te</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Get te for the transition being scanned (block)</span>
            <span class="k">elif</span> <span class="n">in_te</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">te</span><span class="p">,</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span>
                                        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">te</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nte</span><span class="p">:</span>
                    <span class="n">in_te</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">in_pec</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Get pec for the transition being scanned (block)</span>
            <span class="k">elif</span> <span class="n">in_pec</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">pec</span><span class="p">[</span><span class="n">ind</span><span class="p">:</span><span class="n">ind</span><span class="o">+</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="c1"># pec[il, :] = data</span>
                <span class="n">ind</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>
                <span class="c1"># il += 1</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">==</span> <span class="n">pec</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">in_pec</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">_get_adf15_key</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">isoel</span><span class="p">,</span> <span class="n">typ0</span><span class="p">,</span> <span class="n">typ1</span><span class="p">)</span>
                    <span class="c1"># PEC reshaping and conversion to cm3/s -&gt; m3/s</span>
                    <span class="n">pec</span> <span class="o">=</span> <span class="n">pec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nne</span><span class="p">,</span> <span class="n">nte</span><span class="p">))</span> <span class="o">*</span> <span class="mf">1e-6</span>
                    <span class="c1"># log(ne)+6 to convert /cm3 -&gt; /m3</span>
                    <span class="n">ne</span> <span class="o">=</span> <span class="n">ne</span><span class="o">*</span><span class="mf">1e6</span>

                    <span class="k">if</span> <span class="n">pec_as_func</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">pec_rec</span> <span class="o">=</span> <span class="n">scpRectSpl</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ne</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">te</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pec</span><span class="p">),</span>
                            <span class="n">kx</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
                            <span class="n">ky</span><span class="o">=</span><span class="n">deg</span><span class="p">)</span>
                        <span class="k">def</span> <span class="nf">pec</span><span class="p">(</span><span class="n">Te</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pec_rec</span><span class="o">=</span><span class="n">pec_rec</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pec_rec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ne</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">Te</span><span class="p">)))</span>

                    <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;lambda0&#39;</span><span class="p">:</span> <span class="n">lamb</span><span class="p">,</span>
                        <span class="s1">&#39;ion&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">+&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">charge</span><span class="p">),</span>
                        <span class="s1">&#39;charge&#39;</span><span class="p">:</span> <span class="n">charge</span><span class="p">,</span>
                        <span class="s1">&#39;element&#39;</span><span class="p">:</span> <span class="n">elem</span><span class="p">,</span>
                        <span class="s1">&#39;symbol&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">typ0</span><span class="p">,</span> <span class="n">typ1</span><span class="p">,</span> <span class="n">isoel</span><span class="p">),</span>
                        <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">pfe</span><span class="p">,</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">typ</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;ne&#39;</span><span class="p">:</span> <span class="n">ne</span><span class="p">,</span>
                        <span class="s1">&#39;ne_units&#39;</span><span class="p">:</span> <span class="s1">&#39;/m3&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;te&#39;</span><span class="p">:</span> <span class="n">te</span><span class="p">,</span>
                        <span class="s1">&#39;te_units&#39;</span><span class="p">:</span> <span class="s1">&#39;eV&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pec&#39;</span><span class="p">:</span> <span class="n">pec</span><span class="p">,</span>
                        <span class="s1">&#39;pec_type&#39;</span><span class="p">:</span> <span class="s1">&#39;f(ne, Te)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;pec_units&#39;</span><span class="p">:</span> <span class="s1">&#39;m3/s&#39;</span><span class="p">,</span>
                    <span class="p">}</span>

            <span class="c1"># Get transitions from table at the end</span>
            <span class="k">if</span> <span class="s1">&#39;photon emissivity atomic transitions&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">itab</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">6</span>
            <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="n">itab</span><span class="p">:</span>
                <span class="n">in_tab</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">in_tab</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">lstr</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">isoel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lstr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lstr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="mf">1.e-10</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">_get_adf15_key</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">isoel</span><span class="p">,</span> <span class="n">typ0</span><span class="p">,</span> <span class="n">typ1</span><span class="p">)</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="p">((</span><span class="n">lambmin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lambmin</span> <span class="o">&lt;</span> <span class="n">lamb</span><span class="p">)</span>
                      <span class="ow">and</span> <span class="p">(</span><span class="n">lambmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lambmax</span> <span class="o">&gt;</span> <span class="n">lamb</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Inconsistency in file </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- line should be present&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;lambda0&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lamb</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Inconsistency in file </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lstr</span>
                          <span class="ow">or</span> <span class="n">lstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Inconsistency in table, type not found:</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- expected: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- line: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">trans</span> <span class="o">=</span> <span class="n">lstr</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="n">lstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])]</span>
                    <span class="n">dout</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;transition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">isoel</span> <span class="o">==</span> <span class="n">nlines</span><span class="p">:</span>
                    <span class="n">in_tab</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="s1">&#39;transition&#39;</span> <span class="ow">in</span> <span class="n">vv</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">dout</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on Jun 29, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>