<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tofu.data._core &#8212; Tofu 1.4.9-233-gb0679bc0</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/gallery-rendered-html.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          tofu</a>
        <span class="navbar-text navbar-version pull-left"><b>1.4.9-233-gb0679bc0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../../installation.html">Installation</a></li>
                <li><a href="../../../contributing.html">Contributing</a></li>
                <li><a href="../../../auto_examples/index.html">Gallery</a></li>
                <li><a href="../../../aboutus.html">About</a></li>
                <li><a href="../../../releases.html">Releases</a></li>
                <li><a href="../../../tofu.html">API</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">How to install tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">A guide to contributing to tofu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/tutorials/tuto_plot_gallery_fusion_machines.html">A list of all different device configurations available (ITER, WEST, JET, ...)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Tutorials and examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu_from_bash.html">Using tofu from a bash terminal</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.html">tofu package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.geom.html">tofu.geom package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dumpro.html">tofu.dumpro package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.data.html">tofu.data package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tofu.dust.html">tofu.dust package</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for tofu.data._core</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># Built-in</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">itt</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">inspect</span>

<span class="c1"># Common</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">scpinterp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="kn">import</span> <span class="n">Triangulation</span> <span class="k">as</span> <span class="n">mplTri</span>


<span class="c1"># tofu</span>
<span class="kn">from</span> <span class="nn">tofu</span> <span class="kn">import</span> <span class="n">__version__</span> <span class="k">as</span> <span class="n">__version__</span>
<span class="kn">import</span> <span class="nn">tofu.pathfile</span> <span class="k">as</span> <span class="nn">tfpf</span>
<span class="kn">import</span> <span class="nn">tofu.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tofu.data._comp</span> <span class="k">as</span> <span class="nn">_comp</span>
    <span class="kn">import</span> <span class="nn">tofu.data._plot</span> <span class="k">as</span> <span class="nn">_plot</span>
    <span class="kn">import</span> <span class="nn">tofu.data._def</span> <span class="k">as</span> <span class="nn">_def</span>
    <span class="kn">import</span> <span class="nn">tofu._physics</span> <span class="k">as</span> <span class="nn">_physics</span>
    <span class="kn">import</span> <span class="nn">tofu.data._spectrafit2d</span> <span class="k">as</span> <span class="nn">_spectrafit2d</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_comp</span> <span class="k">as</span> <span class="n">_comp</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_plot</span> <span class="k">as</span> <span class="n">_plot</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_def</span> <span class="k">as</span> <span class="n">_def</span>
    <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">_physics</span> <span class="k">as</span> <span class="n">_physics</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_spectrafit2d</span> <span class="k">as</span> <span class="n">_spectrafit2d</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DataCam1D&#39;</span><span class="p">,</span><span class="s1">&#39;DataCam2D&#39;</span><span class="p">,</span>
           <span class="s1">&#39;DataCam1DSpectral&#39;</span><span class="p">,</span><span class="s1">&#39;DataCam2DSpectral&#39;</span><span class="p">,</span>
           <span class="s1">&#39;Plasma2D&#39;</span><span class="p">]</span>
<span class="n">_INTERPT</span> <span class="o">=</span> <span class="s1">&#39;zero&#39;</span>


<span class="c1">#############################################</span>
<span class="c1">#       utils</span>
<span class="c1">#############################################</span>

<span class="k">def</span> <span class="nf">_format_ind</span><span class="p">(</span><span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper routine to convert selected channels (as numbers) in `ind` to</span>
<span class="sd">    a boolean array format.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ind : integer, or list of integers</span>
<span class="sd">        A channel or a list of channels that the user wants to select.</span>
<span class="sd">    n : integer, or None</span>
<span class="sd">        The total number of available channels.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ind : ndarray of booleans, size (n,)</span>
<span class="sd">        The array with the selected channels set to True, remaining ones set</span>
<span class="sd">        to False</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; _format_ind(ind=[0, 3], n=4)</span>
<span class="sd">    [True, False, False, True]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># list of accepted integer types</span>
        <span class="n">lInt</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">longlong</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="ow">in</span> <span class="n">lInt</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">ii</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ii</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ii</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">]:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="n">lInt</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">ii</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Index must be int, or an iterable of bool or int &quot;</span>
                       <span class="s2">&quot;(first element of index has&quot;</span>
                       <span class="s2">&quot; type: </span><span class="si">{}</span><span class="s2">)!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                       <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ind</span>


<span class="k">def</span> <span class="nf">_select_ind</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">nRef</span><span class="p">):</span>
    <span class="n">ltypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
    <span class="n">C0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span>
    <span class="n">C1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span>
    <span class="n">C3</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span>
    <span class="k">assert</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">C0</span><span class="p">,</span><span class="n">C1</span><span class="p">,</span><span class="n">C2</span><span class="p">,</span><span class="n">C3</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span>
    <span class="n">nnRef</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nnRef</span><span class="p">,</span><span class="n">nRef</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">ind</span>
    <span class="k">elif</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">C0</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="c1"># Traditional :</span>
        <span class="c1">#for vv in v:</span>
        <span class="c1">#    ind[np.nanargmin(np.abs(ref-vv))] = True</span>
        <span class="c1"># Faster with digitize :</span>
        <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ref</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">ind</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">ref</span><span class="p">[</span><span class="n">ii</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="n">C2</span> <span class="ow">or</span> <span class="n">C3</span><span class="p">:</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([(</span><span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span>
                   <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">vvv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span> <span class="k">for</span> <span class="n">vvv</span> <span class="ow">in</span> <span class="n">vv</span><span class="p">]))</span>
                  <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">c0</span><span class="o">!=</span><span class="n">c1</span>
        <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span> <span class="o">|</span> <span class="p">((</span><span class="n">ref</span><span class="o">&gt;=</span><span class="n">vv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ref</span><span class="o">&lt;=</span><span class="n">vv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">C3</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">ind</span>
    <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">ind</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">ind</span>




<span class="c1">#############################################</span>
<span class="c1">#       class</span>
<span class="c1">#############################################</span>

<span class="k">class</span> <span class="nc">DataAbstract</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="p">):</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="c1"># Fixed (class-wise) dictionary of default properties</span>
    <span class="n">_ddef</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Id&#39;</span><span class="p">:{</span><span class="s1">&#39;include&#39;</span><span class="p">:[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span><span class="s1">&#39;Cls&#39;</span><span class="p">,</span><span class="s1">&#39;Exp&#39;</span><span class="p">,</span><span class="s1">&#39;Diag&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="s1">&#39;shot&#39;</span><span class="p">,</span><span class="s1">&#39;version&#39;</span><span class="p">]},</span>
             <span class="s1">&#39;dtreat&#39;</span><span class="p">:{</span><span class="s1">&#39;order&#39;</span><span class="p">:[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span><span class="s1">&#39;interp-indt&#39;</span><span class="p">,</span><span class="s1">&#39;interp-indch&#39;</span><span class="p">,</span><span class="s1">&#39;data0&#39;</span><span class="p">,</span><span class="s1">&#39;dfit&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;indt&#39;</span><span class="p">,</span> <span class="s1">&#39;indch&#39;</span><span class="p">,</span> <span class="s1">&#39;indlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;interp-t&#39;</span><span class="p">]}}</span>

    <span class="c1"># Does not exist before Python 3.6 !!!</span>
    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="c1"># Python 2</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">,</span><span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="c1"># Python 3</span>
        <span class="c1">#super().__init_subclass__(**kwdargs)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">DataAbstract</span><span class="o">.</span><span class="n">_ddef</span><span class="p">)</span>
        <span class="c1">#cls._dplot = copy.deepcopy(Struct._dplot)</span>
        <span class="c1">#cls._set_color_ddef(cls._color)</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="s1">&#39;geom&#39;</span><span class="p">,</span>
                 <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lCam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">),</span>
                 <span class="n">SavePath_Include</span><span class="o">=</span><span class="n">tfpf</span><span class="o">.</span><span class="n">defInclude</span><span class="p">):</span>

        <span class="c1"># Create a dplot at instance level</span>
        <span class="c1">#self._dplot = copy.deepcopy(self.__class__._dplot)</span>

        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_ddataRef</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dtreat</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_ddata</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dlabels</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dlabels</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dgeom</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dchans</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dextra</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dextra</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dX12</span><span class="p">())</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_Id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">Diag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">ID</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg Id must be a utils.ID instance!</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Id</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">Name</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="n">Diag</span> <span class="o">=</span> <span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">Diag</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Name</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Diag</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Diag</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Exp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Exp</span>
        <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">][</span><span class="s1">&#39;include&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">shot</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;shot&#39;</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
                <span class="n">include</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;shot&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shot</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;shot&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
                <span class="n">include</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;shot&#39;</span><span class="p">)</span>
        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span><span class="n">Name</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span>
                        <span class="s1">&#39;Diag&#39;</span><span class="p">:</span><span class="n">Diag</span><span class="p">,</span> <span class="s1">&#39;include&#39;</span><span class="p">:</span><span class="n">include</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">kwdargs</span>

    <span class="c1">###########</span>
    <span class="c1"># Get largs</span>
    <span class="c1">###########</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_ddataRef</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;indtX&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;lamb&#39;</span><span class="p">,</span> <span class="s1">&#39;indtlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;indXlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;indtXlamb&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_ddata</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dtreat</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dtreat&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dlabels</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dlabels&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dgeom</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dX12</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dX12&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dchans</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dchans&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dextra</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dextra&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span>


    <span class="c1">###########</span>
    <span class="c1"># Get check and format inputs</span>
    <span class="c1">###########</span>



    <span class="k">def</span> <span class="nf">_checkformat_inputs_ddataRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">indXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;data can not be None!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indtX</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">indtlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indtlamb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indXlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indXlamb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtXlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indtXlamb</span><span class="p">,</span>
                                                 <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">assert</span> <span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;self is not of spectral type</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;  =&gt; the data cannot be 3D ! (ndim)&quot;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="n">msg</span>

        <span class="n">nt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">nt</span><span class="p">,):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wrong time dimension</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- t.shape = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- nt = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nt</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">n1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide at least X or lamb (both are None)!&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">n1</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;lamb provided =&gt; self._isSpectral() must be True!&quot;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n1</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lamb.ndim must be in [1, 2]</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- lamb.shape = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lamb</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lamb</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">n1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lamb has wrong size!</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- expected: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lamb</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lamb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;lamb has wrong shape!</span><span class="se">\n</span><span class="s2">&quot;</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- expected: (.., </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lamb</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;object cannot be spectral!&quot;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">n1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;X.ndim should be in [1, 2]</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- expected: (..., </span><span class="si">{}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">()</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">n1</span>

            <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">lamb</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="n">n2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">lamb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">n2</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lamb</span><span class="p">])</span>


        <span class="c1"># Get shapes</span>
        <span class="n">nt</span><span class="p">,</span> <span class="n">nch</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">nnch</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">nnlamb</span><span class="p">,</span> <span class="n">nlamb</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nnlamb</span><span class="p">,</span> <span class="n">nlamb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># Check indices</span>
        <span class="k">if</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">indtX</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">(</span><span class="n">nt</span><span class="p">,)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indtX</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indtX</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">nnch</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">indtlamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span><span class="o">~</span><span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lC</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">indtlamb</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">(</span><span class="n">nt</span><span class="p">,)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indtlamb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indtlamb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nnlamb</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">indXlamb</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nch</span><span class="p">,)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indXlamb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indXlamb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nnlamb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">indtXlamb</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nch</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">indtXlamb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">indtXlamb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nnlamb</span>

        <span class="c1"># Check consistency X/lamb shapes vs indices</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">nnch</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">nt</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">ii</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="p">[</span><span class="n">indtlamb</span><span class="p">,</span><span class="n">indXlamb</span><span class="p">,</span><span class="n">indtXlamb</span><span class="p">]]):</span>
                    <span class="k">assert</span> <span class="n">nnlamb</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">nch</span><span class="p">]</span>

        <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nlamb</span><span class="p">,</span> <span class="n">nnch</span><span class="p">,</span> <span class="n">nnlamb</span><span class="p">,</span>
             <span class="n">indtX</span><span class="p">,</span> <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">l</span>

    <span class="k">def</span> <span class="nf">_checkformat_inputs_XRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indtX</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indXlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indXlamb</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

        <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
        <span class="n">nt</span><span class="p">,</span> <span class="n">n1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">n1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">n1</span>
        <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">])</span>

        <span class="c1"># Get shapes</span>
        <span class="n">nnch</span><span class="p">,</span> <span class="n">nch</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># Check indices</span>
        <span class="k">if</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtX&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">indtX</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nt</span><span class="p">,)</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">indtX</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">indtX</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nnch</span>
        <span class="k">if</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indXlamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indXlamb&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtXlamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtXlamb&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">indXlamb</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">(</span><span class="n">nch</span><span class="p">,)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">indXlamb</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">indXlamb</span><span class="p">)</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnlamb&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="n">indtXlamb</span><span class="o">.</span><span class="n">shape</span><span class="o">==</span><span class="p">(</span><span class="n">nt</span><span class="p">,</span><span class="n">nch</span><span class="p">)</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">indtXlamb</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span>
                    <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">indtXlamb</span><span class="p">)</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnlamb&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">nnch</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span>


    <span class="k">def</span> <span class="nf">_checkformat_inputs_dlabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dlabels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dlabels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dlabels</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">lk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lamb&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dlabels</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">dlabels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="s1">&#39;a.u.&#39;</span><span class="p">}</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dlabels</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">dlabels</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;units&#39;</span><span class="p">]])</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dlabels</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dlabels</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="k">return</span> <span class="n">dlabels</span>

    <span class="k">def</span> <span class="nf">_checkformat_inputs_dtreat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtreat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dtreat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dtreat</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtreat</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
        <span class="n">lk0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dtreat</span><span class="p">()</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="n">dtreat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lk0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;dtreat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;dtreat&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;dtreat&#39;</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span>
                <span class="k">assert</span> <span class="n">dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;interp-t&#39;</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;indt&#39;</span><span class="p">,</span><span class="s1">&#39;indch&#39;</span><span class="p">,</span><span class="s1">&#39;indlamb&#39;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">dtreat</span>

    <span class="k">def</span> <span class="nf">_checkformat_inputs_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lCam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">lCam</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="n">nC</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">lCam</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nC</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lCam</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">lCam</span> <span class="o">=</span> <span class="p">[</span><span class="n">lCam</span><span class="p">]</span>
            <span class="n">nC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lCam</span><span class="p">)</span>
            <span class="c1"># Check type consistency</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">_is2D</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">()</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lCam</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
                <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> : </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span><span class="n">cc</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">)</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lCam</span><span class="p">]</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) fed wrong lCam:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Cls</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="c1"># Check config consistency</span>
            <span class="n">lconf</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">config</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lCam</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">cc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lconf</span><span class="p">]):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The provided Cams should have a config !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lconf</span> <span class="k">if</span> <span class="n">cc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># To be finished after modifying __eq__ in tf.utils</span>
            <span class="n">lexcept</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dvisible&#39;</span><span class="p">,</span><span class="s1">&#39;dcompute&#39;</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The following Cam do not have a consistent config:&quot;</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lCam</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cc</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">lexcept</span><span class="o">=</span><span class="n">lexcept</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Check number of channels wrt data</span>
            <span class="n">nR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cc</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;nRays&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">lCam</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nR</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Total nb. of rays from lCam != data.shape[1] !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="p">,</span> <span class="n">lCam</span><span class="p">,</span> <span class="n">nC</span>

    <span class="k">def</span> <span class="nf">_checkformat_inputs_dchans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">dchans</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dchans</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dchans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dchans</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ldchans</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">_dchans</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ldchans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">assert</span> <span class="n">ldchans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ldchans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">dchans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ldchans</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dchans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                                    <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ldchans</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dchans</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dchans</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">]</span>
                <span class="n">dchans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>
        <span class="k">return</span> <span class="n">dchans</span>

    <span class="k">def</span> <span class="nf">_checkformat_inputs_dextra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">dextra</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dextra</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dextra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dextra</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">dextra</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">dextra</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All dextra values should be dict with &#39;t&#39;:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - dextra[</span><span class="si">%s</span><span class="s2">] = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">dextra</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dextra</span>

    <span class="c1">###########</span>
    <span class="c1"># Get keys of dictionnaries</span>
    <span class="c1">###########</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_ddataRef</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;lamb&#39;</span><span class="p">,</span> <span class="s1">&#39;nt&#39;</span><span class="p">,</span> <span class="s1">&#39;nch&#39;</span><span class="p">,</span> <span class="s1">&#39;nlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;nnch&#39;</span><span class="p">,</span> <span class="s1">&#39;nnlamb&#39;</span><span class="p">,</span>
              <span class="s1">&#39;indtX&#39;</span><span class="p">,</span> <span class="s1">&#39;indtlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;indXlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;indtXlamb&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_ddata</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;lamb&#39;</span><span class="p">,</span> <span class="s1">&#39;nt&#39;</span><span class="p">,</span> <span class="s1">&#39;nch&#39;</span><span class="p">,</span> <span class="s1">&#39;nlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;nnch&#39;</span><span class="p">,</span> <span class="s1">&#39;nnlamb&#39;</span><span class="p">,</span>
              <span class="s1">&#39;indtX&#39;</span><span class="p">,</span> <span class="s1">&#39;indtlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;indXlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;indtXlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;uptodate&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dtreat</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">,</span><span class="s1">&#39;mask-ind&#39;</span><span class="p">,</span> <span class="s1">&#39;mask-val&#39;</span><span class="p">,</span> <span class="s1">&#39;interp-indt&#39;</span><span class="p">,</span> <span class="s1">&#39;interp-indch&#39;</span><span class="p">,</span>
              <span class="s1">&#39;data0-indt&#39;</span><span class="p">,</span> <span class="s1">&#39;data0-Dt&#39;</span><span class="p">,</span> <span class="s1">&#39;data0-data&#39;</span><span class="p">,</span>
              <span class="s1">&#39;dfit&#39;</span><span class="p">,</span> <span class="s1">&#39;indt&#39;</span><span class="p">,</span>  <span class="s1">&#39;indch&#39;</span><span class="p">,</span> <span class="s1">&#39;indlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;interp-t&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dlabels</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">lk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;lamb&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dgeom</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;lCam&#39;</span><span class="p">,</span> <span class="s1">&#39;nC&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dX12</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;x1&#39;</span><span class="p">,</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span><span class="s1">&#39;n1&#39;</span><span class="p">,</span> <span class="s1">&#39;n2&#39;</span><span class="p">,</span>
              <span class="s1">&#39;ind1&#39;</span><span class="p">,</span> <span class="s1">&#39;ind2&#39;</span><span class="p">,</span> <span class="s1">&#39;indr&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dchans</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dextra</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">lk</span>

    <span class="c1">###########</span>
    <span class="c1"># _init</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dtreat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">dlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lCam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_ddataRef</span><span class="p">()</span>
        <span class="n">kwddataRef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dtreat</span><span class="p">()</span>
        <span class="n">kwdtreat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dlabels</span><span class="p">()</span>
        <span class="n">kwdlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dgeom</span><span class="p">()</span>
        <span class="n">kwdgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dchans</span><span class="p">()</span>
        <span class="n">kwdchans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dextra</span><span class="p">()</span>
        <span class="n">kwdextra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ddataRef</span><span class="p">(</span><span class="o">**</span><span class="n">kwddataRef</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dtreat</span><span class="p">(</span><span class="o">**</span><span class="n">kwdtreat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ddata</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dlabels</span><span class="p">(</span><span class="o">**</span><span class="n">kwdlabels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="o">**</span><span class="n">kwdgeom</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="n">kwdX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dX12</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_dX12</span><span class="p">(</span><span class="o">**</span><span class="n">kwdX12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dchans</span><span class="p">(</span><span class="o">**</span><span class="n">kwdchans</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dextra</span><span class="p">(</span><span class="o">**</span><span class="n">kwdextra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">###########</span>
    <span class="c1"># set dictionaries</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_set_ddataRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_ddataRef</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nlamb</span><span class="p">,</span> <span class="n">nnch</span><span class="p">,</span> <span class="n">nnlamb</span> <span class="o">=</span> <span class="n">lout</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span>
        <span class="n">indtX</span><span class="p">,</span> <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span> <span class="o">=</span> <span class="n">lout</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;lamb&#39;</span><span class="p">:</span><span class="n">lamb</span><span class="p">,</span>
                          <span class="s1">&#39;nt&#39;</span><span class="p">:</span><span class="n">nt</span><span class="p">,</span> <span class="s1">&#39;nch&#39;</span><span class="p">:</span><span class="n">nch</span><span class="p">,</span> <span class="s1">&#39;nlamb&#39;</span><span class="p">:</span><span class="n">nlamb</span><span class="p">,</span>
                          <span class="s1">&#39;nnch&#39;</span><span class="p">:</span><span class="n">nnch</span><span class="p">,</span> <span class="s1">&#39;nnlamb&#39;</span><span class="p">:</span><span class="n">nnlamb</span><span class="p">,</span>
                          <span class="s1">&#39;indtX&#39;</span><span class="p">:</span><span class="n">indtX</span><span class="p">,</span> <span class="s1">&#39;indtlamb&#39;</span><span class="p">:</span><span class="n">indtlamb</span><span class="p">,</span>
                          <span class="s1">&#39;indXlamb&#39;</span><span class="p">:</span><span class="n">indXlamb</span><span class="p">,</span> <span class="s1">&#39;indtXlamb&#39;</span><span class="p">:</span><span class="n">indtXlamb</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">set_dtreat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtreat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dtreat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dtreat</span><span class="p">(</span><span class="n">dtreat</span><span class="o">=</span><span class="n">dtreat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span> <span class="o">=</span> <span class="n">dtreat</span>

    <span class="k">def</span> <span class="nf">_set_dlabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dlabels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dlabels</span><span class="p">(</span><span class="n">dlabels</span><span class="o">=</span><span class="n">dlabels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dlabels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dlabels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lCam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">lCam</span><span class="p">,</span> <span class="n">nC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dgeom</span><span class="p">(</span><span class="n">lCam</span><span class="o">=</span><span class="n">lCam</span><span class="p">,</span>
                                                          <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lCam&#39;</span><span class="p">:</span><span class="n">lCam</span><span class="p">,</span> <span class="s1">&#39;nC&#39;</span><span class="p">:</span><span class="n">nC</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">:</span><span class="n">config</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">set_dchans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dchans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set (or update) the dchans dict</span>

<span class="sd">        dchans is a dict of np.ndarrays of len() = self.nch containing</span>
<span class="sd">        channel-specific information</span>

<span class="sd">        Use the kwarg &#39;method&#39; to set / update the dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">]</span>
        <span class="n">dchans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dchans</span><span class="p">(</span><span class="n">dchans</span><span class="o">=</span><span class="n">dchans</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span> <span class="o">=</span> <span class="n">dchans</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dchans</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_dextra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;set&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set (or update) the dextra dict</span>

<span class="sd">        dextra is a dict of nested dict</span>
<span class="sd">        It contains all extra signal that can help interpret the data</span>
<span class="sd">            e.g.: heating power time traces, plasma current...</span>
<span class="sd">        Each nested dict should have the following fields:</span>
<span class="sd">            &#39;t&#39;    : 1D np.ndarray (time vector)</span>
<span class="sd">            &#39;data&#39; : 1D np.ndarray (data time trace)</span>
<span class="sd">            &#39;name&#39; : str (used as label in legend)</span>
<span class="sd">            &#39;units&#39;: str (used n parenthesis in legend after name)</span>

<span class="sd">        Use the kwarg &#39;method&#39; to set / update the dict</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">,</span><span class="s1">&#39;update&#39;</span><span class="p">]</span>
        <span class="n">dextra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dextra</span><span class="p">(</span><span class="n">dextra</span><span class="o">=</span><span class="n">dextra</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dextra</span> <span class="o">=</span> <span class="n">dextra</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dextra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span>

    <span class="c1">###########</span>
    <span class="c1"># strip dictionaries</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">_strip_ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_ddata</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_ddata</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_strip_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">lC</span><span class="p">,</span> <span class="n">config</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">list</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]])</span>
                <span class="n">lC</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">])):</span>
                    <span class="n">lC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">],</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">))</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">],</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="n">lCam</span><span class="o">=</span><span class="n">lC</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lpfe</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]:</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span>
                    <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span>
                    <span class="n">lf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lf</span> <span class="k">if</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">]</span>
                    <span class="n">exist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;BEWARE:</span>
<span class="s2">                            You are about to delete the lCam objects</span>
<span class="s2">                            Only the path/name to saved a object will be kept</span>

<span class="s2">                            But it appears that the following object has no</span>
<span class="s2">                            saved file where specified (obj.Id.SavePath)</span>
<span class="s2">                            Thus it won&#39;t be possible to retrieve it</span>
<span class="s2">                            (unless available in the current console:&quot;&quot;&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">lpfe</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lpfe</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span>
                <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span>
                <span class="n">lf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lf</span> <span class="k">if</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">]</span>
                <span class="n">exist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;BEWARE:</span>
<span class="s2">                        You are about to delete the config object</span>
<span class="s2">                        Only the path/name to saved a object will be kept</span>

<span class="s2">                        But it appears that the following object has no</span>
<span class="s2">                        saved file where specified (obj.Id.SavePath)</span>
<span class="s2">                        Thus it won&#39;t be possible to retrieve it</span>
<span class="s2">                        (unless available in the current console:&quot;&quot;&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfe</span>


    <span class="c1">###########</span>
    <span class="c1"># _strip and get/from dict</span>
    <span class="c1">###########</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">])</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 1: dgeom pathfiles</span>
<span class="s2">                 2: dgeom pathfiles + clear data</span>
<span class="s2">                 &quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="n">nMax</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span>

    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip_ddata</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dgeom</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ddataRef&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;ddata&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;dtreat&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;dlabels&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dlabels</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;dgeom&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;dchans&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;dextra&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dextra</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;dX12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">dout</span>

    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;ddataRef&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;ddata&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dtreat&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dlabels</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dlabels&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dgeom&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dextra</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dextra&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;dchans&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dchans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dchans&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is2D</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dX12&#39;</span><span class="p">])</span>


    <span class="c1">###########</span>
    <span class="c1"># properties</span>
    <span class="c1">###########</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ddataRef</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_ddata</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtreat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dlabels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dlabels</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dextra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dextra</span>

    <span class="k">def</span> <span class="nf">get_ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_ddata</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;nt&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;nch&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lCam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_isLOS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">cc</span><span class="o">.</span><span class="n">_isLOS</span><span class="p">()</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">c0</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_isSpectral</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;spectral&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_is2D</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;2d&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c1">###########</span>
    <span class="c1"># Hidden and public methods for ddata</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">set_XRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reset the reference X</span>

<span class="sd">        Useful if to replace channel indices by a time-vraying quantity</span>
<span class="sd">        e.g.: distance to the magnetic axis</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_XRef</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">indtX</span><span class="o">=</span><span class="n">indtX</span><span class="p">,</span>
                                            <span class="n">indXlamb</span><span class="o">=</span><span class="n">indtXlamb</span><span class="p">)</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">nnch</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span> <span class="o">=</span> <span class="n">out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nnch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indtX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtXlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indtXlamb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_indt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store the desired index array for the time vector</span>

<span class="sd">        If an array of indices (refering to self.ddataRef[&#39;t&#39;] is not provided,</span>
<span class="sd">        uses self.select_t(t=t) to produce it</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">indt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide either t or indt (or none)!&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_t</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_indch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store the desired index array for the channels</span>

<span class="sd">        If None =&gt; all channels</span>
<span class="sd">        Must be a 1d array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">indch</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indch</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">indch</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span>
        <span class="n">indch</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indch</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_indlamb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store the desired index array for the wavelength</span>

<span class="sd">        If None =&gt; all wavelengths</span>
<span class="sd">        Must be a 1d array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The wavelength can only be set with DataSpectral object !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indlamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indlamb</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">indlamb</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span>
            <span class="n">indlamb</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indlamb</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nlamb&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indlamb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="s1">&#39;__iter__&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;mask-ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;mask-val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_data0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">data0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">indt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">data0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nlamb&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">],)</span>
                    <span class="n">data0</span> <span class="o">=</span> <span class="n">data0</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data0</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provided data0 has wrong shape !</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Expected: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">data0</span><span class="o">.</span><span class="n">shape</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">Dt</span><span class="p">,</span> <span class="n">indt</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">indt</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">indt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_t</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">Dt</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">indt</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
                        <span class="n">data0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">indt</span><span class="p">,:,:]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">indt</span><span class="p">,:]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">indt</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">data0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data0</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;data0-indt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;data0-Dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;data0-data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_interp_indt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the indices of the times for which to interpolate data</span>

<span class="sd">        The index can be provided as:</span>
<span class="sd">            - A 1d np.ndarray of boolean or int indices</span>
<span class="sd">                =&gt; interpolate data at these times for all channels</span>
<span class="sd">            - A dict with:</span>
<span class="sd">                * keys = int indices of channels</span>
<span class="sd">                * values = array of int indices of times at which to interpolate</span>

<span class="sd">        Time indices refer to self.ddataRef[&#39;t&#39;]</span>
<span class="sd">        Channel indices refer to self.ddataRef[&#39;X&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">indt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">indt</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">list</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">indt</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">k</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indt</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indt</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">indt</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s1">&#39;__iter__&#39;</span><span class="p">)</span>
                <span class="n">indt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indt</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">lC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">indt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indt</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">indt</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span>
            <span class="n">indt</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indt</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;interp-indt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_interp_indch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the indices of the channels for which to interpolate data</span>

<span class="sd">        The index can be provided as:</span>
<span class="sd">            - A 1d np.ndarray of boolean or int indices of channels</span>
<span class="sd">                =&gt; interpolate data at these channels for all times</span>
<span class="sd">            - A dict with:</span>
<span class="sd">                * keys = int indices of times</span>
<span class="sd">                * values = array of int indices of chan. for which to interpolate</span>

<span class="sd">        Time indices refer to self.ddataRef[&#39;t&#39;]</span>
<span class="sd">        Channel indices refer to self.ddataRef[&#39;X&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">indch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">indch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">list</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">indch</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">k</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indch</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indch</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">indch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s1">&#39;__iter__&#39;</span><span class="p">)</span>
                <span class="n">indch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indch</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">lC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">indch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indch</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">indch</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span>
            <span class="n">indch</span> <span class="o">=</span> <span class="n">_format_ind</span><span class="p">(</span><span class="n">indch</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;interp-indch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_dfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dfit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the fitting dictionnary</span>

<span class="sd">        A dict contaning all parameters for fitting the data</span>
<span class="sd">        Valid dict content includes:</span>
<span class="sd">            - &#39;type&#39;: str</span>
<span class="sd">                &#39;fft&#39;:  A fourier filtering</span>
<span class="sd">                &#39;svd&#39;:  A svd filtering</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Not implemented yet !, dfit forced to None&quot;</span><span class="p">)</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">assert</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dfit</span><span class="p">,</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dfit</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">assert</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">dfit</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">dfit</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;svd&#39;</span><span class="p">,</span><span class="s1">&#39;fft&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;dfit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">set_dtreat_interpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the time vector on which to interpolate the data &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;interp-t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mask_ind</span><span class="p">,</span> <span class="n">mask_val</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mask_ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[:,</span><span class="n">mask_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_val</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[:,</span><span class="n">mask_ind</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">mask_val</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_interp_indt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;interp not coded yet for 3d data !&quot;</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">ind</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">],</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">]],</span>
                                             <span class="n">t</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">]],</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">],</span><span class="n">kk</span><span class="p">],</span>
                                             <span class="n">right</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">,</span><span class="n">ii</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_interp_indch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ind</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;interp not coded yet for 3d data !&quot;</span>
        <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">,</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">ind</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">data</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">]],</span>
                                             <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">]],</span> <span class="n">data</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="o">~</span><span class="n">ind</span><span class="p">[</span><span class="n">kk</span><span class="p">]],</span>
                                             <span class="n">right</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="o">~</span><span class="n">ind</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="o">~</span><span class="n">ind</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_data0</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">data0</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">data0</span>
            <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">data0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">data0</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:,:]</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_dfit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dfit</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dfit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dfit</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;svd&#39;</span><span class="p">:</span>
                <span class="c1">#data = _comp.()</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">dfit</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;svd&#39;</span><span class="p">:</span>
                <span class="c1">#data = _comp.()</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_indt</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nnch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">indtX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nt0</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">size</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indt</span><span class="p">,:]</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">indt</span><span class="p">,:,:]</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">indt</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">nt0</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indt</span><span class="p">,:]</span>
            <span class="n">nnch</span> <span class="o">=</span> <span class="n">indt</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtX</span> <span class="o">=</span> <span class="n">indtX</span><span class="p">[</span><span class="n">indt</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indtlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtlamb</span> <span class="o">=</span> <span class="n">indtlamb</span><span class="p">[</span><span class="n">indt</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtXlamb</span> <span class="o">=</span> <span class="n">indtXlamb</span><span class="p">[</span><span class="n">indt</span><span class="p">,:]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span> <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="p">,</span> <span class="n">nnch</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_indch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">indXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">indch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">indch</span><span class="p">,:]</span>
        <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">indch</span><span class="p">]</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">X</span><span class="p">[:,</span><span class="n">indch</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indXlamb</span> <span class="o">=</span> <span class="n">indXlamb</span><span class="p">[</span><span class="n">indch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtXlamb</span> <span class="o">=</span> <span class="n">indtXlamb</span><span class="p">[:,</span><span class="n">indch</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_indlamb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">indlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,:,</span><span class="n">indlamb</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span><span class="p">[</span><span class="n">indlamb</span><span class="p">]</span> <span class="k">if</span> <span class="n">lamb</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">lamb</span><span class="p">[:,</span><span class="n">indlamb</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">lamb</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_interp_t</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">indtX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">indtlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">scpinterp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">bounds_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                               <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="n">indtX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">indtlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">):</span>
            <span class="n">indt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">interpt</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">interpt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">indtX</span> <span class="o">=</span> <span class="n">indtX</span><span class="p">[</span><span class="n">indt</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">indtlamb</span> <span class="o">=</span> <span class="n">indtlamb</span><span class="p">[</span><span class="n">indt</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">indtXlamb</span> <span class="o">=</span> <span class="n">indtXlamb</span><span class="p">[</span><span class="n">indt</span><span class="p">,:]</span>
        <span class="k">return</span> <span class="n">d</span><span class="p">,</span> <span class="n">interpt</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span> <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indtXlamb</span>




    <span class="k">def</span> <span class="nf">_get_ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_ddata</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">set_dtreat_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the order in which the data treatment should be performed</span>

<span class="sd">        Provide an ordered list of keywords indicating the order in which</span>
<span class="sd">         you wish the data treatment steps to be performed.</span>
<span class="sd">        Each keyword corresponds to a step.</span>
<span class="sd">        Available steps are (in default order):</span>
<span class="sd">            - &#39;mask&#39; :</span>
<span class="sd">            - &#39;interp_indt&#39; :</span>
<span class="sd">            - &#39;interp_indch&#39; :</span>
<span class="sd">            - &#39;data0&#39; :</span>
<span class="sd">            - &#39;dfit&#39; :</span>
<span class="sd">            - &#39;indt&#39; :</span>
<span class="sd">            - &#39;indch&#39; :</span>
<span class="sd">            - &#39;interp_t&#39;:</span>

<span class="sd">        All steps are performed on the stored reference self.dataRef[&#39;data&#39;]</span>
<span class="sd">        Thus, the time and channels restriction must be the last 2 steps before</span>
<span class="sd">        interpolating on an external time vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;dtreat&#39;</span><span class="p">][</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">order</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;indt&#39;</span><span class="p">,</span><span class="s1">&#39;indch&#39;</span><span class="p">,</span><span class="s1">&#39;indlamb&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">order</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;indt and indch must be the treatment steps -2 and -3 !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">order</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;interp-t&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;interp-t must be the last treatment step !&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_get_treated_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Produce a working copy of the data based on the treated reference</span>

<span class="sd">        The reference data is always stored and untouched in self.ddataRef</span>
<span class="sd">        You always interact with self.data, which returns a working copy.</span>
<span class="sd">        That working copy is the reference data, eventually treated along the</span>
<span class="sd">            lines defined (by the user) in self.dtreat</span>
<span class="sd">        By reseting the treatment (self.reset()) all data treatment is</span>
<span class="sd">        cancelled and the working copy returns the reference data.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># --------------------</span>
        <span class="c1"># Copy reference data</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">indtX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtX&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indtX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtX</span> <span class="o">=</span> <span class="n">indtX</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">indtlamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtlamb&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indtlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtlamb</span> <span class="o">=</span> <span class="n">indtlamb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">indXlamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indXlamb&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indXlamb</span> <span class="o">=</span> <span class="n">indXlamb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">indtXlamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtXlamb&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indtXlamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indtXlamb</span> <span class="o">=</span> <span class="n">indtXlamb</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">nnch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnch&#39;</span><span class="p">]</span>
        <span class="c1"># --------------------</span>
        <span class="c1"># Apply data treatment</span>
        <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]:</span>
            <span class="c1"># data only</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;mask&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;mask-ind&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mask</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;mask-ind&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;mask-val&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;interp_indt&#39;</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_indt</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;interp-indt&#39;</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;interp_indch&#39;</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_indch</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;interp-indch&#39;</span><span class="p">],</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;data0&#39;</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data0</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;data0-data&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;dfit&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;dfit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dfit</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;dfit&#39;</span><span class="p">])</span>

            <span class="c1"># data + others</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;indt&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indt&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span><span class="n">indtlamb</span><span class="p">,</span><span class="n">indtXlamb</span><span class="p">,</span> <span class="n">nnch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indt</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span>
                                                                   <span class="n">nnch</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span>
                                                                   <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="p">,</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indt&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;indch&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indch&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">,</span><span class="n">X</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span><span class="n">indtXlamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indch</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indch&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;indlamb&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indlamb&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">,</span> <span class="n">lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indch</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indlamb&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">kk</span><span class="o">==</span><span class="s1">&#39;interp_t&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;interp-t&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span><span class="p">,</span><span class="n">t</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span><span class="n">indtlamb</span><span class="p">,</span><span class="n">indtXlamb</span>\
                        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_t</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">indtX</span><span class="p">,</span> <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;interp-t&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">)</span>
        <span class="c1"># --------------------</span>
        <span class="c1"># Safety check</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="p">(</span><span class="n">nt</span><span class="p">,</span> <span class="n">nch</span><span class="p">),</span> <span class="n">nlamb</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nt</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nlamb</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nt</span><span class="p">,),</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nnch</span><span class="p">,</span> <span class="n">nch</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Data, X, t shape unconsistency:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - data.shape: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - X.shape:     </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - (nnch, nch): </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">((</span><span class="n">nnch</span><span class="p">,</span><span class="n">nch</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - t.shape: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - nt :     </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">lamb</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnlamb&#39;</span><span class="p">],</span> <span class="n">nlamb</span><span class="p">)</span>

        <span class="n">lout</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nlamb</span><span class="p">,</span>
                <span class="n">indtX</span><span class="p">,</span> <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="p">,</span> <span class="n">nnch</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lout</span>

    <span class="k">def</span> <span class="nf">_set_ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">lamb</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nlamb</span><span class="p">,</span>\
                    <span class="n">indtX</span><span class="p">,</span> <span class="n">indtlamb</span><span class="p">,</span> <span class="n">indXlamb</span><span class="p">,</span> <span class="n">indtXlamb</span><span class="p">,</span>\
                    <span class="n">nnch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_treated_data</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lamb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;nlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlamb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;nnch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nnch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;nnlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnlamb&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;indtX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indtX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;indtlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indtlamb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;indXlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indXlamb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;indtXlamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indtXlamb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="k">def</span> <span class="nf">clear_ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear the working copy of data</span>

<span class="sd">        Harmless, as it preserves the reference copy and the treatment dict</span>
<span class="sd">        Use only to free some memory</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_ddata</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="s1">&#39;uptodate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">clear_dtreat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear all treatment parameters in self.dtreat</span>

<span class="sd">        Subsequently also clear the working copy of data</span>
<span class="sd">        The working copy of data is thus reset to the reference data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
              <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;order&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;BEWARE : You are about to delete the data treatment</span>
<span class="s2">                              i.e.: to clear self.dtreat (and also self.ddata)</span>
<span class="s2">                              Are you sure ?</span>
<span class="s2">                              If yes, use self.clear_dtreat(force=True)&quot;&quot;&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dtreat</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dtreat</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dtreat</span><span class="p">(</span><span class="n">dtreat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_ddata</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">dchans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the dchans updated with indch</span>

<span class="sd">        Return a dict with all keys if key=None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indch&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indch&#39;</span><span class="p">]):</span>
            <span class="n">dch</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dch</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lk</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">dch</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indch&#39;</span><span class="p">]]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">dch</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">kk</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">_dtreat</span><span class="p">[</span><span class="s1">&#39;indch&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Don&#39;t know how to treat self._dchans[</span><span class="si">%s</span><span class="s2">]:&quot;</span><span class="o">%</span><span class="n">kk</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  shape = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dch</span> <span class="o">=</span> <span class="n">dch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dch</span>


    <span class="c1">###########</span>
    <span class="c1"># Other public methods</span>
    <span class="c1">###########</span>

    <span class="k">def</span> <span class="nf">select_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a time index array</span>

<span class="sd">        Return a boolean or integer index array, hereafter called &#39;ind&#39;</span>
<span class="sd">        The array refers to the reference time vector self.ddataRef[&#39;t&#39;]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t :     None / float / np.ndarray / list / tuple</span>
<span class="sd">            The time values to be selected:</span>
<span class="sd">                - None : ind matches all time values</span>
<span class="sd">                - float : ind is True only for the time closest to t</span>
<span class="sd">                - np.ndarray : ind is True only for the times closest to t</span>
<span class="sd">                - list (len()==2): ind is True for the times inside [t[0],t[1]]</span>
<span class="sd">                - tuple (len()==2): ind is True for times outside ]t[0];t[1][</span>
<span class="sd">        out :   type</span>
<span class="sd">            Specifies the type of the output index array:</span>
<span class="sd">                - bool : return a boolean array of shape (self.ddataRef[&#39;nt&#39;],)</span>
<span class="sd">                - int : return the array as integers indices</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        ind :   np.ndarray</span>
<span class="sd">            The array of indices, of dtype specified by keywordarg out</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">_select_ind</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ind</span>


    <span class="k">def</span> <span class="nf">select_ch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">touch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a channels index array</span>

<span class="sd">        Return a boolean or integer index array, hereafter called &#39;ind&#39;</span>
<span class="sd">        The array refers to the reference channel/&#39;X&#39; vector self.ddataRef[&#39;X&#39;]</span>

<span class="sd">        There are 3 different ways of selecting channels, by refering to:</span>
<span class="sd">            - The &#39;X&#39; vector/array values in self.dataRef[&#39;X&#39;]</span>
<span class="sd">            - The dict of channels keys/values (if self.dchans != None)</span>
<span class="sd">            - which element each LOS touches (if self.lCam != None)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        val :   None / str / float / np.array / list / tuple</span>
<span class="sd">            The value against which to dicriminate.</span>
<span class="sd">            Behaviour depends whether key is provided:</span>
<span class="sd">                - key is None =&gt; val compares vs self.ddataRef[&#39;X&#39;]</span>
<span class="sd">                - key provided =&gt; val compares vs self.dchans[key]</span>
<span class="sd">            If key is None, the behaviour is similar to self.select_indt():</span>
<span class="sd">                - None : ind matches all channels</span>
<span class="sd">                - float : ind is True only for X closest to val</span>
<span class="sd">                - np.ndarray : ind is True only for X closest to val</span>
<span class="sd">                - list (len()==2): ind is True for X inside [val[0],val[1]]</span>
<span class="sd">                - tuple (len()==2): ind is True for X outside ]val[0];val[1][</span>

<span class="sd">        key :   None / str</span>
<span class="sd">            If provided, dict key to indicate which self.dchans[key] to use</span>

<span class="sd">        log :   str</span>
<span class="sd">            If key provided, val can be a list of criteria</span>
<span class="sd">            Then, log indicates whether all / any / none should be matched</span>

<span class="sd">        touch : None</span>
<span class="sd">            If key and val are None, return the indices of the LOS touching the</span>
<span class="sd">            elements indicated in touch.</span>
<span class="sd">            Requires that self.dgeom[&#39;lCam&#39;] is not None (tf.geom.Cam.select())</span>

<span class="sd">        out :   type</span>
<span class="sd">            Specifies the type of the output index array:</span>
<span class="sd">                - bool : return a boolean array of shape (self.ddataRef[&#39;nt&#39;],)</span>
<span class="sd">                - int : return the array as integers indices</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        ind :   np.ndarray</span>
<span class="sd">            The array of indices, of dtype specified by keywordarg out</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">bool</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;any&#39;</span><span class="p">,</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="s1">&#39;not&#39;</span><span class="p">]</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">touch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">lC</span> <span class="o">=</span> <span class="p">[</span><span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">lc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
              <span class="ow">not</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="ow">and</span> <span class="n">lc</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lC</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">lC</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># get all channels</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">],),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">lC</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># get touch</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;self.dgeom[&#39;lCam&#39;] must be set to use touch !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]]):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;self.dgeom[&#39;lCam&#39;] contains pathfiles !&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  =&gt; Run self.strip(0)&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]:</span>
                <span class="n">ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">touch</span><span class="o">=</span><span class="n">touch</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">lC</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="c1"># get values on X</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnch&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">_select_ind</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nt&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nnch&#39;</span><span class="p">]):</span>
                    <span class="n">iind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;indtX&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ii</span>
                    <span class="n">ind</span><span class="p">[</span><span class="n">iind</span><span class="p">,:]</span> <span class="o">=</span>  <span class="n">_select_ind</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provided key not valid!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - key: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Please provide a valid key of self.dchans():</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">ltypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]</span>
            <span class="n">C0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
            <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span>
            <span class="k">if</span> <span class="n">C0</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ltypes</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_dchans</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">==</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">log</span><span class="o">==</span><span class="s1">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">log</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ind</span>

    <span class="k">def</span> <span class="nf">select_lamb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a wavelength index array</span>

<span class="sd">        Return a boolean or integer index array, hereafter called &#39;ind&#39;</span>
<span class="sd">        The array refers to the reference time vector self.ddataRef[&#39;lamb&#39;]</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lamb :     None / float / np.ndarray / list / tuple</span>
<span class="sd">            The time values to be selected:</span>
<span class="sd">                - None : ind matches all wavelength values</span>
<span class="sd">                - float : ind is True only for the wavelength closest to lamb</span>
<span class="sd">                - np.ndarray : ind True only for the wavelength closest to lamb</span>
<span class="sd">                - list (len()==2): ind True for wavelength in [lamb[0],lamb[1]]</span>
<span class="sd">                - tuple (len()==2): ind True for wavelength outside ]t[0];t[1][</span>
<span class="sd">        out :   type</span>
<span class="sd">            Specifies the type of the output index array:</span>
<span class="sd">                - bool : return a boolean array of shape (self.ddataRef[&#39;nlamb&#39;],)</span>
<span class="sd">                - int : return the array as integers indices</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        ind :   np.ndarray</span>
<span class="sd">            The array of indices, of dtype specified by keywordarg out</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">out</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">bool</span><span class="p">,</span><span class="nb">int</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">_select_ind</span><span class="p">(</span><span class="n">lamb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddataRef</span><span class="p">[</span><span class="s1">&#39;nlamb&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ind</span>



    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">vmin_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normt_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
             <span class="n">ntMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlbdMax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
             <span class="n">lls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lclbd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">inct</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">incX</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">inclbd</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
             <span class="n">fmt_t</span><span class="o">=</span><span class="s1">&#39;06.3f&#39;</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="s1">&#39;01.0f&#39;</span><span class="p">,</span>
             <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="n">dmarker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the data content in a generic interactive figure  &quot;&quot;&quot;</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Data_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">indref</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                             <span class="n">vmin_map</span><span class="o">=</span><span class="n">vmin_map</span><span class="p">,</span> <span class="n">vmax_map</span><span class="o">=</span><span class="n">vmax_map</span><span class="p">,</span>
                             <span class="n">cmap_map</span><span class="o">=</span><span class="n">cmap_map</span><span class="p">,</span> <span class="n">normt_map</span><span class="o">=</span><span class="n">normt_map</span><span class="p">,</span>
                             <span class="n">ntMax</span><span class="o">=</span><span class="n">ntMax</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="n">nchMax</span><span class="p">,</span> <span class="n">nlbdMax</span><span class="o">=</span><span class="n">nlbdMax</span><span class="p">,</span>
                             <span class="n">lls</span><span class="o">=</span><span class="n">lls</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="n">lct</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="n">lcch</span><span class="p">,</span> <span class="n">lclbd</span><span class="o">=</span><span class="n">lclbd</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="n">cbck</span><span class="p">,</span>
                             <span class="n">inct</span><span class="o">=</span><span class="n">inct</span><span class="p">,</span> <span class="n">incX</span><span class="o">=</span><span class="n">incX</span><span class="p">,</span> <span class="n">inclbd</span><span class="o">=</span><span class="n">inclbd</span><span class="p">,</span>
                             <span class="n">fmt_t</span><span class="o">=</span><span class="n">fmt_t</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="n">fmt_X</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span>
                             <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span> <span class="n">dmarker</span><span class="o">=</span><span class="n">dmarker</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span>
                             <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
                             <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">,</span>
                             <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kh</span>

    <span class="k">def</span> <span class="nf">plot_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lD</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">vmin_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normt_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">ntMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlbdMax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                     <span class="n">lls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lclbd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">inct</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">incX</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">inclbd</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
                     <span class="n">fmt_t</span><span class="o">=</span><span class="s1">&#39;06.3f&#39;</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="s1">&#39;01.0f&#39;</span><span class="p">,</span> <span class="n">fmt_l</span><span class="o">=</span><span class="s1">&#39;07.3f&#39;</span><span class="p">,</span>
                     <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="n">dmarker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharelamb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot several Data instances of the same diag</span>

<span class="sd">        Useful to compare :</span>
<span class="sd">                - the diag data for 2 different shots</span>
<span class="sd">                - experimental vs synthetic data for the same shot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lD</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">C0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span><span class="n">DataAbstract</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">lD</span><span class="p">])</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">lD</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span><span class="n">DataAbstract</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span><span class="p">,</span> <span class="s1">&#39;Provided first arg. must be a tf.data.DataAbstract or list !&#39;</span>
        <span class="n">lD</span> <span class="o">=</span> <span class="p">[</span><span class="n">lD</span><span class="p">]</span> <span class="k">if</span> <span class="n">C1</span> <span class="k">else</span> <span class="n">lD</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Data_plot</span><span class="p">([</span><span class="bp">self</span><span class="p">]</span><span class="o">+</span><span class="n">lD</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">indref</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                             <span class="n">vmin_map</span><span class="o">=</span><span class="n">vmin_map</span><span class="p">,</span> <span class="n">vmax_map</span><span class="o">=</span><span class="n">vmax_map</span><span class="p">,</span>
                             <span class="n">cmap_map</span><span class="o">=</span><span class="n">cmap_map</span><span class="p">,</span> <span class="n">normt_map</span><span class="o">=</span><span class="n">normt_map</span><span class="p">,</span>
                             <span class="n">ntMax</span><span class="o">=</span><span class="n">ntMax</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="n">nchMax</span><span class="p">,</span> <span class="n">nlbdMax</span><span class="o">=</span><span class="n">nlbdMax</span><span class="p">,</span>
                             <span class="n">lls</span><span class="o">=</span><span class="n">lls</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="n">lct</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="n">lcch</span><span class="p">,</span> <span class="n">lclbd</span><span class="o">=</span><span class="n">lclbd</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="n">cbck</span><span class="p">,</span>
                             <span class="n">inct</span><span class="o">=</span><span class="n">inct</span><span class="p">,</span> <span class="n">incX</span><span class="o">=</span><span class="n">incX</span><span class="p">,</span> <span class="n">inclbd</span><span class="o">=</span><span class="n">inclbd</span><span class="p">,</span>
                             <span class="n">fmt_t</span><span class="o">=</span><span class="n">fmt_t</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="n">fmt_X</span><span class="p">,</span> <span class="n">fmt_l</span><span class="o">=</span><span class="n">fmt_l</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span>
                             <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span> <span class="n">dmarker</span><span class="o">=</span><span class="n">dmarker</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span>
                             <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">,</span> <span class="n">sharelamb</span><span class="o">=</span><span class="n">sharelamb</span><span class="p">,</span>
                             <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span>
                             <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">,</span>
                             <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kh</span>

    <span class="k">def</span> <span class="nf">plot_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lD</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indref</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                  <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">vmin_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normt_map</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">ntMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nlbdMax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                  <span class="n">inct</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">incX</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">inclbd</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span>
                  <span class="n">lls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lclbd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">fmt_t</span><span class="o">=</span><span class="s1">&#39;06.3f&#39;</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="s1">&#39;01.0f&#39;</span><span class="p">,</span>
                  <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="n">dmarker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot several Data instances of different diags</span>

<span class="sd">        Useful to visualize several diags for the same shot</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lD</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="n">C0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span><span class="n">DataAbstract</span><span class="p">)</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">lD</span><span class="p">])</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">lD</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span><span class="n">DataAbstract</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">C0</span> <span class="ow">or</span> <span class="n">C1</span><span class="p">,</span> <span class="s1">&#39;Provided first arg. must be a tf.data.DataAbstract or list !&#39;</span>
        <span class="n">lD</span> <span class="o">=</span> <span class="p">[</span><span class="n">lD</span><span class="p">]</span> <span class="k">if</span> <span class="n">C1</span> <span class="k">else</span> <span class="n">lD</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Data_plot_combine</span><span class="p">([</span><span class="bp">self</span><span class="p">]</span><span class="o">+</span><span class="n">lD</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span>
                                     <span class="n">indref</span><span class="o">=</span><span class="n">indref</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span>
                                     <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                                     <span class="n">vmin_map</span><span class="o">=</span><span class="n">vmin_map</span><span class="p">,</span> <span class="n">vmax_map</span><span class="o">=</span><span class="n">vmax_map</span><span class="p">,</span>
                                     <span class="n">cmap_map</span><span class="o">=</span><span class="n">cmap_map</span><span class="p">,</span> <span class="n">normt_map</span><span class="o">=</span><span class="n">normt_map</span><span class="p">,</span>
                                     <span class="n">ntMax</span><span class="o">=</span><span class="n">ntMax</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="n">nchMax</span><span class="p">,</span>
                                     <span class="n">inct</span><span class="o">=</span><span class="n">inct</span><span class="p">,</span> <span class="n">incX</span><span class="o">=</span><span class="n">incX</span><span class="p">,</span>
                                     <span class="n">lls</span><span class="o">=</span><span class="n">lls</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="n">lct</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="n">lcch</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="n">cbck</span><span class="p">,</span>
                                     <span class="n">fmt_t</span><span class="o">=</span><span class="n">fmt_t</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="n">fmt_X</span><span class="p">,</span>
                                     <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span>
                                     <span class="n">dmarker</span><span class="o">=</span><span class="n">dmarker</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span>
                                     <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
                                     <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
                                     <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kh</span>


    <span class="k">def</span> <span class="nf">calc_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;scipy-fourier&#39;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">window</span><span class="o">=</span><span class="s1">&#39;hann&#39;</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                         <span class="n">nperseg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noverlap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">padded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">wave</span><span class="o">=</span><span class="s1">&#39;morlet&#39;</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the power spectrum density for each channel</span>

<span class="sd">        The power spectrum density is computed with the chosen method</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fmin :  None / float</span>
<span class="sd">            The minimum frequency of interest</span>
<span class="sd">            If None, set to 5/T, where T is the whole time interval</span>
<span class="sd">            Used to constrain the number of points per window</span>
<span class="sd">        deg :   bool</span>
<span class="sd">            Flag indicating whether to return the phase in deg (vs rad)</span>
<span class="sd">        method : str</span>
<span class="sd">            Flag indicating which method to use for computation:</span>
<span class="sd">                - &#39;scipy-fourier&#39;:  uses scipy.signal.spectrogram()</span>
<span class="sd">                    (windowed fast fourier transform)</span>
<span class="sd">                - &#39;scipy-stft&#39;:     uses scipy.signal.stft()</span>
<span class="sd">                    (short time fourier transform)</span>
<span class="sd">                - &#39;scipy-wavelet&#39;:  uses scipy.signal.cwt()</span>
<span class="sd">                    (continuous wavelet transform)</span>
<span class="sd">            The following keyword args are fed to one of these scipy functions</span>
<span class="sd">            See the corresponding online scipy documentation for details on</span>
<span class="sd">            each function and its arguments</span>
<span class="sd">        window : None / str / tuple</span>
<span class="sd">            If method=&#39;scipy-fourier&#39;</span>
<span class="sd">            Flag indicating which type of window to use</span>
<span class="sd">        detrend : None / str</span>
<span class="sd">            If method=&#39;scipy-fourier&#39;</span>
<span class="sd">            Flag indicating whether and how to remove the trend of the signal</span>
<span class="sd">        nperseg :   None / int</span>
<span class="sd">            If method=&#39;scipy-fourier&#39;</span>
<span class="sd">            Number of points to the used for each window</span>
<span class="sd">            If None, deduced from fmin</span>
<span class="sd">        noverlap:</span>
<span class="sd">            If method=&#39;scipy-fourier&#39;</span>
<span class="sd">            Number of points on which successive windows should overlap</span>
<span class="sd">            If None, nperseg-1</span>
<span class="sd">        boundary:</span>
<span class="sd">            If method=&#39;scipy-stft&#39;</span>

<span class="sd">        padded :</span>
<span class="sd">            If method=&#39;scipy-stft&#39;</span>
<span class="sd">            d</span>
<span class="sd">        wave: None / str</span>
<span class="sd">            If method=&#39;scipy-wavelet&#39;</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        tf :    np.ndarray</span>
<span class="sd">            Time vector of the spectrogram (1D)</span>
<span class="sd">        f:      np.ndarray</span>
<span class="sd">            frequency vector of the spectrogram (1D)</span>
<span class="sd">        lspect: list of np.ndarrays</span>
<span class="sd">            list of () spectrograms</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;spectrogram not implemented yet for spectral data class&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">tf</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">lpsd</span><span class="p">,</span> <span class="n">lang</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                              <span class="n">fmin</span><span class="o">=</span><span class="n">fmin</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
                                              <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                                              <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">nperseg</span><span class="p">,</span>
                                              <span class="n">noverlap</span><span class="o">=</span><span class="n">noverlap</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="n">boundary</span><span class="p">,</span>
                                              <span class="n">padded</span><span class="o">=</span><span class="n">padded</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span>
                                              <span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tf</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">lpsd</span><span class="p">,</span> <span class="n">lang</span>

    <span class="k">def</span> <span class="nf">plot_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">method</span><span class="o">=</span><span class="s1">&#39;scipy-fourier&#39;</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">window</span><span class="o">=</span><span class="s1">&#39;hann&#39;</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                         <span class="n">nperseg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noverlap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">padded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="s1">&#39;morlet&#39;</span><span class="p">,</span>
                         <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plotmethod</span><span class="o">=</span><span class="s1">&#39;imshow&#39;</span><span class="p">,</span>
                         <span class="n">cmap_f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap_img</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ntMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nfMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnspect</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the spectrogram of all channels with chosen method</span>

<span class="sd">        All non-plotting arguments are fed to self.calc_spectrogram()</span>
<span class="sd">        see self.calc_spectrogram? for details</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        kh :    tofu.utils.HeyHandler</span>
<span class="sd">            The tofu KeyHandler object handling figure interactivity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;spectrogram not implemented yet for spectral data class&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">tf</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">lpsd</span><span class="p">,</span> <span class="n">lang</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
                                              <span class="n">fmin</span><span class="o">=</span><span class="n">fmin</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">,</span>
                                              <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
                                              <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">nperseg</span><span class="p">,</span>
                                              <span class="n">noverlap</span><span class="o">=</span><span class="n">noverlap</span><span class="p">,</span> <span class="n">boundary</span><span class="o">=</span><span class="n">boundary</span><span class="p">,</span>
                                              <span class="n">padded</span><span class="o">=</span><span class="n">padded</span><span class="p">,</span> <span class="n">wave</span><span class="o">=</span><span class="n">wave</span><span class="p">,</span>
                                              <span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">)</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Data_plot_spectrogram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">lpsd</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="n">fmax</span><span class="p">,</span>
                                         <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span> <span class="n">plotmethod</span><span class="o">=</span><span class="n">plotmethod</span><span class="p">,</span>
                                         <span class="n">cmap_f</span><span class="o">=</span><span class="n">cmap_f</span><span class="p">,</span> <span class="n">cmap_img</span><span class="o">=</span><span class="n">cmap_img</span><span class="p">,</span>
                                         <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">ntMax</span><span class="o">=</span><span class="n">ntMax</span><span class="p">,</span>
                                         <span class="n">nfMax</span><span class="o">=</span><span class="n">nfMax</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span>
                                         <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
                                         <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                                         <span class="n">normt</span><span class="o">=</span><span class="n">normt</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
                                         <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">returnspect</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kh</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">lpsd</span><span class="p">,</span> <span class="n">lang</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kh</span>

    <span class="k">def</span> <span class="nf">calc_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lapack_driver</span><span class="o">=</span><span class="s1">&#39;gesdd&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the SVD decomposition of data</span>

<span class="sd">        The input data np.ndarray shall be of dimension 2,</span>
<span class="sd">            with time as the first dimension, and the channels in the second</span>
<span class="sd">            Hence data should be of shape (nt, nch)</span>

<span class="sd">        Uses scipy.linalg.svd(), with:</span>
<span class="sd">            full_matrices = True</span>
<span class="sd">            compute_uv = True</span>
<span class="sd">            overwrite_a = False</span>
<span class="sd">            check_finite = True</span>

<span class="sd">        See scipy online doc for details</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        chronos:    np.ndarray</span>
<span class="sd">            First arg (u) returned by scipy.linalg.svd()</span>
<span class="sd">            Contains the so-called &#39;chronos&#39;, of shape (nt, nt)</span>
<span class="sd">                i.e.: the time-dependent part of the decoposition</span>
<span class="sd">        s:          np.ndarray</span>
<span class="sd">            Second arg (s) returned by scipy.linalg.svd()</span>
<span class="sd">            Contains the singular values, of shape (nch,)</span>
<span class="sd">                i.e.: the channel-dependent part of the decoposition</span>
<span class="sd">        topos:      np.ndarray</span>
<span class="sd">            Third arg (v) returned by scipy.linalg.svd()</span>
<span class="sd">            Contains the so-called &#39;topos&#39;, of shape (nch, nch)</span>
<span class="sd">                i.e.: the channel-dependent part of the decoposition</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;svd not implemented yet for spectral data class&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">chronos</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">topos</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">calc_svd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lapack_driver</span><span class="o">=</span><span class="n">lapack_driver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chronos</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">topos</span>


    <span class="k">def</span> <span class="nf">extract_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lapack_driver</span><span class="o">=</span><span class="s1">&#39;gesdd&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extract, as Data object, the filtered signal using selected modes</span>

<span class="sd">        The svd (chronos, s, topos) is computed,</span>
<span class="sd">        The selected modes are used to re-construct a filtered signal, using:</span>
<span class="sd">            data = chronos[:,modes] @ (s[None,modes] @ topos[modes,:]</span>

<span class="sd">        The result is exported a an array or a Data object on the same class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;svd not implemented yet for spectral data class&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">modes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">modes</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg mode cannot be None !&quot;</span>
        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Arg modes must a positive int or a list of such!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">modes</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">chronos</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">topos</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">calc_svd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lapack_driver</span><span class="o">=</span><span class="n">lapack_driver</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmult</span><span class="p">(</span><span class="n">chronos</span><span class="p">[:,</span><span class="n">modes</span><span class="p">],</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">modes</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">topos</span><span class="p">[</span><span class="n">modes</span><span class="p">,:]))</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="nb">object</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                                  <span class="n">lCam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lCam</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                                  <span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Diag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Diag</span><span class="p">,</span>
                                  <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                                  <span class="n">Name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Name</span> <span class="o">+</span> <span class="s1">&#39;-svd</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">modes</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span>


    <span class="k">def</span> <span class="nf">plot_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lapack_driver</span><span class="o">=</span><span class="s1">&#39;gesdd&#39;</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">Lplot</span><span class="o">=</span><span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cmap_topos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmin_topos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vmax_topos</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ntMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">inct</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">incX</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> <span class="n">incm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
                 <span class="n">lls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lcm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fmt_t</span><span class="o">=</span><span class="s1">&#39;06.3f&#39;</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="s1">&#39;01.0f&#39;</span><span class="p">,</span> <span class="n">fmt_m</span><span class="o">=</span><span class="s1">&#39;03.0f&#39;</span><span class="p">,</span>
                 <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot the chosen modes of the svd decomposition</span>

<span class="sd">        All modes will be plotted, the keyword &#39;modes&#39; is only used to</span>
<span class="sd">        determine the reference modes for computing a common scale for</span>
<span class="sd">        vizualisation</span>

<span class="sd">        Runs self.calc_svd() and then plots the result in an interactive figure</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSpectral</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;svd not implemented yet for spectral data class&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># Computing (~0.2 s for 50 channels 1D and 1000 times)</span>
        <span class="n">chronos</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">topos</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">calc_svd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">lapack_driver</span><span class="o">=</span><span class="n">lapack_driver</span><span class="p">)</span>

        <span class="c1"># Plotting (~11 s for 50 channels 1D and 1000 times)</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">_plot</span><span class="o">.</span><span class="n">Data_plot_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chronos</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">topos</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="n">modes</span><span class="p">,</span>
                                 <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">,</span> <span class="n">Lplot</span><span class="o">=</span><span class="n">Lplot</span><span class="p">,</span>
                                 <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                                 <span class="n">cmap_topos</span><span class="o">=</span><span class="n">cmap_topos</span><span class="p">,</span> <span class="n">vmin_topos</span><span class="o">=</span><span class="n">vmin_topos</span><span class="p">,</span>
                                 <span class="n">vmax_topos</span><span class="o">=</span><span class="n">vmax_topos</span><span class="p">,</span>
                                 <span class="n">ntMax</span><span class="o">=</span><span class="n">ntMax</span><span class="p">,</span> <span class="n">nchMax</span><span class="o">=</span><span class="n">nchMax</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span>
                                 <span class="n">inct</span><span class="o">=</span><span class="n">inct</span><span class="p">,</span> <span class="n">incX</span><span class="o">=</span><span class="n">incX</span><span class="p">,</span> <span class="n">incm</span><span class="o">=</span><span class="n">incm</span><span class="p">,</span>
                                 <span class="n">lls</span><span class="o">=</span><span class="n">lls</span><span class="p">,</span> <span class="n">lct</span><span class="o">=</span><span class="n">lct</span><span class="p">,</span> <span class="n">lcch</span><span class="o">=</span><span class="n">lcch</span><span class="p">,</span> <span class="n">lcm</span><span class="o">=</span><span class="n">lcm</span><span class="p">,</span> <span class="n">cbck</span><span class="o">=</span><span class="n">cbck</span><span class="p">,</span>
                                 <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span> <span class="n">fmt_t</span><span class="o">=</span><span class="n">fmt_t</span><span class="p">,</span> <span class="n">fmt_X</span><span class="o">=</span><span class="n">fmt_X</span><span class="p">,</span> <span class="n">fmt_m</span><span class="o">=</span><span class="n">fmt_m</span><span class="p">,</span>
                                 <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="n">labelpad</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span>
                                 <span class="n">tit</span><span class="o">=</span><span class="n">tit</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
                                 <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kh</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">strip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;npz&#39;</span><span class="p">,</span>
             <span class="n">compressed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_pfe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">deep</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                                             <span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">compressed</span><span class="o">=</span><span class="n">compressed</span><span class="p">,</span>
                                             <span class="n">return_pfe</span><span class="o">=</span><span class="n">return_pfe</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>


    <span class="k">def</span> <span class="nf">save_to_imas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refshot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refrun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tokamak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">restore_size</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">forceupdate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">path_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path_X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">config_description_2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
       <span class="kn">import</span> <span class="nn">tofu.imas2tofu</span> <span class="k">as</span> <span class="nn">_tfimas</span>
       <span class="n">_tfimas</span><span class="o">.</span><span class="n">_save_to_imas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tfversion</span><span class="o">=</span><span class="n">__version__</span><span class="p">,</span>
                             <span class="n">shot</span><span class="o">=</span><span class="n">shot</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="n">run</span><span class="p">,</span> <span class="n">refshot</span><span class="o">=</span><span class="n">refshot</span><span class="p">,</span>
                             <span class="n">refrun</span><span class="o">=</span><span class="n">refrun</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">tokamak</span><span class="o">=</span><span class="n">tokamak</span><span class="p">,</span>
                             <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">occ</span><span class="o">=</span><span class="n">occ</span><span class="p">,</span> <span class="n">dryrun</span><span class="o">=</span><span class="n">dryrun</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span>
                             <span class="n">ids</span><span class="o">=</span><span class="n">ids</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="n">deep</span><span class="p">,</span>
                             <span class="n">restore_size</span><span class="o">=</span><span class="n">restore_size</span><span class="p">,</span>
                             <span class="n">forceupdate</span><span class="o">=</span><span class="n">forceupdate</span><span class="p">,</span>
                             <span class="n">path_data</span><span class="o">=</span><span class="n">path_data</span><span class="p">,</span> <span class="n">path_X</span><span class="o">=</span><span class="n">path_X</span><span class="p">,</span>
                             <span class="n">config_description_2d</span><span class="o">=</span><span class="n">config_description_2d</span><span class="p">,</span>
                             <span class="n">config_occ</span><span class="o">=</span><span class="n">config_occ</span><span class="p">)</span>


    <span class="c1">#----------------------------</span>
    <span class="c1"># Operator overloading section</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_common_params</span><span class="p">(</span><span class="n">obj0</span><span class="p">,</span> <span class="n">obj1</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">Id</span><span class="o">.</span><span class="n">_dall</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;modified&#39;</span>
            <span class="n">dcom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Id&#39;</span><span class="p">:</span><span class="n">Id</span><span class="p">,</span>
                    <span class="s1">&#39;dchans&#39;</span><span class="p">:</span><span class="n">obj0</span><span class="o">.</span><span class="n">_dchans</span><span class="p">,</span> <span class="s1">&#39;dlabels&#39;</span><span class="p">:</span><span class="n">obj0</span><span class="o">.</span><span class="n">dlabels</span><span class="p">,</span>
                    <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">obj0</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="n">obj0</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
                    <span class="s1">&#39;lCam&#39;</span><span class="p">:</span><span class="n">obj0</span><span class="o">.</span><span class="n">lCam</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">:</span><span class="n">obj0</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                    <span class="s1">&#39;dextra&#39;</span><span class="p">:</span><span class="n">obj0</span><span class="o">.</span><span class="n">dextra</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SavePath&#39;</span><span class="p">,</span> <span class="s1">&#39;Diag&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">]</span>
            <span class="n">dcom</span> <span class="o">=</span> <span class="p">{</span><span class="n">ss</span><span class="p">:</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj0</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span><span class="n">ss</span><span class="p">)</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ls</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj0</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj1</span><span class="o">.</span><span class="n">Id</span><span class="p">,</span><span class="n">ss</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">obj0</span><span class="o">.</span><span class="n">_dchans</span> <span class="o">==</span> <span class="n">obj1</span><span class="o">.</span><span class="n">_dchans</span><span class="p">:</span>
                <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;dchans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">_dchans</span>
            <span class="k">if</span> <span class="n">obj0</span><span class="o">.</span><span class="n">dlabels</span> <span class="o">==</span> <span class="n">obj1</span><span class="o">.</span><span class="n">dlabels</span><span class="p">:</span>
                <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;dlabels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">dlabels</span>
            <span class="k">if</span> <span class="n">obj0</span><span class="o">.</span><span class="n">dextra</span> <span class="o">==</span> <span class="n">obj1</span><span class="o">.</span><span class="n">dextra</span><span class="p">:</span>
                <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;dextra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">dextra</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">obj0</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="n">obj1</span><span class="o">.</span><span class="n">t</span><span class="p">):</span>
                <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">t</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">obj0</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">obj1</span><span class="o">.</span><span class="n">X</span><span class="p">):</span>
                <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">X</span>
            <span class="k">if</span> <span class="n">obj0</span><span class="o">.</span><span class="n">lCam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">obj1</span><span class="o">.</span><span class="n">lCam</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">c0</span> <span class="o">==</span> <span class="n">c1</span> <span class="k">for</span> <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">obj0</span><span class="o">.</span><span class="n">lCam</span><span class="p">,</span> <span class="n">obj1</span><span class="o">.</span><span class="n">lCam</span><span class="p">)]):</span>
                    <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">lCam</span>
            <span class="k">if</span> <span class="n">obj0</span><span class="o">.</span><span class="n">config</span> <span class="o">==</span> <span class="n">obj1</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
                <span class="n">dcom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj0</span><span class="o">.</span><span class="n">config</span>
        <span class="k">return</span> <span class="n">dcom</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_recreatefromoperator</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">opfunc</span><span class="p">(</span><span class="n">d0</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">dcom</span> <span class="o">=</span> <span class="n">d0</span><span class="o">.</span><span class="n">_extract_common_params</span><span class="p">(</span><span class="n">d0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">opfunc</span><span class="p">(</span><span class="n">d0</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="n">dcom</span> <span class="o">=</span> <span class="n">d0</span><span class="o">.</span><span class="n">_extract_common_params</span><span class="p">(</span><span class="n">d0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">opfunc</span><span class="p">(</span><span class="n">d0</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="n">dcom</span> <span class="o">=</span> <span class="n">d0</span><span class="o">.</span><span class="n">_extract_common_params</span><span class="p">(</span><span class="n">d0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">DataAbstract</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="n">d0</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Operator overloaded only for same-class instances:</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - provided: </span><span class="si">%s</span><span class="s2"> and </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">d0</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                                    <span class="n">other</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">opfunc</span><span class="p">(</span><span class="n">d0</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">data shapes not matching !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">dcom</span> <span class="o">=</span> <span class="n">d0</span><span class="o">.</span><span class="n">_extract_common_params</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Behaviour not implemented !&quot;</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d0</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="s1">&#39;New&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">dcom</span><span class="p">)</span>


    <span class="k">def</span> <span class="fm">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">-</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__radd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="fm">__pow__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">opfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="n">y</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreatefromoperator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">opfunc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>












<span class="c1">#####################################################################</span>
<span class="c1">#               Data1D and Data2D</span>
<span class="c1">#####################################################################</span>

<span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">)</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span>


<div class="viewcode-block" id="DataCam1D"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam1D">[docs]</a><span class="k">class</span> <span class="nc">DataCam1D</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Data object used for 1D cameras or list of 1D cameras  &quot;&quot;&quot;</span>
<div class="viewcode-block" id="DataCam1D._isSpectral"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam1D._isSpectral">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_isSpectral</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="k">return</span> <span class="kc">False</span></div>
<div class="viewcode-block" id="DataCam1D._is2D"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam1D._is2D">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_is2D</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>        <span class="k">return</span> <span class="kc">False</span></div></div>

<span class="n">lp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">,</span><span class="s1">&#39;dX12&#39;</span><span class="p">]]</span>
<span class="n">DataCam1D</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">lp</span><span class="p">)</span>

<div class="viewcode-block" id="DataCam1DSpectral"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam1DSpectral">[docs]</a><span class="k">class</span> <span class="nc">DataCam1DSpectral</span><span class="p">(</span><span class="n">DataCam1D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Data object used for 1D cameras or list of 1D cameras  &quot;&quot;&quot;</span>
<div class="viewcode-block" id="DataCam1DSpectral._isSpectral"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam1DSpectral._isSpectral">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_isSpectral</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lamb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;lamb&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nlamb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;nlamb&#39;</span><span class="p">)</span></div>

<span class="n">lp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dX12&#39;</span><span class="p">]]</span>
<span class="n">DataCam1D</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">lp</span><span class="p">)</span>


<div class="viewcode-block" id="DataCam2D"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2D">[docs]</a><span class="k">class</span> <span class="nc">DataCam2D</span><span class="p">(</span><span class="n">DataAbstract</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Data object used for 2D cameras or list of 2D cameras  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DataCam2D._isSpectral"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2D._isSpectral">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_isSpectral</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="k">return</span> <span class="kc">False</span></div>
<div class="viewcode-block" id="DataCam2D._is2D"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2D._is2D">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_is2D</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="DataCam2D._checkformat_dX12"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2D._checkformat_dX12">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_dX12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">dX12</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dX12</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span> <span class="ow">or</span> <span class="n">dX12</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="p">:</span><span class="s1">&#39;geom&#39;</span><span class="p">},</span>
              <span class="nb">isinstance</span><span class="p">(</span><span class="n">dX12</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">dX12</span> <span class="o">!=</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="p">:</span><span class="s1">&#39;geom&#39;</span><span class="p">}]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;dX12 must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- None</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- &#39;geom&#39; : will be derived from the cam geometry</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- dict : containing {&#39;x1&#39;  : array of coords.,</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">                     &#39;x2&#39;  : array of coords.,</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">                     &#39;ind1&#39;: array of int indices,</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">                     &#39;ind2&#39;: array of int indices}&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dX12</span><span class="p">()</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dX12</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c2</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dX12 cannot be derived from dgeom[&#39;lCam&#39;][0].dX12 !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;from&#39;</span><span class="p">:</span><span class="s1">&#39;geom&#39;</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">lc</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span><span class="s1">&#39;ind1&#39;</span><span class="p">,</span><span class="s1">&#39;ind2&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">dX12</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">])</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dX12</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dX12</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x2</span><span class="o">.</span><span class="n">size</span>
            <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="n">indr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ind12r_n12</span><span class="p">(</span><span class="n">ind1</span><span class="o">=</span><span class="n">dX12</span><span class="p">[</span><span class="s1">&#39;ind1&#39;</span><span class="p">],</span>
                                                    <span class="n">ind2</span><span class="o">=</span><span class="n">dX12</span><span class="p">[</span><span class="s1">&#39;ind2&#39;</span><span class="p">],</span>
                                                    <span class="n">n1</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="o">=</span><span class="n">n2</span><span class="p">)</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x1&#39;</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">:</span><span class="n">x2</span><span class="p">,</span> <span class="s1">&#39;n1&#39;</span><span class="p">:</span><span class="n">n1</span><span class="p">,</span> <span class="s1">&#39;n2&#39;</span><span class="p">:</span><span class="n">n2</span><span class="p">,</span>
                    <span class="s1">&#39;ind1&#39;</span><span class="p">:</span><span class="n">ind1</span><span class="p">,</span> <span class="s1">&#39;ind2&#39;</span><span class="p">:</span><span class="n">ind2</span><span class="p">,</span> <span class="s1">&#39;indr&#39;</span><span class="p">:</span><span class="n">indr</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">:</span><span class="s1">&#39;self&#39;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">dX12</span></div>

<div class="viewcode-block" id="DataCam2D.set_dX12"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2D.set_dX12">[docs]</a>    <span class="k">def</span> <span class="nf">set_dX12</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dX12</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_dX12</span><span class="p">(</span><span class="n">dX12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dX12</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dX12</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;geom&#39;</span><span class="p">:</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;lCam&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dX12</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dX12</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dX12</span>
        <span class="k">return</span> <span class="n">dX12</span>

<div class="viewcode-block" id="DataCam2D.get_X12plot"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2D.get_X12plot">[docs]</a>    <span class="k">def</span> <span class="nf">get_X12plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="s1">&#39;imshow&#39;</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dX12</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;imshow&#39;</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dX12</span><span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dX12</span><span class="p">[</span><span class="s1">&#39;x2&#39;</span><span class="p">]</span>
            <span class="n">x1min</span><span class="p">,</span> <span class="n">Dx1min</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x1max</span><span class="p">,</span> <span class="n">Dx1max</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">x2min</span><span class="p">,</span> <span class="n">Dx2min</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">x2max</span><span class="p">,</span> <span class="n">Dx2max</span> <span class="o">=</span> <span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1min</span> <span class="o">-</span> <span class="n">Dx1min</span><span class="p">,</span> <span class="n">x1max</span> <span class="o">+</span> <span class="n">Dx1max</span><span class="p">,</span>
                      <span class="n">x2min</span> <span class="o">-</span> <span class="n">Dx2min</span><span class="p">,</span> <span class="n">x2max</span> <span class="o">+</span> <span class="n">Dx2max</span><span class="p">)</span>
            <span class="n">indr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dX12</span><span class="p">[</span><span class="s1">&#39;indr&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">indr</span><span class="p">,</span> <span class="n">extent</span></div></div>

<span class="n">lp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">]]</span>
<span class="n">DataCam2D</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">lp</span><span class="p">)</span>



<div class="viewcode-block" id="DataCam2DSpectral"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2DSpectral">[docs]</a><span class="k">class</span> <span class="nc">DataCam2DSpectral</span><span class="p">(</span><span class="n">DataCam2D</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Data object used for 1D cameras or list of 1D cameras  &quot;&quot;&quot;</span>
<div class="viewcode-block" id="DataCam2DSpectral._isSpectral"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.DataCam2DSpectral._isSpectral">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_isSpectral</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="k">return</span> <span class="kc">True</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lamb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;lamb&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nlamb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ddata</span><span class="p">(</span><span class="s1">&#39;nlamb&#39;</span><span class="p">)</span></div>

<span class="n">lp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
<span class="n">DataCam2D</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">lp</span><span class="p">)</span>


<span class="c1"># ####################################################################</span>
<span class="c1"># ####################################################################</span>
<span class="c1">#               Plasma2D</span>
<span class="c1"># ####################################################################</span>
<span class="c1"># ####################################################################</span>


<div class="viewcode-block" id="Plasma2D"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D">[docs]</a><span class="k">class</span> <span class="nc">Plasma2D</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A generic class for handling 2D (and 1D) plasma profiles</span>

<span class="sd">    Provides:</span>
<span class="sd">        - equilibrium-related quantities</span>
<span class="sd">        - any 1d profile (can be remapped on 2D equilibrium)</span>
<span class="sd">        - spatial interpolation methods</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fixed (class-wise) dictionary of default properties</span>
    <span class="n">_ddef</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Id&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;include&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Mod&#39;</span><span class="p">,</span> <span class="s1">&#39;Cls&#39;</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">,</span> <span class="s1">&#39;Diag&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">,</span> <span class="s1">&#39;version&#39;</span><span class="p">]},</span>
             <span class="s1">&#39;dtreat&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;interp-indt&#39;</span><span class="p">,</span> <span class="s1">&#39;interp-indch&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;data0&#39;</span><span class="p">,</span> <span class="s1">&#39;dfit&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;indt&#39;</span><span class="p">,</span> <span class="s1">&#39;indch&#39;</span><span class="p">,</span> <span class="s1">&#39;indlamb&#39;</span><span class="p">,</span> <span class="s1">&#39;interp-t&#39;</span><span class="p">]}}</span>

    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="c1"># Does not exist before Python 3.6 !!!</span>
        <span class="c1"># Python 2</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Plasma2D</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>
        <span class="c1"># Python 3</span>
        <span class="c1"># super().__init_subclass__(**kwdargs)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Plasma2D</span><span class="o">.</span><span class="n">_ddef</span><span class="p">)</span>
        <span class="c1"># cls._dplot = copy.deepcopy(Struct._dplot)</span>
        <span class="c1"># cls._set_color_ddef(cls._color)</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dradius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d0d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">d2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fromdict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">SavePath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">),</span>
                 <span class="n">SavePath_Include</span><span class="o">=</span><span class="n">tfpf</span><span class="o">.</span><span class="n">defInclude</span><span class="p">):</span>

        <span class="c1"># Create a dplot at instance level</span>
        <span class="c1">#self._dplot = copy.deepcopy(self.__class__._dplot)</span>

        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">kwdargs</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Plasma2D</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwdargs</span><span class="p">)</span>

<div class="viewcode-block" id="Plasma2D._reset"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._reset">[docs]</a>    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Plasma2D</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dgroup</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dindref</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_ddata</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_keys_dgeom</span><span class="p">())</span></div>

<div class="viewcode-block" id="Plasma2D._checkformat_inputs_Id"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._checkformat_inputs_Id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_inputs_Id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">Exp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">include</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwdargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Id</span><span class="p">,</span><span class="n">utils</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">Name</span><span class="p">,</span> <span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span> <span class="o">=</span> <span class="n">Id</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">Id</span><span class="o">.</span><span class="n">shot</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Name</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">Exp</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Exp</span>
        <span class="k">if</span> <span class="n">include</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">include</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_ddef</span><span class="p">[</span><span class="s1">&#39;Id&#39;</span><span class="p">][</span><span class="s1">&#39;include&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">shot</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;shot&#39;</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
                <span class="n">include</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;shot&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shot</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;shot&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include</span><span class="p">:</span>
                <span class="n">include</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;shot&#39;</span><span class="p">)</span>
        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span><span class="n">Name</span><span class="p">,</span> <span class="s1">&#39;Exp&#39;</span><span class="p">:</span><span class="n">Exp</span><span class="p">,</span> <span class="s1">&#39;shot&#39;</span><span class="p">:</span><span class="n">shot</span><span class="p">,</span>
                        <span class="s1">&#39;include&#39;</span><span class="p">:</span><span class="n">include</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">kwdargs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get largs</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Plasma2D._get_largs_dindrefdatagroup"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_largs_dindrefdatagroup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dindrefdatagroup</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dtime&#39;</span><span class="p">,</span> <span class="s1">&#39;dradius&#39;</span><span class="p">,</span> <span class="s1">&#39;dmesh&#39;</span><span class="p">,</span> <span class="s1">&#39;d0d&#39;</span><span class="p">,</span> <span class="s1">&#39;d1d&#39;</span><span class="p">,</span> <span class="s1">&#39;d2d&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

<div class="viewcode-block" id="Plasma2D._get_largs_dgeom"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_largs_dgeom">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_largs_dgeom</span><span class="p">():</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">largs</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get check and format inputs</span>
    <span class="c1">###########</span>

    <span class="c1">#---------------------</span>
    <span class="c1"># Methods for checking and formatting inputs</span>
    <span class="c1">#---------------------</span>

<div class="viewcode-block" id="Plasma2D._extract_dnd"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._extract_dnd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_extract_dnd</span><span class="p">(</span><span class="n">dnd</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span>
                     <span class="n">dim_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quant_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">origin_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units_</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Set defaults</span>
        <span class="n">dim_</span> <span class="o">=</span>   <span class="n">k0</span> <span class="k">if</span> <span class="n">dim_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">dim_</span>
        <span class="n">quant_</span> <span class="o">=</span> <span class="n">k0</span> <span class="k">if</span> <span class="n">quant_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">quant_</span>
        <span class="n">name_</span> <span class="o">=</span>  <span class="n">k0</span> <span class="k">if</span> <span class="n">name_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">name_</span>
        <span class="n">origin_</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span> <span class="k">if</span> <span class="n">origin_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">origin_</span>
        <span class="n">units_</span> <span class="o">=</span> <span class="s1">&#39;a.u.&#39;</span> <span class="k">if</span> <span class="n">units_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">units_</span>

        <span class="c1"># Extrac</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">dnd</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">dim_</span>
        <span class="n">quant</span> <span class="o">=</span> <span class="n">dnd</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">quant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">quant</span> <span class="o">=</span> <span class="n">quant_</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">dnd</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">origin_</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dnd</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name_</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">dnd</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">units_</span>
        <span class="k">return</span> <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span></div>

<div class="viewcode-block" id="Plasma2D._checkformat_dtrm"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._checkformat_dtrm">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_dtrm</span><span class="p">(</span><span class="n">dtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dradius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">d0d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d2d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dtime&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">,</span> <span class="s1">&#39;dradius&#39;</span><span class="p">:</span><span class="n">dradius</span><span class="p">,</span> <span class="s1">&#39;dmesh&#39;</span><span class="p">:</span><span class="n">dmesh</span><span class="p">,</span>
              <span class="s1">&#39;d0d&#39;</span><span class="p">:</span><span class="n">d0d</span><span class="p">,</span> <span class="s1">&#39;d1d&#39;</span><span class="p">:</span><span class="n">d1d</span><span class="p">,</span> <span class="s1">&#39;d2d&#39;</span><span class="p">:</span><span class="n">d2d</span><span class="p">}</span>

        <span class="c1"># Define allowed keys for each dict</span>
        <span class="n">lkok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span>
                <span class="s1">&#39;depend&#39;</span><span class="p">]</span>
        <span class="n">lkmeshmax</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;ftype&#39;</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;faces&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;shapeRZ&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;nfaces&#39;</span><span class="p">,</span> <span class="s1">&#39;nnodes&#39;</span><span class="p">,</span> <span class="s1">&#39;mpltri&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;ntri&#39;</span><span class="p">]</span>
        <span class="n">lkmeshmin</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;ftype&#39;</span><span class="p">]</span>
        <span class="n">dkok</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dtime&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">lkok</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="s1">&#39;ndim&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">]},</span>
                <span class="s1">&#39;dradius&#39;</span><span class="p">:{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">lkok</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="s1">&#39;ndim&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]},</span>
                <span class="s1">&#39;d0d&#39;</span><span class="p">:{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">lkok</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="s1">&#39;ndim&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]},</span>
                <span class="s1">&#39;d1d&#39;</span><span class="p">:{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">lkok</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="s1">&#39;ndim&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]},</span>
                <span class="s1">&#39;d2d&#39;</span><span class="p">:{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">lkok</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="s1">&#39;ndim&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]}}</span>
        <span class="n">dkok</span><span class="p">[</span><span class="s1">&#39;dmesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">lkok</span> <span class="o">+</span> <span class="n">lkmeshmax</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="n">lkmeshmin</span><span class="p">}</span>

        <span class="c1"># Check each dict independently</span>
        <span class="k">for</span> <span class="n">dk</span><span class="p">,</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">continue</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span>
                                              <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span>
                      <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">dv</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg </span><span class="si">%s</span><span class="s2"> must be a dict with:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - (key, values) of type (str, dict)&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span>  <span class="n">dv</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">k1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">v0</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">v0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                                <span class="k">for</span> <span class="n">k1</span> <span class="ow">in</span> <span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]])</span>
                <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg </span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">] must be a dict with keys in:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span><span class="n">k0</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">])</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;And with at least the following keys:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">])</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Missing:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Non-valid:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">v0</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;data&#39;</span> <span class="ow">in</span> <span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;min&#39;</span><span class="p">]:</span>
                    <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;ndim&#39;</span><span class="p">]:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">][&#39;data&#39;] has wrong dimensions:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span><span class="n">k0</span><span class="p">)</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Expected: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dkok</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="s1">&#39;ndim&#39;</span><span class="p">])</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="c1"># mesh</span>
                <span class="k">if</span> <span class="n">dk</span> <span class="o">==</span> <span class="s1">&#39;dmesh&#39;</span><span class="p">:</span>

                    <span class="n">lmok</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rect&#39;</span><span class="p">,</span> <span class="s1">&#39;tri&#39;</span><span class="p">,</span> <span class="s1">&#39;quadtri&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lmok</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Mesh[&#39;type&#39;] should be in </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lmok</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]))</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rect&#39;</span><span class="p">:</span>
                        <span class="n">c0</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">v0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">v0</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                                  <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A mesh of type &#39;rect&#39; must have attr.:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- R of dim in [1, 2]</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Z of dim in [1, 2]&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">shapeu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">])</span>

                        <span class="n">shapeRZ</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;shapeRZ&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">shapeRZ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">shapeRZ</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">shapeRZ</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shapeRZ</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">):</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Non-increasing R&quot;</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="n">R</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Impossible to know R dimension!&quot;</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">R</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Inconsistent shapeRZ&quot;</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">R</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;R&#39;</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Inconsistent shapeRZ&quot;</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">):</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Non-increasing Z&quot;</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="n">Z</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]))</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Impossible to know R dimension!&quot;</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">Z</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Inconsistent shapeRZ&quot;</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">Z</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>
                                <span class="k">if</span> <span class="n">shapeRZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Inconsistent shapeRZ&quot;</span>
                                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">shapeRZ</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shapeRZ</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">shapeRZ</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">)]:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Inconsistent shapeRZ&quot;</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="n">shapeRZ</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Please provide shapeRZ &quot;</span>
                                   <span class="o">+</span> <span class="s2">&quot; = (&#39;R&#39;, &#39;Z&#39;) or (&#39;Z&#39;, &#39;R&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="o">+</span> <span class="s2">&quot;Could not be inferred from data itself&quot;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="k">def</span> <span class="nf">trifind</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span>
                                    <span class="n">Rbin</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">R</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">Zbin</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">Z</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">Z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                    <span class="n">nR</span><span class="o">=</span><span class="n">R</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">nZ</span><span class="o">=</span><span class="n">Z</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                    <span class="n">shapeRZ</span><span class="o">=</span><span class="n">shapeRZ</span><span class="p">):</span>
                            <span class="n">indR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">Rbin</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
                            <span class="n">indZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">Zbin</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">shapeRZ</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">):</span>
                                <span class="n">indpts</span> <span class="o">=</span> <span class="n">indR</span><span class="o">*</span><span class="n">nZ</span> <span class="o">+</span> <span class="n">indZ</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">indpts</span> <span class="o">=</span> <span class="n">indZ</span><span class="o">*</span><span class="n">nR</span> <span class="o">+</span> <span class="n">indR</span>
                            <span class="n">indout</span> <span class="o">=</span> <span class="p">((</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">R</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                                      <span class="o">|</span> <span class="p">(</span><span class="n">z</span> <span class="o">&lt;</span> <span class="n">Z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="n">Z</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">indpts</span><span class="p">[</span><span class="n">indout</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">return</span> <span class="n">indpts</span>

                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;shapeRZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapeRZ</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">size</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span><span class="o">.</span><span class="n">size</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;trifind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trifind</span>
                        <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;ftype&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Linear interpolation not handled yet !&quot;</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="n">Z</span><span class="o">.</span><span class="n">size</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;faces&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">v0</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ls</span><span class="p">]):</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The following keys should be in dmesh:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ls</span><span class="p">))</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;faces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;faces&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">nnodes</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">nfaces</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;faces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                        <span class="c1"># Test for duplicates</span>
                        <span class="n">nodesu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">facesu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;faces&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodesu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nnodes</span><span class="p">,</span>
                              <span class="n">facesu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nfaces</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Non-valid mesh </span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span> <span class="n">k0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">ndup</span> <span class="o">=</span> <span class="n">nnodes</span> <span class="o">-</span> <span class="n">nodesu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">ndsh</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                                <span class="n">undsh</span> <span class="o">=</span> <span class="n">nodesu</span><span class="o">.</span><span class="n">shape</span>
                                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                                    <span class="s2">&quot;  Duplicate nodes: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndup</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- nodes.shape: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndsh</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- unique shape: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">undsh</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">ndup</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nfaces</span> <span class="o">-</span> <span class="n">facesu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">facsh</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;faces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                                <span class="n">ufacsh</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">facesu</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                                    <span class="s2">&quot;  Duplicate faces: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndup</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- faces.shape: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">facsh</span><span class="p">)</span>
                                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- unique shape: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ufacsh</span><span class="p">))</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="c1"># Test for unused nodes</span>
                        <span class="n">facesu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">facesu</span><span class="p">)</span>
                        <span class="n">c0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">facesu</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">facesu</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">nnodes</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
                            <span class="n">ino</span> <span class="o">=</span> <span class="nb">str</span><span class="p">([</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nnodes</span><span class="p">)</span>
                                       <span class="k">if</span> <span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">facesu</span><span class="p">])</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unused nodes in </span><span class="si">{0}</span><span class="s2">[</span><span class="si">{1}</span><span class="s2">]:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span> <span class="n">k0</span><span class="p">)</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - unused nodes indices: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ino</span><span class="p">)</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nnodes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nnodes&#39;</span><span class="p">,</span> <span class="n">nnodes</span><span class="p">)</span>
                        <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nfaces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nfaces&#39;</span><span class="p">,</span> <span class="n">nfaces</span><span class="p">)</span>

                        <span class="k">assert</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;nnodes&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;faces&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;nnodes&#39;</span><span class="p">]</span>
                        <span class="c1"># Only triangular meshes so far</span>
                        <span class="k">assert</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tri&#39;</span><span class="p">,</span> <span class="s1">&#39;quadtri&#39;</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

                        <span class="k">if</span> <span class="s1">&#39;tri&#39;</span> <span class="ow">in</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]:</span>
                            <span class="n">fshap</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;faces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                            <span class="n">fshap0</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;nfaces&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">fshap</span> <span class="o">!=</span> <span class="n">fshap0</span><span class="p">:</span>
                                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Wrong shape of </span><span class="si">{}</span><span class="s2">[</span><span class="si">{}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dk</span><span class="p">,</span> <span class="n">k0</span><span class="p">)</span>
                                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Expected: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fshap0</span><span class="p">)</span>
                                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fshap</span><span class="p">))</span>
                                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">v0</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mpltri&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;mpltri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mplTri</span><span class="p">(</span>
                                    <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span>
                                    <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                                    <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;faces&#39;</span><span class="p">])</span>
                            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;mpltri&#39;</span><span class="p">],</span> <span class="n">mplTri</span><span class="p">)</span>
                            <span class="k">assert</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;ftype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="n">ntri</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;ntri&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;ftype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nnodes&#39;</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                    <span class="n">dd</span><span class="p">[</span><span class="n">dk</span><span class="p">][</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;nfaces&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ntri</span>
                                <span class="p">)</span>

        <span class="c1"># Check unicity of all keys</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">dv</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">for</span> <span class="n">dv</span> <span class="ow">in</span> <span class="n">dd</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itt</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
        <span class="n">lku</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> : </span><span class="si">{1}</span><span class="s1"> times&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kk</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">lk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">kk</span><span class="p">)))</span>
              <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lku</span> <span class="k">if</span> <span class="n">lk</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lk</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Each key of (dtime, dradius, dmesh, d0d, d1d, d2d)&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot; must be unique !</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;The following keys are repeated :</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lk</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">dtime</span><span class="p">,</span> <span class="n">dradius</span><span class="p">,</span> <span class="n">dmesh</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dtime&#39;</span><span class="p">],</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dradius&#39;</span><span class="p">],</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;dmesh&#39;</span><span class="p">]</span>
        <span class="n">d0d</span><span class="p">,</span> <span class="n">d1d</span><span class="p">,</span> <span class="n">d2d</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;d0d&#39;</span><span class="p">],</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;d1d&#39;</span><span class="p">],</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;d2d&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dradius</span><span class="p">,</span> <span class="n">dmesh</span><span class="p">,</span> <span class="n">d0d</span><span class="p">,</span> <span class="n">d1d</span><span class="p">,</span> <span class="n">d2d</span></div>


<div class="viewcode-block" id="Plasma2D._checkformat_inputs_dgeom"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._checkformat_inputs_dgeom">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_inputs_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObject</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span></div>

    <span class="c1">###########</span>
    <span class="c1"># Get keys of dictionnaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Plasma2D._get_keys_dgroup"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_keys_dgroup">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dgroup</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Plasma2D._get_keys_dindref"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_keys_dindref">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dindref</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Plasma2D._get_keys_ddata"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_keys_ddata">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_ddata</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">lk</span></div>

<div class="viewcode-block" id="Plasma2D._get_keys_dgeom"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_keys_dgeom">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_keys_dgeom</span><span class="p">():</span>
        <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lk</span></div>


    <span class="c1">###########</span>
    <span class="c1"># _init</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Plasma2D._init"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._init">[docs]</a>    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dradius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">d0d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwdargs</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">kwdargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dindrefdatagroup</span><span class="p">()</span>
        <span class="n">kwdindrefdatagroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="n">largs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_largs_dgeom</span><span class="p">()</span>
        <span class="n">kwdgeom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_kwdargs</span><span class="p">(</span><span class="n">kwdargs</span><span class="p">,</span> <span class="n">largs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_dindrefdatagroup</span><span class="p">(</span><span class="o">**</span><span class="n">kwdindrefdatagroup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_dgeom</span><span class="p">(</span><span class="o">**</span><span class="n">kwdgeom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span></div>


    <span class="c1">###########</span>
    <span class="c1"># set dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Plasma2D._find_lref"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._find_lref">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_find_lref</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">dindref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lrefname</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="s1">&#39;depend&#39;</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">lref</span> <span class="o">=</span> <span class="n">dd</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lref</span> <span class="o">=</span> <span class="p">[[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dindref</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sh</span> <span class="ow">and</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lrefname</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">sh</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">]</span>
            <span class="n">lref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itt</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">lref</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lref</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Maybe not enoough references for </span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ddstr</span><span class="p">,</span><span class="n">k0</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - shape: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - lref:  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">lref</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lref</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Too many references for </span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ddstr</span><span class="p">,</span><span class="n">k0</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - shape: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - lref:  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">lref</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lref</span></div>




<div class="viewcode-block" id="Plasma2D._set_dindrefdatagroup"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._set_dindrefdatagroup">[docs]</a>    <span class="k">def</span> <span class="nf">_set_dindrefdatagroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dradius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmesh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">d0d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d2d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Check dtime is not None</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_dtrm</span><span class="p">(</span><span class="n">dtime</span><span class="o">=</span><span class="n">dtime</span><span class="p">,</span> <span class="n">dradius</span><span class="o">=</span><span class="n">dradius</span><span class="p">,</span> <span class="n">dmesh</span><span class="o">=</span><span class="n">dmesh</span><span class="p">,</span>
                                     <span class="n">d0d</span><span class="o">=</span><span class="n">d0d</span><span class="p">,</span> <span class="n">d1d</span><span class="o">=</span><span class="n">d1d</span><span class="p">,</span> <span class="n">d2d</span><span class="o">=</span><span class="n">d2d</span><span class="p">)</span>
        <span class="n">dtime</span><span class="p">,</span> <span class="n">dradius</span><span class="p">,</span> <span class="n">dmesh</span><span class="p">,</span> <span class="n">d0d</span><span class="p">,</span> <span class="n">d1d</span><span class="p">,</span> <span class="n">d2d</span> <span class="o">=</span> <span class="n">out</span>

        <span class="n">dgroup</span><span class="p">,</span> <span class="n">dindref</span><span class="p">,</span> <span class="n">ddata</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Get indt</span>
        <span class="k">if</span> <span class="n">dtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dtime</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">(</span><span class="n">dtime</span><span class="p">,</span><span class="n">k0</span><span class="p">,</span>
                                        <span class="n">dim_</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">quant_</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span>
                                        <span class="n">name_</span><span class="o">=</span><span class="n">k0</span><span class="p">,</span> <span class="n">units_</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
                <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>

                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dindref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">dtime</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dtime</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="n">dtime</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>

                <span class="n">dindref</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                               <span class="s1">&#39;group&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">}</span>

                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">dtime</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">:(</span><span class="n">k0</span><span class="p">,)}</span>

        <span class="c1"># d0d</span>
        <span class="k">if</span> <span class="n">d0d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">d0d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">(</span><span class="n">d0d</span><span class="p">,</span><span class="n">k0</span><span class="p">)</span>
                <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>

                <span class="c1"># data</span>
                <span class="n">d0d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d0d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="n">d0d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;=</span> <span class="mi">1</span>

                <span class="n">depend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_lref</span><span class="p">(</span><span class="n">d0d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">d0d</span><span class="p">,</span>
                                         <span class="n">ddstr</span><span class="o">=</span><span class="s1">&#39;d0d&#39;</span><span class="p">,</span> <span class="n">dindref</span><span class="o">=</span><span class="n">dindref</span><span class="p">,</span>
                                         <span class="n">lrefname</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">])</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dindref</span><span class="p">[</span><span class="n">depend</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;time&#39;</span>
                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">d0d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">:</span><span class="n">depend</span><span class="p">}</span>

        <span class="c1"># get radius</span>
        <span class="k">if</span> <span class="n">dradius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dradius</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">(</span><span class="n">dradius</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">name_</span><span class="o">=</span><span class="n">k0</span><span class="p">)</span>
                <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>
                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dindref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dradius</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dradius</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;depend&#39;</span><span class="p">,[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lkt</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dtime</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dradius</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]]</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lkt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="n">axist</span> <span class="o">=</span> <span class="n">dradius</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">lkt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># Handle cases with only 1 time step</span>
                    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">dindref</span><span class="p">[</span><span class="n">lkt</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
                    <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">axist</span><span class="p">]</span>
                <span class="n">dindref</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="n">size</span><span class="p">,</span>
                               <span class="s1">&#39;group&#39;</span><span class="p">:</span><span class="s1">&#39;radius&#39;</span><span class="p">}</span>

                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">depend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_lref</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">dradius</span><span class="p">,</span>
                                         <span class="n">ddstr</span><span class="o">=</span><span class="s1">&#39;dradius&#39;</span><span class="p">,</span> <span class="n">dindref</span><span class="o">=</span><span class="n">dindref</span><span class="p">,</span>
                                         <span class="n">lrefname</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">])</span>
                <span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">,</span>
                             <span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">:</span><span class="n">depend</span><span class="p">}</span>


        <span class="c1"># Get d1d</span>
        <span class="k">if</span> <span class="n">d1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">d1d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">(</span><span class="n">d1d</span><span class="p">,</span><span class="n">k0</span><span class="p">)</span>
                <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>

                <span class="n">d1d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d1d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="n">d1d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>

                <span class="c1"># data</span>
                <span class="n">depend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_lref</span><span class="p">(</span><span class="n">d1d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">d1d</span><span class="p">,</span>
                                         <span class="n">ddstr</span><span class="o">=</span><span class="s1">&#39;d1d&#39;</span><span class="p">,</span> <span class="n">dindref</span><span class="o">=</span><span class="n">dindref</span><span class="p">,</span>
                                         <span class="n">lrefname</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;radius&#39;</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">d1d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">:</span><span class="n">depend</span><span class="p">}</span>

        <span class="c1"># dmesh ref</span>
        <span class="k">if</span> <span class="n">dmesh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">dmesh</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">(</span><span class="n">dmesh</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">dim_</span><span class="o">=</span><span class="s1">&#39;mesh&#39;</span><span class="p">)</span>
                <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>

                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dindref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">dindref</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span><span class="n">dmesh</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;group&#39;</span><span class="p">:</span><span class="s1">&#39;mesh&#39;</span><span class="p">}</span>

                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">dmesh</span><span class="p">[</span><span class="n">k0</span><span class="p">],</span>
                             <span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">:(</span><span class="n">k0</span><span class="p">,)}</span>

        <span class="c1"># d2d</span>
        <span class="k">if</span> <span class="n">d2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">d2d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">(</span><span class="n">d2d</span><span class="p">,</span><span class="n">k0</span><span class="p">)</span>
                <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>

                <span class="n">d2d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">d2d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                <span class="k">assert</span> <span class="n">d2d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>

                <span class="n">depend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_lref</span><span class="p">(</span><span class="n">d2d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">k0</span><span class="p">,</span> <span class="n">dd</span><span class="o">=</span><span class="n">d2d</span><span class="p">,</span>
                                         <span class="n">ddstr</span><span class="o">=</span><span class="s1">&#39;d2d&#39;</span><span class="p">,</span> <span class="n">dindref</span><span class="o">=</span><span class="n">dindref</span><span class="p">,</span>
                                         <span class="n">lrefname</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="s1">&#39;mesh&#39;</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">k0</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">d2d</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                             <span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                             <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">:</span><span class="n">depend</span><span class="p">}</span>

        <span class="c1"># dgroup</span>
        <span class="n">dgroup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dref&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dtime</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dradius</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dref&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dradius</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dmesh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dgroup</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dref&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">dmesh</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]}</span>

        <span class="c1"># Update dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span> <span class="o">=</span> <span class="n">dgroup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span> <span class="o">=</span> <span class="n">dindref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span> <span class="o">=</span> <span class="n">ddata</span>
        <span class="c1"># Complement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complement</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plasma2D._complement"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._complement">[docs]</a>    <span class="k">def</span> <span class="nf">_complement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># --------------</span>
        <span class="c1"># ddata</span>
        <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lindout</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">lindout</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;ddata[</span><span class="si">{}</span><span class="s2">][&#39;depend&#39;] keys not in dindref:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;    - &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lindout</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;lgroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span>
                                        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;depend&#39;</span><span class="p">]]</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;depend&#39;</span><span class="p">]])</span>

            <span class="c1"># if only one dim =&gt; mesh or iterable or unspecified</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">type_</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">c0</span> <span class="o">=</span> <span class="n">type_</span> <span class="ow">is</span> <span class="nb">dict</span> <span class="ow">and</span> <span class="s1">&#39;mesh&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddata</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;lgroup&#39;</span><span class="p">]</span>
                <span class="n">c1</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Signal </span><span class="si">{}</span><span class="s2">[&#39;data&#39;] should be either:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- dict: a mesh</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- iterable of len() = &quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (shape[0] of ref)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                           <span class="o">+</span> <span class="s2">&quot;  You provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- type: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- len(): </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                           <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- </span><span class="si">{}</span><span class="s2">[&#39;data&#39;]: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
                <span class="k">assert</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape</span>

        <span class="c1"># --------------</span>
        <span class="c1"># dindref</span>
        <span class="k">for</span> <span class="n">k0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="n">k0</span> <span class="ow">in</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;depend&#39;</span><span class="p">]]</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="p">[</span><span class="n">k0</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="c1"># --------------</span>
        <span class="c1"># dgroup</span>
        <span class="k">for</span> <span class="n">gg</span><span class="p">,</span> <span class="n">vg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lindref</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gg</span><span class="p">]</span>
            <span class="n">ldata</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                     <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dindref</span><span class="p">[</span><span class="n">vref</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]</span>
                             <span class="k">for</span> <span class="n">vref</span> <span class="ow">in</span> <span class="n">lindref</span><span class="p">])]</span>
            <span class="c1">#assert vg[&#39;depend&#39;] in lidindref</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">gg</span><span class="p">][</span><span class="s1">&#39;lindref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lindref</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dgroup</span><span class="p">[</span><span class="n">gg</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ldata</span></div>


<div class="viewcode-block" id="Plasma2D.set_dgeom"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.set_dgeom">[docs]</a>    <span class="k">def</span> <span class="nf">set_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_inputs_dgeom</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;config&#39;</span><span class="p">:</span><span class="n">config</span><span class="p">}</span></div>


    <span class="c1">###########</span>
    <span class="c1"># strip dictionaries</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Plasma2D._strip_ddata"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._strip_ddata">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="Plasma2D._strip_dgeom"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._strip_dgeom">[docs]</a>    <span class="k">def</span> <span class="nf">_strip_dgeom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strip</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">],</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_set_dgeom</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">strip</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;strip&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SavePath</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">SaveName</span>
                <span class="n">pfe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span><span class="p">)</span>
                <span class="n">lf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span><span class="n">ff</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">lf</span> <span class="k">if</span> <span class="n">name</span><span class="o">+</span><span class="s1">&#39;.npz&#39;</span> <span class="ow">in</span> <span class="n">ff</span><span class="p">]</span>
                <span class="n">exist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">exist</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;BEWARE:</span>
<span class="s2">                        You are about to delete the config object</span>
<span class="s2">                        Only the path/name to saved a object will be kept</span>

<span class="s2">                        But it appears that the following object has no</span>
<span class="s2">                        saved file where specified (obj.Id.SavePath)</span>
<span class="s2">                        Thus it won&#39;t be possible to retrieve it</span>
<span class="s2">                        (unless available in the current console:&quot;&quot;&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    - </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pfe</span></div>

    <span class="c1">###########</span>
    <span class="c1"># _strip and get/from dict</span>
    <span class="c1">###########</span>

<div class="viewcode-block" id="Plasma2D._strip_init"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._strip_init">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_strip_init</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_dstrip</span><span class="p">[</span><span class="s1">&#39;allowed&#39;</span><span class="p">])</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                 1: dgeom pathfiles</span>
<span class="s2">                 &quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">ToFuObjectBase</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="n">nMax</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="Plasma2D.strip"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># super()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Plasma2D</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plasma2D._strip"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._strip">[docs]</a>    <span class="k">def</span> <span class="nf">_strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strip_dgeom</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">)</span></div>

<div class="viewcode-block" id="Plasma2D._to_dict"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dgroup&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;dindref&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;ddata&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                <span class="s1">&#39;dgeom&#39;</span><span class="p">:{</span><span class="s1">&#39;dict&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">,</span> <span class="s1">&#39;lexcept&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">dout</span></div>

<div class="viewcode-block" id="Plasma2D._from_dict"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._from_dict">[docs]</a>    <span class="k">def</span> <span class="nf">_from_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dgroup&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dindref&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;ddata&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">fd</span><span class="p">[</span><span class="s1">&#39;dgeom&#39;</span><span class="p">])</span></div>


    <span class="c1">###########</span>
    <span class="c1"># properties</span>
    <span class="c1">###########</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dindref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ddata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">kk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dradius</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">kk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;radius&#39;</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dmesh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">kk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">vv</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">])</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgeom</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>

    <span class="c1">#---------------------</span>
    <span class="c1"># Read-only for internal use</span>
    <span class="c1">#---------------------</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_lquantboth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return list of quantities available both in 1d and 2d &quot;&quot;&quot;</span>
        <span class="n">lq1</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">vd</span><span class="p">][</span><span class="s1">&#39;quant&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">vd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]]</span>
        <span class="n">lq2</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">vd</span><span class="p">][</span><span class="s1">&#39;quant&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">vd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]]</span>
        <span class="n">lq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lq1</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">lq2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">lq</span>

<div class="viewcode-block" id="Plasma2D._get_ldata"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_ldata">[docs]</a>    <span class="k">def</span> <span class="nf">_get_ldata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">indref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">return_key</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">log</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="s1">&#39;any&#39;</span><span class="p">,</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>
        <span class="n">lid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lid</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;dim&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dim</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">lid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">quant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;quant&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">quant</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">lid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">lid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">units</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">lid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">4</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">origin</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">lid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">5</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">depend</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">lid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ind</span><span class="p">[</span><span class="mi">6</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;lgroup&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="n">lid</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">log</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">log</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_key</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ind</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">lid</span><span class="p">[</span><span class="n">ind</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">ind</span><span class="p">,</span> <span class="n">lid</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Plasma2D._get_keyingroup"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_keyingroup">[docs]</a>    <span class="k">def</span> <span class="nf">_get_keyingroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">lg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;lgroup&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">lg</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Required data key does not have matching group:</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- ddata[</span><span class="si">{}</span><span class="s2">][&#39;lgroup&#39;] = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">lg</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- Expected group:  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">raise_</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">ind</span><span class="p">,</span> <span class="n">akeys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ldata</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                                     <span class="n">origin</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="p">,</span>
                                     <span class="n">return_key</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Remove indref and group</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[:</span><span class="mi">5</span><span class="p">,:]</span> <span class="o">&amp;</span> <span class="n">ind</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>

        <span class="c1"># Any perfect match ?</span>
        <span class="n">nind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">nind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">sol</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sol</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">indkey</span> <span class="o">=</span> <span class="n">ind</span><span class="p">[</span><span class="n">sol</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">akeys</span><span class="p">[</span><span class="n">indkey</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lstr</span> <span class="o">=</span> <span class="s2">&quot;[dim,quant,name,units,origin]&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Several possible matches in </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lstr</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lstr</span> <span class="o">=</span> <span class="s2">&quot;[dim,quant,name,units,origin]&quot;</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No match in </span><span class="si">{}</span><span class="s2"> for </span><span class="si">{}</span><span class="s2"> in group </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lstr</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Requested </span><span class="si">{}</span><span class="s2"> could not be identified!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msgstr</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Please provide a valid (unique) key/name/quant/dim:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary</span><span class="p">(</span><span class="n">verb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_</span><span class="o">=</span><span class="s1">&#39;msg&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raise_</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">msg</span></div>


    <span class="c1">#---------------------</span>
    <span class="c1"># Methods for showing data</span>
    <span class="c1">#---------------------</span>

<div class="viewcode-block" id="Plasma2D.get_summary"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.get_summary">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;l&#39;</span><span class="p">,</span>
                    <span class="n">table_sep</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Summary description of the object content &quot;&quot;&quot;</span>
        <span class="c1"># # Make sure the data is accessible</span>
        <span class="c1"># msg = &quot;The data is not accessible because self.strip(2) was used !&quot;</span>
        <span class="c1"># assert self._dstrip[&#39;strip&#39;]&lt;2, msg</span>

        <span class="c1"># -----------------------</span>
        <span class="c1"># Build for ddata</span>
        <span class="n">col0</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;group key&#39;</span><span class="p">,</span> <span class="s1">&#39;nb. indref&#39;</span><span class="p">]</span>
        <span class="n">ar0</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;lindref&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span><span class="n">v0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="c1"># -----------------------</span>
        <span class="c1"># Build for ddata</span>
        <span class="n">col1</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;indref key&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">]</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k0</span><span class="p">,</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">k0</span><span class="p">,</span><span class="n">v0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="c1"># -----------------------</span>
        <span class="c1"># Build for ddata</span>
        <span class="n">col2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data key&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="s1">&#39;depend&#39;</span><span class="p">,</span> <span class="s1">&#39;lgroup&#39;</span><span class="p">]</span>
        <span class="n">ar2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k0</span><span class="p">,</span><span class="n">v0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">lu</span> <span class="o">=</span> <span class="p">[</span><span class="n">k0</span><span class="p">,</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;quant&#39;</span><span class="p">],</span> <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                  <span class="n">v0</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span> <span class="n">shape</span><span class="p">,</span>
                  <span class="nb">str</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;depend&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="s1">&#39;lgroup&#39;</span><span class="p">])]</span>
            <span class="n">ar2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lu</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_summary</span><span class="p">([</span><span class="n">ar0</span><span class="p">,</span><span class="n">ar1</span><span class="p">,</span><span class="n">ar2</span><span class="p">],</span> <span class="p">[</span><span class="n">col0</span><span class="p">,</span> <span class="n">col1</span><span class="p">,</span> <span class="n">col2</span><span class="p">],</span>
                                  <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="p">,</span> <span class="n">table_sep</span><span class="o">=</span><span class="n">table_sep</span><span class="p">,</span>
                                  <span class="n">verb</span><span class="o">=</span><span class="n">verb</span><span class="p">,</span> <span class="n">return_</span><span class="o">=</span><span class="n">return_</span><span class="p">)</span></div>

    <span class="c1">#---------------------</span>
    <span class="c1"># Methods for adding ref / quantities</span>
    <span class="c1">#---------------------</span>

<div class="viewcode-block" id="Plasma2D._checkformat_addref"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._checkformat_addref">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_addref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check data</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
              <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">),</span>
              <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg data must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- np.ndarray: a 1d array</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- dict:       a dict containing a 2d mesh</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- str:        an absolute path to an existing file</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># If file: check content and extract data</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span>
             <span class="n">quant</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_ref_from_file</span><span class="p">(</span>
                 <span class="n">pfe</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                 <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
                 <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>

        <span class="c1"># Check key</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg key must be a str not already in self.ddata.keys()</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- key: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check group</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Arg group must be str in self.dgroup.keys()</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- group: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- available groups: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dgroups</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span></div>

<div class="viewcode-block" id="Plasma2D._add_ref_from_file"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._add_ref_from_file">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_ref_from_file</span><span class="p">(</span><span class="n">pfe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">comments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span>

        <span class="n">lf</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.mat&#39;</span><span class="p">,</span> <span class="s1">&#39;.txt&#39;</span><span class="p">]</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">pfe</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">lf</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Only the following file formats are supported:</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">- &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">- &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lf</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;You provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Extract data</span>
        <span class="k">if</span> <span class="n">pfe</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.mat&#39;</span><span class="p">:</span>
            <span class="c1"># load and check only one 1x1 struct</span>
            <span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">scpio</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">scpio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
            <span class="n">ls</span> <span class="o">=</span> <span class="p">[</span><span class="n">ss</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ss</span><span class="p">]</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                  <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
                  <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The file should contain a 1x1 matlab struct only!</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;file contains: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ls</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Get into unique struct and get key / value pairs</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">ls</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nk</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nk</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Non-conform file!</span><span class="se">\n</span><span class="s2">&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">len(out.dtype) = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">len(out[0] = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">lvi</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span>
                       <span class="ow">and</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,))]</span>
            <span class="n">limat</span> <span class="o">=</span> <span class="p">[</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nk</span><span class="p">)</span> <span class="k">if</span> <span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lvi</span><span class="p">]</span>

            <span class="n">c0</span> <span class="o">=</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">limat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nk</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
                  <span class="ow">and</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">limat</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span>
                       <span class="ow">and</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">limat</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The struct store in </span><span class="si">{}</span><span class="s2"> should contain:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- at least a (1, N) matrice</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- optionally, the following char str:</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- key: unique identifier</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- group: &#39;time&#39;, &#39;radius&#39;, &#39;mesh&#39;, ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- dim: physical dimension (e.g.: &#39;B flux&#39;,)</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- quant: &#39;psi&#39;, &#39;phi, ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- units: &#39;Wb&#39;, ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- origin: &#39;NICE&#39;, &#39;CHEASE&#39;...&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t\t</span><span class="s2">by the default the file name</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">- name: short identifier (e.g.: 1dpsiNICE)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;You provided:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="n">out</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">ii</span><span class="p">]:</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lvi</span><span class="p">}</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">limat</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">pfe</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.txt&#39;</span><span class="p">:</span>
            <span class="c1"># data array</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">pfe</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;data stored in </span><span class="si">{}</span><span class="s2"> is not a 1d array!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                       <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- data.shape = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># params</span>
            <span class="n">dout</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">from_txt_extract_params</span><span class="p">(</span>
                <span class="n">pfe</span><span class="o">=</span><span class="n">pfe</span><span class="p">,</span>
                <span class="n">lparams</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;origin&#39;</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">dout</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span>

        <span class="c1"># Get default values</span>
        <span class="n">din</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="n">quant</span><span class="p">,</span>
               <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k0</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="n">din</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">din</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k0</span><span class="p">,</span> <span class="n">pfe</span><span class="p">)</span> <span class="k">if</span> <span class="n">k0</span> <span class="o">==</span> <span class="s1">&#39;origin&#39;</span> <span class="k">else</span> <span class="n">dout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dout</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">din</span><span class="p">[</span><span class="n">k0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">]:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Non-matching values of </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pfe</span><span class="p">)</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- kwdarg: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">din</span><span class="p">[</span><span class="n">k0</span><span class="p">])</span>
                               <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">- file: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dout</span><span class="p">[</span><span class="n">k0</span><span class="p">]))</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">],</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">],</span>
                <span class="n">din</span><span class="p">[</span><span class="s1">&#39;quant&#39;</span><span class="p">],</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;dim&#39;</span><span class="p">],</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">],</span> <span class="n">din</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="Plasma2D.add_ref"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.add_ref">[docs]</a>    <span class="k">def</span> <span class="nf">add_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a reference</span>

<span class="sd">        The reference data is contained in data, which can be:</span>
<span class="sd">            - np.array: a 1d profile</span>
<span class="sd">            - dict: for mesh</span>
<span class="sd">            - str:  absolute path to a file, holding a 1d profile</span>

<span class="sd">        Please also provide (if not included in file if data is a str):</span>
<span class="sd">            - key: unique str identifying the data</span>
<span class="sd">            - group: str identifying the reference group (self.dgroup.keys())</span>
<span class="sd">        If data is a str to a file, key and group (and others) can be included</span>
<span class="sd">        in the file</span>

<span class="sd">        Parameters dim, quant, units, origin and name are optional</span>
<span class="sd">        Parameters comments and delimiter and only used if data is the path to</span>
<span class="sd">        a .txt file (fed to np.loadtxt)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span>
         <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_addref</span><span class="p">(</span>
             <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
             <span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
             <span class="n">comments</span><span class="o">=</span><span class="n">comments</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">)</span>

        <span class="c1"># Format inputs</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="n">origin</span>
        <span class="p">}},</span>
            <span class="n">key</span><span class="p">)</span>
        <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ftype&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nnodes&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ftype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nfaces&#39;</span><span class="p">]</span>

        <span class="c1"># Update attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span> <span class="s1">&#39;ldata&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">key</span><span class="p">]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                            <span class="s1">&#39;dim&#39;</span><span class="p">:</span> <span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span> <span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
                            <span class="s1">&#39;origin&#39;</span><span class="p">:</span> <span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;depend&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">key</span><span class="p">,),</span> <span class="s1">&#39;lgroup&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">group</span><span class="p">]}</span>

        <span class="c1"># Run global consistency check and complement if necessary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complement</span><span class="p">()</span></div>

<div class="viewcode-block" id="Plasma2D.add_quantity"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.add_quantity">[docs]</a>    <span class="k">def</span> <span class="nf">add_quantity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depend</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a quantity &quot;&quot;&quot;</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;key must be a str not already in self.ddata.keys()!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;data must be either:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - np.ndarray</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - dict (mesh)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dnd</span><span class="p">({</span><span class="n">key</span><span class="p">:{</span><span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                                 <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span> <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">}},</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">dim</span><span class="p">,</span> <span class="n">quant</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">str</span><span class="p">,</span><span class="nb">tuple</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">depend</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">depend</span> <span class="o">=</span> <span class="p">(</span><span class="n">depend</span><span class="p">,)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">depend</span><span class="p">)):</span>
            <span class="k">assert</span> <span class="n">depend</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">lgroup</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">dd</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">depend</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">data</span><span class="p">,</span>
                            <span class="s1">&#39;dim&#39;</span><span class="p">:</span><span class="n">dim</span><span class="p">,</span> <span class="s1">&#39;quant&#39;</span><span class="p">:</span><span class="n">quant</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span><span class="n">units</span><span class="p">,</span>
                            <span class="s1">&#39;origin&#39;</span><span class="p">:</span><span class="n">origin</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;depend&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">depend</span><span class="p">),</span> <span class="s1">&#39;lgroup&#39;</span><span class="p">:</span><span class="n">lgroup</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_complement</span><span class="p">()</span></div>


    <span class="c1">#---------------------</span>
    <span class="c1"># Method for getting time of a quantity</span>
    <span class="c1">#---------------------</span>

<div class="viewcode-block" id="Plasma2D.get_time"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.get_time">[docs]</a>    <span class="k">def</span> <span class="nf">get_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the time vector associated to a chosen quantity (identified</span>
<span class="sd">        by its key)&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Provided key not in self.ddata.keys() !</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Available: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">indref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">indref</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]</span>
             <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">indref</span><span class="p">,)</span>
                 <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;quant&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No / several macthing time vectors were identified:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">key</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Found: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="Plasma2D.get_time_common"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.get_time_common">[docs]</a>    <span class="k">def</span> <span class="nf">get_time_common</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeys</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the common time vector to several quantities</span>

<span class="sd">        If they do not have a common time vector, a reference one is choosen</span>
<span class="sd">        according to criterion choose</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check all data have time-dependency</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">get_time</span><span class="p">(</span><span class="n">kk</span><span class="p">)}</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lkeys</span><span class="p">}</span>
        <span class="n">dtu</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
        <span class="k">for</span> <span class="n">kt</span> <span class="ow">in</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dtu</span><span class="p">[</span><span class="n">kt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ldata&#39;</span><span class="p">:[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">lkeys</span> <span class="k">if</span> <span class="n">dout</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">kt</span><span class="p">]}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lt</span><span class="p">,</span> <span class="n">lres</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">kt</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kt</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])))</span>
                             <span class="k">for</span> <span class="n">kt</span> <span class="ow">in</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">choose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">choose</span>  <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
            <span class="k">if</span> <span class="n">choose</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="n">tref</span> <span class="o">=</span> <span class="n">lt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">lres</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">dout</span><span class="p">,</span> <span class="n">dtu</span><span class="p">,</span> <span class="n">tref</span></div>

<div class="viewcode-block" id="Plasma2D._get_time_common_arrays"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_time_common_arrays">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_time_common_arrays</span><span class="p">(</span><span class="n">dins</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dout</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dins</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">dtu</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dins</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">ss</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">]])</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">ss</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="k">for</span> <span class="n">ss</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">,</span><span class="s1">&#39;t&#39;</span><span class="p">]])</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="n">c0</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dins must be a dict of the form (at least):</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    dins[</span><span class="si">%s</span><span class="s2">] = {&#39;val&#39;: np.ndarray,</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                &#39;t&#39;:   np.ndarray}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">kt</span><span class="p">,</span> <span class="n">already</span> <span class="o">=</span> <span class="nb">id</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]),</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">kt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">lisclose</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dtu</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                                <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]))]</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lisclose</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lisclose</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">kt</span> <span class="o">=</span> <span class="n">lisclose</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">already</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">dtu</span><span class="p">[</span><span class="n">kt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                               <span class="s1">&#39;ldata&#39;</span><span class="p">:[</span><span class="n">k</span><span class="p">]}</span>
            <span class="k">if</span> <span class="n">already</span><span class="p">:</span>
                <span class="n">dtu</span><span class="p">[</span><span class="n">kt</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">dtu</span><span class="p">[</span><span class="n">kt</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dout</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">kt</span><span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtu</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tref</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lt</span><span class="p">,</span> <span class="n">lres</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">kt</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">dtu</span><span class="p">[</span><span class="n">kt</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])))</span>
                             <span class="k">for</span> <span class="n">kt</span> <span class="ow">in</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">choose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">choose</span>  <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
            <span class="k">if</span> <span class="n">choose</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                <span class="n">tref</span> <span class="o">=</span> <span class="n">lt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">lres</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">dout</span><span class="p">,</span> <span class="n">dtu</span><span class="p">,</span> <span class="n">tref</span></div>

<div class="viewcode-block" id="Plasma2D._interp_on_common_time"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._interp_on_common_time">[docs]</a>    <span class="k">def</span> <span class="nf">_interp_on_common_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lkeys</span><span class="p">,</span>
                               <span class="n">choose</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a dict of time-interpolated data &quot;&quot;&quot;</span>
        <span class="n">dout</span><span class="p">,</span> <span class="n">dtu</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_common</span><span class="p">(</span><span class="n">lkeys</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">tref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">tref</span>
            <span class="n">ltu</span> <span class="o">=</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">tref</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">tref</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">ltu</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">tref</span> <span class="ow">in</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ltu</span> <span class="o">=</span> <span class="n">ltu</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="n">tref</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">interp_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interp_t</span> <span class="o">=</span> <span class="n">_INTERPT</span>

        <span class="c1"># Interpolate</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">ltu</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dtu</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scpinterp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                                     <span class="n">kind</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)(</span><span class="n">tr</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tref</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="ow">and</span> <span class="n">tref</span> <span class="ow">in</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dtu</span><span class="p">[</span><span class="n">tref</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]:</span>
                 <span class="n">dout</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dout</span><span class="p">,</span> <span class="n">tref</span></div>

<div class="viewcode-block" id="Plasma2D._interp_on_common_time_arrays"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._interp_on_common_time_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">_interp_on_common_time_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dins</span><span class="p">,</span>
                                      <span class="n">choose</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a dict of time-interpolated data &quot;&quot;&quot;</span>
        <span class="n">dout</span><span class="p">,</span> <span class="n">dtu</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_common_arrays</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">tref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">tref</span>
            <span class="n">ltu</span> <span class="o">=</span> <span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dout</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">tref</span> <span class="o">=</span> <span class="n">dout</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">dtu</span><span class="p">[</span><span class="n">tref</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
            <span class="n">ltu</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dtu</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">([</span><span class="n">tref</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">interp_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interp_t</span> <span class="o">=</span> <span class="n">_INTERPT</span>

        <span class="c1"># Interpolate</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">ltu</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dtu</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]:</span>
                <span class="n">dout</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scpinterp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">dtu</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                                     <span class="n">dout</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                                     <span class="n">kind</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                     <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)(</span><span class="n">tr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dout</span><span class="p">,</span> <span class="n">tref</span></div>

<div class="viewcode-block" id="Plasma2D.interp_t"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.interp_t">[docs]</a>    <span class="k">def</span> <span class="nf">interp_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dkeys</span><span class="p">,</span>
                 <span class="n">choose</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
        <span class="c1"># Check inputs</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">dkeys</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="nb">dict</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dkeys</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">dkeys</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">kk</span><span class="p">}</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">dkeys</span><span class="p">}</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">type</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
               <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span>
               <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">))</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span>
              <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">dkeys</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dkeys</span><span class="p">)</span>

        <span class="c1"># Separate by type</span>
        <span class="n">dk0</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">kk</span><span class="p">,</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">dkeys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">])</span>
        <span class="n">dk1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">kk</span><span class="p">,</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">dkeys</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dkeys</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dk0</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dk1</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dk0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dk1</span><span class="p">)</span>


        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dk0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dkeys</span><span class="p">):</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dk0</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="n">dout</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_on_common_time</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">,</span>
                                                     <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                                     <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
            <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">dout</span><span class="p">[</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">dout</span><span class="p">[</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]][</span><span class="s1">&#39;t&#39;</span><span class="p">]}</span>
                    <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">dk0</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dk1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dkeys</span><span class="p">):</span>
            <span class="n">dout</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_on_common_time_arrays</span><span class="p">(</span><span class="n">dk1</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">,</span>
                                                            <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                                            <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">lk</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dk0</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
                <span class="n">dout</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_interp_on_common_time</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">,</span>
                                                       <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                                       <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
                <span class="n">dout1</span><span class="p">,</span> <span class="n">_</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_on_common_time_arrays</span><span class="p">(</span><span class="n">dk1</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">,</span>
                                                              <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                                              <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dout0</span><span class="p">,</span> <span class="n">dtu0</span><span class="p">,</span> <span class="n">tref0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_time_common</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span>
                                                          <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">)</span>
                <span class="n">dout1</span><span class="p">,</span> <span class="n">dtu1</span><span class="p">,</span> <span class="n">tref1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_common_arrays</span><span class="p">(</span><span class="n">dk1</span><span class="p">,</span>
                                                                  <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="ow">in</span> <span class="n">dtu0</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dout1</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;if t is str, it must refer to a valid key:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dtu0</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dout1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">t</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">dtu1</span><span class="p">[</span><span class="n">dout1</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span> <span class="n">t</span>
                    <span class="n">tref</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">choose</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">choose</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>
                    <span class="k">if</span> <span class="n">choose</span> <span class="o">==</span> <span class="s1">&#39;min&#39;</span><span class="p">:</span>
                        <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">tref0</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="n">dtu1</span><span class="p">[</span><span class="n">tref1</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span>
                        <span class="n">dt0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t0</span><span class="p">))</span>
                        <span class="n">dt1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">dt0</span> <span class="o">&lt;</span> <span class="n">dt1</span><span class="p">:</span>
                            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span> <span class="n">tref0</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">tref0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tref1</span><span class="p">,</span> <span class="n">tref1</span>

                <span class="n">dout</span><span class="p">,</span> <span class="n">tref</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_interp_on_common_time</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">,</span>
                                                          <span class="n">t</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                                          <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
                <span class="n">dout</span> <span class="o">=</span> <span class="p">{</span><span class="n">kk</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">dout</span><span class="p">[</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">dout</span><span class="p">[</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]][</span><span class="s1">&#39;t&#39;</span><span class="p">]}</span>
                        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span><span class="n">vv</span> <span class="ow">in</span> <span class="n">dk0</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">dout1</span><span class="p">,</span> <span class="n">_</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interp_on_common_time_arrays</span><span class="p">(</span><span class="n">dk1</span><span class="p">,</span> <span class="n">choose</span><span class="o">=</span><span class="n">choose</span><span class="p">,</span>
                                                                <span class="n">t</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                                                <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">)</span>
            <span class="n">dout</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dout1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dout</span><span class="p">,</span> <span class="n">tref</span></div>

    <span class="c1">#---------------------</span>
    <span class="c1"># Methods for computing additional plasma quantities</span>
    <span class="c1">#---------------------</span>


<div class="viewcode-block" id="Plasma2D._fill_dins"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._fill_dins">[docs]</a>    <span class="k">def</span> <span class="nf">_fill_dins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dins</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dins</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dins</span></div>

<div class="viewcode-block" id="Plasma2D._checkformat_shapes"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._checkformat_shapes">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_checkformat_shapes</span><span class="p">(</span><span class="n">dins</span><span class="p">):</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dins</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">shape</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>

        <span class="c1"># Check shape consistency for broadcasting</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dins</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">assert</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],),</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dins</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Non-conform shape for dins[</span><span class="si">%s</span><span class="s2">]:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">k</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Expected: (</span><span class="si">%s</span><span class="s2">,...) or (1,)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span>
                    <span class="k">elif</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][:,</span><span class="kc">None</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">][</span><span class="kc">None</span><span class="p">,:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">shape</span>
                <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dins</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="n">dins</span></div>



<div class="viewcode-block" id="Plasma2D.compute_bremzeff"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.compute_bremzeff">[docs]</a>    <span class="k">def</span> <span class="nf">compute_bremzeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Te</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">tTe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tzeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the bremsstrahlung spectral radiance at lamb</span>

<span class="sd">        The plasma conditions are set by:</span>
<span class="sd">            - Te   (eV)</span>
<span class="sd">            - ne   (/m3)</span>
<span class="sd">            - zeff (adim.)</span>

<span class="sd">        The wavelength is set by the diagnostics</span>
<span class="sd">            - lamb (m)</span>

<span class="sd">        The vol. spectral emis. is returned in ph / (s.m3.sr.m)</span>

<span class="sd">        The computation requires an intermediate : gff(Te, zeff)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Te&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">Te</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tTe</span><span class="p">},</span>
                <span class="s1">&#39;ne&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tne</span><span class="p">},</span>
                <span class="s1">&#39;zeff&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">zeff</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tzeff</span><span class="p">}}</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">vv</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">dins</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;All fields should be provided:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">dins</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">dins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_dins</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>
        <span class="n">dins</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_t</span><span class="p">(</span><span class="n">dins</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">)</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>
        <span class="n">dins</span><span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">lamb</span><span class="p">}</span>
        <span class="n">dins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_shapes</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>

        <span class="n">val</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">_physics</span><span class="o">.</span><span class="n">compute_bremzeff</span><span class="p">(</span><span class="n">dins</span><span class="p">[</span><span class="s1">&#39;Te&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                               <span class="n">dins</span><span class="p">[</span><span class="s1">&#39;ne&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                               <span class="n">dins</span><span class="p">[</span><span class="s1">&#39;zeff&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                               <span class="n">dins</span><span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">units</span></div>

<div class="viewcode-block" id="Plasma2D.compute_fanglev"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.compute_fanglev">[docs]</a>    <span class="k">def</span> <span class="nf">compute_fanglev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">BR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">ne</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">tBR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tBPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tBZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tne</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the vector faraday angle at lamb</span>

<span class="sd">        The plasma conditions are set by:</span>
<span class="sd">            - BR    (T) , array of R component of B</span>
<span class="sd">            - BRPhi (T) , array of phi component of B</span>
<span class="sd">            - BZ    (T) , array of Z component of B</span>
<span class="sd">            - ne    (/m3)</span>

<span class="sd">        The wavelength is set by the diagnostics</span>
<span class="sd">            - lamb (m)</span>

<span class="sd">        The vector faraday angle is returned in T / m</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dins</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;BR&#39;</span><span class="p">:</span>  <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">BR</span><span class="p">,</span>   <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tBR</span><span class="p">},</span>
                <span class="s1">&#39;BPhi&#39;</span><span class="p">:{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">BPhi</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tBPhi</span><span class="p">},</span>
                <span class="s1">&#39;BZ&#39;</span><span class="p">:</span>  <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">BZ</span><span class="p">,</span>   <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tBZ</span><span class="p">},</span>
                <span class="s1">&#39;ne&#39;</span><span class="p">:</span>  <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">ne</span><span class="p">,</span>   <span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="n">tne</span><span class="p">}}</span>
        <span class="n">dins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fill_dins</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>
        <span class="n">dins</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_t</span><span class="p">(</span><span class="n">dins</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">)</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>
        <span class="n">dins</span><span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="p">:</span><span class="n">lamb</span><span class="p">}</span>
        <span class="n">dins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_shapes</span><span class="p">(</span><span class="n">dins</span><span class="p">)</span>

        <span class="n">val</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="n">_physics</span><span class="o">.</span><span class="n">compute_fangle</span><span class="p">(</span><span class="n">BR</span><span class="o">=</span><span class="n">dins</span><span class="p">[</span><span class="s1">&#39;BR&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                             <span class="n">BPhi</span><span class="o">=</span><span class="n">dins</span><span class="p">[</span><span class="s1">&#39;BPhi&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                             <span class="n">BZ</span><span class="o">=</span><span class="n">dins</span><span class="p">[</span><span class="s1">&#39;BZ&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                             <span class="n">ne</span><span class="o">=</span><span class="n">dins</span><span class="p">[</span><span class="s1">&#39;ne&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">],</span>
                                             <span class="n">lamb</span><span class="o">=</span><span class="n">dins</span><span class="p">[</span><span class="s1">&#39;lamb&#39;</span><span class="p">][</span><span class="s1">&#39;val&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">units</span></div>



    <span class="c1">#---------------------</span>
    <span class="c1"># Methods for interpolation</span>
    <span class="c1">#---------------------</span>


<div class="viewcode-block" id="Plasma2D._get_quantrefkeys"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_quantrefkeys">[docs]</a>    <span class="k">def</span> <span class="nf">_get_quantrefkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qq</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Get relevant lists</span>
        <span class="n">kq</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">k1d</span><span class="p">,</span> <span class="n">k2d</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kq</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref1d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ref2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;quant </span><span class="si">%s</span><span class="s2"> needs refs (1d and 2d) for interpolation</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">qq</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  =&gt; ref1d and ref2d cannot be both None !&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ref1d</span> <span class="o">=</span> <span class="n">ref2d</span>
            <span class="n">k1d</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">ref1d</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span>
                                            <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;ref1d&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Interpolation of </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">qq</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  ref could not be identified among 1d quantities</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - ref1d : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ref1d</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ref2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ref2d</span> <span class="o">=</span> <span class="n">ref1d</span>
            <span class="n">k2d</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">ref2d</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">,</span>
                                            <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;ref2d&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Interpolation of </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;  ref could not be identified among 2d quantities</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - ref2d: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">ref2d</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">q1d</span><span class="p">,</span> <span class="n">q2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">k1d</span><span class="p">][</span><span class="s1">&#39;quant&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">k2d</span><span class="p">][</span><span class="s1">&#39;quant&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">q1d</span> <span class="o">!=</span> <span class="n">q2d</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;ref1d and ref2d must be of the same quantity !</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - ref1d (</span><span class="si">%s</span><span class="s2">):   </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ref1d</span><span class="p">,</span> <span class="n">q1d</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - ref2d (</span><span class="si">%s</span><span class="s2">):   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ref2d</span><span class="p">,</span> <span class="n">q2d</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">kq</span><span class="p">,</span> <span class="n">k1d</span><span class="p">,</span> <span class="n">k2d</span></div>


<div class="viewcode-block" id="Plasma2D._get_indtmult"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_indtmult">[docs]</a>    <span class="k">def</span> <span class="nf">_get_indtmult</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idquant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># Get time vectors and bins</span>
        <span class="n">idtq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idquant</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idtq</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">tbinq</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">tq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">idref1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">idtr1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idref1d</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tr1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idtr1</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">tbinr1</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tr1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">tr1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">idref2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">idref2d</span> <span class="o">!=</span> <span class="n">idref1d</span><span class="p">:</span>
            <span class="n">idtr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idref2d</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tr2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idtr2</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">tbinr2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tr2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">tr2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Get tbinall and tall</span>
        <span class="k">if</span> <span class="n">idref1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tbinall</span> <span class="o">=</span> <span class="n">tbinq</span>
            <span class="n">tall</span> <span class="o">=</span> <span class="n">tq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idref2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">tbinall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">tbinq</span><span class="p">,</span><span class="n">tbinr1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tbinall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">tbinq</span><span class="p">,</span><span class="n">tbinr1</span><span class="p">,</span><span class="n">tbinr2</span><span class="p">])</span>
            <span class="n">tall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">tbinall</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tbinall</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tbinall</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                         <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tbinall</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">tbinall</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                         <span class="n">tbinall</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tbinall</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tbinall</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])]</span>

        <span class="c1"># Get indtqr1r2 (tall with respect to tq, tr1, tr2)</span>
        <span class="n">indtq</span><span class="p">,</span> <span class="n">indtr1</span><span class="p">,</span> <span class="n">indtr2</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">tbinq</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">indtq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">tall</span><span class="p">,</span> <span class="n">tbinq</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indtq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">idref1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">indtq</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">tall</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">idref1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tbinr1</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">indtr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">tall</span><span class="p">,</span> <span class="n">tbinr1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indtr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">idref2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tbinr2</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">indtr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">tall</span><span class="p">,</span> <span class="n">tbinr2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indtr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ntall</span> <span class="o">=</span> <span class="n">tall</span><span class="o">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="n">tall</span><span class="p">,</span> <span class="n">tbinall</span><span class="p">,</span> <span class="n">ntall</span><span class="p">,</span> <span class="n">indtq</span><span class="p">,</span> <span class="n">indtr1</span><span class="p">,</span> <span class="n">indtr2</span></div>

<div class="viewcode-block" id="Plasma2D._get_indtu"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_indtu">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_indtu</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tbinall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">idref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">indtr1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indtr2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Get indt (t with respect to tbinall)</span>
        <span class="n">indt</span><span class="p">,</span> <span class="n">indtu</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">tall</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tall</span><span class="p">):</span>
                <span class="n">indt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tall</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">indtu</span> <span class="o">=</span> <span class="n">indt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">indt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tbinall</span><span class="p">)</span>
                <span class="n">indtu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">indt</span><span class="p">)</span>
                <span class="c1"># Update</span>
                <span class="n">tall</span> <span class="o">=</span> <span class="n">tall</span><span class="p">[</span><span class="n">indtu</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">idref1d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">indtr1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">indtr1</span> <span class="o">=</span> <span class="n">indtr1</span><span class="p">[</span><span class="n">indtu</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">idref2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">indtr2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">indtr2</span> <span class="o">=</span> <span class="n">indtr2</span><span class="p">[</span><span class="n">indtu</span><span class="p">]</span>
        <span class="n">ntall</span> <span class="o">=</span> <span class="n">tall</span><span class="o">.</span><span class="n">size</span>
        <span class="k">return</span> <span class="n">tall</span><span class="p">,</span> <span class="n">ntall</span><span class="p">,</span> <span class="n">indt</span><span class="p">,</span> <span class="n">indtu</span><span class="p">,</span> <span class="n">indtr1</span><span class="p">,</span> <span class="n">indtr2</span></div>

<div class="viewcode-block" id="Plasma2D.get_tcommon"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.get_tcommon">[docs]</a>    <span class="k">def</span> <span class="nf">get_tcommon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lq</span><span class="p">,</span> <span class="n">prefer</span><span class="o">=</span><span class="s1">&#39;finer&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check if common t, else choose according to prefer</span>

<span class="sd">        By default, prefer the finer time resolution</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lq</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">lq</span> <span class="o">=</span> <span class="p">[</span><span class="n">lq</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="n">lq</span><span class="p">:</span>
            <span class="n">ltr</span> <span class="o">=</span> <span class="p">[</span><span class="n">kk</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">qq</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
                   <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ltr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ltr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ltr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ltr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">prefer</span> <span class="o">==</span> <span class="s1">&#39;finer&#39;</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">t</span></div>

<div class="viewcode-block" id="Plasma2D._get_tcom"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_tcom">[docs]</a>    <span class="k">def</span> <span class="nf">_get_tcom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idquant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">idref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idq2dR</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">idquant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_indtmult</span><span class="p">(</span><span class="n">idquant</span><span class="o">=</span><span class="n">idquant</span><span class="p">,</span>
                                     <span class="n">idref1d</span><span class="o">=</span><span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span><span class="o">=</span><span class="n">idref2d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_indtmult</span><span class="p">(</span><span class="n">idquant</span><span class="o">=</span><span class="n">idq2dR</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>


<div class="viewcode-block" id="Plasma2D._get_finterp"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._get_finterp">[docs]</a>    <span class="k">def</span> <span class="nf">_get_finterp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">idquant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">idq2dR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idq2dPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">idq2dZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ani</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">interp_t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interp_t</span> <span class="o">=</span> <span class="s1">&#39;nearest&#39;</span>

        <span class="c1"># Get idmesh</span>
        <span class="k">if</span> <span class="n">idquant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idref1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lidmesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idquant</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
                           <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">qq</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lidmesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idref2d</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
                           <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">qq</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">idq2dR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">lidmesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">qq</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq2dR</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
                       <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">qq</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">lidmesh</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">idmesh</span> <span class="o">=</span> <span class="n">lidmesh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Get common time indices</span>
        <span class="k">if</span> <span class="n">interp_t</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tcom</span><span class="p">(</span><span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span><span class="p">,</span> <span class="n">idq2dR</span><span class="p">)</span>
            <span class="n">tall</span><span class="p">,</span> <span class="n">tbinall</span><span class="p">,</span> <span class="n">ntall</span><span class="p">,</span> <span class="n">indtq</span><span class="p">,</span> <span class="n">indtr1</span><span class="p">,</span> <span class="n">indtr2</span> <span class="o">=</span> <span class="n">out</span>

        <span class="c1"># Get mesh</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rect&#39;</span><span class="p">:</span>
            <span class="n">mpltri</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">trifind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;trifind&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mpltri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;mpltri&#39;</span><span class="p">]</span>
            <span class="n">trifind</span> <span class="o">=</span> <span class="n">mpltri</span><span class="o">.</span><span class="n">get_trifinder</span><span class="p">()</span>

        <span class="c1"># # Prepare output</span>

        <span class="c1"># Interpolate</span>
        <span class="c1"># Note : Maybe consider using scipy.LinearNDInterpolator ?</span>
        <span class="k">if</span> <span class="n">idquant</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vquant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idquant</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;quadtri&#39;</span>
                  <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;ntri&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c0</span><span class="p">:</span>
                <span class="n">vquant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">vquant</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;ntri&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vq2dR</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq2dR</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">vq2dPhi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq2dPhi</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">vq2dZ</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq2dZ</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">interp_space</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interp_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;ftype&#39;</span><span class="p">]</span>

        <span class="c1"># get interpolation function</span>
        <span class="k">if</span> <span class="n">ani</span><span class="p">:</span>
            <span class="c1"># Assuming same mesh and time vector for all 3 components</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">get_finterp_ani</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idq2dR</span><span class="p">,</span> <span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">idq2dZ</span><span class="p">,</span>
                                         <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                         <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
                                         <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                                         <span class="n">idmesh</span><span class="o">=</span><span class="n">idmesh</span><span class="p">,</span> <span class="n">vq2dR</span><span class="o">=</span><span class="n">vq2dR</span><span class="p">,</span>
                                         <span class="n">vq2dZ</span><span class="o">=</span><span class="n">vq2dZ</span><span class="p">,</span> <span class="n">vq2dPhi</span><span class="o">=</span><span class="n">vq2dPhi</span><span class="p">,</span>
                                         <span class="n">tall</span><span class="o">=</span><span class="n">tall</span><span class="p">,</span> <span class="n">tbinall</span><span class="o">=</span><span class="n">tbinall</span><span class="p">,</span>
                                         <span class="n">ntall</span><span class="o">=</span><span class="n">ntall</span><span class="p">,</span>
                                         <span class="n">indtq</span><span class="o">=</span><span class="n">indtq</span><span class="p">,</span> <span class="n">trifind</span><span class="o">=</span><span class="n">trifind</span><span class="p">,</span>
                                         <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">,</span> <span class="n">mpltri</span><span class="o">=</span><span class="n">mpltri</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">_comp</span><span class="o">.</span><span class="n">get_finterp_isotropic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span><span class="p">,</span>
                                               <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                               <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
                                               <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span>
                                               <span class="n">idmesh</span><span class="o">=</span><span class="n">idmesh</span><span class="p">,</span> <span class="n">vquant</span><span class="o">=</span><span class="n">vquant</span><span class="p">,</span>
                                               <span class="n">tall</span><span class="o">=</span><span class="n">tall</span><span class="p">,</span> <span class="n">tbinall</span><span class="o">=</span><span class="n">tbinall</span><span class="p">,</span>
                                               <span class="n">ntall</span><span class="o">=</span><span class="n">ntall</span><span class="p">,</span> <span class="n">mpltri</span><span class="o">=</span><span class="n">mpltri</span><span class="p">,</span>
                                               <span class="n">indtq</span><span class="o">=</span><span class="n">indtq</span><span class="p">,</span> <span class="n">indtr1</span><span class="o">=</span><span class="n">indtr1</span><span class="p">,</span>
                                               <span class="n">indtr2</span><span class="o">=</span><span class="n">indtr2</span><span class="p">,</span> <span class="n">trifind</span><span class="o">=</span><span class="n">trifind</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="Plasma2D._checkformat_qr12RPZ"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D._checkformat_qr12RPZ">[docs]</a>    <span class="k">def</span> <span class="nf">_checkformat_qr12RPZ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">q2dR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dZ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lc0</span> <span class="o">=</span> <span class="p">[</span><span class="n">quant</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ref1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">lc1</span> <span class="o">=</span> <span class="p">[</span><span class="n">q2dR</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">q2dPhi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">q2dZ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">all</span><span class="p">(</span><span class="n">lc0</span><span class="p">),</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc1</span><span class="p">)])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide either (xor):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - a scalar field (isotropic emissivity):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        quant : scalar quantity to interpolate</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                if quant is 1d, intermediate reference</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;                fields are necessary for 2d interpolation</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        ref1d : 1d reference field on which to interpolate</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        ref2d : 2d reference field on which to interpolate</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - a vector (R,Phi,Z) field (anisotropic emissivity):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        q2dR :  R component of the vector field</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        q2dPhi: R component of the vector field</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        q2dZ :  Z component of the vector field</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;        =&gt; all components have teh same time and mesh !</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check requested quant is available in 2d or 1d</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">lc1</span><span class="p">):</span>
            <span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantrefkeys</span><span class="p">(</span><span class="n">quant</span><span class="p">,</span> <span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="p">)</span>
            <span class="n">idq2dR</span><span class="p">,</span> <span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">idq2dZ</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">ani</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idq2dR</span><span class="p">,</span> <span class="n">msg</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">q2dR</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span>
                                              <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">q2dPhi</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span>
                                              <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">idq2dZ</span><span class="p">,</span> <span class="n">msg</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">q2dZ</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span>
                                              <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">ani</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span><span class="p">,</span> <span class="n">idq2dR</span><span class="p">,</span> <span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">idq2dZ</span><span class="p">,</span> <span class="n">ani</span></div>


<div class="viewcode-block" id="Plasma2D.get_finterp2d"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.get_finterp2d">[docs]</a>    <span class="k">def</span> <span class="nf">get_finterp2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">q2dR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the function interpolating (X,Y,Z) pts on a 1d/2d profile</span>

<span class="sd">        Can be used as input for tf.geom.CamLOS1D/2D.calc_signal()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Only &#39;nearest&#39; available so far for interp_t!&quot;</span>
        <span class="k">assert</span> <span class="n">interp_t</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">msg</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_qr12RPZ</span><span class="p">(</span><span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                                        <span class="n">q2dR</span><span class="o">=</span><span class="n">q2dR</span><span class="p">,</span> <span class="n">q2dPhi</span><span class="o">=</span><span class="n">q2dPhi</span><span class="p">,</span> <span class="n">q2dZ</span><span class="o">=</span><span class="n">q2dZ</span><span class="p">)</span>
        <span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span><span class="p">,</span> <span class="n">idq2dR</span><span class="p">,</span> <span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">idq2dZ</span><span class="p">,</span> <span class="n">ani</span> <span class="o">=</span> <span class="n">out</span>


        <span class="c1"># Interpolation (including time broadcasting)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_finterp</span><span class="p">(</span><span class="n">idquant</span><span class="o">=</span><span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="o">=</span><span class="n">idref1d</span><span class="p">,</span>
                                 <span class="n">idref2d</span><span class="o">=</span><span class="n">idref2d</span><span class="p">,</span> <span class="n">idq2dR</span><span class="o">=</span><span class="n">idq2dR</span><span class="p">,</span>
                                 <span class="n">idq2dPhi</span><span class="o">=</span><span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">idq2dZ</span><span class="o">=</span><span class="n">idq2dZ</span><span class="p">,</span>
                                 <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
                                 <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span> <span class="n">ani</span><span class="o">=</span><span class="n">ani</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span></div>


<div class="viewcode-block" id="Plasma2D.interp_pts2profile"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.interp_pts2profile">[docs]</a>    <span class="k">def</span> <span class="nf">interp_pts2profile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">q2dR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the value of the desired profiles_1d quantity</span>

<span class="sd">        For the desired inputs points (pts):</span>
<span class="sd">            - pts are in (X,Y,Z) coordinates</span>
<span class="sd">            - space interpolation is linear on the 1d profiles</span>
<span class="sd">        At the desired input times (t):</span>
<span class="sd">            - using a nearest-neighbourg approach for time</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check inputs</span>
        <span class="c1"># msg = &quot;Only &#39;nearest&#39; available so far for interp_t!&quot;</span>
        <span class="c1"># assert interp_t == &#39;nearest&#39;, msg</span>

        <span class="c1"># Check requested quant is available in 2d or 1d</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkformat_qr12RPZ</span><span class="p">(</span><span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                                        <span class="n">q2dR</span><span class="o">=</span><span class="n">q2dR</span><span class="p">,</span> <span class="n">q2dPhi</span><span class="o">=</span><span class="n">q2dPhi</span><span class="p">,</span> <span class="n">q2dZ</span><span class="o">=</span><span class="n">q2dZ</span><span class="p">)</span>
        <span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span><span class="p">,</span> <span class="n">idq2dR</span><span class="p">,</span> <span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">idq2dZ</span><span class="p">,</span> <span class="n">ani</span> <span class="o">=</span> <span class="n">out</span>

        <span class="c1"># Check the pts is (2,...) array of floats</span>
        <span class="k">if</span> <span class="n">pts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ani</span><span class="p">:</span>
                <span class="n">idmesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq2dR</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
                          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">idref1d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">idmesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idquant</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
                              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">idmesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_</span> <span class="k">for</span> <span class="n">id_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idref2d</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">]</span>
                              <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="p">[</span><span class="n">id_</span><span class="p">][</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mesh&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rect&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;shapeRZ&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">):</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;nZ&#39;</span><span class="p">])</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;nR&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;R&#39;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;nZ&#39;</span><span class="p">])</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;nR&#39;</span><span class="p">])</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">],)),</span> <span class="n">Z</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmesh</span><span class="p">[</span><span class="n">idmesh</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
                <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">pts</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],)),</span> <span class="n">pts</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="n">pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">pts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;pts must be np.ndarray of (X,Y,Z) points coordinates</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Can be multi-dimensional, but the 1st dimension is (X,Y,Z)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Expected shape : (3,...)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - Provided shape : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">pts</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Check t</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lc</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">assert</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>

        <span class="c1"># Interpolation (including time broadcasting)</span>
        <span class="c1"># this is the second slowest step (~0.08 s)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_finterp</span><span class="p">(</span><span class="n">idquant</span><span class="o">=</span><span class="n">idquant</span><span class="p">,</span> <span class="n">idref1d</span><span class="o">=</span><span class="n">idref1d</span><span class="p">,</span> <span class="n">idref2d</span><span class="o">=</span><span class="n">idref2d</span><span class="p">,</span>
                                 <span class="n">idq2dR</span><span class="o">=</span><span class="n">idq2dR</span><span class="p">,</span> <span class="n">idq2dPhi</span><span class="o">=</span><span class="n">idq2dPhi</span><span class="p">,</span> <span class="n">idq2dZ</span><span class="o">=</span><span class="n">idq2dZ</span><span class="p">,</span>
                                 <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
                                 <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span> <span class="n">ani</span><span class="o">=</span><span class="n">ani</span><span class="p">,</span> <span class="n">Type</span><span class="o">=</span><span class="n">Type</span><span class="p">)</span>

        <span class="c1"># This is the slowest step (~1.8 s)</span>
        <span class="n">val</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">vect</span><span class="o">=</span><span class="n">vect</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">,</span> <span class="n">t</span></div>


<div class="viewcode-block" id="Plasma2D.calc_signal_from_Cam"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.calc_signal_from_Cam">[docs]</a>    <span class="k">def</span> <span class="nf">calc_signal_from_Cam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cam</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">quant</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">q2dR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dPhi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">q2dZ</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">Brightness</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">interp_t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">res</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">DL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resMode</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span>
                             <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="nb">object</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dataname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wintit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">units</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="k">if</span> <span class="s1">&#39;Cam&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cam</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Arg cam must be tofu Camera instance (CamLOS1D, CamLOS2D...)&quot;</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cam</span><span class="o">.</span><span class="n">calc_signal_from_Plasma2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
                                             <span class="n">quant</span><span class="o">=</span><span class="n">quant</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                                             <span class="n">q2dR</span><span class="o">=</span><span class="n">q2dR</span><span class="p">,</span> <span class="n">q2dPhi</span><span class="o">=</span><span class="n">q2dPhi</span><span class="p">,</span>
                                             <span class="n">q2dZ</span><span class="o">=</span><span class="n">q2dZ</span><span class="p">,</span>
                                             <span class="n">Brightness</span><span class="o">=</span><span class="n">Brightness</span><span class="p">,</span>
                                             <span class="n">interp_t</span><span class="o">=</span><span class="n">interp_t</span><span class="p">,</span>
                                             <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">,</span>
                                             <span class="n">fill_value</span><span class="o">=</span><span class="n">fill_value</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span>
                                             <span class="n">DL</span><span class="o">=</span><span class="n">DL</span><span class="p">,</span> <span class="n">resMode</span><span class="o">=</span><span class="n">resMode</span><span class="p">,</span>
                                             <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
                                             <span class="n">pot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">dataname</span><span class="o">=</span><span class="n">dataname</span><span class="p">,</span>
                                             <span class="n">fs</span><span class="o">=</span><span class="n">fs</span><span class="p">,</span> <span class="n">dmargin</span><span class="o">=</span><span class="n">dmargin</span><span class="p">,</span>
                                             <span class="n">wintit</span><span class="o">=</span><span class="n">wintit</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="n">invert</span><span class="p">,</span>
                                             <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">draw</span><span class="o">=</span><span class="n">draw</span><span class="p">,</span>
                                             <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">)</span></div>


    <span class="c1">#---------------------</span>
    <span class="c1"># Methods for getting data</span>
    <span class="c1">#---------------------</span>

<div class="viewcode-block" id="Plasma2D.get_dextra"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.get_dextra">[docs]</a>    <span class="k">def</span> <span class="nf">get_dextra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="p">[</span><span class="n">dextra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dextra</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">,</span>
              <span class="nb">type</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dextra</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dextra</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">dextra</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">dextra</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]</span>
                      <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;lgroup&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
                          <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dindref</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">dextra</span> <span class="o">=</span> <span class="p">[</span><span class="n">dextra</span><span class="p">]</span>

        <span class="c1"># get data</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dextra</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dextra</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
                    <span class="n">ee</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">dextra</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ee</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">dextra</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="kc">None</span>
                <span class="n">ee</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">ee</span><span class="p">][</span><span class="s1">&#39;lgroup&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;time-only dependent signals allowed in dextra!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">ee</span><span class="p">][</span><span class="s1">&#39;lgroup&#39;</span><span class="p">]))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">idt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">ee</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">ee</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;data2D&#39;</span>
                <span class="n">dd</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">ee</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idt</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">ee</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                      <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">ee</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]}</span>
                <span class="k">if</span> <span class="n">cc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span>
                <span class="n">dextra</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
            <span class="n">dextra</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dextra</span></div>

<div class="viewcode-block" id="Plasma2D.get_Data"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.get_Data">[docs]</a>    <span class="k">def</span> <span class="nf">get_Data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lquant</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">remap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dextra</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tofu.data</span> <span class="k">as</span> <span class="nn">tfd</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">data</span> <span class="k">as</span> <span class="n">tfd</span>

        <span class="c1"># Check and format input</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">lquant</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">list</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lquant</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">lquant</span> <span class="o">=</span> <span class="p">[</span><span class="n">lquant</span><span class="p">]</span>
        <span class="n">nquant</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lquant</span><span class="p">)</span>

        <span class="c1"># Get X if common</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="n">nquant</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c0</span> <span class="ow">or</span> <span class="n">c1</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;X must be specified, either as :</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;    - a str (name or quant)</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;    - a list of str</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">+</span> <span class="s2">&quot;    Provided: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">idX</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># prepare remap pts</span>
        <span class="k">if</span> <span class="n">remap</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">refS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dStruct</span><span class="p">[</span><span class="s1">&#39;dObj&#39;</span><span class="p">][</span><span class="s1">&#39;Ves&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ptsRZ</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">extent</span> <span class="o">=</span> <span class="n">refS</span><span class="o">.</span><span class="n">get_sampleCross</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;imshow&#39;</span><span class="p">)</span>
            <span class="n">dmap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;data2D&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;extent&#39;</span><span class="p">:</span><span class="n">extent</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">X</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lquantboth</span><span class="p">:</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">X</span>

        <span class="c1"># Define Data</span>
        <span class="n">dcommon</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">Exp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">Exp</span><span class="p">,</span> <span class="n">shot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span><span class="o">.</span><span class="n">shot</span><span class="p">,</span>
                       <span class="n">Diag</span><span class="o">=</span><span class="s1">&#39;profiles1d&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># dextra</span>
        <span class="n">dextra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dextra</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span>

        <span class="c1"># Get output</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">qq</span> <span class="ow">in</span> <span class="n">lquant</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nquant</span><span class="p">):</span>
            <span class="n">qq</span> <span class="o">=</span> <span class="n">lquant</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">remap</span><span class="p">:</span>
                <span class="c1"># Check requested quant is available in 2d or 1d</span>
                <span class="n">idq</span><span class="p">,</span> <span class="n">idrefd1</span><span class="p">,</span> <span class="n">idref2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_quantrefkeys</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">idq</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span>
                                                <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;quant&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idq</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dgroup</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">][</span><span class="s1">&#39;ldata&#39;</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Only 1d quantities can be turned into tf.data.Data !</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;    - </span><span class="si">%s</span><span class="s2"> is not a radius-dependent quantity&quot;</span><span class="o">%</span><span class="n">qq</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">idt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq</span><span class="p">][</span><span class="s1">&#39;depend&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">idX</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_keyingroup</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span>
                                                <span class="n">msgstr</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">raise_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">dlabels</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]},</span>
                       <span class="s1">&#39;X&#39;</span><span class="p">:{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idX</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idX</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]},</span>
                       <span class="s1">&#39;t&#39;</span><span class="p">:{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idt</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idt</span><span class="p">][</span><span class="s1">&#39;units&#39;</span><span class="p">]}}</span>

            <span class="n">dextra_</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dextra</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remap</span><span class="p">:</span>
                <span class="n">dmapii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dmap</span><span class="p">)</span>
                <span class="n">val</span><span class="p">,</span> <span class="n">tii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp_pts2profile</span><span class="p">(</span><span class="n">qq</span><span class="p">,</span> <span class="n">ptsRZ</span><span class="o">=</span><span class="n">ptsRZ</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                                                   <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">)</span>
                <span class="n">dmapii</span><span class="p">[</span><span class="s1">&#39;data2D&#39;</span><span class="p">],</span> <span class="n">dmapii</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">tii</span>
                <span class="n">dextra_</span><span class="p">[</span><span class="s1">&#39;map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmapii</span>
            <span class="n">lout</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataCam1D</span><span class="p">(</span><span class="n">Name</span> <span class="o">=</span> <span class="n">qq</span><span class="p">,</span>
                                 <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idq</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                 <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idt</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                 <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ddata</span><span class="p">[</span><span class="n">idX</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span>
                                 <span class="n">dextra</span> <span class="o">=</span> <span class="n">dextra_</span><span class="p">,</span> <span class="n">dlabels</span><span class="o">=</span><span class="n">dlabels</span><span class="p">,</span> <span class="o">**</span><span class="n">dcommon</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nquant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">lout</span> <span class="o">=</span> <span class="n">lout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lout</span></div>


    <span class="c1">#---------------------</span>
    <span class="c1"># Methods for plotting data</span>
    <span class="c1">#---------------------</span>

<div class="viewcode-block" id="Plasma2D.plot"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lquant</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">remap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">lDat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Data</span><span class="p">(</span><span class="n">lquant</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">remap</span><span class="o">=</span><span class="n">remap</span><span class="p">,</span>
                             <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                             <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lDat</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">kh</span> <span class="o">=</span> <span class="n">lDat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_combine</span><span class="p">(</span><span class="n">lDat</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kh</span> <span class="o">=</span> <span class="n">lDat</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kh</span></div>

<div class="viewcode-block" id="Plasma2D.plot_combine"><a class="viewcode-back" href="../../../tofu.data.html#tofu.data._core.Plasma2D.plot_combine">[docs]</a>    <span class="k">def</span> <span class="nf">plot_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lquant</span><span class="p">,</span> <span class="n">lData</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">ref1d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">remap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; plot combining several quantities from the Plasma2D itself and</span>
<span class="sd">        optional extra list of Data instances &quot;&quot;&quot;</span>
        <span class="n">lDat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Data</span><span class="p">(</span><span class="n">lquant</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">remap</span><span class="o">=</span><span class="n">remap</span><span class="p">,</span>
                             <span class="n">ref1d</span><span class="o">=</span><span class="n">ref1d</span><span class="p">,</span> <span class="n">ref2d</span><span class="o">=</span><span class="n">ref2d</span><span class="p">,</span>
                             <span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> <span class="n">interp_space</span><span class="o">=</span><span class="n">interp_space</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">lDat</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">lData</span> <span class="o">=</span> <span class="n">lDat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">lData</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lData</span> <span class="o">=</span> <span class="n">lDat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="p">[</span><span class="n">lData</span><span class="p">]</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="n">lDat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_combine</span><span class="p">(</span><span class="n">lData</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="n">sharex</span><span class="p">,</span> <span class="n">bck</span><span class="o">=</span><span class="n">bck</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kh</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2016-2021, Tofu contributors.<br/>
      Last updated on May 12, 2021.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>